
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Streaming Network of Dreams - Смотрите лучшие фильмы и сериалы в высоком качестве">
    <meta name="keywords" content="фильмы, сериалы, стриминг, онлайн кино, HD качество">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Streaming Network of Dreams</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- QR Code Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <style>
        :root {
            color-scheme: dark;
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-left: env(safe-area-inset-left, 0px);
            --safe-area-right: env(safe-area-inset-right, 0px);
        }
        html, body {
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        body {
            background-color: #000000;
            color: #F3F4F6;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        /* Disable context menu for all links and images globally */
        a, img, button, video {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Allow text selection only in input fields */
        input, textarea {
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
        }
        #app-container {
            background-color: #000000;
            width: 100%;
            min-height: 100vh;
            min-height: 100dvh; /* Dynamic viewport height for mobile */
            display: flex;
            flex-direction: column;
        }
        main {
            padding-bottom: calc(3rem + var(--safe-area-bottom));
            flex: 1;
        }

        /* Container max-width for very large screens */
        @media (min-width: 2560px) {
            #main {
                max-width: 2400px;
                margin-left: auto;
                margin-right: auto;
            }
        }
    body::-webkit-scrollbar, #category-nav::-webkit-scrollbar, #episode-list::-webkit-scrollbar, #search-results::-webkit-scrollbar, #notification-list::-webkit-scrollbar, #ai-chat-messages::-webkit-scrollbar, #hero-slider::-webkit-scrollbar { display: none; }
    body, #category-nav, #episode-list, #search-results, #notification-list, #ai-chat-messages, #hero-slider { -ms-overflow-style: none; scrollbar-width: none; }
    /* Ensure hero slider horizontal scrollbar hidden on all browsers */
    #hero-slider::-webkit-scrollbar { height: 0; background: transparent; }

        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3rem; /* 48px - reduced from 64px */
            z-index: 20;
            flex-shrink: 0;
            padding-bottom: var(--safe-area-bottom);
        }
        #player {
            position: fixed;
            inset: 0;
            z-index: 50;
            background-color: #000;
        }
        .category-btn.active { background-color: #DC2626; color: #FFFFFF; }

        /* Responsive category buttons */
        .category-btn {
            font-size: 0.8125rem !important;
            padding: 0.5rem 0.875rem !important;
            transition: all 0.2s ease;
        }
        @media (min-width: 768px) {
            .category-btn {
                font-size: 0.875rem !important;
                padding: 0.5rem 1rem !important;
            }
        }
        @media (min-width: 1024px) {
            .category-btn {
                font-size: 0.9375rem !important;
                padding: 0.625rem 1.25rem !important;
            }
        }

        .episode-item.active { background-color: #DC2626; }
        .lang-btn.active { background-color: #DC2626; color: #FFFFFF; font-weight: bold; }
        .bottom-nav-link.active {
            color: #ef4444;
            background-color: rgba(239, 68, 68, 0.1);
        }
        .bottom-nav-link.active #bottom-nav-avatar {
            box-shadow: 0 0 0 2px #ef4444;
            transform: scale(1.05);
        }
        .fav-button.favorited { color: #ef4444; }
        .bottom-nav-link {
            gap: 0.15rem;
            min-height: 100%;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            pointer-events: auto;
            touch-action: manipulation;
        }
        .bottom-nav-link:focus-visible {
            outline: 2px solid #ef4444;
            outline-offset: 2px;
        }
        /* Profile menu modal animations */
        #profile-menu-content {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Devices modal tabs */
        .devices-tab-btn {
            color: #9CA3AF;
            background: transparent;
        }
        .devices-tab-btn.active {
            color: white;
            background: #374151;
        }
        .devices-tab-btn:hover:not(.active) {
            background: #1F2937;
        }
        .devices-tab-content.hidden {
            display: none !important;
        }
        #qr-reader video {
            width: 100% !important;
            height: auto !important;
            border-radius: 12px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 15px 50px rgba(102, 126, 234, 0.6);
            }
        }

        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }

        .animate-fadeIn {
            animation: fadeIn 0.5s ease-out;
        }

        #category-nav {
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            padding: 0 1rem;
        }
        #category-nav button {
            scroll-snap-align: start;
        }
        .quality-option.active, .speed-option.active, .subtitle-option.active { color: #ef4444; font-weight: bold; }
        .player-controls { opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none; }
        .player-controls.visible { opacity: 1; pointer-events: auto; }
        #center-play-btn.hidden, #center-pause-btn.hidden { display: none; }
        .seek-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%) scale(0.5);
            color: white;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 1rem;
            border-radius: 50%;
            font-size: 1.8rem;
            opacity: 0;
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            pointer-events: none;
        }
        .seek-indicator.show { opacity: 1; transform: translateY(-50%) scale(1); }
        /* Smoothly animate rating bars to their target width */
        .rating-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        input[type="range"] { -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; width: 100%; }
        input[type="range"]::-webkit-slider-runnable-track { background: rgba(255, 255, 255, 0.3); height: 0.35rem; border-radius: 1rem; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; margin-top: -6px; background-color: #ef4444; height: 1.1rem; width: 1.1rem; border-radius: 50%; border: 2px solid #111827; }
        body.snd-modal-locked { overflow: hidden; }
    /* Ad overlay styles */
    #ad-overlay { display: none; }
    #ad-overlay > div { box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
    /* Support chat dots animation */
    .dots span {
        display:inline-block;
        width:6px;
        height:6px;
        margin:0 2px;
        border-radius:9999px;
        background:#34d399;
        animation:pulse-dot 1.2s infinite ease-in-out both;
    }
    .dots span:nth-child(2){ animation-delay:.15s }
    .dots span:nth-child(3){ animation-delay:.3s }
    @keyframes pulse-dot {
        0%,80%,100%{ transform:scale(0.6); opacity:.6 }
        40%{ transform:scale(1); opacity:1 }
    }
        .snd-chip-option {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.35rem 0.85rem;
            border-radius: 9999px;
            border: 1px solid rgba(255,255,255,0.25);
            background-color: rgba(17, 24, 39, 0.85);
            color: #d1d5db;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .snd-chip-option:hover { border-color: #ef4444; color: #fff; }
        .snd-chip-option.active {
            border-color: #ef4444;
            color: #fff;
            background: linear-gradient(135deg, rgba(239,68,68,0.35), rgba(17,24,39,0.85));
            box-shadow: 0 6px 18px rgba(239,68,68,0.25);
        }
        .snd-toggle-track {
            display: inline-block;
            width: 42px;
            height: 22px;
            border-radius: 9999px;
            background: rgba(148,163,184,0.35);
            position: relative;
            transition: background 0.2s ease;
        }
        .snd-toggle-track::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 4px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #ffffff;
            transition: transform 0.2s ease;
        }
        #card-subtitles-toggle:checked + .snd-toggle-track {
            background: rgba(239,68,68,0.75);
        }
        #card-subtitles-toggle:checked + .snd-toggle-track::after {
            transform: translateX(18px);
        }
        .snd-cast-card.active {
            border: 1px solid rgba(239,68,68,0.45);
            box-shadow: 0 12px 28px rgba(239,68,68,0.25);
        }
        .snd-cast-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.1rem 0.6rem;
            border-radius: 9999px;
            background: rgba(239,68,68,0.18);
            border: 1px solid rgba(239,68,68,0.45);
            color: #fef2f2;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .video-progress {
            --watched-percent: 0%;
            --buffered-percent: 0%;
            background: linear-gradient(to right,
                #ef4444 0%,
                #ef4444 var(--watched-percent),
                #ffffff var(--watched-percent),
                #ffffff var(--buffered-percent),
                rgba(255,255,255,0.2) var(--buffered-percent),
                rgba(255,255,255,0.2) 100%);
            border-radius: 9999px;
            height: 4px;
        }
        .video-progress::-webkit-slider-runnable-track {
            height: 4px;
            border-radius: 9999px;
            background: linear-gradient(to right,
                #ef4444 0%,
                #ef4444 var(--watched-percent),
                #ffffff var(--watched-percent),
                #ffffff var(--buffered-percent),
                rgba(255,255,255,0.2) var(--buffered-percent),
                rgba(255,255,255,0.2) 100%);
        }
        .video-progress::-moz-range-track {
            height: 4px;
            border-radius: 9999px;
            background: linear-gradient(to right,
                #ef4444 0%,
                #ef4444 var(--watched-percent),
                #ffffff var(--watched-percent),
                #ffffff var(--buffered-percent),
                rgba(255,255,255,0.2) var(--buffered-percent),
                rgba(255,255,255,0.2) 100%);
        }
        .video-progress::-webkit-slider-thumb { margin-top: -6px; }

        #player-settings-panel {
            position: absolute;
            right: 1rem;
            bottom: 5rem;
            width: 280px;
            max-height: calc(100% - 6rem);
            background-color: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            transform: translateX(150%);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            z-index: 40;
            opacity: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
            /* Defensive: remove stray 1px lines between hero and content */
            #home-hero-wrapper, #hero-slider, #secondary-top-nav, #main-grid-wrapper, #main {
                border: 0 !important;
                box-shadow: none !important;
                outline: none !important;
                background-clip: padding-box !important;
            }
            #main-grid-wrapper {
                margin-top: 0 !important;
                padding-top: 0 !important;
            }

            /* ========== RESPONSIVE HERO SECTION ========== */
            /* Mobile First: Small phones (320px - 480px) */
            #home-hero-wrapper {
                height: 70vh !important;
                max-height: none !important;
                margin-bottom: 0 !important;
                padding-bottom: 0 !important;
            }
            #hero-slider {
                height: 100% !important;
            }

            /* Medium phones (481px - 767px) */
            @media (min-width: 481px) and (max-width: 767px) {
                #home-hero-wrapper {
                    height: 65vh !important;
                }
            }

            /* Tablets (768px - 1024px) */
            @media (min-width: 768px) and (max-width: 1024px) {
                #home-hero-wrapper {
                    height: 70vh !important;
                    max-height: 700px !important;
                }
            }

            /* Desktop (1025px+) */
            @media (min-width: 1025px) {
                #home-hero-wrapper {
                    height: 75vh !important;
                    max-height: 820px !important;
                }
            }

            /* Large Desktop (1920px+) */
            @media (min-width: 1920px) {
                #home-hero-wrapper {
                    height: 70vh !important;
                    max-height: 900px !important;
                }
            }

            /* Also clear common pseudo-element sources */
            #home-hero-wrapper::before, #home-hero-wrapper::after, #main-grid-wrapper::before, #main-grid-wrapper::after {
                border: 0 !important;
                box-shadow: none !important;
                background: transparent !important;
                content: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* ========== RESPONSIVE MOVIES GRID ========== */
            /* Mobile First: 2 columns */
            #movies-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
                gap: 0.75rem !important;
            }

            /* Large phones: 3 columns (480px+) */
            @media (min-width: 480px) {
                #movies-grid {
                    grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
                    gap: 0.875rem !important;
                }
            }

            /* Tablets: 4 columns (768px+) */
            @media (min-width: 768px) {
                #movies-grid {
                    grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
                    gap: 1rem !important;
                }
                #main-grid-wrapper {
                    padding: 0 1.5rem !important;
                }
            }

            /* Small Desktop: 5 columns (1024px+) */
            @media (min-width: 1024px) {
                #movies-grid {
                    grid-template-columns: repeat(5, minmax(0, 1fr)) !important;
                    gap: 1.125rem !important;
                }
            }

            /* Large Desktop: 6 columns (1280px+) */
            @media (min-width: 1280px) {
                #movies-grid {
                    grid-template-columns: repeat(6, minmax(0, 1fr)) !important;
                    gap: 1.25rem !important;
                }
                #main-grid-wrapper {
                    padding: 0 2rem !important;
                }
            }

            /* Extra Large: 7-8 columns (1920px+) */
            @media (min-width: 1920px) {
                #movies-grid {
                    grid-template-columns: repeat(7, minmax(0, 1fr)) !important;
                    gap: 1.5rem !important;
                }
            }

            /* ========== MOVIE CARD RESPONSIVE ========== */
            .movie-card-link {
                aspect-ratio: 2/3;
                display: block;
                border-radius: 0.5rem;
                overflow: hidden;
            }

            /* Larger text on bigger screens */
            @media (min-width: 768px) {
                .movie-card-link h3 {
                    font-size: 0.9375rem !important;
                }
                .movie-card-link p {
                    font-size: 0.75rem !important;
                }
                .movie-card-link .fa-play-circle {
                    font-size: 3rem !important;
                }
            }

            @media (min-width: 1024px) {
                .movie-card-link h3 {
                    font-size: 1rem !important;
                }
                .movie-card-link p {
                    font-size: 0.8125rem !important;
                }
                .movie-card-link .fa-play-circle {
                    font-size: 3.5rem !important;
                }
                .movie-card-link {
                    border-radius: 0.625rem;
                }
            }

        #player-settings-panel.open {
            transform: translateX(0);
            opacity: 1;
        }
        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
        }
        .settings-item:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .settings-item i {
            width: 24px;
            text-align: center;
        }
        .toggle-checkbox:checked { right: 0; border-color: #DC2626; }
        .toggle-checkbox:checked + .toggle-label { background-color: #DC2626; }
        #mini-player-container { transition: opacity 0.3s ease-in-out; cursor: grab; }
        #mini-player-container.grabbing { cursor: grabbing; }
        #mini-player-container.hidden { opacity: 0; pointer-events: none; }
        #mini-player-container video { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .toast-notification { transition: opacity 0.3s, transform 0.3s; }
        .notification-dot {
            position: absolute; top: -2px; right: -2px; width: 8px; height: 8px;
            background-color: #ef4444; border-radius: 50%; border: 1px solid #111827;
        }
        #notification-panel {
            transition: opacity 0.3s, transform 0.3s;
            transform-origin: top right;
        }
        #notification-panel.hidden {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
            pointer-events: none;
        }
        #notification-panel:not(.hidden) {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

        /* Responsive notification panel */
        @media (max-width: 640px) {
            #notification-panel {
                top: 0 !important;
                right: 0 !important;
                left: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                border-radius: 0 !important;
                max-height: 100vh !important;
            }
        }

        @media (min-width: 641px) and (max-width: 768px) {
            #notification-panel {
                width: 85vw !important;
                max-width: 400px !important;
            }
        }

        #notification-list {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.2) transparent;
        }

        .notification-item {
            min-height: 70px;
            transition: background-color 0.2s ease, opacity 0.2s ease;
        }

        .notification-item:last-child {
            border-bottom: none !important;
        }

        .notification-item:active {
            background-color: rgba(75, 85, 99, 0.5) !important;
        }

        .sports-category-card {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1.5rem;
            border-radius: 1rem;
            background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(17,24,39,0.65));
            border: 1px solid rgba(255,255,255,0.08);
            color: #F3F4F6;
            transition: transform 0.2s ease, border-color 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
        }
        .sports-category-card:hover {
            transform: translateY(-4px);
            border-color: rgba(239,68,68,0.55);
            background: linear-gradient(135deg, rgba(239,68,68,0.25), rgba(17,24,39,0.75));
        }
        .sports-category-card.active {
            border-color: #ef4444;
            box-shadow: 0 12px 30px rgba(239,68,68,0.25);
            background: linear-gradient(135deg, rgba(239,68,68,0.35), rgba(17,24,39,0.85));
        }
        .sports-category-card i {
            font-size: 1.75rem;
            color: #f87171;
        }
        .details-hero-bg {
            position: relative; height: 250px; overflow: hidden;
        }
        .details-hero-bg::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-size: cover; background-position: center;
            filter: blur(10px) brightness(0.7); transform: scale(1.2);
            background-image: var(--bg-image);
        }
        .details-hero-bg .overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to top, rgba(17, 24, 39, 1) 0%, rgba(17, 24, 39, 0.5) 50%, rgba(17, 24, 39, 0.2) 100%);
        }
        .chat-bubble-user { background-color: #DC2626; }
        /* Highlight for the top navigation categories.  When a tab is active, underline it so users know which section is selected. */
        .top-text-nav .top-nav-item.active {
            border-bottom: 2px solid #ef4444;
        }
        .chat-bubble-ai { background-color: #374151; }
        .typing-indicator span {
            height: 8px; width: 8px; margin: 0 2px;
            background-color: #9CA3AF; border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        #player-loading-spinner {
            pointer-events: none;
        }
        .player-loader {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: #FFF;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .speed-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            font-size: 1rem;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            pointer-events: none;
            z-index: 30;
        }
        /* Login/Register Tabs */
        .auth-tab {
            border-bottom: 2px solid transparent;
        }
        .auth-tab.active {
            border-bottom-color: #ef4444;
            color: #ef4444;
        }

        /* --- Home Hero (HBO Max style) --- */
        .home-hero {
            position: relative;
            height: 100%; /* Match parent container height */
            overflow: hidden;
        }
        .home-hero .hero-gradient {
            /* Disable the dark gradient overlay so the hero doesn't end in solid black */
            display: none !important;
            background: transparent !important;
        }
        .home-hero .hero-content {
            position: relative; z-index: 2; height: 100%;
            display: flex; flex-direction: column;
        }
        .top-text-nav span {
            margin-right: 1.25rem;
            font-weight: 600;
            color: rgba(243,244,246,0.85);
            white-space: nowrap;
            cursor: pointer;
            transition: color 0.2s ease;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            position: relative;
            z-index: 10;
            font-size: 0.875rem; /* 14px for mobile */
        }
        .top-text-nav span.active, .top-text-nav span:hover { color: #fff; }

        /* Responsive top navigation */
        @media (min-width: 768px) {
            .top-text-nav span {
                font-size: 0.9375rem; /* 15px for tablet */
                margin-right: 1.5rem;
            }
        }
        @media (min-width: 1025px) {
            .top-text-nav span {
                font-size: 1rem; /* 16px for desktop */
                margin-right: 1.75rem;
            }
        }
        .top-text-nav {
            scrollbar-width: none;
            -ms-overflow-style: none;
            touch-action: pan-x;
            z-index: 20;
        }
        .top-text-nav::-webkit-scrollbar {
            display: none;
        }

        /* Hero dots - responsive sizing */
        .hero-dots {
            display:flex;
            gap:.4rem;
            background: transparent;
            padding: 0.5rem 0; /* Small padding for touch targets */
        }
        .hero-dots .dot {
            width:.5rem;
            height:.5rem;
            border-radius:9999px;
            background:rgba(255,255,255,.4);
            transition: all 0.3s ease;
        }
        .hero-dots .dot.active {
            background:#fff;
            transform: scale(1.2);
        }

        /* Larger dots on desktop */
        @media (min-width: 768px) {
            .hero-dots .dot {
                width:.6rem;
                height:.6rem;
            }
        }
        @media (min-width: 1025px) {
            .hero-dots {
                gap:.5rem;
            }
            .hero-dots .dot {
                width:.65rem;
                height:.65rem;
            }
        }

        #support-sms-toast {
            position: fixed;
            top: calc(var(--safe-area-top) + 0.75rem);
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(17, 24, 39, 0.9);
            color: #f3f4f6;
            padding: 0.6rem 0.95rem;
            border-radius: 9999px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.35);
            backdrop-filter: blur(10px);
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease, transform 0.25s ease;
        }
        #support-sms-toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }
        #support-sms-toast button {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: inherit;
            background: transparent;
            border: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
            text-align: left;
        }
        .support-sms-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            background: rgba(239,68,68,0.2);
            color: #fca5a5;
            border-radius: 9999px;
            padding: 0.1rem 0.45rem;
        }
        .support-sms-text {
            font-size: 0.8rem;
            max-width: 60vw;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        @media (max-width: 640px) {
            .home-hero { height: 70vh; }
            .top-text-nav { overflow-x: auto; padding-bottom: 0.5rem; }
            .support-sms-text { max-width: 72vw; }
        }
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
            .player-controls,
            .toast-notification,
            #mini-player-container {
                transition: none;
            }
        }
        /* Accessibility: Screen reader only utility class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        .focus\:not-sr-only:focus {
            position: static;
            width: auto;
            height: auto;
            padding: inherit;
            margin: inherit;
            overflow: visible;
            clip: auto;
            white-space: normal;
        }
        /* Skeleton Loading Screens for better UX */
        .skeleton {
            background: linear-gradient(90deg,
                rgba(255,255,255,0.05) 25%,
                rgba(255,255,255,0.1) 50%,
                rgba(255,255,255,0.05) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        .skeleton-card {
            width: 100%;
            height: 300px;
            border-radius: 0.5rem;
        }
        .skeleton-text {
            height: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
        }
        .skeleton-title {
            height: 1.5rem;
            width: 60%;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
        }
        /* Smooth fade-in for loaded content */
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Optimized transitions */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        button, a {
            touch-action: manipulation;
        }
        /* Profile Avatar Styles */
        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }
        .profile-avatar:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(239,68,68,0.4);
        }
        .profile-avatar.active {
            border: 4px solid #ef4444;
            box-shadow: 0 0 0 4px rgba(239,68,68,0.2);
        }
        .profile-avatar.kids {
            border: 4px solid #10b981;
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
        }
        .profile-avatar.kids:hover {
            box-shadow: 0 8px 24px rgba(16,185,129,0.4);
        }
        .profile-crown {
            position: absolute;
            top: -8px;
            right: -8px;
            font-size: 1.5rem;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .profile-kids-badge {
            position: absolute;
            bottom: -4px;
            right: -4px;
            background: #10b981;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            border: 2px solid #000;
        }
        .avatar-color-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .avatar-color-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .avatar-color-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .avatar-color-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .avatar-color-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .avatar-color-6 { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        .avatar-color-7 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .avatar-color-8 { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); }
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
    <!-- Google Cast SDK (sender) va HLS qo'llab-quvvatlovi -->
    <!--
      Google tomonidan tavsiya etilgan Cast Web Sender SDK skript manzili.
      Oldingi manzil (https://www.gstatic.com/cast/sdk/libs/cast_sender.js) ayrim brauzerlarda 404 qaytarar edi,
      shuning uchun uni quyidagi rasmiy kutilgan URLga almashtirdik. "loadCastFramework=1" parametri
      Cast Framework API ni yuklashni ta'minlaydi.
    -->
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <!-- HLS.js kutubxonasi avtomatik sifat uchun -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
    <script>
        window.SOUNDORA_CAST_APP_ID = '2433D30A';
    </script>
    <script>
        // Register service worker to enable offline capabilities and caching
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.error('Service Worker registration failed:', err));
        }
    </script>
</head>
<body class="antialiased">

<div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[100] flex items-center justify-center">
    <i class="fas fa-spinner fa-spin text-white text-4xl"></i>
</div>

<div id="app-container">
    <header class="absolute top-0 left-0 right-0 z-30 bg-gradient-to-b from-black/60 to-transparent flex-shrink-0">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between h-16">
                <a id="home-link-header" href="#" class="text-xl font-bold text-white tracking-wider">SN<span class="text-red-500">D</span></a>
                <div class="flex items-center space-x-4">
                    <!-- Til filtri uchun tugma va ochiluvchi ro'yxat -->
                    <div id="language-button-wrapper-header" class="relative">
                        <button id="language-button-header" class="px-3 py-1 border border-red-500 text-red-500 rounded-md text-sm font-bold"></button>
                        <div id="language-dropdown" class="absolute right-0 mt-2 bg-gray-800 border border-gray-700 rounded-md shadow-lg hidden z-50">
                            <ul id="language-dropdown-list" class="py-2"></ul>
                        </div>
                    </div>
                    <div id="notification-button-wrapper-header" class="relative">
                        <button id="notification-button-header" class="text-gray-300 hover:text-red-500 transition duration-300"><i class="fas fa-bell text-lg"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="notification-panel" class="hidden fixed bg-gray-800 rounded-lg shadow-2xl z-50 border border-gray-700 flex flex-col" style="top: 1rem; right: 1rem; width: 90vw; max-width: 420px;"></div>
    <div id="support-sms-toast" class="hidden" role="alert" aria-live="assertive">
        <button id="support-sms-toast-btn" type="button">
            <span class="support-sms-pill" data-lang-key="support"></span>
            <span id="support-sms-toast-text" class="support-sms-text"></span>
        </button>
    </div>

    <main>
        <div id="main"></div>
        <div id="movie-details" class="hidden"></div>
        <div id="favorites" class="hidden"></div>
        <!-- Container for downloads page; added so navigation to 'downloads' works -->
        <div id="downloads" class="hidden"></div>
        <div id="genre-survey" class="hidden"></div>
        <div id="support" class="hidden"></div>
        <div id="profile" class="hidden"></div>
        <div id="guest-profile" class="hidden"></div>
        <div id="login" class="hidden"></div>
        <div id="register" class="hidden"></div>
        <div id="settings" class="hidden"></div>
        <div id="edit-profile" class="hidden"></div>
        <div id="language-settings" class="hidden"></div>
        <div id="content-settings" class="hidden"></div>
        <div id="playback-settings" class="hidden"></div>
        <div id="privacy-policy" class="hidden"></div>
        <div id="faq" class="hidden"></div>
        <div id="premium" class="hidden"></div>
    </main>

    <!-- Modal for showing video download progress -->
    <div id="download-progress-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-75 z-50">
        <div class="bg-gray-800 p-4 rounded-lg w-80 text-center">
            <h3 class="text-lg font-bold mb-3" data-lang-key="downloading">Downloading...</h3>
            <div class="w-full h-4 bg-gray-600 rounded overflow-hidden">
                <div id="download-progress-bar" class="h-full bg-red-500" style="width: 0%;"></div>
            </div>
            <div id="download-progress-text" class="mt-2 text-gray-300 text-sm">0 MB / 0 MB</div>
        </div>
    </div>

    <!-- Offline and Online banners -->
    <div id="offline-banner" class="hidden fixed top-0 left-0 right-0 bg-yellow-500 text-black p-3 z-50 flex justify-between items-center">
        <span data-lang-key="offlineMode">You are offline</span>
        <button id="offline-ok-btn" class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white px-3 py-1 rounded-md">OK</button>
    </div>
    <div id="online-banner" class="hidden fixed top-0 left-0 right-0 bg-green-500 text-black p-3 z-50 flex justify-between items-center">
        <span data-lang-key="onlineMode">You are online</span>
        <button id="online-ok-btn" class="bg-black bg-opacity-50 hover:bg-opacity-70 text-white px-3 py-1 rounded-md">OK</button>
    </div>

    <!-- Bottom navigation redesigned: removed search, added support and no text labels on icons -->
    <nav class="bg-gray-900/95 backdrop-blur-md border-t border-gray-800/50 shadow-lg" role="navigation" aria-label="Bottom navigation">
        <div class="flex justify-around items-center h-full px-1">
            <!-- Home link -->
            <a id="home-link-bottom" href="#" class="bottom-nav-link flex items-center justify-center text-gray-400 hover:text-red-500 transition-all duration-200 py-2 px-3 rounded-lg hover:bg-gray-800/50" title="Home" aria-label="Home">
                <i class="fas fa-home text-xl"></i>
            </a>
            <!-- Favorites link -->
            <a id="favorites-link-bottom" href="#" class="bottom-nav-link flex items-center justify-center text-gray-400 hover:text-red-500 transition-all duration-200 py-2 px-3 rounded-lg hover:bg-gray-800/50" title="Favorites" aria-label="Favorites">
                <i class="fas fa-heart text-xl"></i>
            </a>
            <!-- Support/Chat link: opens support chat page -->
            <a id="support-link-bottom" href="#" class="bottom-nav-link flex items-center justify-center text-gray-400 hover:text-red-500 transition-all duration-200 py-2 px-3 rounded-lg hover:bg-gray-800/50" title="Support" aria-label="Support">
                <i class="fas fa-headset text-xl"></i>
            </a>
            <!-- Profile link with avatar and name -->
            <a id="profile-link-bottom" href="#" class="bottom-nav-link flex items-center justify-center text-gray-400 hover:text-red-500 transition-all duration-200 py-2 px-3 rounded-lg hover:bg-gray-800/50 relative" title="Profile" aria-label="Profile">
                <div id="bottom-nav-avatar" class="w-8 h-8 rounded-full bg-gradient-to-br from-red-500 to-pink-600 flex items-center justify-center text-white font-bold ring-2 ring-transparent hover:ring-red-500 transition-all duration-200">
                    <i class="fas fa-user text-sm"></i>
                </div>
                <!-- Premium badge -->
                <span id="bottom-nav-premium-badge" class="hidden absolute -top-0.5 -right-0.5 bg-gradient-to-r from-yellow-400 to-yellow-600 text-black text-[7px] font-bold px-1 rounded-full">
                    👑
                </span>
            </a>
        </div>
    </nav>
</div>

<!-- Player container -->
<div id="player" class="hidden"></div>

<div id="modal-overlay" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[70] flex items-center justify-center p-4"></div>
<div id="mini-player-container" class="hidden fixed bottom-20 md:bottom-4 right-4 w-64 h-36 bg-gray-900 rounded-lg shadow-2xl overflow-hidden z-40"></div>
<div id="toast-notification" class="toast-notification hidden fixed bottom-20 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transform translate-y-4"></div>

<!-- Profile Long Press Menu Modal -->
<div id="profile-menu-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[80] flex items-end justify-center" style="pointer-events: auto;">
    <div class="bg-[#262626] rounded-t-3xl w-full max-w-md transform translate-y-full transition-transform duration-300" id="profile-menu-content" style="pointer-events: auto;">
        <!-- Handle bar -->
        <div class="pt-3 pb-2">
            <div class="w-10 h-1 bg-gray-600 rounded-full mx-auto"></div>
        </div>

        <!-- Header -->
        <div class="px-4 pb-3 border-b border-gray-700">
            <div class="flex items-center justify-between">
                <h3 class="text-white text-base font-semibold">sultanmusic</h3>
                <button id="close-profile-menu-btn" class="text-gray-400 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Current Account (Active) -->
        <div class="px-4 py-3 border-b border-gray-700">
            <div class="flex items-center gap-3">
                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                    <span class="text-white text-xl font-bold">S</span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <span class="text-white font-semibold text-base">sultanmusic</span>
                        <i class="fas fa-check-circle text-blue-500 text-sm"></i>
                    </div>
                    <span class="text-gray-400 text-sm">Active now</span>
                </div>
            </div>
        </div>

        <!-- Other Accounts List -->
        <div id="accounts-list" class="max-h-60 overflow-y-auto">
            <!-- Accounts will be added dynamically -->
        </div>

        <!-- Add Account Button -->
        <div class="px-4 py-3 border-t border-gray-700">
            <button id="add-account-btn" class="w-full flex items-center gap-3 py-3 px-2 hover:bg-gray-800/50 rounded-lg transition-colors">
                <div class="w-14 h-14 rounded-full border-2 border-dashed border-gray-600 flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-plus text-gray-400 text-xl"></i>
                </div>
                <span class="text-white font-medium text-base">Add account SND</span>
            </button>
        </div>

        <!-- Footer - SND branding -->
        <div class="px-4 py-4 flex items-center justify-center gap-2 border-t border-gray-700">
            <span class="text-gray-500 text-xs font-semibold tracking-wide">SND</span>
        </div>
    </div>
</div>

<!-- Connected Devices Modal -->
<div id="devices-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-[90] flex items-center justify-center p-4">
    <div class="bg-[#1a1a1a] rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="px-6 py-4 border-b border-gray-800 flex items-center justify-between">
            <h2 class="text-xl font-bold text-white">Connected Devices</h2>
            <button id="close-devices-modal" class="text-gray-400 hover:text-white transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Tabs -->
        <div class="px-6 py-3 border-b border-gray-800 flex gap-4">
            <button id="devices-tab" class="devices-tab-btn active px-4 py-2 rounded-lg text-sm font-medium transition-all">
                <i class="fas fa-mobile-alt mr-2"></i>
                Devices
            </button>
            <button id="qr-tab" class="devices-tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all">
                <i class="fas fa-qrcode mr-2"></i>
                Add Device
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-y-auto p-6">
            <!-- Devices List Tab -->
            <div id="devices-content" class="devices-tab-content">
                <div class="mb-4 flex items-center justify-between">
                    <p class="text-gray-400 text-sm">Manage devices that have access to your account</p>
                    <button id="scan-qr-btn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                        <i class="fas fa-camera mr-2"></i>
                        Scan QR
                    </button>
                </div>

                <!-- Current Device -->
                <div class="mb-6">
                    <h3 class="text-white font-semibold mb-3">Current Device</h3>
                    <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-red-500 to-pink-600 flex items-center justify-center">
                                <i class="fas fa-mobile-alt text-white text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <h4 id="current-device-name" class="text-white font-medium">This Device</h4>
                                <p id="current-device-info" class="text-gray-400 text-sm">Browser • Active now</p>
                            </div>
                            <span class="bg-green-500/20 text-green-400 text-xs px-3 py-1 rounded-full font-medium">
                                Active
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Other Devices -->
                <div>
                    <h3 class="text-white font-semibold mb-3">Other Devices</h3>
                    <div id="other-devices-list" class="space-y-3">
                        <!-- Devices will be added here dynamically -->
                    </div>
                    <div id="no-devices-message" class="text-center py-8 text-gray-500">
                        <i class="fas fa-mobile-alt text-4xl mb-3"></i>
                        <p>No other devices connected</p>
                    </div>
                </div>
            </div>

            <!-- QR Code Tab -->
            <div id="qr-content" class="devices-tab-content hidden">
                <div class="text-center">
                    <h3 class="text-white text-lg font-semibold mb-2">Add New Device</h3>
                    <p class="text-gray-400 text-sm mb-6">Scan this QR code from your new device</p>

                    <!-- QR Code Container -->
                    <div class="bg-white rounded-xl p-6 inline-block mb-4">
                        <div id="qr-code-container" class="w-64 h-64 flex items-center justify-center">
                            <!-- QR code will be generated here -->
                        </div>
                    </div>

                    <!-- Timer -->
                    <div class="mb-6">
                        <p id="qr-timer" class="text-yellow-400 text-sm font-semibold">Expires in 59s</p>
                    </div>

                    <div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700 text-left">
                        <h4 class="text-white font-medium mb-2 flex items-center gap-2">
                            <i class="fas fa-info-circle text-blue-500"></i>
                            How to use:
                        </h4>
                        <ol class="text-gray-400 text-sm space-y-2 pl-4">
                            <li>1. Open the app on your new device</li>
                            <li>2. Go to Profile → Connected Devices</li>
                            <li>3. Tap "Scan QR" button</li>
                            <li>4. Scan this QR code</li>
                            <li>5. Approve the request on this device</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal for Login -->
<div id="qr-scanner-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
    <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-md w-full border border-gray-800">
        <div class="flex items-center justify-between p-6 border-b border-gray-800">
            <h3 class="text-xl font-bold text-white" data-lang-key="scanQR">Scan QR Code</h3>
            <button id="close-qr-scanner" class="text-gray-400 hover:text-white text-3xl leading-none transition-colors">×</button>
        </div>

        <div class="p-6">
            <p class="text-sm text-gray-400 mb-4 text-center" data-lang-key="scanInstruction">Scan the QR code on your device to sign in</p>

            <!-- QR Reader Container -->
            <div id="qr-reader" class="w-full aspect-square bg-black rounded-lg overflow-hidden"></div>

            <p id="qr-scan-status" class="text-sm text-center mt-4 text-gray-400"></p>
        </div>
    </div>
</div>

<!-- New Notification Popup (Top Center, 5 seconds) -->
<div id="notification-popup" class="hidden fixed top-20 left-1/2 -translate-x-1/2 z-[90] w-11/12 max-w-md">
    <div class="bg-gradient-to-r from-purple-600/95 to-pink-600/95 backdrop-blur-md rounded-xl shadow-2xl p-4 transform -translate-y-4 opacity-0 transition-all duration-500" id="popup-content">
        <div class="flex items-start gap-3">
            <div class="flex-shrink-0 w-16 h-24 rounded-lg overflow-hidden bg-gray-800" id="popup-poster-container">
                <img id="popup-poster" class="w-full h-full object-cover" />
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                    <i id="popup-icon" class="fas fa-bell text-white"></i>
                    <span id="popup-label" class="text-xs font-semibold text-white/80 uppercase tracking-wide">New Notification</span>
                </div>
                <h4 id="popup-title" class="text-white font-bold text-sm mb-1 line-clamp-2"></h4>
                <p id="popup-desc" class="text-white/90 text-xs line-clamp-2"></p>
            </div>
            <button id="popup-close" class="flex-shrink-0 text-white/70 hover:text-white transition">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
</div>

<script type="module">
    // Firebase SDK'larini import qilish
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        signOut,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        GoogleAuthProvider,
        signInWithPopup,
        updatePassword,
        EmailAuthProvider,
        reauthenticateWithCredential,
        RecaptchaVerifier, // Telefon raqami uchun qo'shildi
        signInWithPhoneNumber // Telefon raqami uchun qo'shildi
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, onSnapshot, doc, setDoc, getDoc, updateDoc, query, where, getDocs, addDoc, serverTimestamp, arrayUnion, arrayRemove, runTransaction, enableIndexedDbPersistence, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getMessaging, getToken, onMessage, isSupported } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

    // Firebase konfiguratsiyasi
    const firebaseConfig = {
        apiKey: "AIzaSyBeYmiy_FX22I4--UnNTRxjWiAh--sX9Ug",
        authDomain: "soundora-music.firebaseapp.com",
        projectId: "soundora-music",
        storageBucket: "soundora-music.appspot.com",
        messagingSenderId: "92363153683",
        appId: "1:92363153683:web:16feda8fb9607d8da97ae6",
        measurementId: "G-KP08NSCRD6"
    };

    // Firebase ilovasini ishga tushirish
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
// Enable offline persistence so cached data renders instantly
try { enableIndexedDbPersistence(db); } catch (e) { console.warn('IndexedDB persistence disabled or failed:', e?.code || e); }
    const auth = getAuth(app);
    let regionRestrictionCache = null;
    let regionRestrictionPromise = null;

    // Track which top navigation section is currently selected.  Default to
    // 'home'.  When the user clicks Series, Movies, SND, Sports or
    // Challenges, this variable will be updated and the movie list will be
    // filtered accordingly.
    let selectedSection = 'home';
    let topNavHandlerAttached = false; // Flag to prevent duplicate listeners
    const SPORTS_CATEGORIES = [
        { id: 'all', label: 'All Sports', icon: 'fas fa-layer-group', keywords: [] },
        { id: 'football', label: 'Football', icon: 'fas fa-futbol', keywords: ['football', 'soccer', 'futbol'] },
        { id: 'basketball', label: 'Basketball', icon: 'fas fa-basketball-ball', keywords: ['basketball', 'nba'] },
        { id: 'volleyball', label: 'Volleyball', icon: 'fas fa-volleyball-ball', keywords: ['volleyball'] },
        { id: 'mma', label: 'MMA & Boxing', icon: 'fas fa-hand-fist', keywords: ['mma', 'boxing', 'ufc', 'fight'] },
        { id: 'motorsport', label: 'Motorsport', icon: 'fas fa-flag-checkered', keywords: ['motorsport', 'racing', 'formula', 'f1'] }
    ];
    const PRIMARY_CATEGORY_LABELS = {
        general: 'Movies & Series',
        sports: 'Sports',
        snd: 'SND Originals',
        challenge: 'Challenges'
    };
    let selectedSportsCategory = 'all';

    /**
     * Region restriction check. Reads the region restriction configuration from
     * Firestore (document 'config/regionRestrictions'). If the document does
     * not exist, by default all regions are considered blocked. The user's
     * selected region is read from localStorage ('soundora-region'). If the
     * region is blocked, the entire page content is replaced with a message
     * indicating the service is unavailable and shows an HTTP-like code 444.
     * Returns true if blocked, false otherwise.
     */
    async function checkRegionRestriction(force = false) {
        if (!force) {
            if (regionRestrictionCache !== null) return regionRestrictionCache;
            if (regionRestrictionPromise) return regionRestrictionPromise;
        }
        regionRestrictionPromise = (async () => {
            try {
                const region = localStorage.getItem('soundora-region') || 'kz';
                const cfgRef = doc(db, 'config', 'regionRestrictions');
                const snap = await getDoc(cfgRef);
                let blockAll = true;
                let allowedRegions = [];
                let blockedRegions = [];
                let msg;
                let code;
                if (snap.exists()) {
                    const data = snap.data() || {};
                    blockAll = data.blockAll !== undefined ? data.blockAll : false;
                    allowedRegions = Array.isArray(data.allowedRegions) ? data.allowedRegions : [];
                    blockedRegions = Array.isArray(data.blockedRegions) ? data.blockedRegions : [];
                    msg = data.message;
                    code = data.code;
                }
                if (!code) code = '444';
                if (!msg) msg = translations[currentLanguage]?.regionBlockedMessage || 'This service is not available in your region.';
                let isBlocked;
                if (blockAll) {
                    isBlocked = !allowedRegions.includes(region);
                } else {
                    isBlocked = blockedRegions.includes(region);
                }
                if (isBlocked) {
                    const blockHtml = `
                        <div style="display:flex;flex-direction:column;justify-content:center;align-items:center;min-height:100vh;background-color:#0a0a0a;color:#f3f4f6;padding:2rem;text-align:center;">
                            <h1 style="font-size:4rem;font-weight:bold;margin-bottom:1rem;">${code}</h1>
                            <p style="font-size:1.25rem;max-width:600px;">${msg}</p>
                        </div>`;
                    document.body.innerHTML = blockHtml;
                    return true;
                }
            } catch (error) {
                console.error('Failed to check region restrictions', error);
            }
            return false;
        })();
        try {
            regionRestrictionCache = await regionRestrictionPromise;
        } finally {
            regionRestrictionPromise = null;
        }
        return regionRestrictionCache;
    }

// ==================== PROFESSIONAL ENHANCEMENTS ====================
// Global error handler for better user experience
window.addEventListener('error', (event) => {
    console.error('Global error:', event.error);
    // Prevent page crash on script errors
    if (event.error && event.error.message) {
        const errorMsg = event.error.message.toLowerCase();
        // Ignore common non-critical errors
        if (errorMsg.includes('resizeobserver') || errorMsg.includes('script error')) {
            event.preventDefault();
            return true;
        }
    }
});

// Unhandled promise rejection handler
window.addEventListener('unhandledrejection', (event) => {
    console.error('Unhandled promise rejection:', event.reason);
    event.preventDefault(); // Prevent console spam
});

// Performance monitoring (optional - for debugging)
if ('PerformanceObserver' in window) {
    try {
        const perfObserver = new PerformanceObserver((list) => {
            for (const entry of list.getEntries()) {
                // Log slow resources (>1s load time)
                if (entry.duration > 1000) {
                    console.warn(`Slow resource: ${entry.name} took ${entry.duration.toFixed(0)}ms`);
                }
            }
        });
        perfObserver.observe({ entryTypes: ['resource', 'navigation'] });
    } catch (e) {
        // Performance API not fully supported
    }
}

// Accessibility: Skip to content link for screen readers
(function addA11yEnhancements() {
    const skipLink = document.createElement('a');
    skipLink.href = '#main';
    skipLink.textContent = 'Skip to main content';
    skipLink.className = 'sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:bg-red-600 focus:text-white focus:px-4 focus:py-2 focus:rounded';
    skipLink.style.position = 'absolute';
    skipLink.style.left = '-9999px';
    skipLink.addEventListener('focus', function() {
        this.style.left = '1rem';
        this.style.top = '1rem';
        this.style.zIndex = '9999';
    });
    skipLink.addEventListener('blur', function() {
        this.style.left = '-9999px';
    });
    document.body.insertBefore(skipLink, document.body.firstChild);
})();

// Image lazy loading optimization
document.addEventListener('DOMContentLoaded', () => {
    // Add loading="lazy" to all images that don't have it
    setTimeout(() => {
        document.querySelectorAll('img:not([loading])').forEach(img => {
            img.setAttribute('loading', 'lazy');
        });
    }, 1000);
});

// ==================== SECURITY & PERFORMANCE ENHANCEMENTS ====================
// Production mode: Disable console logs in production
(function setupProductionMode() {
    const IS_PRODUCTION = window.location.hostname !== 'localhost' &&
                         !window.location.hostname.includes('127.0.0.1') &&
                         !window.location.hostname.includes('192.168');

    if (IS_PRODUCTION) {
        // Disable console.log in production, keep errors and warnings
        console.log = function() {};
        console.debug = function() {};
        // Keep console.warn and console.error for debugging critical issues
    }
})();

// HTML Sanitization utility - prevent XSS attacks
window.sanitizeHTML = (function() {
    const tagWhitelist = ['b', 'i', 'em', 'strong', 'span', 'p', 'br', 'div'];
    const attrWhitelist = ['class', 'id', 'style'];

    return function(html) {
        if (typeof html !== 'string') return '';

        // Remove script tags
        html = html.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');

        // Remove event handlers
        html = html.replace(/\s*on\w+\s*=\s*["'][^"']*["']/gi, '');
        html = html.replace(/\s*on\w+\s*=\s*[^\s>]*/gi, '');

        // Remove javascript: protocol
        html = html.replace(/javascript:/gi, '');

        // Remove dangerous attributes
        html = html.replace(/\s*(data-|xmlns|formaction|action)\w*\s*=\s*["'][^"']*["']/gi, '');

        return html;
    };
})();

// Input validation utility
window.validateInput = {
    email: (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email),
    phone: (phone) => /^[\d\s\-\+\(\)]{10,}$/.test(phone),
    username: (username) => /^[a-zA-Z0-9_]{3,20}$/.test(username),
    password: (password) => password && password.length >= 6,
    url: (url) => {
        try {
            new URL(url);
            return true;
        } catch {
            return false;
        }
    },
    safeString: (str) => {
        // Remove HTML tags and dangerous characters
        if (typeof str !== 'string') return '';
        return str.replace(/<[^>]*>/g, '')
                 .replace(/[<>'"]/g, '')
                 .trim();
    }
};

// Debounce utility for performance optimization
window.debounceUtil = function(func, wait = 300) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
};

// Throttle utility for scroll/resize events
window.throttleUtil = function(func, limit = 100) {
    let inThrottle;
    return function(...args) {
        if (!inThrottle) {
            func.apply(this, args);
            inThrottle = true;
            setTimeout(() => inThrottle = false, limit);
        }
    };
};

// Local Storage wrapper with error handling and quota management
window.safeStorage = {
    set: (key, value, expiryDays = null) => {
        try {
            const item = {
                value: value,
                timestamp: Date.now(),
                expiry: expiryDays ? Date.now() + (expiryDays * 24 * 60 * 60 * 1000) : null
            };
            localStorage.setItem(key, JSON.stringify(item));
            return true;
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                console.warn('LocalStorage quota exceeded. Clearing old data...');
                // Clear expired items
                Object.keys(localStorage).forEach(k => {
                    try {
                        const stored = JSON.parse(localStorage.getItem(k));
                        if (stored && stored.expiry && stored.expiry < Date.now()) {
                            localStorage.removeItem(k);
                        }
                    } catch {}
                });
                // Try again
                try {
                    localStorage.setItem(key, JSON.stringify(item));
                    return true;
                } catch {
                    return false;
                }
            }
            console.error('Failed to save to localStorage:', e);
            return false;
        }
    },
    get: (key) => {
        try {
            const item = localStorage.getItem(key);
            if (!item) return null;

            const parsed = JSON.parse(item);

            // Check if item has expired
            if (parsed.expiry && parsed.expiry < Date.now()) {
                localStorage.removeItem(key);
                return null;
            }

            return parsed.value;
        } catch (e) {
            console.error('Failed to read from localStorage:', e);
            return null;
        }
    },
    remove: (key) => {
        try {
            localStorage.removeItem(key);
            return true;
        } catch (e) {
            console.error('Failed to remove from localStorage:', e);
            return false;
        }
    },
    clear: () => {
        try {
            localStorage.clear();
            return true;
        } catch (e) {
            console.error('Failed to clear localStorage:', e);
            return false;
        }
    }
};

// Network status monitoring
(function setupNetworkMonitoring() {
    let wasOffline = !navigator.onLine;

    window.addEventListener('online', () => {
        if (wasOffline) {
            console.log('Connection restored');
            // Notify user
            if (typeof showToast === 'function') {
                setTimeout(() => {
                    const msg = window.translations?.[window.currentLanguage]?.onlineMode || 'You are online';
                    showToast(msg);
                }, 500);
            }
        }
        wasOffline = false;
    });

    window.addEventListener('offline', () => {
        console.warn('Connection lost');
        // Notify user
        if (typeof showToast === 'function') {
            const msg = window.translations?.[window.currentLanguage]?.offlineMode || 'You are offline';
            showToast(msg);
        }
        wasOffline = true;
    });
})();

// Memory leak prevention - cleanup event listeners on page unload
window.addEventListener('beforeunload', () => {
    // Pause all videos
    document.querySelectorAll('video').forEach(video => {
        try {
            video.pause();
            video.src = '';
            video.load();
        } catch (e) {}
    });
});
// ==================== END SECURITY & PERFORMANCE ENHANCEMENTS ====================

document.addEventListener('DOMContentLoaded', async () => {
    // Increase the application version to force service worker cache refresh
    const APP_VERSION = '1.0.1';
    window.pageLoadTimestamp = Date.now(); // Sahifa yuklanish vaqti
    let movies = [];
    let currentUser = null;
    let notifications = [];
    let isAccountSwitchInProgress = false;
    let isInitialAuthCheckDone = false; // Global flag to track if first auth check completed

    // Auto-cleanup expired notifications every 5 minutes
    setInterval(() => {
        const now = Date.now();
        const beforeCount = notifications.length;
        notifications = notifications.filter(n => {
            if (!n.expiresAt) return true; // Keep permanent notifications
            const expiryTime = new Date(n.expiresAt).getTime();
            return now <= expiryTime; // Keep only non-expired
        });

        if (notifications.length !== beforeCount) {
            persistNotifications();
            updateNotificationDot();
            if (isNotificationPanelOpen) {
                renderNotificationPanel();
            }
        }
    }, 300000); // 5 minutes

    // ==================== MULTI-PROFILE SYSTEM ====================
    let currentProfile = null;
    let userProfiles = [];
    const AVATAR_COLORS = ['avatar-color-1', 'avatar-color-2', 'avatar-color-3', 'avatar-color-4', 'avatar-color-5', 'avatar-color-6', 'avatar-color-7', 'avatar-color-8'];

    function loadProfiles() {
        try {
            const stored = localStorage.getItem('soundora-profiles');
            userProfiles = stored ? JSON.parse(stored) : [];
            return userProfiles;
        } catch (e) {
            console.error('Failed to load profiles:', e);
            return [];
        }
    }

    function saveProfiles() {
        try {
            localStorage.setItem('soundora-profiles', JSON.stringify(userProfiles));
            return true;
        } catch (e) {
            console.error('Failed to save profiles:', e);
            return false;
        }
    }

    function getCurrentProfile() {
        try {
            const profileId = localStorage.getItem('soundora-active-profile');
            if (profileId) {
                return userProfiles.find(p => p.id === profileId) || null;
            }
        } catch (e) {}
        return null;
    }

    function setActiveProfile(profileId) {
        try {
            localStorage.setItem('soundora-active-profile', profileId);
            currentProfile = userProfiles.find(p => p.id === profileId) || null;
            if (currentProfile) {
                currentProfile.lastUsed = Date.now();
                saveProfiles();
                window.currentProfileFilter = currentProfile.isKids ? 'kids' : 'all';
            }
            return true;
        } catch (e) {
            return false;
        }
    }

    function createProfile(name, isKids = false, avatarColor = null) {
        const newProfile = {
            id: 'profile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
            name: name || (isKids ? (translations[currentLanguage]?.kidsProfileName || 'Kids') : 'User'),
            isKids: isKids,
            avatarColor: avatarColor || AVATAR_COLORS[userProfiles.length % AVATAR_COLORS.length],
            createdAt: Date.now(),
            lastUsed: Date.now()
        };
        userProfiles.push(newProfile);
        saveProfiles();
        return newProfile;
    }

    function deleteProfile(profileId) {
        const index = userProfiles.findIndex(p => p.id === profileId);
        if (index > -1) {
            userProfiles.splice(index, 1);
            saveProfiles();
            if (currentProfile?.id === profileId) {
                if (userProfiles.length > 0) {
                    setActiveProfile(userProfiles[0].id);
                } else {
                    currentProfile = null;
                    localStorage.removeItem('soundora-active-profile');
                }
            }
            return true;
        }
        return false;
    }

    function filterMoviesForProfile(moviesList) {
        if (!currentProfile || !currentProfile.isKids) return moviesList;
        const kidsGenres = ['Animation', 'Family', 'Анимация', 'Семейный', 'Animatsiya', 'Oila uchun'];
        return moviesList.filter(movie => {
            if (movie.is18Plus) return false;
            const movieGenres = Array.isArray(movie.genre) ? movie.genre : (typeof movie.genre === 'string' ? movie.genre.split(',').map(g => g.trim()) : []);
            return movieGenres.some(g => kidsGenres.includes(g));
        });
    }

    loadProfiles();
    if (userProfiles.length === 0) {
        const defaultProfile = createProfile('Main', false);
        setActiveProfile(defaultProfile.id);
    } else {
        currentProfile = getCurrentProfile();
        if (!currentProfile && userProfiles.length > 0) {
            setActiveProfile(userProfiles[0].id);
        }
    }
    window.currentProfileFilter = currentProfile?.isKids ? 'kids' : 'all';
    // ==================== END MULTI-PROFILE SYSTEM ====================

    let supportChatUnsub = null;
    let activeSupportChatId = null;
    let lastSupportMessageKey = null;
    let supportToastTimeoutId = null;
    let supportChatPrimed = false;
    let adminAlertsUnsub = null;
    let adminMessagesUnsub = null;
    const SUPPORT_TOAST_DURATION = 3000;
    const SUPPORT_CHAT_LAST_KEY_PREFIX = 'soundora-support-lastKey-';
    const debugMode = true; // Debugging uchun - test rejimida

    const setMovies = (list) => {
        movies = Array.isArray(list) ? list : [];
        try {
            window.movies = movies;
            window.sndMovies = movies;
        } catch (_) {}
        return movies;
    };

    setMovies([]);

    // Render instantly from local caches while Firestore connects
    try { hydrateFromCache(); } catch (_) {}

    // Region restriction check: if blocked, display message and abort further initialisation
    if (await checkRegionRestriction()) {
        return;
    }
    // On page load, restore only NON-ADMIN notifications from localStorage.
    // Admin messages will be loaded from Firebase in real-time via subscribeToAdminMessages().
    // This prevents showing deleted admin notifications that are still in localStorage.
    try {
        const storedNotifications = JSON.parse(localStorage.getItem('soundora-notifications') || '[]');
        if (Array.isArray(storedNotifications)) {
            // Filter out ALL admin-originated messages – both new ('adminMsg_') and legacy ('admin_').
            // These will be loaded fresh from Firebase via the real-time subscriptions.
            notifications = storedNotifications.filter(n => !n.id || (!n.id.startsWith('adminMsg_') && !n.id.startsWith('admin_')));
            console.log('📂 Loaded', notifications.length, 'non-admin notifications from localStorage');
        }
    } catch (_) {
        notifications = [];
    }
    // Immediately reflect any unread notifications in the header bell when the
    // page first loads.  This ensures that if the user previously had pending
    // notifications, the red dot is visible without requiring a refresh.
    try {
        updateNotificationDot();
    } catch (_) {}
    let isPlayerLocked = false;
    // Til bo'yicha filtr. 'all' tanlovi barcha tillarga mos filmlarni ko'rsatadi. Foydalanuvchining tanlagan tilini ushbu o'zgaruvchida saqlaymiz.
    let selectedLangFilter = 'all';
    // Mavjud til kodlari ro'yxati. Ushbu ro'yxat katalogda til bo'yicha filtr tugmalarini yaratishda ishlatiladi.
    const LANGUAGE_FILTERS = ['all', 'uz', 'tj', 'kz', 'kg', 'ru', 'en'];

    // ---- Ultra-fast UI hydrate from local caches ----
    function hydrateFromCache() {
        try {
            const lastUid = localStorage.getItem('soundora-lastUid');
            if (lastUid) {
                const uCache = localStorage.getItem('soundora-user-cache-' + lastUid);
                if (uCache) {
                    try { currentUser = JSON.parse(uCache); } catch (_) {}
                }
            }
        } catch (_){}
        try {
            const mCache = localStorage.getItem('soundora-movies-cache');
            if (mCache) {
                try {
                    setMovies(JSON.parse(mCache) || []);
                } catch (_) {
                    setMovies([]);
                }
            } else {
                setMovies([]);
            }
        } catch (_) {
            setMovies([]);
        }
        // If nothing in history yet, render a basic shell
        try {
            const state = history.state || { page: 'main' };
            renderPage(state);
        } catch (_){}
    }


    /**
     * Til tanlash tugmasi matnini yangilaydi. 'all' bo'lsa, "All" deb ko'rsatiladi,
     * aks holda til kodi katta harflarda yoziladi.
     */
    function renderLanguageButton() {
        const btn = document.getElementById('language-button-header');
        if (!btn) return;
        const label = selectedLangFilter === 'all' ? 'All' : selectedLangFilter.toUpperCase();
        btn.textContent = label;
    }

    /**
     * Ochiluvchi til ro'yxatini quradi. Har bir til uchun tugma yaratib, bosilganda ushbu
     * tilni tanlaydi va filmlar ro'yxatini qayta filtrlaydi. Tanlangan til foydalanuvchi
     * hisobida saqlanadi yoki guest uchun localStorage'ga yoziladi.
     */
    function buildLanguageDropdown() {
        const list = document.getElementById('language-dropdown-list');
        if (!list) return;
        list.innerHTML = '';
        LANGUAGE_FILTERS.forEach((lang) => {
            const li = document.createElement('li');
            li.className = 'px-4 py-2 hover:bg-gray-700 cursor-pointer text-sm';
            const label = lang === 'all' ? 'All' : lang.toUpperCase();
            li.textContent = label;
            li.dataset.langValue = lang;
            // Faol tilni ta'kidlash
            if (selectedLangFilter === lang) {
                li.classList.add('bg-gray-700', 'text-red-400');
            }
            li.addEventListener('click', async (e) => {
                const newLang = e.currentTarget.dataset.langValue;
                if (newLang === selectedLangFilter) {
                    hideLanguageDropdown();
                    return;
                }
                selectedLangFilter = newLang;
                // Tanlangan tilni saqlash: foydalanuvchi login bo'lsa Firestorega, aks holda localStorage'ga
                try {
                    if (currentUser && currentUser.uid) {
                        await updateDoc(doc(db, 'users', currentUser.uid), { preferredMovieLang: selectedLangFilter });
                    } else {
                        localStorage.setItem('soundora-preferredMovieLang', selectedLangFilter);
                    }
                } catch (err) {
                    console.error('Error saving preferred movie language', err);
                }
                // Til tugmasi va dropdownni yangilash. buildLanguageDropdown chaqirilishi yangi holatni aks ettirish uchun kerak.
                renderLanguageButton();
                buildLanguageDropdown();
                hideLanguageDropdown();
                // Joriy kategoriya bo'yicha filmlarni qayta filtrla
                const activeCategoryButton = document.querySelector('#category-nav .category-btn.active');
                const currentCategory = activeCategoryButton ? activeCategoryButton.dataset.categoryValue : 'categoryAll';
                filterAndDisplayMovies(currentCategory);
            });
            list.appendChild(li);
        });
    }

    /**
     * Dropdownni toggl qilish uchun yordamchi funksiyasi. Hidden classni ochib/yopadi.
     */
    function toggleLanguageDropdown() {
        const dropdown = document.getElementById('language-dropdown');
        if (!dropdown) return;
        dropdown.classList.toggle('hidden');
    }

    /**
     * Dropdownni yopadi. Hidden classni qo'llaydi.
     */
    function hideLanguageDropdown() {
        const dropdown = document.getElementById('language-dropdown');
        if (!dropdown) return;
        dropdown.classList.add('hidden');
    }

    /**
     * Til filtri tugmasini va dropdownni dastlabki holatda sozlaydi. LocalStorage yoki user hujjatidan
     * saqlangan tilni yuklab, tugmani yangilaydi va dropdown ro'yxatini quradi. Tugmani bosishda
     * dropdown ochiladi; sahifaga tashqaridan bosilganda esa yopiladi.
     */
    function initLanguageFilter() {
        // Guest foydalanuvchi uchun mahalliy saqlangan tilni o'qish
        try {
            if (!currentUser) {
                const stored = localStorage.getItem('soundora-preferredMovieLang');
                if (stored) {
                    selectedLangFilter = stored;
                }
            }
        } catch (err) {
            console.error('Error reading preferred movie language from localStorage', err);
        }
        renderLanguageButton();
        buildLanguageDropdown();
        const langBtn = document.getElementById('language-button-header');
        if (langBtn) {
            langBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleLanguageDropdown();
            });
        }
        // Tashqi kliklar dropdownni yopishi uchun global listener
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('language-dropdown');
            const wrapper = document.getElementById('language-button-wrapper-header');
            if (!dropdown || !wrapper) return;
            if (!dropdown.contains(e.target) && !wrapper.contains(e.target)) {
                hideLanguageDropdown();
            }
        });
    }
    // Telefon raqami orqali kirish uchun global o'zgaruvchilar
    window.recaptchaVerifier = null;
    window.confirmationResult = null;

    // Google Cast konteksti sozlanadi. Agar cast framework yuklangan bo'lsa, qabul qiluvchi ilova identifikatori
    // SOUNDORA_CAST_APP_ID o'zgaruvchisidan olinadi. autoJoinPolicy bilan Chrome cast sessiyalarni boshqarish
    // va to'g'ri context sozlanadi.
    try {
        if (window.cast && cast.framework && typeof cast.framework.CastContext === 'function') {
            const castContext = cast.framework.CastContext.getInstance();
            castContext.setOptions({
                receiverApplicationId: window.SOUNDORA_CAST_APP_ID || '2433D30A',
                autoJoinPolicy: window.chrome && chrome.cast && chrome.cast.AutoJoinPolicy ? chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED : undefined
            });
        }
    } catch (err) {
        console.error('Cast context initialization failed', err);
    }

    // Davlatlar ro'yxati (nomi, bayrog'i va kodi)
    const countries = [
        { name: "Uzbekistan", code: "+998", flag: "рџ‡єрџ‡ї" },
        { name: "Russia", code: "+7", flag: "рџ‡·рџ‡є" },
        { name: "Kazakhstan", code: "+7", flag: "рџ‡°рџ‡ї" },
        { name: "Tajikistan", code: "+992", flag: "рџ‡№рџ‡Ї" },
        { name: "Kyrgyzstan", code: "+996", flag: "рџ‡°рџ‡¬" },
        { name: "Turkey", code: "+90", flag: "рџ‡№рџ‡·" },
        { name: "USA", code: "+1", flag: "рџ‡єрџ‡ё" },
        { name: "Germany", code: "+49", flag: "рџ‡©рџ‡Є" },
        { name: "South Korea", code: "+82", flag: "рџ‡°рџ‡·" },
        { name: "China", code: "+86", flag: "рџ‡Ёрџ‡і" }
    ];

    const centralAsiaRegions = [
        { value: 'uzbekistan', label: 'Узбекистан' },
        { value: 'kazakhstan', label: 'Казахстан' },
        { value: 'kyrgyzstan', label: 'Кыргызстан' },
        { value: 'tajikistan', label: 'Таджикистан' },
        { value: 'turkmenistan', label: 'Туркменистан' },
        { value: 'afghanistan', label: 'Афганистан' }
    ];

    const genreSurveyOptions = [
        { value: 'action', icon: '🔥', translationKey: 'genreAction' },
        { value: 'adventure', icon: '🧭', translationKey: 'genreAdventure' },
        { value: 'comedy', icon: '😂', translationKey: 'genreComedy' },
        { value: 'drama', icon: '🎭', translationKey: 'genreDrama' },
        { value: 'fantasy', icon: '🪄', translationKey: 'genreFantasy' },
        { value: 'sci-fi', icon: '🚀', translationKey: 'genreSciFi' },
        { value: 'thriller', icon: '🕵️', translationKey: 'genreThriller' },
        { value: 'horror', icon: '👻', translationKey: 'genreHorror' },
        { value: 'romance', icon: '💞', translationKey: 'genreRomance' },
        { value: 'animation', icon: '🎨', translationKey: 'genreAnimation' },
        { value: 'documentary', icon: '🎬', translationKey: 'genreDocumentary' },
        { value: 'family', icon: '👨‍👩‍👧', translationKey: 'genreFamily' }
    ];

    // Tarjimalar obyekti
    const translations = {
        en: { heroTitle: "Endless Worlds, Endless Stories", heroSubtitle: "Watch the best movies and series in high quality only on Soundora Films.", heroButton: "Watch Now", searchPlaceholder: "Search for movies...", noResults: "No movies found.", noFavorites: "Your favorites list is empty. Add movies to see them here.", backButton: "Back", description: "Description", producerTitle: "Producer", castTitle: "Cast", genre: "Genre", country: "Country", language: "Language", rating: "Rating", duration: "Duration", watchTrailer: "Watch Trailer", episodes: "Episodes", series: "Series", episode: "Episode", addToFavorites: "Add to List", removeFromFavorites: "Remove from List", bottomNavHome: "Home", bottomNavSearch: "Search", bottomNavFavorites: "Favorites", bottomNavProfile: "Profile", rightsReserved: "All Rights Reserved.", studio: "Studio", myFavorites: "My Favorites", settings: "Settings", languageSettingTitle: "App Language", profile: "Profile", favorites: "Favorites", categoryTrending: "Trending", categoryAll: "All", categoryNew: "New", editProfile: "Edit Profile", content: "Content", save: "Save", contentSettingsTitle: "Content Settings", show18Plus: "Show 18+ content", name: "Name", email: "Email", logout: "Logout", loginTitle: "Login", registerTitle: "Register", loginWithEmail: "Sign in with Email", password: "Password", login: "Login", dontHaveAccount: "Don't have an account?", registerNow: "Register now", alreadyHaveAccount: "Already have an account?", loginNow: "Login now", or: "or", loginRequired: "Please log in to watch.", invalidCredentials: "Invalid login or password.", playback: "Playback", enableMiniPlayer: "Enable Mini Player", miniPlayerHint: "Continue watching in a small window while Browse.", privacyPolicy: "Privacy Policy", faq: "FAQ", appVersion: "App Version", liveChat: "Support", privacyTitle: "Privacy Policy", privacy1Title: "1. Information We Collect", privacy1Text: "We collect information to provide better services to all our users. This includes: information you provide us (like your name and email when you register), and information we get from your use of our services (like movies you watch, your favorites, and device information).", privacy2Title: "2. How We Use Information", privacy2Text: "We use the information we collect to provide, maintain, protect, and improve our services, to develop new ones, and to protect Soundora Films and our users. We also use this information to offer you tailored content — like giving you more relevant movie recommendations.", privacy3Title: "3. Information We Share", privacy3Text: "We do not share personal information with companies, organizations, and individuals outside of Soundora Films unless one of the following circumstances applies: with your consent, for external processing, or for legal reasons. This is a demo application, and your data is not shared with any third parties.", privacy4Title: "4. Your Rights", privacy4Text: "You have the right to access, update, and delete your personal information. You can review and update your personal information by signing into your profile and visiting the 'Edit Profile' page. If you have any questions, please contact our support.", faqTitle: "Frequently Asked Questions", faq1Title: "Q: How do I change my password?", faq1Answer: "A: You can change your password by going to Profile > Settings > Edit Profile. This is a demo feature and is not currently functional.", faq2Title: "Q: Is Soundora Films free?", faq2Answer: "A: This is a demonstration version, and its use is completely free. There are no subscriptions or fees.", faq3Title: "Q: How do I enable the mini-player?", faq3Answer: "A: You can enable or disable the mini-player feature by navigating to Profile > Settings > Playback.", notifications: "Notifications", noNewNotifications: "No new notifications", markAllAsRead: "Mark all as read", refresh: "Refresh", newMovieAdded: "has been added.", newSeriesAdded: "has been added.", premium: "Premium", getPremium: "Get Premium Access", premiumHint: "Unlock exclusive movies, ad-free watching, and more!", subscribeNow: "Subscribe Now", premiumRequiredTitle: "Premium Required", premiumRequiredText: "To watch this content, you need a premium subscription.", goToPremium: "Go to Premium", plan1Month: "1 Month", plan3Months: "3 Months", plan7Months: "7 Months", plan12Months: "12 Months", pricePerMonth: "/month", total: "Total", mostPopular: "Most Popular", bestValue: "Best Value", howToSubscribe: "How to Subscribe?", subscribeStep1: "1. Copy your User ID from the Profile page.", subscribeStep2: "2. Open the Live Chat and send your ID to the operator.", subscribeStep3: "3. Inform the operator about your desired subscription plan and follow their instructions.", copyId: "Copy ID", idCopied: "ID Copied!", watchNow: "Watch Now", download: "Download", likes: "Likes", dislikes: "Dislikes", originalTitle: "Original Title", free: "Free", year: "Year", quality: "Quality", apControl: "Admin Panel", profileUpdateSuccess: "Profile updated successfully!", profileUpdateError: "Error updating profile.", aiChatTitle: "Emro AI Assistant", aiChatWelcome: "Hello! I'm Emro, your AI assistant. How can I help you find a movie or navigate the site today? Type 'operator' to speak to a human.", aiChatPlaceholder: "Ask Emro AI...", loginToAccess: "To access your profile, favorites, and settings, please log in or create an account.", operatorRedirectTitle: "Connecting to Operator", operatorRedirectText: "You will be redirected to live chat in", operatorRedirectCancel: "Cancel", operatorConnectPrompt: "Please click the button below to connect.", operatorConnectNow: "Connect Now", aiDefaultSorry: "Sorry, I can only help with finding movies or navigating the site.", playerSettings: "Settings", playbackSpeed: "Playback Speed", subtitles: "Subtitles", screenLock: "Screen Lock", more: "More", loopVideo: "Loop video", normalSpeed: "Normal", exitMessage: "Press back again to exit", noSubtitles: "Off", fullscreenError: "Fullscreen mode is not available",
        registerWarningTitle: "Important Warning", registerWarningText: "Creating an account does not require any real information. The login and password can be entered randomly, but you need to know the login and password to access the account. Do not forget and do not give the information to others.", fullName: "Full Name", loginLabel: "Login (Email)", dobLabel: "Date of Birth", secretWordLabel: "Secret Word", secretWordPlaceholder: "For password recovery",
        changePassword: "Change Password", newPassword: "New password", confirmPassword: "Confirm new password", passwordUpdateSuccess: "Password updated successfully!", passwordUpdateError: "Error updating password.", passwordsDoNotMatch: "Passwords do not match.",
        loginWithPhone: "Phone", phoneNumber: "Phone Number", sendCode: "Send Code", verificationCode: "Verification Code", verify: "Verify", invalidPhoneNumber: "Invalid phone number.", smsSent: "SMS with code has been sent.", invalidCode: "Invalid verification code.",
        registerWithPhone: "Register with Phone",
        },
                ru: { heroTitle: "Бесконечные миры, бесконечные истории", heroSubtitle: "Смотрите лучшие фильмы и сериалы в высоком качестве только на Soundora Films.", heroButton: "Смотреть сейчас", searchPlaceholder: "Поиск фильмов...", noResults: "Фильмы не найдены.", noFavorites: "Ваш список избранного пуст. Добавляйте фильмы, чтобы увидеть их здесь.", backButton: "Назад", description: "Описание", producerTitle: "Продюсер", castTitle: "В ролях", genre: "Жанр", country: "Страна", language: "Язык", rating: "Рейтинг", duration: "Длительность", watchTrailer: "Трейлер", episodes: "Эпизоды", series: "Сериал", episode: "Эпизод", addToFavorites: "В избранное", removeFromFavorites: "Убрать из избранного", bottomNavHome: "Главная", bottomNavSearch: "Поиск", bottomNavFavorites: "Избранное", bottomNavProfile: "Профиль", rightsReserved: "Все права защищены.", studio: "Студия", myFavorites: "Мои избранные", settings: "Настройки", languageSettingTitle: "Язык приложения", profile: "Профиль", favorites: "Избранное", categoryTrending: "В тренде", categoryAll: "Все", categoryNew: "Новые", editProfile: "Изменить профиль", content: "Контент", save: "Сохранить", contentSettingsTitle: "Настройки контента", show18Plus: "Показывать контент 18+", name: "Имя", email: "Эл. почта", logout: "Выйти", loginTitle: "Вход", registerTitle: "Регистрация", loginWithEmail: "Email", password: "Пароль", login: "Войти", dontHaveAccount: "Нет аккаунта?", registerNow: "Зарегистрироваться", alreadyHaveAccount: "Уже есть аккаунт?", loginNow: "Войти", or: "или", loginRequired: "Пожалуйста, войдите, чтобы посмотреть.", invalidCredentials: "Неверный логин или пароль.", playback: "Воспроизведение", enableMiniPlayer: "Включить мини-плеер", miniPlayerHint: "Продолжайте просмотр в маленьком окне во время навигации.", privacyPolicy: "Политика конфиденциальности", faq: "FAQ", appVersion: "Версия приложения", liveChat: "Поддержка", privacyTitle: "Политика конфиденциальности", privacy1Title: "1. Какую информацию мы собираем", privacy1Text: "Мы собираем информацию для улучшения наших сервисов для всех пользователей. Это включает: информацию, которую вы предоставляете (например, ваше имя и email при регистрации), и информацию, которую мы получаем от использования вами наших сервисов (например, какие фильмы вы смотрите, ваше избранное и информация об устройстве).", privacy2Title: "2. Как мы используем информацию", privacy2Text: "Мы используем собранную информацию для предоставления, поддержки, защиты и улучшения наших сервисов, для разработки новых, а также для защиты Soundora Films и наших пользователей. Мы также используем эту информацию, чтобы предлагать вам персонализированный контент, например, более релевантные рекомендации фильмов.", privacy3Title: "3. Какой информацией мы делимся", privacy3Text: "Мы не передаем личную информацию компаниям, организациям и частным лицам, не связанным с Soundora Films, за исключением следующих случаев: с вашего согласия, для внешней обработки или по юридическим причинам. Это демонстрационное приложение, и ваши данные не передаются третьим лицам.", privacy4Title: "4. Ваши права", privacy4Text: "Вы имеете право на доступ, обновление и удаление вашей личной информации. Вы можете просматривать и обновлять свою личную информацию, войдя в свой профиль и посетив страницу 'Изменить профиль'. Если у вас есть вопросы, пожалуйста, свяжитесь с нашей поддержкой.", faqTitle: "Часто задаваемые вопросы", faq1Title: "В: Как изменить мой пароль?", faq1Answer: "О: Вы можете изменить свой пароль, перейдя в Профиль > Настройки > Изменить профиль. Это демонстрационная функция и в настоящее время не работает.", faq2Title: "В: Soundora Films бесплатный?", faq2Answer: "О: Это демонстрационная версия, и ее использование абсолютно бесплатно. Подписок или платежей нет.", faq3Title: "В: Как включить мини-плеер?", faq3Answer: "О: Вы можете включить или выключить функцию мини-плеера, перейдя в Профиль > Настройки > Воспроизведение.", notifications: "Уведомления", noNewNotifications: "Нет новых уведомлений", markAllAsRead: "Отметить все как прочитанные", refresh: "Обновить", newMovieAdded: "добавлен.", newSeriesAdded: "добавлен.", premium: "Премиум", getPremium: "Получить Премиум", premiumHint: "Откройте эксклюзивные фильмы, просмотр без рекламы и многое другое!", subscribeNow: "Подписаться", premiumRequiredTitle: "Нужен Премиум", premiumRequiredText: "Для просмотра этого контента требуется премиум-подписка.", goToPremium: "Перейти к Премиум", plan1Month: "1 Месяц", plan3Months: "3 Месяца", plan7Months: "7 Месяцев", plan12Months: "12 Месяцев", pricePerMonth: "/месяц", total: "Итого", mostPopular: "Популярный", bestValue: "Выгодно", howToSubscribe: "Как подписаться?", subscribeStep1: "1. Скопируйте ваш ID пользователя на странице Профиля.", subscribeStep2: "2. Откройте Онлайн-чат и отправьте ваш ID оператору.", subscribeStep3: "3. Сообщите оператору желаемый план подписки и следуйте инструкциям.", copyId: "Копировать ID", idCopied: "ID скопирован!", watchNow: "Смотреть", download: "Скачать", likes: "Лайки", dislikes: "Дизлайки", originalTitle: "Оригинальное название", free: "Бесплатно", year: "Год", quality: "Качество", apControl: "Панель Администратора", profileUpdateSuccess: "Профиль успешно обновлен!", profileUpdateError: "Ошибка при обновлении профиля.", aiChatTitle: "Ассистент Emro AI", aiChatWelcome: "Здравствуйте! Я Emro, ваш AI-ассистент. Чем я могу помочь вам сегодня: найти фильм или сориентировать на сайте? Введите 'оператор', чтобы связаться с человеком.", aiChatPlaceholder: "Спросите у Emro AI...", loginToAccess: "Чтобы получить доступ к своему профилю, избранному и настройкам, войдите в систему или создайте учетную запись.", operatorRedirectTitle: "Соединение с оператором", operatorRedirectText: "Вы будете перенаправлены в чат через", operatorRedirectCancel: "Отмена", operatorConnectPrompt: "Нажмите кнопку ниже для подключения.", operatorConnectNow: "Подключиться сейчас", aiDefaultSorry: "Извините, я могу помочь только с поиском фильмов или навигацией по сайту.", playerSettings: "Настройки", playbackSpeed: "Скорость", subtitles: "Субтитры", screenLock: "Блокировка экрана", more: "Ещё", loopVideo: "Повтор видео", normalSpeed: "Обычная", exitMessage: "Нажмите ещё раз для выхода", noSubtitles: "Выкл.", fullscreenError: "Полноэкранный режим недоступен", registerWarningTitle: "Важное предупреждение", registerWarningText: "Создание учетной записи не требует никаких реальных данных. Логин и пароль можно вводить произвольно, но для входа в аккаунт их необходимо знать. Не забывайте и не передавайте свои данные другим.", fullName: "Имя, Фамилия", loginLabel: "Логин (Email)", dobLabel: "Дата рождения", secretWordLabel: "Секретное слово", secretWordPlaceholder: "Для восстановления пароля", changePassword: "Сменить пароль", newPassword: "Новый пароль", confirmPassword: "Подтвердите новый пароль", passwordUpdateSuccess: "Пароль успешно изменен!", passwordUpdateError: "Ошибка при смене пароля.", passwordsDoNotMatch: "Пароли не совпадают.", loginWithPhone: "Телефон", phoneNumber: "Номер телефона", sendCode: "Отправить код", verificationCode: "Код подтверждения", verify: "Подтвердить", invalidPhoneNumber: "Неверный номер телефона.", smsSent: "SMS с кодом отправлено.", invalidCode: "Неверный код подтверждения.", registerWithPhone: "Регистрация по телефону"
        },
        uz: { heroTitle: "Cheksiz dunyolar, cheksiz hikoyalar", heroSubtitle: "Eng yaxshi filmlar va seriallarni yuqori sifatda faqat Soundora Films'da tomosha qiling.", heroButton: "Hozir Ko'rish", searchPlaceholder: "Filmlarni qidirish...", noResults: "Filmlar topilmadi.", noFavorites: "Sevimlilar roК»yxatingiz boК»sh. Ularni ko'rish uchun film qo'shing.", backButton: "Orqaga", description: "Tavsif", producerTitle: "Prodyuser", castTitle: "Rollarda", genre: "Janr", country: "Davlat", language: "Til", rating: "Reyting", duration: "Davomiyligi", watchTrailer: "Treylerni Ko'rish", episodes: "Qismlar", series: "Serial", episode: "Qism", addToFavorites: "Sevimlilarga", removeFromFavorites: "Sevimlilardan o'chirish", bottomNavHome: "Bosh Sahifa", bottomNavSearch: "Qidiruv", bottomNavFavorites: "Sevimlilar", bottomNavProfile: "Profil", rightsReserved: "Barcha huquqlar himoyalangan.", studio: "Studiya", myFavorites: "Mening sevimlilarim", settings: "Sozlamalar", languageSettingTitle: "Ilova tili", profile: "Profil", favorites: "Sevimlilar", categoryTrending: "Trenddagilar", categoryAll: "Barchasi", categoryNew: "Yangilar", editProfile: "Profilni tahrirlash", content: "Kontent", save: "Saqlash", contentSettingsTitle: "Kontent Sozlamalari", show18Plus: "18+ kontentni ko'rsatish", name: "Ism", email: "Email", logout: "Chiqish", loginTitle: "Hisobga Kirish", registerTitle: "Ro'yxatdan o'tish", loginWithEmail: "Email", password: "Parol", login: "Kirish", dontHaveAccount: "Hisobingiz yo'qmi?", registerNow: "Ro'yxatdan o'ting", alreadyHaveAccount: "Hisobingiz bormi?", loginNow: "Hisobga kiring", or: "yoki", loginRequired: "Tomosha qilish uchun hisobga kiring.", invalidCredentials: "Login yoki parol xato.", playback: "Ijro etish", enableMiniPlayer: "Mini-pleyerni yoqish", miniPlayerHint: "Boshqa sahifalarni ko'rayotganda kichik oynada tomosha qilishni davom eting.", privacyPolicy: "Maxfiylik siyosati", faq: "FAQ", appVersion: "Ilova versiyasi", liveChat: "Qo'llab-quvvatlash", privacyTitle: "Maxfiylik siyosati", privacy1Title: "1. Biz yig'adigan ma'lumotlar", privacy1Text: "Biz barcha foydalanuvchilarimizga yaxshiroq xizmat ko'rsatish uchun ma'lumotlarni yig'amiz. Bunga quyidagilar kiradi: siz bizga taqdim etgan ma'lumotlar (masalan, ro'yxatdan o'tayotganda ismingiz va elektron pochta manzilingiz) va xizmatlarimizdan foydalanish natijasida olingan ma'lumotlar (masalan, siz tomosha qilgan filmlar, sevimlilar ro'yxatingiz va qurilmangiz haqidagi ma'lumotlar).", privacy2Title: "2. Ma'lumotlardan qanday foydalanamiz", privacy2Text: "Biz yig'ilgan ma'lumotlardan xizmatlarimizni taqdim etish, qo'llab-quvvatlash, himoya qilish va yaxshilash, yangilarini ishlab chiqish hamda Soundora Films va foydalanuvchilarimizni himoya qilish uchun foydalanamiz. Shuningdek, biz ushbu ma'lumotlardan sizga moslashtirilgan kontentni taklif qilish uchun foydalanamiz - masalan, sizga ko'proq mos keladigan film tavsiyalarini berish.", privacy3Title: "3. Biz ulashadigan ma'lumotlar", privacy3Text: "Biz shaxsiy ma'lumotlarni Soundora Films bilan bog'liq bo'lmagan kompaniyalar, tashkilotlar va shaxslar bilan ulashmaymiz, quyidagi holatlar bundan mustasno: sizning roziligingiz bilan, tashqi qayta ishlash uchun yoki qonuniy sabablarga ko'ra. Bu demo-ilova bo'lgani uchun sizning ma'lumotlaringiz hech qanday uchinchi tomonga berilmaydi.", privacy4Title: "4. Sizning huquqlaringiz", privacy4Text: "Siz o'z shaxsiy ma'lumotlaringizga kirish, ularni yangilash va o'chirish huquqiga egasiz. Profilingizga kirib, 'Profilni tahrirlash' sahifasiga o'tish orqali shaxsiy ma'lumotlaringizni ko'rib chiqishingiz va yangilashingiz mumkin. Savollaringiz bo'lsa, qo'llab-quvvatlash xizmatimizga murojaat qiling.", faqTitle: "Ko'p beriladigan savollar", faq1Title: "S: Parolni qanday o'zgartirish mumkin?", faq1Answer: "J: Parolni o'zgartirish uchun Profil > Sozlamalar > Profilni tahrirlash bo'limiga o'ting. Bu demo xususiyat bo'lib, hozirda ishlamaydi.", faq2Title: "S: Soundora Films bepulmi?", faq2Answer: "J: Bu namoyish versiyasi va undan foydalanish mutlaqo bepul. Obuna yoki to'lovlar yo'q.", faq3Title: "S: Mini-pleyerni qanday yoqish mumkin?", faq3Answer: "J: Mini-pleyer funksiyasini Profil > Sozlamalar > Ijro etish bo'limiga o'tib yoqishingiz yoki o'chirishingiz mumkin.", notifications: "Bildirishnomalar", noNewNotifications: "Yangi bildirishnomalar yo'q", markAllAsRead: "Barchasini o'qilgan deb belgilash", refresh: "Yangilash", newMovieAdded: "qo'shildi.", newSeriesAdded: "qo'shildi.", premium: "Premium", getPremium: "Premium'ga ega bo'ling", premiumHint: "Eksklyuziv filmlar, reklamasiz tomosha va boshqa imkoniyatlarni oching!", subscribeNow: "Obuna bo'lish", premiumRequiredTitle: "Premium Obuna Kerak", premiumRequiredText: "Ushbu kontentni tomosha qilish uchun premium obuna kerak.", goToPremium: "Premium'ga o'tish", plan1Month: "1 Oy", plan3Months: "3 Oy", plan7Months: "7 Oy", plan12Months: "12 Oy", pricePerMonth: "/oyiga", total: "Jami", mostPopular: "Ommabop", bestValue: "Eng Yaxshi Taklif", howToSubscribe: "Qanday obuna bo'lish mumkin?", subscribeStep1: "1. Profil sahifasidan ID raqamingizdan nusxa oling.", subscribeStep2: "2. Jonli Chat'ni ochib, ID raqamingizni operatorga yuboring.", subscribeStep3: "3. Operatorga kerakli obuna rejasini ayting va uning ko'rsatmalariga amal qiling.", copyId: "ID'dan nusxa olish", idCopied: "ID nusxalandi!", watchNow: "Tomosha Qilish", download: "Yuklab Olish", likes: "Layklar", dislikes: "Dizlayklar", originalTitle: "Asl nomi", free: "Bepul", year: "Yili", quality: "Sifat", apControl: "Admin Paneli", profileUpdateSuccess: "Profil muvaffaqiyatli yangilandi!", profileUpdateError: "Profilni yangilashda xatolik.", aiChatTitle: "Emro AI Yordamchisi", aiChatWelcome: "Salom! Men Emro, sizning AI yordamchingizman. Bugun sizga qanday yordam bera olaman: kino topish yoki saytda yo'l ko'rsatish bo'yicha? Haqiqiy odam bilan gaplashish uchun 'operator' deb yozing.", aiChatPlaceholder: "Emro AI'dan so'rang...", loginToAccess: "Profilingiz, sevimlilaringiz va sozlamalaringizga kirish uchun tizimga kiring yoki hisob yarating.", operatorRedirectTitle: "Operatorga ulanmoqda", operatorRedirectText: "Siz jonli suhbatga yo'naltirilmoqdasiz", operatorRedirectCancel: "Bekor qilish", operatorConnectPrompt: "Ulanish uchun quyidagi tugmani bosing.", operatorConnectNow: "Hozir Ulanish", aiDefaultSorry: "Kechirasiz, men faqat filmlarni topishda yoki saytda harakatlanishda yordam bera olaman.", playerSettings: "Sozlamalar", playbackSpeed: "Tezlik", subtitles: "Subtitrlar", screenLock: "Ekran blokirovkasi", more: "Qo'shimcha", loopVideo: "Videoni takrorlash", normalSpeed: "Normal", exitMessage: "Chiqish uchun yana bir marta bosing", noSubtitles: "O'chirilgan", fullscreenError: "To'liq ekran rejimi mavjud emas",
        registerWarningTitle: "Muhim Ogohlantirish", registerWarningText: "Hisob yaratishda hech qanday haqiqiy ma'lumot shart emas. Login va parol tasodifiy kiritish mumkin, lekin hisobga kirish uchun login va parolni bilishingiz kerak. Esdan chiqarmang va ma'lumotlarni boshqalarga bermang.", fullName: "Ism, Familiya", loginLabel: "Login (Email)", dobLabel: "Tug'ilgan kun", secretWordLabel: "Maxfiy so'z", secretWordPlaceholder: "Parolni tiklash uchun",
        changePassword: "Parolni o'zgartirish", newPassword: "Yangi parol", confirmPassword: "Yangi parolni tasdiqlang", passwordUpdateSuccess: "Parol muvaffaqiyatli o'zgartirildi!", passwordUpdateError: "Parolni o'zgartirishda xatolik.", passwordsDoNotMatch: "Parollar mos kelmadi.",
        loginWithPhone: "Telefon", phoneNumber: "Telefon raqam", sendCode: "Kodni yuborish", verificationCode: "Tasdiqlash kodi", verify: "Tasdiqlash", invalidPhoneNumber: "Telefon raqami noto'g'ri.", smsSent: "Kodli SMS yuborildi.", invalidCode: "Tasdiqlash kodi noto'g'ri.",
        registerWithPhone: "Telefon orqali",
        }
    };

    // Override brand names to "SND" or "Streaming Network of Dreams" after translations are defined.
    // Update English translation strings to use the full brand name.
    translations.en.heroSubtitle = translations.en.heroSubtitle.replaceAll('Soundora Films', 'Streaming Network of Dreams');
    translations.en.privacy2Text = translations.en.privacy2Text.replaceAll('Soundora Films', 'Streaming Network of Dreams');
    translations.en.privacy3Text = translations.en.privacy3Text.replaceAll('Soundora Films', 'Streaming Network of Dreams');
    translations.en.faq2Title = translations.en.faq2Title.replaceAll('Soundora Films', 'Streaming Network of Dreams');
    // Update Russian translations to use the abbreviation "SND".
    translations.ru.heroSubtitle = translations.ru.heroSubtitle.replaceAll('Soundora Films', 'SND');
    translations.ru.privacy2Text = translations.ru.privacy2Text.replaceAll('Soundora Films', 'SND');
    translations.ru.privacy3Text = translations.ru.privacy3Text.replaceAll('Soundora Films', 'SND');
    translations.ru.faq2Title = translations.ru.faq2Title.replaceAll('Soundora Films', 'SND');
    // Update Uzbek translations to use the abbreviation "SND".
    translations.uz.heroSubtitle = translations.uz.heroSubtitle.replaceAll('Soundora Films', 'SND');
    translations.uz.privacy2Text = translations.uz.privacy2Text.replaceAll('Soundora Films', 'SND');
    translations.uz.privacy3Text = translations.uz.privacy3Text.replaceAll('Soundora Films', 'SND');
    translations.uz.faq2Title = translations.uz.faq2Title.replaceAll('Soundora Films', 'SND');
    let currentLanguage = 'en';
    // --- Additional translations for new features ---
    const extraTranslations = {
        en: {
            detailsTab: "Details",
        actorsTab: "Actors",
        ratingTab: "Rating",
            creatorsTab: "Creators",
            yourRatingTitle: "Your rating",
            ratingImproves: "Ratings improve recommendations",
            directionCheckbox: "Direction",
            plotCheckbox: "Plot",
            spectacleCheckbox: "Spectacle",
            actorsCheckbox: "Актеры",
            screenshotsTitle: "Скриншоты",
            noCastInfo: "Информация об актёрах пока недоступна.",
            rateButton: "Оценить",
            whoIsWatching: "Who's watching SND?",
            otherAccount: "Sign in to another account",
            shareSubscription: "Share subscription",
            thankYouForRating: "Thank you for rating!",
            navHome: "Home",
            navFavorites: "Favorites",
            navSupport: "Support",
            navProfile: "Profile",
            sndRating: "SND Rating",
            rateThisMovie: "Rate this movie",
            filmographyTitle: "Filmography",
            filmographyEmpty: "No other titles yet.",
            directorTitle: "Director",
            privacyLastUpdated: "Last updated: August 23, 2025",
            switchAccount: "Switch account",
            switchedToAccount: "Switched to",
            noSavedAccounts: "No saved accounts yet."
            , downloads: "Downloads"
            , noDownloads: "No downloaded movies yet."
            , downloadAdded: "Movie added to downloads"
            , downloadStarted: "Downloading..."
            , downloadCompleted: "Downloaded"
            , downloadButton: "Download"
            , offlineMode: "You are offline"
            , onlineMode: "You are online"
            , resumeMessage: "You stopped earlier. Continue watching from where you left off?"
            , resumeYes: "Yes"
            , resumeNo: "No"
            , enableResumePrompt: "Ask to resume playback"
            , resumePromptHint: "Show a prompt to continue from your last position when returning to a movie"
            , expiresOn: "Expires on"
            , daysLeft: "days left"
            , votes: "ratings"
            , addProfile: "Add profile"
            , addKids: "Add kids"
            , kidsProfileName: "Kids"
            , kidsOnlyMovies: "Only cartoons and family content"
            , createProfile: "Create Profile"
            , profileName: "Profile Name"
            , enterProfileName: "Enter name..."
            , selectAvatar: "Choose Avatar"
            , isKidsProfile: "Kids Profile (Cartoons Only)"
            , profileCreated: "Profile created successfully!"
            , switchToProfile: "Switch to"
            , editProfile: "Edit Profile"
            , deleteProfile: "Delete Profile"
            , manageProfiles: "Manage Profiles"
            , currentProfile: "Current Profile"
            , switchAccountConfirm: "Switch to this account?"
            , switchAccountMessage: "Do you want to switch to"
            , confirmYes: "Yes, Switch"
            , confirmNo: "Cancel"
            , loginNewAccount: "Login with new account"
            , addNewAccount: "Add New Account"
            , accountSaved: "Account saved successfully!"
            , promoCode: "Promo code"
            , enterPromoCode: "Enter promo code"
            , activatePromo: "Redeem"
            , promoCodesList: "Your Promo Codes"
            , codeUsed: "Activated"
            , codeUnused: "Unused"
            , copy: "Copy"
            , generateCode: "Generate Code"
            , noPromoCodes: "No promo codes yet."
            , promoCodeCopied: "Promo code copied!"
            , supportNewMessage: "New support message"
            , supportChatTitle: "Support Chat"
            , supportChatWaiting: "Please wait for an agent to join."
            , supportChatQueue: "Your position in queue:"
            , supportChatPlaceholder: "Type your message..."
            , supportChatSend: "Send"
            , supportChatSystem: "System"
            , supportChatAgentPrefix: "Agent"
            , supportChatUserPrefix: "You"
            , supportChatOperatorQuick: "Operator"
        , supportChatClosed: "Operator has closed the chat."
            , subscribeStep2: "2. Open the support chat (type 'operator' in the AI chat) and send your ID to the agent."
            , loginWithGoogle: "Sign in with Google"
            , qrLogin: "Sign in with QR code"
            , scanQR: "Scan QR Code"
            , scanInstruction: "Scan the QR code on your device to sign in"
        },
        ru: {
            detailsTab: "Р”РµС‚Р°Р»Рё",
        actorsTab: "РђРєС‚РµСЂС‹",
        ratingTab: "Р РµР№С‚РёРЅРі",
            creatorsTab: "РЎРѕР·РґР°С‚РµР»Рё",
            yourRatingTitle: "РўРІРѕСЏ РѕС†РµРЅРєР°",
            ratingImproves: "РћС†РµРЅРєРё СѓР»СѓС‡С€Р°СЋС‚ СЂРµРєРѕРјРµРЅРґР°С†РёРё",
            directionCheckbox: "Р РµР¶РёСЃСЃСѓСЂР°",
            plotCheckbox: "РЎСЋР¶РµС‚",
            spectacleCheckbox: "Р—СЂРµР»РёС‰РЅРѕСЃС‚СЊ",
            actorsCheckbox: "РђРєС‚С‘СЂС‹",
            rateButton: "РћС†РµРЅРёС‚СЊ",
            whoIsWatching: "РљС‚Рѕ СЃРјРѕС‚СЂРёС‚ SND?",
            otherAccount: "Р’РѕР№С‚Рё РІ РґСЂСѓРіРѕР№ Р°РєРєР°СѓРЅС‚",
            shareSubscription: "РџРѕРґРµР»РёС‚СЊСЃСЏ РїРѕРґРїРёСЃРєРѕР№",
            thankYouForRating: "РЎРїР°СЃРёР±Рѕ Р·Р° РѕС†РµРЅРєСѓ!",
            sndRating: "SND СЂРµР№С‚РёРЅРі",
            rateThisMovie: "РћС†РµРЅРёС‚СЊ С„РёР»СЊРј",
            directorTitle: "Р РµР¶РёСЃСЃС‘СЂ",
            privacyLastUpdated: "РџРѕСЃР»РµРґРЅРµРµ РѕР±РЅРѕРІР»РµРЅРёРµ: 23 Р°РІРіСѓСЃС‚Р° 2025",
            switchAccount: "РЎРјРµРЅРёС‚СЊ Р°РєРєР°СѓРЅС‚"
            , noSavedAccounts: "Нет сохранённых аккаунтов."
            , downloads: "Р—Р°РіСЂСѓР·РєРё"
            , noDownloads: "РќРµС‚ Р·Р°РіСЂСѓР¶РµРЅРЅС‹С… С„РёР»СЊРјРѕРІ."
            , downloadAdded: "Р¤РёР»СЊРј РґРѕР±Р°РІР»РµРЅ РІ Р·Р°РіСЂСѓР·РєРё"
            , downloadStarted: "РќР°С‡Р°Р»Р°СЃСЊ Р·Р°РіСЂСѓР·РєР°. Р¤РёР»СЊРј РїРѕСЏРІРёС‚СЃСЏ РІ СЂР°Р·РґРµР»Рµ Р·Р°РіСЂСѓР·РѕРє"
            , downloadCompleted: "Р—Р°РіСЂСѓР¶РµРЅРѕ"
            , downloadButton: "РЎРєР°С‡Р°С‚СЊ"
            , offlineMode: "Р’С‹ РѕС„Р»Р°Р№РЅ"
            , onlineMode: "Р’С‹ РѕРЅР»Р°Р№РЅ"
            , resumeMessage: "Р’С‹ РѕСЃС‚Р°РЅРѕРІРёР»РёСЃСЊ СЂР°РЅРµРµ. РџСЂРѕРґРѕР»Р¶РёС‚СЊ РїСЂРѕСЃРјРѕС‚СЂ СЃ СЌС‚РѕРіРѕ РјРµСЃС‚Р°?"
            , resumeYes: "Р”Р°"
            , resumeNo: "РќРµС‚"
            , enableResumePrompt: "РџРѕРєР°Р·С‹РІР°С‚СЊ Р·Р°РїСЂРѕСЃ РїСЂРѕРґРѕР»Р¶РµРЅРёСЏ"
            , resumePromptHint: "РџСЂРё РІРѕР·РІСЂР°С‚Рµ Рє С„РёР»СЊРјСѓ СЃРїСЂР°С€РёРІР°С‚СЊ, С…РѕС‚РёС‚Рµ Р»Рё РїСЂРѕРґРѕР»Р¶РёС‚СЊ СЃ СЃРѕС…СЂР°РЅС‘РЅРЅРѕРіРѕ РјРµСЃС‚Р°"
            , expiresOn: "Р”РµР№СЃС‚РІРёС‚РµР»СЊРЅРѕ РґРѕ"
            , daysLeft: "РґРЅРµР№ РѕСЃС‚Р°Р»РѕСЃСЊ"
            , votes: "РѕС†РµРЅРѕРє"
            , addProfile: "Р”РѕР±Р°РІРёС‚СЊ РїСЂРѕС„РёР»СЊ"
            , addKids: "Р”РѕР±Р°РІРёС‚СЊ РґРµС‚СЃРєРёР№"
            , promoCode: "РџСЂРѕРјРѕРєРѕРґ"
            , enterPromoCode: "Р’РІРµРґРёС‚Рµ РїСЂРѕРјРѕРєРѕРґ"
            , activatePromo: "РђРєС‚РёРІРёСЂРѕРІР°С‚СЊ"
            , promoCodesList: "Р’Р°С€Рё РїСЂРѕРјРѕРєРѕРґС‹"
            , codeUsed: "РђРєС‚РёРІРёСЂРѕРІР°РЅ"
            , codeUnused: "РќРµ РёСЃРїРѕР»СЊР·РѕРІР°РЅ"
            , copy: "РљРѕРїРёСЂРѕРІР°С‚СЊ"
            , generateCode: "РЎРѕР·РґР°С‚СЊ РєРѕРґ"
            , noPromoCodes: "РџСЂРѕРјРѕРєРѕРґРѕРІ РЅРµС‚."
            , promoCodeCopied: "РџСЂРѕРјРѕРєРѕРґ СЃРєРѕРїРёСЂРѕРІР°РЅ!"
            , supportChatTitle: "Р§Р°С‚ РїРѕРґРґРµСЂР¶РєРё"
            , supportChatWaiting: "РџРѕР¶Р°Р»СѓР№СЃС‚Р°, РґРѕР¶РґРёС‚РµСЃСЊ РїРѕРґРєР»СЋС‡РµРЅРёСЏ РѕРїРµСЂР°С‚РѕСЂР°."
            , supportChatQueue: "Р’Р°С€Р° РїРѕР·РёС†РёСЏ РІ РѕС‡РµСЂРµРґРё:"
            , supportChatPlaceholder: "Р’РІРµРґРёС‚Рµ СЃРѕРѕР±С‰РµРЅРёРµ..."
            , supportChatSend: "РћС‚РїСЂР°РІРёС‚СЊ"
            , supportChatSystem: "РЎРёСЃС‚РµРјР°"
            , supportChatAgentPrefix: "РћРїРµСЂР°С‚РѕСЂ"
            , supportChatUserPrefix: "Р’С‹"
            , supportChatOperatorQuick: "РћРїРµСЂР°С‚РѕСЂ"
        , supportChatClosed: "РћРїРµСЂР°С‚РѕСЂ Р·Р°РєСЂС‹Р» С‡Р°С‚."
            , subscribeStep2: "2. РћС‚РєСЂРѕР№С‚Рµ С‡Р°С‚ РїРѕРґРґРµСЂР¶РєРё (РЅР°РїРёС€РёС‚Рµ 'РѕРїРµСЂР°С‚РѕСЂ' РІ AI-С‡Р°С‚) Рё РѕС‚РїСЂР°РІСЊС‚Рµ СЃРІРѕР№ ID РѕРїРµСЂР°С‚РѕСЂСѓ."
        },
        uz: {
            detailsTab: "Ma'lumotlar",
        actorsTab: "Aktyorlar",
        ratingTab: "Reyting",
            creatorsTab: "Yaratganlar",
            yourRatingTitle: "Sizning bahongiz",
            ratingImproves: "Baholar tavsiyalarni yaxshilaydi",
            directionCheckbox: "Rejissura",
            plotCheckbox: "Syujet",
            spectacleCheckbox: "Tomosha",
            actorsCheckbox: "Aktyorlar",
            rateButton: "Baholash",
            whoIsWatching: "SND-ni kim ko'rmoqda?",
            otherAccount: "Boshqa akkauntga kirish",
            shareSubscription: "Obunani baham ko'rish",
            thankYouForRating: "Baholaganingiz uchun rahmat!",
            sndRating: "SND reytingi",
            rateThisMovie: "Filmdan baho bering",
            directorTitle: "Rejissyor",
            privacyLastUpdated: "Oxirgi yangilanish: 23-avgust, 2025",
            switchAccount: "Hisobni almashtirish"
            , noSavedAccounts: "Saqlangan akkauntlar yo'q."
            , downloads: "Yuklanganlar"
            , noDownloads: "Yuklangan filmlar yo'q."
            , downloadAdded: "Film yuklanganlarga qo'shildi"
            , downloadStarted: "Yuklash boshlandi. Yuklashlar bo'limida kuzatib boring"
            , downloadCompleted: "Yuklab olindi"
            , downloadButton: "Yuklab olish"
            , offlineMode: "Siz oflayn rejimdasiz"
            , onlineMode: "Siz onlayn rejimdasiz"
            , resumeMessage: "Siz avval to'xtagan edingiz. Shu joydan davom ettirishni xohlaysizmi?"
            , resumeYes: "Ha"
            , resumeNo: "Yo'q"
            , enableResumePrompt: "Davom ettirish so'rovi"
            , resumePromptHint: "Filmga qaytganingizda oxirgi to'xtagan joydan davom etishni so'rov oynasi"
            , expiresOn: "Muddati"
            , daysLeft: "kun qoldi"
            , votes: "baholar"
            , addProfile: "Profil qo'shish"
            , addKids: "Bolalar profilini qo'shish"
            , kidsProfileName: "Bolalar"
            , kidsOnlyMovies: "Faqat multfilmlar va oilaviy kontent"
            , createProfile: "Profil Yaratish"
            , profileName: "Profil Nomi"
            , enterProfileName: "Ismni kiriting..."
            , selectAvatar: "Avatar Tanlang"
            , isKidsProfile: "Bolalar Profili (Faqat Multfilmlar)"
            , profileCreated: "Profil muvaffaqiyatli yaratildi!"
            , switchToProfile: "O'tish"
            , editProfile: "Profilni Tahrirlash"
            , deleteProfile: "Profilni O'chirish"
            , manageProfiles: "Profillarni Boshqarish"
            , currentProfile: "Joriy Profil"
            , switchAccountConfirm: "Bu akkauntga o'tilsinmi?"
            , switchAccountMessage: "O'tmoqchimisiz"
            , confirmYes: "Ha, O'tish"
            , confirmNo: "Bekor qilish"
            , loginNewAccount: "Yangi akkaunt bilan kirish"
            , addNewAccount: "Yangi Akkaunt Qo'shish"
            , accountSaved: "Akkaunt saqlandi!"
            , promoCode: "Promokod"
            , enterPromoCode: "Promokodni kiriting"
            , activatePromo: "Faollashtirish"
            , promoCodesList: "Sizning promokodlaringiz"
            , codeUsed: "Faollashtirilgan"
            , codeUnused: "Faollashtirilmagan"
            , copy: "Nusxa olish"
            , generateCode: "Kod yaratish"
            , noPromoCodes: "Promokodlar yo'q."
            , promoCodeCopied: "Promokod nusxalandi!"
            , supportNewMessage: "Yangi qo'llab-quvvatlash xabari"
            , supportChatTitle: "Qo'llab-quvvatlash chati"
            , supportChatWaiting: "Iltimos, operator ulanishini kuting."
            , supportChatQueue: "Navbatdagi o'rningiz:"
            , supportChatPlaceholder: "Xabaringizni yozing..."
            , supportChatSend: "Yuborish"
            , supportChatSystem: "Tizim"
            , supportChatAgentPrefix: "Operator"
            , supportChatUserPrefix: "Siz"
            , supportChatOperatorQuick: "Operator"
        , supportChatClosed: "Operator chatni yopdi."
            , subscribeStep2: "2. Qo'llab-quvvatlash chatini oching (AI chatga 'operator' deb yozing) va ID raqamingizni operatorga yuboring."
            , loginWithGoogle: "Google orqali kirish"
            , qrLogin: "QR kod orqali kirish"
            , scanQR: "QR kodni skanerlang"
            , scanInstruction: "Qurilmangizda QR kodni skanerlang va hisobga kiring"
        }
};
extraTranslations.en.filmographyTitle = extraTranslations.en.filmographyTitle || "Filmography";
extraTranslations.en.filmographyEmpty = extraTranslations.en.filmographyEmpty || "No other titles yet.";
extraTranslations.ru.filmographyTitle = "Filmografiya";
extraTranslations.ru.filmographyEmpty = "Drugikh filmov net.";
extraTranslations.uz.filmographyTitle = "Filmografiya";
extraTranslations.uz.filmographyEmpty = "Hozircha boshqa filmlar yoq.";
    extraTranslations.en.autoQuality = extraTranslations.en.autoQuality || "Auto";
    extraTranslations.ru.autoQuality = "Avto";
    extraTranslations.uz.autoQuality = "Auto";
    extraTranslations.en.confirmPassword = "Confirm password";
    extraTranslations.ru.confirmPassword = "Подтвердите пароль";
    extraTranslations.uz.confirmPassword = "Parolni tasdiqlang";
    extraTranslations.en.secretWordLabel = "Secret word (for recovery)";
    extraTranslations.ru.secretWordLabel = "Секретное слово (для восстановления)";
    extraTranslations.uz.secretWordLabel = "Maxfiy so'z (tiklash uchun)";
    extraTranslations.en.secretWordPlaceholder = "Enter your recovery word";
    extraTranslations.ru.secretWordPlaceholder = "Слово для восстановления доступа";
    extraTranslations.uz.secretWordPlaceholder = "Tiklash uchun maxfiy so'z";
    extraTranslations.en.regionLabel = "Region (Central Asia)";
    extraTranslations.ru.regionLabel = "Регион (Центральная Азия)";
    extraTranslations.uz.regionLabel = "Hudud (Markaziy Osiyo)";
    extraTranslations.en.authWelcomeTitle = "Welcome back to Soundora";
    extraTranslations.ru.authWelcomeTitle = "Добро пожаловать в Soundora";
    extraTranslations.uz.authWelcomeTitle = "Soundora platformasiga xush kelibsiz";
    extraTranslations.en.authWelcomeSubtitle = "Sign in to continue watching films and series.";
    extraTranslations.ru.authWelcomeSubtitle = "Войдите, чтобы продолжить смотреть фильмы и сериалы.";
    extraTranslations.uz.authWelcomeSubtitle = "Filmlar va seriallarni davom ettirish uchun tizimga kiring.";
    extraTranslations.en.loginWithGoogle = "Continue with Google";
    extraTranslations.ru.loginWithGoogle = "Продолжить через Google";
    extraTranslations.uz.loginWithGoogle = "Google orqali davom etish";
    extraTranslations.en.registerHint = "Create a new Soundora аккаунт";
    extraTranslations.ru.registerHint = "Создайте новую учетную запись Soundora";
    extraTranslations.uz.registerHint = "Yangi Soundora akkauntini yarating";
    extraTranslations.en.registerCta = "Create account";
    extraTranslations.ru.registerCta = "Создать аккаунт";
    extraTranslations.uz.registerCta = "Akkaunt yaratish";
    extraTranslations.en.genreSurveyTitle = "Pick the genres you love";
    extraTranslations.ru.genreSurveyTitle = "Выберите любимые жанры";
    extraTranslations.uz.genreSurveyTitle = "Sevimli janrlaringizni tanlang";
    extraTranslations.en.genreSurveySubtitle = "We will customize the catalog to your taste. You can select up to 6 genres.";
    extraTranslations.ru.genreSurveySubtitle = "Мы настроим каталог под ваш вкус. Выберите до 6 жанров.";
    extraTranslations.uz.genreSurveySubtitle = "Tanlov asosida tavsiyalar sozlanadi. 6 tagacha janrni belgilang.";
    extraTranslations.en.genreSurveyCta = "Save preferences";
    extraTranslations.ru.genreSurveyCta = "Сохранить предпочтения";
    extraTranslations.uz.genreSurveyCta = "Tanlovni saqlash";
    extraTranslations.en.genreSurveySkip = "Skip for now";
    extraTranslations.ru.genreSurveySkip = "Пропустить пока";
    extraTranslations.uz.genreSurveySkip = "Hozircha o'tkazib yuborish";
    extraTranslations.en.genreSurveySaved = "Preferences saved";
    extraTranslations.ru.genreSurveySaved = "Предпочтения сохранены";
    extraTranslations.uz.genreSurveySaved = "Tanlovlar saqlandi";
    extraTranslations.en.genreSurveyHelper = "Select at least three genres to personalise the feed.";
    extraTranslations.ru.genreSurveyHelper = "Выберите минимум три жанра, чтобы персонализировать каталог.";
    extraTranslations.uz.genreSurveyHelper = "Katalogni moslash uchun kamida uchta janrni belgilang.";
    extraTranslations.en.registerFieldMissing = "Please fill in all required fields.";
    extraTranslations.ru.registerFieldMissing = "Заполните все обязательные поля.";
    extraTranslations.uz.registerFieldMissing = "Iltimos, barcha maydonlarni to'ldiring.";
    extraTranslations.en.passwordMismatch = "Passwords do not match.";
    extraTranslations.ru.passwordMismatch = "Пароли не совпадают.";
    extraTranslations.uz.passwordMismatch = "Parollar mos emas.";
    extraTranslations.en.registerSuccess = "Account created. Continue with preferences.";
    extraTranslations.ru.registerSuccess = "Аккаунт создан. Выберите предпочтения.";
    extraTranslations.uz.registerSuccess = "Akkaunt yaratildi. Janrlarni tanlang.";
    extraTranslations.en.googlePopupClosed = "Google window was closed. Try again.";
    extraTranslations.ru.googlePopupClosed = "Окно Google закрыто. Попробуйте снова.";
    extraTranslations.uz.googlePopupClosed = "Google oynasi yopildi. Qayta urinib ko'ring.";
    extraTranslations.en.weakPassword = "Password must contain at least 6 characters.";
    extraTranslations.ru.weakPassword = "Пароль должен содержать не менее 6 символов.";
    extraTranslations.uz.weakPassword = "Parol kamida 6 ta belgidan iborat bo'lishi kerak.";
    extraTranslations.en.emailAlreadyUsed = "Email is already registered.";
    extraTranslations.ru.emailAlreadyUsed = "Этот email уже зарегистрирован.";
    extraTranslations.uz.emailAlreadyUsed = "Bu email allaqachon ro'yxatdan o'tgan.";
    extraTranslations.en.genreAction = "Action";
    extraTranslations.ru.genreAction = "Боевик";
    extraTranslations.uz.genreAction = "Jangari";
    extraTranslations.en.genreAdventure = "Adventure";
    extraTranslations.ru.genreAdventure = "Приключения";
    extraTranslations.uz.genreAdventure = "Sarguzasht";
    extraTranslations.en.genreComedy = "Comedy";
    extraTranslations.ru.genreComedy = "Комедия";
    extraTranslations.uz.genreComedy = "Komediya";
    extraTranslations.en.genreDrama = "Drama";
    extraTranslations.ru.genreDrama = "Драма";
    extraTranslations.uz.genreDrama = "Drama";
    extraTranslations.en.genreFantasy = "Fantasy";
    extraTranslations.ru.genreFantasy = "Фэнтези";
    extraTranslations.uz.genreFantasy = "Fantastika";
    extraTranslations.en.genreSciFi = "Sci-Fi";
    extraTranslations.ru.genreSciFi = "Научная фантастика";
    extraTranslations.uz.genreSciFi = "Ilmiy fantastika";
    extraTranslations.en.genreThriller = "Thriller";
    extraTranslations.ru.genreThriller = "Триллер";
    extraTranslations.uz.genreThriller = "Triller";
    extraTranslations.en.genreHorror = "Horror";
    extraTranslations.ru.genreHorror = "Ужасы";
    extraTranslations.uz.genreHorror = "Qo'rqinchli";
    extraTranslations.en.genreRomance = "Romance";
    extraTranslations.ru.genreRomance = "Романтика";
    extraTranslations.uz.genreRomance = "Romantika";
    extraTranslations.en.genreAnimation = "Animation";
    extraTranslations.ru.genreAnimation = "Анимация";
    extraTranslations.uz.genreAnimation = "Animatsiya";
    extraTranslations.en.genreDocumentary = "Documentary";
    extraTranslations.ru.genreDocumentary = "Документальный";
    extraTranslations.uz.genreDocumentary = "Hujjatli";
    extraTranslations.en.genreFamily = "Family";
    extraTranslations.ru.genreFamily = "Семейный";
    extraTranslations.uz.genreFamily = "Oila uchun";
// Merge extraTranslations into existing translations
    Object.keys(extraTranslations).forEach(lang => {
        translations[lang] = { ...(translations[lang] || {}), ...extraTranslations[lang] };
    });

    // Fix corrupted Russian translations - comprehensive encoding fix
    if (translations.ru) {
        translations.ru = {
            ...translations.ru,
            detailsTab: "Детали",
            actorsTab: "Актеры",
            ratingTab: "Рейтинг",
            creatorsTab: "Создатели",
            yourRatingTitle: "Твоя оценка",
            ratingImproves: "Оценки улучшают рекомендации",
            directionCheckbox: "Режиссура",
            plotCheckbox: "Сюжет",
            spectacleCheckbox: "Зрелищность",
            actorsCheckbox: "Актёры",
            rateButton: "Оценить",
            whoIsWatching: "Кто смотрит SND?",
            otherAccount: "Войти в другой аккаунт",
            shareSubscription: "Поделиться подпиской",
            thankYouForRating: "Спасибо за оценку!",
            sndRating: "SND рейтинг",
            rateThisMovie: "Оценить фильм",
            directorTitle: "Режиссёр",
            privacyLastUpdated: "Последнее обновление: 23 августа 2025",
            switchAccount: "Сменить аккаунт",
            noSavedAccounts: "Нет сохранённых аккаунтов.",
            navHome: "Главная",
            navFavorites: "Избранное",
            navSupport: "Поддержка",
            navProfile: "Профиль",
            downloads: "Загрузки",
            noDownloads: "Нет загруженных фильмов.",
            downloadAdded: "Фильм добавлен в загрузки",
            downloadStarted: "Началась загрузка. Фильм появится в разделе загрузок",
            downloadCompleted: "Загружено",
            downloadButton: "Скачать",
            offlineMode: "Вы офлайн",
            onlineMode: "Вы онлайн",
            resumeMessage: "Вы остановились ранее. Продолжить просмотр с этого места?",
            resumeYes: "Да",
            resumeNo: "Нет",
            enableResumePrompt: "Показывать запрос продолжения",
            resumePromptHint: "При возврате к фильму спрашивать, хотите ли продолжить с сохранённого места",
            expiresOn: "Действительно до",
            daysLeft: "дней осталось",
            votes: "оценок",
            addProfile: "Добавить профиль",
            addKids: "Добавить детский",
            kidsProfileName: "Детский",
            kidsOnlyMovies: "Только мультфильмы и семейный контент",
            createProfile: "Создать Профиль",
            profileName: "Имя Профиля",
            enterProfileName: "Введите имя...",
            selectAvatar: "Выберите Аватар",
            isKidsProfile: "Детский Профиль (Только Мультфильмы)",
            profileCreated: "Профиль успешно создан!",
            switchToProfile: "Переключиться на",
            editProfile: "Редактировать Профиль",
            deleteProfile: "Удалить Профиль",
            manageProfiles: "Управление Профилями",
            currentProfile: "Текущий Профиль",
            switchAccountConfirm: "Переключиться на этот аккаунт?",
            switchAccountMessage: "Хотите переключиться на",
            confirmYes: "Да, Переключить",
            confirmNo: "Отмена",
            loginNewAccount: "Войти с новым аккаунтом",
            addNewAccount: "Добавить Новый Аккаунт",
            accountSaved: "Аккаунт сохранен!",
            promoCode: "Промокод",
            enterPromoCode: "Введите промокод",
            activatePromo: "Активировать",
            promoCodesList: "Ваши промокоды",
            codeUsed: "Активирован",
            codeUnused: "Не использован",
            copy: "Копировать",
            generateCode: "Создать код",
            noPromoCodes: "Промокодов нет.",
            promoCodeCopied: "Промокод скопирован!",
            supportChatTitle: "Чат поддержки",
            supportChatWaiting: "Пожалуйста, дождитесь подключения оператора.",
            supportChatQueue: "Ваша позиция в очереди:",
            supportChatPlaceholder: "Введите сообщение...",
            supportChatSend: "Отправить",
            supportChatSystem: "Система",
            supportChatAgentPrefix: "Оператор",
            supportChatUserPrefix: "Вы",
            supportChatOperatorQuick: "Оператор",
            supportChatClosed: "Оператор закрыл чат.",
            subscribeStep2: "2. Откройте чат поддержки (напишите 'оператор' в AI-чат) и отправьте свой ID оператору."
        };
    }

    // Fix Uzbek encoding issue
    if (translations.uz) {
        translations.uz.resumeNo = "Yo'q"; // Fix "Yo'q"
        translations.uz.navHome = "Bosh sahifa";
        translations.uz.navFavorites = "Sevimlilar";
        translations.uz.navSupport = "Yordam";
        translations.uz.navProfile = "Profil";
    }

    let isMiniPlayerEnabled = JSON.parse(localStorage.getItem('soundora-miniPlayerEnabled')) ?? true;
    // Whether to display the resume playback prompt when returning to a movie. Default true.
    let isResumePromptEnabled = JSON.parse(localStorage.getItem('soundora-resumePromptEnabled')) ?? true;
    let readNotifications = JSON.parse(localStorage.getItem('soundora-readNotifications')) || [];
    let postLoginRedirect = null;
    let activeVideoElement = null;
    let miniPlayerState = { active: false, state: null };
    let currentHistoryState = null;
    try {
        window.currentHistoryState = currentHistoryState;
    } catch (err) {}
    let playerControlTimeout;
    let isNotificationPanelOpen = false;

    const modalOverlay = document.getElementById('modal-overlay');
    const miniPlayerContainer = document.getElementById('mini-player-container');
    const toastNotification = document.getElementById('toast-notification');
    const notificationPanel = document.getElementById('notification-panel');
    const supportSmsToast = document.getElementById('support-sms-toast');
    const supportSmsToastText = document.getElementById('support-sms-toast-text');
    const supportSmsToastButton = document.getElementById('support-sms-toast-btn');
    const mainEl = document.querySelector('main');
    const loadingOverlay = document.getElementById('loading-overlay');

    supportSmsToastButton?.addEventListener('click', () => {
        window.location.href = 'support.html';
    });

    // Add missing translations
    if (!translations.ru.switchedToAccount) {
        translations.ru.switchedToAccount = "Переключено на";
    }
    if (!translations.uz.switchedToAccount) {
        translations.uz.switchedToAccount = "O'tkazildi";
    }

    let popupTimeout = null;
    let lastShownNotificationId = null; // Oxirgi ko'rsatilgan bildirishnoma ID'si
    let lastNotificationTime = 0; // Oxirgi bildirishnoma ko'rsatilgan vaqt
    const NOTIFICATION_COOLDOWN = 3000; // 3 soniya cooldown (yangi bildirishnoma o'rtasida)

    function showNotificationPopup(notification) {
        console.log('🎉 Showing popup notification:', notification);
        console.log('isInitialAuthCheckDone:', isInitialAuthCheckDone);

        // Check if support notifications are disabled
        if (notification.type === 'chat') {
            const notificationsEnabled = localStorage.getItem('supportNotificationsEnabled') !== 'false';
            if (!notificationsEnabled) {
                console.log('⏭️ Support notifications disabled, skipping');
                return;
            }
        }

        const now = Date.now();

        // Agar bir xil bildirishnoma oldin ko'rsatilgan bo'lsa, qayta ko'rsatmaslik
        if (lastShownNotificationId === notification.id) {
            console.log('⏭️ Skipping duplicate notification:', notification.id);
            return;
        }

        // Cooldown tekshiruvi - oxirgi bildirishnomadan keyin 3 soniya o'tmagan bo'lsa
        if (now - lastNotificationTime < NOTIFICATION_COOLDOWN) {
            console.log('⏰ Notification cooldown active, skipping');
            return;
        }

        // Agar popup allaqachon ko'rsatilgan bo'lsa va bir xil notification kelsa
        let popup = document.getElementById('notification-popup');
        if (popup && !popup.classList.contains('hidden')) {
            console.log('⏭️ Popup already visible, skipping duplicate');
            return;
        }

        lastShownNotificationId = notification.id;
        lastNotificationTime = now;

        popup = document.getElementById('notification-popup');
        const popupContent = document.getElementById('popup-content');
        const posterContainer = document.getElementById('popup-poster-container');
        const poster = document.getElementById('popup-poster');
        const icon = document.getElementById('popup-icon');
        const label = document.getElementById('popup-label');
        const title = document.getElementById('popup-title');
        const desc = document.getElementById('popup-desc');
        const closeBtn = document.getElementById('popup-close');

        if (!popup) {
            console.error('❌ Notification popup element not found!');
            return;
        }

        // Clear any existing timeout
        if (popupTimeout) {
            clearTimeout(popupTimeout);
        }

        const t = translations[currentLanguage] || translations.en;

        // Configure based on notification type
        if (notification.type === 'movie') {
            posterContainer.classList.remove('hidden');
            poster.src = notification.poster || 'https://placehold.co/150x225/8b5cf6/fff?text=Movie';
            icon.className = 'fas fa-film text-white';
            label.textContent = currentLanguage === 'uz' ? 'Yangi Kino' :
                               currentLanguage === 'ru' ? 'Новый Фильм' :
                               'New Movie';
            title.textContent = notification.title || 'New Content';
            desc.textContent = notification.description || t.checkItOut || 'Check it out now!';
            popupContent.className = 'bg-gradient-to-r from-purple-600/95 to-pink-600/95 backdrop-blur-md rounded-xl shadow-2xl p-4 transform -translate-y-4 opacity-0 transition-all duration-500';
        } else if (notification.type === 'chat') {
            posterContainer.classList.add('hidden');
            icon.className = 'fas fa-comments text-white';
            label.textContent = currentLanguage === 'uz' ? 'Support Xabari' :
                               currentLanguage === 'ru' ? 'Сообщение Поддержки' :
                               'Support Message';
            title.textContent = notification.content || 'New message from support';
            desc.textContent = currentLanguage === 'uz' ? 'Bosing va chatni oching' :
                              currentLanguage === 'ru' ? 'Нажмите, чтобы открыть чат' :
                              'Click to open chat';
            popupContent.className = 'bg-gradient-to-r from-blue-600/95 to-cyan-600/95 backdrop-blur-md rounded-xl shadow-2xl p-4 transform -translate-y-4 opacity-0 transition-all duration-500';
        } else {
            posterContainer.classList.add('hidden');
            icon.className = 'fas fa-bell text-white';
            label.textContent = currentLanguage === 'uz' ? 'Admin Xabar' :
                               currentLanguage === 'ru' ? 'Объявление' :
                               'Announcement';
            title.textContent = notification.content || 'New message from admin';
            desc.textContent = '';
            popupContent.className = 'bg-gradient-to-r from-amber-600/95 to-orange-600/95 backdrop-blur-md rounded-xl shadow-2xl p-4 transform -translate-y-4 opacity-0 transition-all duration-500';
        }

        // Show popup with animation
        popup.classList.remove('hidden');
        requestAnimationFrame(() => {
            popupContent.classList.remove('-translate-y-4', 'opacity-0');
            popupContent.classList.add('translate-y-0', 'opacity-100');
        });

        // Click to view notification
        const clickHandler = () => {
            hideNotificationPopup();
            if (notification.type === 'movie' && notification.movieId) {
                navigate({ page: 'movie-details', movieId: notification.movieId });
            } else if (notification.type === 'chat' && notification.chatId) {
                // Remove this chat notification from notifications array
                console.log('🗑️ Removing chat notification after popup click:', notification.id);
                const beforeCount = notifications.length;
                notifications = notifications.filter(n => n.id !== notification.id);
                if (notifications.length < beforeCount) {
                    persistNotifications();
                    updateNotificationDot();
                    console.log(`✅ Removed chat notification, ${notifications.length} notifications remaining`);
                }
                // Navigate to support page with chatId
                navigate({ page: 'support', chatId: notification.chatId });
            } else {
                toggleNotificationPanel();
            }
        };

        popupContent.style.cursor = 'pointer';
        popupContent.addEventListener('click', clickHandler, { once: true });

        // Close button
        closeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            hideNotificationPopup();
        }, { once: true });

        // Auto hide after 5 seconds
        popupTimeout = setTimeout(() => {
            hideNotificationPopup();
            // Move to notification panel
            updateNotificationDot();
        }, 5000);
    }

    function hideNotificationPopup() {
        const popup = document.getElementById('notification-popup');
        const popupContent = document.getElementById('popup-content');

        if (!popup || !popupContent) return;

        popupContent.classList.add('-translate-y-4', 'opacity-0');
        popupContent.classList.remove('translate-y-0', 'opacity-100');

        setTimeout(() => {
            popup.classList.add('hidden');
            lastShownNotificationId = null; // Reset qilamiz, yangi bildirishnoma ko'rsatish uchun
        }, 500);
    }

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), delay);
        };
    }

    async function setupPushNotifications() {
        const isMessagingSupported = await isSupported();
        // Agar brauzer Firebase Messaging'ni qo'llab-quvvatlasa va VAPID kaliti to'g'ri bo'lsa, pushni faollashtiramiz.
        if (isMessagingSupported) {
            try {
                const messaging = getMessaging(app);
                const permission = await Notification.requestPermission();
                // Firebasening ochiq VAPID kaliti konfiguratsiyasi. Uni server funksiyalar orqali (functions.config().push.vapid_key) sozlash mumkin.
                const vapidKey = (typeof functions !== 'undefined' && functions.config().push && functions.config().push.vapid_key)
                    ? functions.config().push.vapid_key
                    : 'YOUR_PUBLIC_VAPID_KEY_FROM_FIREBASE';
                // Agar ruxsat berilgan va kalit haqiqiy bo'lsa, tokenni so'raymiz.
                if (permission === 'granted' && vapidKey && vapidKey !== 'YOUR_PUBLIC_VAPID_KEY_FROM_FIREBASE') {
                    const fcmToken = await getToken(messaging, { vapidKey });
                    if (fcmToken && currentUser) {
                        const userRef = doc(db, "users", currentUser.uid);
                        await updateDoc(userRef, { fcmToken: fcmToken });
                    }
                } else if (permission === 'granted') {
                    console.warn('Push notifications disabled: VAPID key is missing or invalid.');
                }
                onMessage(messaging, (payload) => {
                    console.log('Message received. ', payload);
                    showToast(`${payload.notification.title}: ${payload.notification.body}`);
                });
            } catch (error) {
                console.error('An error occurred while setting up push notifications.', error);
            }
        } else {
            console.log("Firebase Messaging is not supported in this browser.");
        }
    }

    function updateNotificationDot() {
        const unreadExists = notifications.some(n => !readNotifications.includes(n.id));
        const wrapper = document.getElementById('notification-button-wrapper-header');
        if (!wrapper) return;

        let dot = wrapper.querySelector('.notification-dot');
        if (unreadExists && !dot) {
            const newDot = document.createElement('div');
            newDot.className = 'notification-dot';
            wrapper.appendChild(newDot);
        } else if (!unreadExists && dot) {
            dot.remove();
        }
    }

    function persistNotifications() {
        try {
            localStorage.setItem('soundora-notifications', JSON.stringify(notifications));
            console.log('💾 Saved', notifications.length, 'notifications to localStorage');
        } catch (e) {
            console.warn('Failed to persist notifications', e);
        }
    }

    function truncateSupportPreview(text) {
        const fallback = translations[currentLanguage]?.supportNewMessage || 'New support message';
        if (!text) return fallback;
        const trimmed = String(text).trim();
        if (!trimmed) return fallback;
        return trimmed.length > 80 ? `${trimmed.slice(0, 77).trimEnd()}...` : trimmed;
    }

    function normalizeSupportTimestamp(ts) {
        try {
            if (!ts) return new Date().toISOString();
            if (typeof ts.toDate === 'function') return ts.toDate().toISOString();
            if (ts instanceof Date) return ts.toISOString();
            if (typeof ts === 'object' && typeof ts.seconds === 'number') {
                const millis = ts.seconds * 1000 + (ts.nanoseconds || 0) / 1e6;
                return new Date(millis).toISOString();
            }
            if (typeof ts === 'string' || typeof ts === 'number') {
                const date = new Date(ts);
                return isNaN(date.getTime()) ? new Date().toISOString() : date.toISOString();
            }
        } catch (_) {}
        return new Date().toISOString();
    }

    function buildSupportMessageKey(chatId, message, isoTimestamp) {
        const safeIso = isoTimestamp || normalizeSupportTimestamp(message?.timestamp);
        const sender = (message?.sender || '').toString().toLowerCase();
        const content = (message?.content || '').toString();
        return `${chatId}__${safeIso}__${sender}__${content}`;
    }

    function showSupportSmsToast(previewText) {
        if (!supportSmsToast || !supportSmsToastText) return;
        supportSmsToastText.textContent = previewText;
        supportSmsToast.classList.remove('hidden');
        requestAnimationFrame(() => supportSmsToast.classList.add('show'));
        if (supportToastTimeoutId) {
            clearTimeout(supportToastTimeoutId);
        }
        supportToastTimeoutId = setTimeout(() => hideSupportSmsToast(), SUPPORT_TOAST_DURATION);
    }

    function hideSupportSmsToast() {
        if (!supportSmsToast) return;
        supportSmsToast.classList.remove('show');
        if (supportToastTimeoutId) {
            clearTimeout(supportToastTimeoutId);
            supportToastTimeoutId = null;
        }
        setTimeout(() => {
            if (supportSmsToast && !supportSmsToast.classList.contains('show')) {
                supportSmsToast.classList.add('hidden');
            }
        }, 220);
    }

    function getStoredSupportMessageKey(chatId) {
        try {
            return localStorage.getItem(SUPPORT_CHAT_LAST_KEY_PREFIX + chatId);
        } catch (_) {
            return null;
        }
    }

    function storeLastSupportMessageKey(chatId, key) {
        try {
            localStorage.setItem(SUPPORT_CHAT_LAST_KEY_PREFIX + chatId, key);
        } catch (_) {}
    }

    function isSupportAgentMessage(message) {
        const sender = (message?.sender || '').toString().toLowerCase();
        return sender && sender !== 'user';
    }

    function addChatNotification(chatId, message, isoTimestamp, messageKey) {
        const notifId = `chat_${messageKey}`;
        if (!notifications.some(n => n.id === notifId)) {
            const newNotification = {
                id: notifId,
                type: 'chat',
                chatId,
                content: message?.content || '',
                timestamp: isoTimestamp
            };

            notifications.push(newNotification);
            persistNotifications();
            updateNotificationDot();

            // Show popup for new support message - faqat real yangi xabarlar uchun
            console.log('📨 New support message received, showing popup');
            // Birinchi 5 soniya ichida (sahifa yuklanayotganda) popup ko'rsatmaslik
            const pageLoadTime = window.pageLoadTimestamp || Date.now();
            const timeSinceLoad = Date.now() - pageLoadTime;

            if (isInitialAuthCheckDone && timeSinceLoad > 5000) {
                showNotificationPopup(newNotification);
            } else {
                console.log('⏰ Skipping chat popup - page just loaded or auth not done');
            }

            if (isNotificationPanelOpen) {
                renderNotificationPanel();
            }
        }
    }

    function handleSupportChatMessage(chatId, message) {
        if (!message || !isSupportAgentMessage(message)) return;
        const isoTimestamp = normalizeSupportTimestamp(message.timestamp);
        const messageKey = buildSupportMessageKey(chatId, message, isoTimestamp);
        if (lastSupportMessageKey === messageKey) return;
        const storedKey = getStoredSupportMessageKey(chatId);
        if (storedKey === messageKey) {
            lastSupportMessageKey = messageKey;
            return;
        }
        lastSupportMessageKey = messageKey;
        storeLastSupportMessageKey(chatId, messageKey);
        const preview = truncateSupportPreview(message.content);
        showSupportSmsToast(preview);
        addChatNotification(chatId, message, isoTimestamp, messageKey);
    }

    function cleanupSupportChatSubscription() {
        if (supportChatUnsub) {
            supportChatUnsub();
            supportChatUnsub = null;
        }
        activeSupportChatId = null;
        lastSupportMessageKey = null;
        supportChatPrimed = false;
    }

    function ensureSupportChatSubscription(userData) {
        const chatIdCandidate = userData?.customId || userData?.userCustomId || userData?.humanId || userData?.uid || userData?.id;
        if (!chatIdCandidate) {
            cleanupSupportChatSubscription();
            return;
        }
        const chatId = String(chatIdCandidate);
        if (activeSupportChatId === chatId && supportChatUnsub) return;
        cleanupSupportChatSubscription();
        activeSupportChatId = chatId;
        lastSupportMessageKey = getStoredSupportMessageKey(chatId);
        supportChatPrimed = false;
        try {
            const chatRef = doc(db, 'supportChats', chatId);
            supportChatUnsub = onSnapshot(chatRef, (snap) => {
                if (!snap.exists()) return;
                const data = snap.data() || {};
                const messagesArr = Array.isArray(data.messages) ? data.messages : [];
                if (!messagesArr.length) return;
                const lastMessage = messagesArr[messagesArr.length - 1];
                if (!supportChatPrimed) {
                    const primingKey = buildSupportMessageKey(chatId, lastMessage);
                    lastSupportMessageKey = lastSupportMessageKey || primingKey;
                    storeLastSupportMessageKey(chatId, lastSupportMessageKey);
                    supportChatPrimed = true;
                    return;
                }
                handleSupportChatMessage(chatId, lastMessage);
            }, (error) => {
                console.error('Support chat listener error:', error);
            });
        } catch (error) {
            console.error('Failed to subscribe to support chat', error);
        }
    }

    function toggleNotificationPanel() {
        isNotificationPanelOpen = !isNotificationPanelOpen;
        if (isNotificationPanelOpen) {
            renderNotificationPanel();
            notificationPanel.classList.remove('hidden');
        } else {
            notificationPanel.classList.add('hidden');
        }
    }

    function markAllNotificationsAsRead() {
        // Mark all current notifications as read
        readNotifications = notifications.map(n => n.id);
        localStorage.setItem('soundora-readNotifications', JSON.stringify(readNotifications));
        renderNotificationPanel();
        updateNotificationDot();
    }

    // Clean up old admin messages that no longer exist in Firebase
    function cleanupOldAdminMessages() {
        const beforeCount = notifications.length;
        notifications = notifications.filter(n => !n.id || !n.id.startsWith('adminMsg_'));
        const removedCount = beforeCount - notifications.length;
        if (removedCount > 0) {
            console.log(`🧹 Cleaned up ${removedCount} old admin messages from localStorage`);
            persistNotifications();
            updateNotificationDot();
        }
    }

    function formatTimeAgo(dateString) {
        const now = new Date();
        const past = new Date(dateString);
        const seconds = Math.floor((now - past) / 1000);

        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " yil oldin";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " oy oldin";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " kun oldin";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " soat oldin";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " daqiqa oldin";
        return Math.floor(seconds) + " soniya oldin";
    }

    function renderNotificationPanel() {
        if (debugMode) console.log('🔔 Rendering notification panel with', notifications.length, 'notifications');
        const sortedNotifications = [...notifications].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        if (debugMode) {
            console.log('📋 Sorted notifications:', sortedNotifications.map(n => ({
                id: n.id,
                type: n.type,
                content: n.content || n.title,
                alertId: n.alertId,
                audience: n.audience
            })));
        }

        // Calculate dynamic height based on notification count
        const notificationCount = sortedNotifications.length;
        let dynamicHeight = 'auto';
        let maxHeight = '90vh';

        if (notificationCount === 0) {
            dynamicHeight = 'auto';
            maxHeight = '200px';
        } else if (notificationCount === 1) {
            dynamicHeight = 'auto';
            maxHeight = '220px';
        } else if (notificationCount === 2) {
            dynamicHeight = 'auto';
            maxHeight = '320px';
        } else if (notificationCount === 3) {
            dynamicHeight = 'auto';
            maxHeight = '420px';
        } else {
            dynamicHeight = 'auto';
            maxHeight = '70vh';
        }

        // Update panel styling dynamically
        notificationPanel.style.height = dynamicHeight;
        notificationPanel.style.maxHeight = maxHeight;

        let content;
        if (sortedNotifications.length === 0) {
            content = `<p class="text-center text-gray-400 p-8" data-lang-key="noNewNotifications"></p>`;
        } else {
            content = sortedNotifications.map(n => {
                const isRead = readNotifications.includes(n.id);
                const t = translations[currentLanguage] || translations.en;

                // Chat notifications: show support icon and message content
                if (n.type === 'chat') {
                    return `
                        <div class="notification-item p-3 flex items-start gap-3 border-b border-gray-700/50 cursor-pointer hover:bg-gray-700/70 transition-colors ${isRead ? 'opacity-60' : ''}" data-type="chat" data-chat-id="${n.chatId}" data-notification-id="${n.id}">
                            <div class="flex-grow">
                                <p class="text-sm"><strong>${t.support || 'Support'}</strong> — ${n.content}</p>
                                <p class="text-xs text-gray-400 mt-1">${formatTimeAgo(n.timestamp)}</p>
                            </div>
                            ${!isRead ? '<div class="w-2 h-2 bg-red-500 rounded-full mt-2 flex-shrink-0"></div>' : ''}
                        </div>
                    `;
                }

                // Movie promotion notifications
                if (n.type === 'movie') {
                    const poster = n.poster || 'https://placehold.co/150x225/8b5cf6/ffffff?text=Movie';

                    // Audience information for debugging
                    const audienceInfo = n.audience ?
                        (currentLanguage === 'uz' ?
                            (n.audience === 'registered' ? 'Ro\'yxatdan o\'tganlarga' :
                             n.audience === 'unregistered' ? 'Mehmonlarga' :
                             'Hammaga') :
                         currentLanguage === 'ru' ?
                            (n.audience === 'registered' ? 'Зарегистрированным' :
                             n.audience === 'unregistered' ? 'Незарегистрированным' :
                             'Всем') :
                            (n.audience === 'registered' ? 'Registered Users' :
                             n.audience === 'unregistered' ? 'Unregistered Users' :
                             'All Users')) : '';

                    return `
                        <div class="notification-item p-3 flex items-start gap-3 border-b border-gray-700/50 cursor-pointer hover:bg-gray-700/70 transition-colors bg-gradient-to-r from-purple-900/10 to-pink-900/10 ${isRead ? 'opacity-60' : ''}" data-type="movie" data-movie-id="${n.movieId}" data-notification-id="${n.id}">
                            <img src="${poster}" alt="${n.title}" class="w-12 h-16 object-cover rounded-md flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/150x225/8b5cf6/ffffff?text=Movie';">
                            <div class="flex-grow">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="flex items-center gap-2">
                                        <i class="fas fa-film text-purple-400 text-xs"></i>
                                        <p class="text-sm font-semibold text-purple-300">${n.title}</p>
                                    </div>
                                    ${audienceInfo ? `<span class="text-xs text-gray-500 bg-gray-700 px-2 py-1 rounded">${audienceInfo}</span>` : ''}
                                </div>
                                ${n.description ? `<p class="text-xs text-gray-300 mb-1">${n.description}</p>` : ''}
                                <p class="text-xs text-gray-400">${formatTimeAgo(n.timestamp)}</p>
                            </div>
                            ${!isRead ? '<div class="w-2 h-2 bg-purple-500 rounded-full mt-2 flex-shrink-0"></div>' : ''}
                        </div>
                    `;
                }

                // Admin text announcements (both 'admin' and 'text' types)
                if (n.type === 'admin' || n.type === 'text') {
                    const adminLabel = currentLanguage === 'uz' ? 'Admin Xabar' :
                                      currentLanguage === 'ru' ? 'Объявление' :
                                      'Admin Message';

                    // Audience information for debugging
                    const audienceInfo = n.audience ?
                        (currentLanguage === 'uz' ?
                            (n.audience === 'registered' ? 'Ro\'yxatdan o\'tganlarga' :
                             n.audience === 'unregistered' ? 'Mehmonlarga' :
                             'Hammaga') :
                         currentLanguage === 'ru' ?
                            (n.audience === 'registered' ? 'Зарегистрированным' :
                             n.audience === 'unregistered' ? 'Незарегистрированным' :
                             'Всем') :
                            (n.audience === 'registered' ? 'Registered Users' :
                             n.audience === 'unregistered' ? 'Unregistered Users' :
                             'All Users')) : '';

                    return `
                        <div class="notification-item p-3 flex items-start gap-3 border-b border-gray-700/50 cursor-pointer hover:bg-gray-700/70 transition-colors ${isRead ? 'opacity-60' : ''}" data-type="admin" data-notification-id="${n.id}">
                            <div class="flex-shrink-0 w-10 h-10 rounded-full bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                                <i class="fas fa-bell text-white text-sm"></i>
                            </div>
                            <div class="flex-grow">
                                <div class="flex items-center justify-between">
                                    <p class="text-sm font-medium text-amber-300">${adminLabel}</p>
                                    ${audienceInfo ? `<span class="text-xs text-gray-500 bg-gray-700 px-2 py-1 rounded">${audienceInfo}</span>` : ''}
                                </div>
                                <p class="text-sm text-gray-200 mt-0.5">${n.content}</p>
                                <p class="text-xs text-gray-400 mt-1">${formatTimeAgo(n.timestamp)}</p>
                            </div>
                            ${!isRead ? '<div class="w-2 h-2 bg-amber-500 rounded-full mt-2 flex-shrink-0"></div>' : ''}
                        </div>
                    `;
                }

                // Legacy movie notifications (from catalog)
                const movie = movies.find(m => String(m.id) === String(n.movieId));
                if (!movie) return '';
                return `
                    <div class="notification-item p-3 flex items-start gap-3 border-b border-gray-700/50 cursor-pointer hover:bg-gray-700/70 ${isRead ? 'opacity-60' : ''}" data-type="movie" data-movie-id="${n.movieId}" data-notification-id="${n.id}">
                        <img src="${movie.poster}" alt="${movie.title}" class="w-12 h-16 object-cover rounded-md flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/150x225/ef4444/ffffff?text=Error';">
                        <div class="flex-grow">
                            <p class="text-sm">
                                <strong class="font-bold">${movie.title}</strong>
                                <span data-lang-key="${n.messageKey || 'newMovieAdded'}"></span>
                            </p>
                            <p class="text-xs text-gray-400 mt-1">${formatTimeAgo(n.timestamp)}</p>
                        </div>
                        ${!isRead ? '<div class="w-2 h-2 bg-red-500 rounded-full mt-2 flex-shrink-0"></div>' : ''}
                    </div>
                `;
            }).join('');
        }

        notificationPanel.innerHTML = `
            <div class="p-4 flex justify-between items-center border-b border-gray-700 flex-shrink-0">
                <h3 class="font-bold text-lg" data-lang-key="notifications"></h3>
                <button id="close-notifications-btn" class="text-gray-400 hover:text-white text-2xl">×</button>
            </div>
            <div id="notification-list" class="overflow-y-auto" style="flex: 1; min-height: 0;">${content}</div>
            <div class="p-2 border-t border-gray-700 flex justify-between flex-shrink-0">
                <button id="refresh-notifications-btn" class="text-sm text-gray-400 hover:text-white" data-lang-key="refresh"></button>
                <button id="mark-all-read-btn" class="text-sm text-red-500 hover:text-red-400" data-lang-key="markAllAsRead"></button>
            </div>
        `;

        notificationPanel.querySelector('#close-notifications-btn').addEventListener('click', toggleNotificationPanel);
        notificationPanel.querySelector('#mark-all-read-btn').addEventListener('click', markAllNotificationsAsRead);
        notificationPanel.querySelector('#refresh-notifications-btn').addEventListener('click', () => renderNotificationPanel());

        notificationPanel.querySelectorAll('.notification-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const type = e.currentTarget.dataset.type;
                const notificationId = e.currentTarget.dataset.notificationId;
                const chatId = e.currentTarget.dataset.chatId;

                // Mark as read
                if (!readNotifications.includes(notificationId)) {
                    readNotifications.push(notificationId);
                    localStorage.setItem('soundora-readNotifications', JSON.stringify(readNotifications));
                    updateNotificationDot();
                }

                toggleNotificationPanel();

                if (type === 'chat') {
                    // Remove this chat notification from notifications array
                    console.log('🗑️ Removing chat notification:', notificationId);
                    const beforeCount = notifications.length;
                    notifications = notifications.filter(n => n.id !== notificationId);
                    if (notifications.length < beforeCount) {
                        persistNotifications();
                        updateNotificationDot();
                        console.log(`✅ Removed chat notification, ${notifications.length} notifications remaining`);
                    }

                    // Navigate to support page with chatId
                    console.log('📱 Navigating to support page with chatId:', chatId);
                    navigate({ page: 'support', chatId: chatId });
                } else if (type === 'movie') {
                    const movieId = e.currentTarget.dataset.movieId;
                    if (movieId) {
                        navigate({ page: 'movie-details', movieId: movieId });
                    }
                } else if (type === 'admin') {
                    // Admin text notifications - just mark as read (no navigation)
                    return;
                }
            });
        });

        setLanguage(currentLanguage);
    }

    // Support Chat Page Renderer (Exact copy from support.html)
    let supportChatUnsubscribe = null;
    let supportChatId = null;
    let assignedAdminName = null;

    function renderSupportPage(showChat = false) {
        // Clean up all chat notifications when entering support page
        console.log('🧹 Cleaning up chat notifications on support page entry');
        const beforeCount = notifications.length;
        notifications = notifications.filter(n => n.type !== 'chat');
        if (notifications.length < beforeCount) {
            persistNotifications();
            updateNotificationDot();
            console.log(`✅ Removed ${beforeCount - notifications.length} chat notifications`);
        }

        const supportEl = document.getElementById('support');
        if (!supportEl) return '';

        // Show welcome screen by default (showChat = false)
        const chatStarted = showChat;

        supportEl.innerHTML = `
            <style>
                @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
                #support { 
                    color-scheme: dark; 
                    font-family: 'Inter', sans-serif; 
                    background:#0b0b0f;
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    overflow: hidden;
                }
                #support body, #support .no-select, #support .no-select * { -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; }
                #support .msg-text { -webkit-user-select:text; user-select:text; }
                #support img, #support svg { -webkit-touch-callout:none; }
                #support .bubble { position:relative; max-width:85vw; }
                #support .bubble.sent::after { content:''; position:absolute; right:-6px; top:50%; border:6px solid transparent; border-left-color:#3b82f6; transform:translateY(-50%); }
                #support .bubble.recv::after { content:''; position:absolute; left:-6px; top:50%; border:6px solid transparent; border-right-color:#e5e7eb; transform:translateY(-50%); }
                #support .bubble.recv-dark::after { content:''; position:absolute; left:-6px; top:50%; border:6px solid transparent; border-right-color:#3f3f46; transform:translateY(-50%); }
                #support .dots span { display:inline-block; width:6px; height:6px; margin:0 2px; border-radius:9999px; background:#34d399; animation:pulse 1.2s infinite ease-in-out both; }
                #support .dots span:nth-child(2){ animation-delay:.15s }
                #support .dots span:nth-child(3){ animation-delay:.3s }
                @keyframes pulse { 0%,80%,100%{ transform:scale(0.6); opacity:.6 } 40%{ transform:scale(1); opacity:1 } }
                #support-messages::-webkit-scrollbar{ display:none }
                #support-messages{ 
                    scrollbar-width:none;
                    touch-action: pan-y;
                }
                #support .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 12px) }
                #support .menu-item {
                    background: rgba(255,255,255,0.05);
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.1);
                }
                #support .menu-item:active {
                    background: rgba(255,255,255,0.1);
                }
                
                /* Header animations */
                @keyframes headerFadeIn {
                    from {
                        opacity: 0;
                        transform: translateY(-10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                
                @keyframes iconPulse {
                    0%, 100% {
                        transform: scale(1);
                    }
                    50% {
                        transform: scale(1.1);
                    }
                }
                
                .support-header-animated {
                    animation: headerFadeIn 0.5s ease-out;
                }
                
                .support-icon-animated {
                    animation: iconPulse 2s ease-in-out infinite;
                }
            </style>

            <div class="h-screen w-screen flex flex-col" style="background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1e 100%); overflow: hidden;">
                <!-- Header with back button, title and menu -->
                <header class="no-select px-4 py-3 text-white flex items-center shadow flex-shrink-0 support-header-animated" style="background: rgba(20, 20, 35, 0.95); backdrop-filter: blur(10px);">
                    <button id="support-back-btn" class="p-2 -ml-2 text-gray-300 hover:text-white transition-colors" aria-label="Назад">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    
                    <button id="support-profile-btn" class="flex-1 flex items-center space-x-3 hover:opacity-80 transition-opacity">
                        <div class="w-10 h-10 rounded-full flex items-center justify-center cursor-pointer support-icon-animated" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                        </div>
                        <div class="leading-tight text-left">
                            <h1 class="text-base font-bold">Volunteer Support</h1>
                            <p id="support-status" class="text-xs text-gray-400">поддержка</p>
                        </div>
                    </button>

                    <button id="support-menu-btn" class="p-2 -mr-2 text-gray-300 hover:text-white transition-colors" aria-label="Меню">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
                        </svg>
                    </button>
                </header>

                <!-- Menu dropdown (hidden by default) -->
                <div id="support-menu-dropdown" class="hidden absolute top-16 right-4 w-64 rounded-2xl shadow-2xl z-50 overflow-hidden" style="background: rgba(30, 30, 45, 0.98); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1);">
                    <div class="p-2">
                        <button id="support-toggle-notifications-btn" class="menu-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-left">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span class="text-white text-sm">Уведомления</span>
                            <span id="notif-status-indicator" class="ml-auto text-xs text-green-400">Вкл</span>
                        </button>
                        <button id="support-search-btn" class="menu-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-left mt-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                            <span class="text-white text-sm">Поиск</span>
                        </button>
                        <button id="support-send-id-btn" class="menu-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-left mt-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2" />
                            </svg>
                            <span class="text-white text-sm">Отправить ID профиля</span>
                        </button>
                        <button id="support-clear-history-btn" class="menu-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-left mt-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                            <span class="text-white text-sm">Очистить историю</span>
                        </button>
                        <div class="border-t border-gray-700 my-2"></div>
                        <button id="support-delete-block-btn" class="menu-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-left">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                            </svg>
                            <span class="text-red-400 text-sm font-medium">Удалить и заблокировать</span>
                        </button>
                    </div>
                    <div class="px-4 py-2 text-center text-xs text-gray-500" style="background: rgba(0,0,0,0.3);">
                        <p>Вопрос по Telegram?</p>
                    </div>
                </div>

                ${!chatStarted ? `
                <!-- Welcome screen with pattern background and START button -->
                <main id="support-welcome" class="flex-1 flex flex-col items-center justify-center p-6 relative overflow-hidden animate-fadeIn">
                    <!-- Decorative pattern background -->
                    <div class="absolute inset-0 opacity-10">
                        <svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <pattern id="pattern" x="0" y="0" width="60" height="60" patternUnits="userSpaceOnUse">
                                    <circle cx="10" cy="10" r="2" fill="currentColor"/>
                                    <path d="M 20 15 Q 25 10 30 15" stroke="currentColor" fill="none" stroke-width="1.5"/>
                                    <rect x="35" y="5" width="8" height="8" rx="2" fill="currentColor"/>
                                    <circle cx="15" cy="30" r="3" fill="currentColor"/>
                                    <path d="M 40 35 L 45 40 L 40 45 Z" fill="currentColor"/>
                                    <circle cx="25" cy="50" r="2.5" fill="currentColor"/>
                                    <path d="M 5 45 Q 10 40 15 45" stroke="currentColor" fill="none" stroke-width="1.5"/>
                                </pattern>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#pattern)"/>
                        </svg>
                    </div>
                    
                    <!-- Content -->
                    <div class="relative z-10 text-center mb-8 animate-slideIn">
                        <div class="w-20 h-20 mx-auto mb-6 rounded-full flex items-center justify-center animate-pulse" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 10px 40px rgba(102, 126, 234, 0.4);">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="white" class="w-10 h-10">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-white mb-3">Добро пожаловать!</h2>
                        <p class="text-gray-400 text-sm max-w-sm mx-auto">Мы всегда на связи. Начните чат, и мы поможем вам с любыми вопросами.</p>
                    </div>

                    <button id="support-start-btn" class="relative z-10 w-full max-w-sm py-4 rounded-2xl font-bold text-white text-lg shadow-2xl transition-all active:scale-95 hover:shadow-3xl" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        СТАРТ
                    </button>
                </main>
                ` : `
                <!-- Chat interface with fixed header and footer -->
<div class="flex-1 flex flex-col relative" style="overflow: hidden;">
                    <!-- Messages area (scrollable) -->
                    <main id="support-messages" class="flex-1 p-4 space-y-4" style="overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;">
                        <div id="support-loading" class="w-full flex items-center justify-center text-gray-300">
                            <div class="flex items-center space-x-2">
                                <svg class="animate-spin w-4 h-4" viewBox="0 0 24 24">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" class="opacity-25 fill-none"></circle>
                                    <path d="M4 12a8 8 0 0 1 8-8" class="opacity-75" fill="currentColor"></path>
                                </svg>
                                <span>Подключение…</span>
                            </div>
                        </div>
                        <p id="support-typing-indicator" class="text-xs text-green-400 hidden px-4">
                            <span id="support-typing-name">Оператор</span> пишет <span class="dots"><span></span><span></span><span></span></span>
                        </p>
                    </main>

                    <!-- Scroll to bottom button -->
                    <button id="scroll-to-bottom-btn" class="hidden absolute bottom-20 right-4 w-12 h-12 rounded-full shadow-lg transition-all active:scale-95 z-30" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mx-auto text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </button>

                    <!-- Footer -->
                    <footer class="no-select px-3 py-2 flex-shrink-0" style="background: rgba(20, 20, 35, 0.95); backdrop-filter: blur(10px);">
                        <div class="flex items-center space-x-2">
                            <label for="support-image-input" class="p-2 rounded-full text-gray-400 hover:bg-gray-700 transition cursor-pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909M3.75 19.5h16.5A1.5 1.5 0 0 0 21.75 18V6A1.5 1.5 0 0 0 20.25 4.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0z" />
                                </svg>
                                <input id="support-image-input" type="file" class="hidden" multiple accept="image/*">
                            </label>
                            <input id="support-message-input" type="text" placeholder="Сообщение..." class="flex-1 py-3 px-4 rounded-full border border-gray-700 text-white focus:outline-none focus:border-blue-500" style="background: rgba(30, 30, 45, 0.8);">
                            <button id="support-send-btn" class="text-white p-3 rounded-full shadow transition-all active:scale-95" aria-label="Отправить" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.77 59.77 0 0 1 21.485 12 59.77 59.77 0 0 1 3.27 20.875L6 12Zm0 0h7.5" />
                                </svg>
                            </button>
                        </div>
                    </footer>
                </div>
                `}
            </div>
        `;

        // Hide bottom navigation when entering support page
        const bottomNav = document.querySelector('nav');
        if (bottomNav) {
            bottomNav.classList.add('hidden');
        }

        // Scroll to bottom button functionality
        const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');
        const messagesContainer = document.getElementById('support-messages');
        
        if (chatStarted && messagesContainer && scrollToBottomBtn) {
            // Check scroll position and show/hide button
            const checkScrollPosition = () => {
                const isAtBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 100;
                if (isAtBottom) {
                    scrollToBottomBtn.classList.add('hidden');
                } else {
                    scrollToBottomBtn.classList.remove('hidden');
                }
            };

            // Add scroll listener
            messagesContainer.addEventListener('scroll', checkScrollPosition);

            // Scroll to bottom button click handler
            scrollToBottomBtn.addEventListener('click', () => {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            });

            // Initial scroll to bottom on page load
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }

        // Menu toggle handler
        const menuBtn = document.getElementById('support-menu-btn');
        const menuDropdown = document.getElementById('support-menu-dropdown');
        
        menuBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            menuDropdown?.classList.toggle('hidden');
        });

        // Close menu when clicking outside
        document.addEventListener('click', () => {
            menuDropdown?.classList.add('hidden');
        });

        // Toggle notifications handler
        document.getElementById('support-toggle-notifications-btn')?.addEventListener('click', () => {
            const isEnabled = localStorage.getItem('supportNotificationsEnabled') !== 'false';
            localStorage.setItem('supportNotificationsEnabled', !isEnabled);
            const indicator = document.getElementById('notif-status-indicator');
            if (indicator) {
                indicator.textContent = !isEnabled ? 'Вкл' : 'Выкл';
                indicator.className = !isEnabled ? 'ml-auto text-xs text-green-400' : 'ml-auto text-xs text-red-400';
            }
            menuDropdown?.classList.add('hidden');
        });

        // Search handler
        document.getElementById('support-search-btn')?.addEventListener('click', () => {
            const searchTerm = prompt('Введите текст для поиска:');
            if (searchTerm && searchTerm.trim()) {
                const messagesEl = document.getElementById('support-messages');
                if (messagesEl) {
                    const messages = messagesEl.querySelectorAll('.bubble');
                    messages.forEach(msg => msg.style.backgroundColor = '');
                    
                    let found = false;
                    messages.forEach(msg => {
                        if (msg.textContent.toLowerCase().includes(searchTerm.toLowerCase())) {
                            msg.style.backgroundColor = 'rgba(251, 191, 36, 0.3)';
                            if (!found) {
                                msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                found = true;
                            }
                        }
                    });
                    
                    if (!found) {
                        alert('Ничего не найдено');
                    }
                }
            }
            menuDropdown?.classList.add('hidden');
        });

        // Send ID handler
        document.getElementById('support-send-id-btn')?.addEventListener('click', () => {
            if (currentUser && currentUser.customId) {
                const userMessage = `Мой ID профиля: ${currentUser.customId}`;
                sendSupportMessage(userMessage);
                menuDropdown?.classList.add('hidden');
            } else {
                alert('ID профиля не найден');
            }
        });

        // Clear history handler
        document.getElementById('support-clear-history-btn')?.addEventListener('click', async () => {
            if (confirm('Вы уверены, что хотите очистить историю чата? Администратор сможет восстановить её при необходимости.')) {
                try {
                    if (!currentUser) return;
                    
                    // Mark chat as deleted for user
                    const chatRef = doc(db, 'supportChats', currentUser.uid);
                    await updateDoc(chatRef, {
                        deletedByUser: true,
                        deletedAt: serverTimestamp()
                    });
                    
                    localStorage.removeItem('supportChatStarted');
                    menuDropdown?.classList.add('hidden');
                    
                    // Reinitialize support page
                    renderSupportPage();
                } catch (error) {
                    console.error('Error clearing chat history:', error);
                    alert('Ошибка при очистке истории');
                }
            }
        });

        // Delete and block handler
        document.getElementById('support-delete-block-btn')?.addEventListener('click', () => {
            if (confirm('Вы уверены, что хотите удалить и заблокировать этот чат?')) {
                localStorage.removeItem('supportChatStarted');
                if (supportChatUnsubscribe) {
                    supportChatUnsubscribe();
                    supportChatUnsubscribe = null;
                }
                menuDropdown?.classList.add('hidden');
                navigate({ page: 'main' });
            }
        });

        // Start button handler
        const startBtn = document.getElementById('support-start-btn');
        startBtn?.addEventListener('click', () => {
            // Show chat interface (pass true to show chat)
            renderSupportPage(true);
            initializeSupportChat();
        });

        // Support profile button handler
        const supportProfileBtn = document.getElementById('support-profile-btn');
        supportProfileBtn?.addEventListener('click', () => {
            renderSupportProfilePage();
        });

        // Don't auto-initialize - only when START button clicked
        // if (chatStarted) {
        //     initializeSupportChat();
        // }

        // Back button handler
        document.getElementById('support-back-btn')?.addEventListener('click', () => {
            if (supportChatUnsubscribe) {
                supportChatUnsubscribe();
                supportChatUnsubscribe = null;
            }
            // Show bottom navigation again
            const bottomNav = document.querySelector('nav');
            if (bottomNav) {
                bottomNav.classList.remove('hidden');
            }
            navigate({ page: 'main' });
        });

        return ''; // Return empty string to prevent "undefined" being rendered
    }

    let replyToMessage = null; // Global variable to store reply message

    function renderSupportBubble({ sender, content, timestamp, adminName, read, messageId, replyTo }) {
        const messagesEl = document.getElementById('support-messages');
        if (!messagesEl) return;

        const wrap = document.createElement('div');
        const bubble = document.createElement('div');
        const time = timestamp && typeof timestamp.toDate === 'function' ? timestamp.toDate() : (timestamp instanceof Date ? timestamp : new Date());
        const t = time ? time.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

        // Check marks for sent messages (user)
        let checkMarks = '';
        if (sender === 'user') {
            if (read) {
                // Double check (read)
                checkMarks = `<svg class="inline w-4 h-4 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M1 12l4 4L15 6M9 12l4 4L23 6" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>`;
            } else {
                // Single check (sent)
                checkMarks = `<svg class="inline w-4 h-4 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M5 12l5 5L20 7" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>`;
            }
        }

        // Reply preview
        let replyPreview = '';
        if (replyTo) {
            replyPreview = `
                <div class="bg-black/20 border-l-4 border-blue-400 pl-2 py-1 mb-2 rounded text-xs italic opacity-80">
                    <div class="font-semibold">${replyTo.sender === 'user' ? 'Siz' : 'Operator'}</div>
                    <div class="truncate">${replyTo.content}</div>
                </div>
            `;
        }

        let heading = '';
        if (sender === 'user') {
            wrap.className = 'flex justify-end group';
            wrap.dataset.messageId = messageId || Date.now();
            bubble.className = 'bubble sent bg-blue-500 text-white rounded-lg px-3 py-2 relative';
            heading = `<strong>${currentLanguage === 'ru' ? 'Вы' : currentLanguage === 'uz' ? 'Siz' : 'You'}</strong> <span class="ml-2 text-[10px] opacity-80">${t}${checkMarks}</span>`;
            
            // Reply button (appears on hover)
            const replyBtn = `<button class="reply-btn opacity-0 group-hover:opacity-100 absolute -left-8 top-1/2 -translate-y-1/2 bg-gray-700 hover:bg-gray-600 p-1 rounded-full transition" title="Javob berish">
                <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                </svg>
            </button>`;
            bubble.innerHTML = `${replyBtn}${replyPreview}${heading}<div class="msg-text mt-1 leading-relaxed">${content}</div>`;
        } else if (sender === 'admin') {
            wrap.className = 'flex justify-start group';
            wrap.dataset.messageId = messageId || Date.now();
            bubble.className = 'bubble recv bg-gray-200 text-gray-800 rounded-lg px-3 py-2 relative';
            const name = adminName || assignedAdminName || (currentLanguage === 'ru' ? 'Оператор' : currentLanguage === 'uz' ? 'Operator' : 'Operator');
            heading = `<strong>${currentLanguage === 'ru' ? 'Оператор' : currentLanguage === 'uz' ? 'Operator' : 'Operator'}: ${name}</strong> <span class="ml-2 text-[10px] text-gray-500">${t}</span>`;
            
            // Reply button
            const replyBtn = `<button class="reply-btn opacity-0 group-hover:opacity-100 absolute -right-8 top-1/2 -translate-y-1/2 bg-gray-700 hover:bg-gray-600 p-1 rounded-full transition" title="Javob berish">
                <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"/>
                </svg>
            </button>`;
            bubble.innerHTML = `${replyBtn}${replyPreview}${heading}<div class="msg-text mt-1 leading-relaxed">${content}</div>`;
        } else if (sender === 'assistant') {
            wrap.className = 'flex justify-start';
            bubble.className = 'bubble recv-dark bg-zinc-700 text-white rounded-lg px-3 py-2';
            heading = `<strong>${currentLanguage === 'ru' ? 'Помощник' : currentLanguage === 'uz' ? 'Yordamchi' : 'Assistant'}</strong> <span class="ml-2 text-[10px] opacity-70">${t}</span>`;
            bubble.innerHTML = `${heading}<div class="msg-text mt-1 leading-relaxed">${content}</div>`;
        } else {
            wrap.className = 'flex justify-center';
            bubble.className = 'bubble recv-dark bg-zinc-700 text-white rounded-lg px-3 py-2 text-center';
            heading = `<strong>${currentLanguage === 'ru' ? 'Система' : currentLanguage === 'uz' ? 'Tizim' : 'System'}</strong> <span class="ml-2 text-[10px] opacity-70">${t}</span>`;
            bubble.innerHTML = `${heading}<div class="msg-text mt-1 leading-relaxed">${content}</div>`;
        }

        wrap.appendChild(bubble);
        messagesEl.appendChild(wrap);

        // Add reply button click handler
        const replyBtn = bubble.querySelector('.reply-btn');
        if (replyBtn) {
            replyBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                replyToMessage = {
                    sender: sender,
                    content: content,
                    messageId: messageId || Date.now()
                };
                showReplyPreview();
            });
        }
        
        // Auto scroll to bottom
        setTimeout(() => {
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }, 50);
    }

    function showReplyPreview() {
        const inputContainer = document.querySelector('#support-send-btn').parentElement;
        let replyPreviewEl = document.getElementById('reply-preview');
        
        if (!replyPreviewEl && replyToMessage) {
            replyPreviewEl = document.createElement('div');
            replyPreviewEl.id = 'reply-preview';
            replyPreviewEl.className = 'bg-blue-900/30 border-l-4 border-blue-500 px-3 py-2 mb-2 flex items-center justify-between';
            replyPreviewEl.innerHTML = `
                <div class="flex-1">
                    <div class="text-xs text-blue-400 font-semibold">${replyToMessage.sender === 'user' ? 'Sizning xabaringiz' : 'Operator'}</div>
                    <div class="text-sm text-white truncate">${replyToMessage.content}</div>
                </div>
                <button id="cancel-reply" class="ml-2 p-1 hover:bg-white/10 rounded">
                    <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;
            inputContainer.parentElement.insertBefore(replyPreviewEl, inputContainer);
            
            document.getElementById('cancel-reply').addEventListener('click', cancelReply);
        }
    }

    function cancelReply() {
        replyToMessage = null;
        const replyPreviewEl = document.getElementById('reply-preview');
        if (replyPreviewEl) {
            replyPreviewEl.remove();
        }
    }

    function subscribeSupportChat(chatId) {
        const ref = doc(db, 'supportChats', chatId);
        supportChatUnsubscribe = onSnapshot(ref, (snap) => {
            const data = snap.data();
            const messagesEl = document.getElementById('support-messages');
            if (!messagesEl) return;

            messagesEl.innerHTML = '';
            const loadingEl = document.getElementById('support-loading');
            if (loadingEl) loadingEl.remove();

            if (!data) return;

            // Check if user deleted the chat
            if (data.deletedByUser === true) {
                messagesEl.innerHTML = `<p class="text-center text-gray-400 mt-6">${currentLanguage === 'ru' ? 'История чата очищена. Напишите новое сообщение, чтобы начать.' : currentLanguage === 'uz' ? 'Chat tarixi tozalandi. Yangi xabar yozing.' : 'Chat history cleared. Write a new message to start.'}</p>`;
                return;
            }

            assignedAdminName = data.assignedAdminName || data.adminName || assignedAdminName;
            (data.messages || []).forEach(m => renderSupportBubble(m));

            const typing = data.adminTyping === true || data.typingBy === 'admin';
            const typingEl = document.getElementById('support-typing-indicator');
            const typingNameEl = document.getElementById('support-typing-name');
            if (typing && typingEl && typingNameEl) {
                typingNameEl.textContent = assignedAdminName || (currentLanguage === 'ru' ? 'Оператор' : currentLanguage === 'uz' ? 'Operator' : 'Operator');
                typingEl.classList.remove('hidden');
            } else if (typingEl) {
                typingEl.classList.add('hidden');
            }
            
            // Instant scroll to bottom
            setTimeout(() => {
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }, 50);
        }, (err) => {
            console.error('Chat subscribe error', err);
            const messagesEl = document.getElementById('support-messages');
            if (messagesEl) {
                messagesEl.innerHTML = `<p class="text-center text-red-400 mt-6">${currentLanguage === 'ru' ? 'Нет доступа к чату. Проверьте Firestore Rules для supportChats.' : currentLanguage === 'uz' ? 'Chatga kirish mumkin emas. Firestore qoidalarini tekshiring.' : 'No access to chat. Check Firestore Rules for supportChats.'}</p>`;
            }
        });
    }

    async function createOrOpenSupportChat() {
        if (!currentUser) {
            console.warn('No user logged in');
            return null;
        }

        // 1) Load admin-defined ID from users/{uid}
        let humanId = null;
        try {
            const uSnap = await getDoc(doc(db, 'users', currentUser.uid));
            if (uSnap.exists()) {
                const u = uSnap.data() || {};
                humanId = u.customId || u.profileId || u.humanId || null;
            }
        } catch (e) {
            console.warn('Failed to read users profile id', e);
        }

        const chatId = humanId || currentUser.uid;
        supportChatId = chatId;
        const userIdEl = document.getElementById('support-user-id');
        if (userIdEl) {
            userIdEl.textContent = (currentLanguage === 'ru' ? 'Ваш ID: ' : currentLanguage === 'uz' ? 'Sizning ID: ' : 'Your ID: ') + chatId;
        }

        // 2) Create/merge the chat doc *before any read* to avoid rules blocking a get()
        try {
            await setDoc(doc(db, 'supportChats', chatId), {
                userId: currentUser.uid,
                userName: currentUser.displayName || currentUser.email || 'User',
                userCustomId: humanId,
                status: 'open',
                createdAt: serverTimestamp()
            }, { merge: true });
        } catch (e) {
            console.error('Failed to create/open chat', e);
            const messagesEl = document.getElementById('support-messages');
            if (messagesEl) {
                messagesEl.innerHTML = `<p class="text-center text-red-400 mt-6">${currentLanguage === 'ru' ? 'Не удалось создать чат (нет прав на запись).' : currentLanguage === 'uz' ? 'Chat yaratib bolmadi (yozish huquqi yoq).' : 'Failed to create chat (no write permission).'}</p>`;
            }
            throw e;
        }
        return chatId;
    }

    async function sendSupportMessage(text) {
        if (!supportChatId || !text) return;
        const ref = doc(db, 'supportChats', supportChatId);
        
        try {
            // Get current messages
            const chatSnap = await getDoc(ref);
            const currentMessages = chatSnap.exists() ? (chatSnap.data().messages || []) : [];
            
            const messageData = {
                sender: 'user',
                content: text,
                timestamp: new Date(),
                messageId: Date.now().toString(),
                read: false
            };

            // Add reply data if replying to a message
            if (replyToMessage) {
                messageData.replyTo = {
                    sender: replyToMessage.sender,
                    content: replyToMessage.content,
                    messageId: replyToMessage.messageId
                };
            }

            // Append new message to array
            await updateDoc(ref, {
                messages: [...currentMessages, messageData]
            });

            // Clear reply after sending
            if (replyToMessage) {
                cancelReply();
            }
        } catch (error) {
            console.error('Failed to send message:', error);
            throw error;
        }
    }

    async function initializeSupportChat() {
        if (!currentUser) {
            const messagesEl = document.getElementById('support-messages');
            if (messagesEl) {
                messagesEl.innerHTML = `<p class="text-center text-gray-400 mt-6">${currentLanguage === 'ru' ? 'Пожалуйста, войдите, чтобы использовать чат поддержки.' : currentLanguage === 'uz' ? 'Chatdan foydalanish uchun tizimga kiring.' : 'Please log in to use support chat.'}</p>`;
            }
            const inputEl = document.getElementById('support-message-input');
            const sendBtn = document.getElementById('support-send-btn');
            if (inputEl) inputEl.disabled = true;
            if (sendBtn) sendBtn.disabled = true;
            return;
        }

        try {
            const chatId = await createOrOpenSupportChat();
            if (chatId) {
                subscribeSupportChat(chatId);
                // Scroll to bottom immediately after chat loads
                setTimeout(() => {
                    const messagesEl = document.getElementById('support-messages');
                    if (messagesEl) {
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                    }
                }, 200);
            }
            const inputEl = document.getElementById('support-message-input');
            if (inputEl) inputEl.focus();
        } catch (e) {
            console.error('Failed to initialize support chat', e);
        }

        // Send button handler
        const sendBtn = document.getElementById('support-send-btn');
        const inputEl = document.getElementById('support-message-input');

        sendBtn?.addEventListener('click', async () => {
            const text = inputEl?.value.trim();
            if (!text) return;
            try {
                await sendSupportMessage(text);
                if (inputEl) inputEl.value = '';
                const messagesEl = document.getElementById('support-messages');
                if (messagesEl) {
                    setTimeout(() => {
                        messagesEl.scrollTo({
                            top: messagesEl.scrollHeight,
                            behavior: 'smooth'
                        });
                    }, 100);
                }
            } catch (e) {
                console.error('sendMessage failed', e);
                alert(currentLanguage === 'ru' ? 'Не удалось отправить сообщение (нет прав на запись).' : currentLanguage === 'uz' ? 'Xabar yuborib bolmadi (yozish huquqi yoq).' : 'Failed to send message (no write permission).');
            }
        });

        inputEl?.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const text = inputEl.value.trim();
                if (!text) return;
                try {
                    await sendSupportMessage(text);
                    inputEl.value = '';
                    const messagesEl = document.getElementById('support-messages');
                    if (messagesEl) {
                        setTimeout(() => {
                            messagesEl.scrollTo({
                                top: messagesEl.scrollHeight,
                                behavior: 'smooth'
                            });
                        }, 100);
                    }
                } catch (e2) {
                    console.error('sendMessage failed', e2);
                    alert(currentLanguage === 'ru' ? 'Не удалось отправить сообщение (нет прав на запись).' : currentLanguage === 'uz' ? 'Xabar yuborib bolmadi (yozish huquqi yoq).' : 'Failed to send message (no write permission).');
                }
            }
        });
    }

    // Support Profile Page Renderer
    async function renderSupportProfilePage() {
        const supportProfileEl = document.createElement('div');
        supportProfileEl.id = 'support-profile-page';
        supportProfileEl.className = 'fixed inset-0 z-50 flex flex-col';
        supportProfileEl.style.background = 'linear-gradient(180deg, #5b7c99 0%, #2c4556 50%, #1a2633 100%)';

        // Fetch support profile image from Firestore
        let supportImageUrl = '';
        let supportImageElement = '🐥'; // Default emoji
        try {
            const supportDoc = await getDoc(doc(db, 'settings', 'supportProfile'));
            if (supportDoc.exists() && supportDoc.data().imageUrl) {
                supportImageUrl = supportDoc.data().imageUrl;
                supportImageElement = `<img src="${supportImageUrl}" alt="Support" style="width: 100%; max-width: 300px; height: auto; object-fit: contain; filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));">`;
            } else {
                supportImageElement = '<div style="font-size: 200px; line-height: 1; filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));">🐥</div>';
            }
        } catch (err) {
            console.warn('Failed to load support profile image:', err);
            supportImageElement = '<div style="font-size: 200px; line-height: 1; filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3));">🐥</div>';
        }

        supportProfileEl.innerHTML = `
            <style>
                #support-profile-page { 
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                }
                .support-circle-btn {
                    width: 80px;
                    height: 80px;
                    border-radius: 50%;
                    background: rgba(255,255,255,0.2);
                    backdrop-filter: blur(10px);
                    border: none;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                    transition: all 0.2s;
                }
                .support-circle-btn:active {
                    background: rgba(255,255,255,0.3);
                    transform: scale(0.95);
                }
                .support-circle-btn svg {
                    width: 32px;
                    height: 32px;
                }
                .support-circle-btn span {
                    font-size: 13px;
                    font-weight: 500;
                }
                .info-section {
                    background: rgba(0,0,0,0.2);
                    border: 1px solid rgba(255,255,255,0.1);
                    border-radius: 12px;
                    padding: 16px;
                    margin-bottom: 12px;
                }
                .info-label {
                    color: rgba(255,255,255,0.5);
                    font-size: 13px;
                    margin-bottom: 4px;
                }
                .info-value {
                    color: white;
                    font-size: 15px;
                }
                .telegram-card {
                    background: rgba(0,0,0,0.6);
                    border-radius: 16px;
                    overflow: hidden;
                }
                .character-image {
                    width: 100%;
                    max-width: 400px;
                    height: auto;
                    object-fit: contain;
                    margin-top: -20px;
                }
            </style>

            <!-- Header with back, profile circle, and menu -->
            <div class="flex items-center justify-between px-4 py-3">
                <button id="support-profile-back-btn" class="p-2 -ml-2 text-white hover:opacity-80 transition-opacity">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                
                <!-- Center Profile Circle -->
                <div class="w-24 h-24 rounded-full border-4 border-white/30 overflow-hidden flex items-center justify-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    ${supportImageUrl ? `<img src="${supportImageUrl}" alt="Support" class="w-full h-full object-cover">` : `
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    `}
                </div>
                
                <button class="p-2 -mr-2 text-white hover:opacity-80 transition-opacity">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
                    </svg>
                </button>
            </div>

            <!-- Main Content Area -->
            <div class="flex-1 flex flex-col px-6 overflow-y-auto">
                <!-- Title Section -->
                <div class="text-center mb-6">
                    <h1 class="text-2xl font-bold text-white mb-1">Volunteer Support</h1>
                    <p class="text-sm text-white/70">support</p>
                </div>

                <!-- Three Square Sections -->
                <div class="flex items-center justify-center gap-4 mb-6">
                    <button id="support-chat-btn" class="w-20 h-20 rounded-xl border-2 border-red-500/50 bg-black/30 flex items-center justify-center hover:bg-black/50 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white/70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                    </button>
                    <button id="support-notification-btn" class="w-20 h-20 rounded-xl border-2 border-red-500/50 bg-black/30 flex items-center justify-center hover:bg-black/50 transition relative">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white/70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <div id="notification-status-indicator" class="absolute top-1 right-1 w-3 h-3 rounded-full bg-green-500"></div>
                    </button>
                    <button class="w-20 h-20 rounded-xl border-2 border-red-500/50 bg-black/30 flex items-center justify-center hover:bg-black/50 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white/70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </button>
                </div>

                <!-- Bio Section -->
                <div class="info-section">
                    <div class="info-label">Bio</div>
                    <div class="info-value">Professional support specialist dedicated to helping you.</div>
                </div>

                <!-- Phone Section -->
                <div class="info-section cursor-pointer" id="phone-section">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="info-label">Telefon</div>
                            <div class="info-value" id="phone-number">+210 777</div>
                        </div>
                        <button id="copy-phone-btn" class="p-2 hover:bg-white/10 rounded-lg transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white/50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                    </div>
                </div>

            </div>
        `;

        document.body.appendChild(supportProfileEl);

        // Back button handler
        document.getElementById('support-profile-back-btn')?.addEventListener('click', () => {
            supportProfileEl.remove();
        });

        // Chat button handler - return to support chat
        document.getElementById('support-chat-btn')?.addEventListener('click', () => {
            supportProfileEl.remove();
            // Already on support page, just close profile
        });

        // Sound button handler - toggle notification sounds
        document.getElementById('support-sound-btn')?.addEventListener('click', () => {
            const currentState = localStorage.getItem('supportSoundEnabled') !== 'false';
            const newState = !currentState;
            localStorage.setItem('supportSoundEnabled', String(newState));
            
            const soundBtn = document.getElementById('support-sound-btn');
            if (soundBtn) {
                if (newState) {
                    soundBtn.style.background = 'rgba(34, 197, 94, 0.3)'; // Green tint
                    showToast(currentLanguage === 'ru' ? 'Звук включен' : currentLanguage === 'uz' ? 'Ovoz yoqildi' : 'Sound enabled');
                } else {
                    soundBtn.style.background = 'rgba(239, 68, 68, 0.3)'; // Red tint
                    showToast(currentLanguage === 'ru' ? 'Звук выключен' : currentLanguage === 'uz' ? 'Ovoz ochirildi' : 'Sound disabled');
                }
            }
        });

        // Stop button handler - clear chat history and return
        document.getElementById('support-stop-btn')?.addEventListener('click', () => {
            if (confirm(currentLanguage === 'ru' ? 'Вы уверены, что хотите остановить поддержку и очистить историю?' : currentLanguage === 'uz' ? 'Qo\'llab-quvvatlashni to\'xtatib, tarixni tozalashni xohlaysizmi?' : 'Are you sure you want to stop support and clear history?')) {
                localStorage.removeItem('supportChatStarted');
                if (supportChatUnsubscribe) {
                    supportChatUnsubscribe();
                    supportChatUnsubscribe = null;
                }
                supportProfileEl.remove();
                navigate({ page: 'main' });
            }
        });

        // Event handlers for support profile buttons
        const chatBtn = supportProfileEl.querySelector('#support-chat-btn');
        const notificationBtn = supportProfileEl.querySelector('#support-notification-btn');
        const copyPhoneBtn = supportProfileEl.querySelector('#copy-phone-btn');

        // Chat button - close profile and return to support chat
        if (chatBtn) {
            chatBtn.addEventListener('click', () => {
                navigate({ page: 'support' });
            });
        }

        // Notification toggle button
        if (notificationBtn) {
            const notificationEnabled = localStorage.getItem('supportNotificationsEnabled') !== 'false'; // Default true
            const indicator = supportProfileEl.querySelector('#notification-status-indicator');
            
            // Set initial state
            if (indicator) {
                indicator.classList.toggle('bg-green-500', notificationEnabled);
                indicator.classList.toggle('bg-red-500', !notificationEnabled);
            }
            
            notificationBtn.addEventListener('click', () => {
                const currentState = localStorage.getItem('supportNotificationsEnabled') !== 'false';
                const newState = !currentState;
                localStorage.setItem('supportNotificationsEnabled', newState.toString());
                
                // Update indicator
                if (indicator) {
                    indicator.classList.toggle('bg-green-500', newState);
                    indicator.classList.toggle('bg-red-500', !newState);
                }
                
                // Show toast
                const message = newState ? 'Bildirishnomalar yoqildi' : 'Bildirishnomalar o\'chirildi';
                showToast(message);
            });
        }

        // Copy phone number button
        if (copyPhoneBtn) {
            copyPhoneBtn.addEventListener('click', async () => {
                const phoneNumber = supportProfileEl.querySelector('#phone-number').textContent;
                try {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(phoneNumber);
                        showToast('Telefon raqam nusxalandi');
                    } else {
                        // Fallback for older browsers
                        const textarea = document.createElement('textarea');
                        textarea.value = phoneNumber;
                        textarea.style.position = 'fixed';
                        textarea.style.opacity = '0';
                        document.body.appendChild(textarea);
                        textarea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textarea);
                        showToast('Telefon raqam nusxalandi');
                    }
                } catch (err) {
                    console.error('Failed to copy:', err);
                    showToast('Nusxalashda xatolik');
                }
            });
        }

        return supportProfileEl;
    }

    const pageRenderers = {
        'main': renderMainPage,
        'movie-details': renderMovieDetailsPage,
        'player': renderPlayerPage,
        'favorites': renderFavoritesPage,
        'support': renderSupportPage,
        'profile': renderProfilePage,
        'guest-profile': renderGuestProfilePage,
        'login': renderLoginPage,
        'register': renderRegisterPage,
        'genre-survey': renderGenreSurveyPage,
        'settings': renderSettingsPage,
        'edit-profile': renderEditProfilePage,
        'language-settings': renderLanguageSettingsPage,
        'content-settings': renderContentSettingsPage,
        'playback-settings': renderPlaybackSettingsPage,
        'privacy-policy': renderPrivacyPolicyPage,
        'faq': renderFaqPage,
        'premium': renderPremiumPage,
        'downloads': renderDownloadsPage,
        'region-settings': renderRegionSettingsPage,
    };

    function showPage(pageId) {
        document.querySelectorAll('main > div, #player').forEach(div => {
            div.classList.add('hidden');
        });

        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.remove('hidden');
        }

        updateActiveNav(pageId);
        const header = document.querySelector('header');
        if (header) {
            header.classList.toggle('hidden', pageId !== 'main');
        }

        // Ensure bottom navigation visibility is consistent.
        // The support page intentionally hides the bottom nav (chat input/footer).
        // Other pages should show the bottom navigation again when navigated to.
        const bottomNav = document.querySelector('nav');
        if (bottomNav) {
            // Hide nav only for the support page; show for all other pages
            bottomNav.classList.toggle('hidden', pageId === 'support');
        }
        window.scrollTo(0, 0);
    }

    function processNavigation(newState, push = true) {
        const leavingPlayerPage = currentHistoryState?.page === 'player';
        const leavingMoviePage = currentHistoryState?.page === 'movie-details';

        // If leaving the movie details page, pause the inline video to prevent audio playing in the background
        if (leavingMoviePage) {
            const cardVideoEl = document.getElementById('card-video');
            if (cardVideoEl && !cardVideoEl.paused) {
                try {
                    // Save current playback position when leaving
                    const movieId = currentHistoryState?.movieId;
                    if (movieId) {
                        localStorage.setItem(`soundora-play-position-${movieId}`, cardVideoEl.currentTime);
                    }
                    cardVideoEl.pause();
                } catch (err) {}
            }
        }

        if (leavingPlayerPage) {
            document.getElementById('player')?.classList.remove('fullscreen-active');
            if (isMiniPlayerEnabled && activeVideoElement) {
                showMiniPlayer(currentHistoryState);
            } else if (activeVideoElement) {
                activeVideoElement.pause();
                activeVideoElement.remove();
                activeVideoElement = null;
            }
        }

        if (newState.page === 'player' && miniPlayerState.active) {
            hideMiniPlayer(false);
        }

        if (push) {
            const stateToPush = { ...newState };
            if (stateToPush.movieId) stateToPush.movieId = String(stateToPush.movieId);

            if (stateToPush.page === 'main') {
                history.replaceState(stateToPush, '', `#${stateToPush.page}`);
            } else {
                history.pushState(stateToPush, '', `#${stateToPush.page}`);
            }
        }

        currentHistoryState = newState;
        try {
            window.currentHistoryState = currentHistoryState;
        } catch (err) {}
        renderPage(newState);
        // Persist last navigation state for offline restore
        try {
            localStorage.setItem('soundora-lastState', JSON.stringify(newState));
        } catch (err) {
            console.error('Error saving last state', err);
        }
    }

    function navigate(state, push = true) {
        const protectedPages = ['profile', 'favorites', 'downloads', 'settings', 'edit-profile', 'language-settings', 'content-settings', 'playback-settings', 'premium'];
        if (!currentUser && protectedPages.includes(state.page)) {
            if(state.page === 'profile') {
                processNavigation({ page: 'guest-profile' }, push);
            } else {
                postLoginRedirect = state;
                processNavigation({ page: 'login' }, push);
            }
        } else {
            processNavigation(state, push);
        }
    }

    function renderPage(state) {
        state = state || { page: 'main' };
        const renderer = pageRenderers[state.page];
        if (renderer) {
            const pageContainer = document.getElementById(state.page);
            if (pageContainer) {
                if (movies.length > 0 || !['main', 'favorites'].includes(state.page)) {
                    // Support page handles its own innerHTML, don't overwrite
                    if (state.page === 'support') {
                        // Always show welcome screen when navigating to support page
                        renderer(false);
                    } else {
                        pageContainer.innerHTML = renderer(state);
                    }
                }
                showPage(state.page);
                setupPageEventListeners(state);
                setLanguage(currentLanguage);
            }
        }
    }

    function renderMainPage() {
        // Construct hero slides from localStorage or fall back to featured movies
        let slidesData = [];
        try {
            const stored = JSON.parse(localStorage.getItem('heroSlides') || '[]');
            if (Array.isArray(stored) && stored.length > 0) {
                const now = Date.now();
                slidesData = stored.map(hs => {
                    // Skip expired slides
                    if (hs.expiry && Number(hs.expiry) < now) return null;
                    const movie = movies.find(m => String(m.id) === String(hs.movieId));
                    if (!movie) return null;
                    const imageUrl = hs.imageUrl || '';
                    return { movie, imageUrl };
                }).filter(Boolean);
            }
        } catch (e) {
            console.warn('Failed to parse heroSlides from storage', e);
        }
        // Determine hero count (default 5) from localStorage; ensure within 1—10
        let heroCount = 5;
        const storedCount = localStorage.getItem('heroCount');
        if (storedCount && !isNaN(parseInt(storedCount))) {
            const cnt = parseInt(storedCount);
            heroCount = Math.min(Math.max(cnt, 1), 10);
        }
        // If slides exist, slice to heroCount; else fall back to featured or first movies
        let heroMovies;
        if (slidesData.length > 0) {
            heroMovies = slidesData.slice(0, heroCount).map(item => item);
        } else {
            const featured = movies.filter(m => m.isFeatured).sort((a, b) => {
                const ta = (a.createdAt && typeof a.createdAt.toDate === 'function') ? a.createdAt.toDate().getTime() : 0;
                const tb = (b.createdAt && typeof b.createdAt.toDate === 'function') ? b.createdAt.toDate().getTime() : 0;
                return tb - ta;
            });
            const fallback = featured.length > 0 ? featured : movies;
            heroMovies = fallback.slice(0, heroCount).map(m => ({ movie: m, imageUrl: '' }));
        }
        if (heroMovies.length === 0 && movies.length > 0) {
            heroMovies = [ { movie: movies[0], imageUrl: '' } ];
        }
        // Build hero slides HTML
        const slidesHtml = heroMovies.map((item, idx) => {
            const m = item.movie || item;
            const imgMobile = m.heroImageMobile || m.heroImage || m.poster || '';
            const imgDesktop = m.heroImageDesktop || m.heroImage || m.poster || '';
            const defaultImg = (window.innerWidth >= 768) ? imgDesktop : imgMobile;
            const custom = item.imageUrl && item.imageUrl.trim() !== '' ? item.imageUrl : defaultImg;
            return `<div class="home-hero flex-shrink-0 w-full snap-start relative" style="--hero-img:url('${custom}'); background-image: url('${custom}'); background-size: cover; background-position: center; background-repeat: no-repeat;">
                <div class="hero-gradient"></div>
                <a href="#" class="absolute inset-0 hero-slide-link" data-movie-id="${m.id}"></a>
            </div>`;
        }).join('');
        // Build dots for hero slider
        const dotsHtml = heroMovies.map((_, i) => `<span class="dot ${i === 0 ? 'active' : ''}"></span>`).join('');
        const topNavItems = `
            <span class="top-nav-item active" data-section="home">Home</span>
            <span class="top-nav-item" data-section="series">Series</span>
            <span class="top-nav-item" data-section="movies">Movies</span>
            <span class="top-nav-item" data-section="snd">SND</span>
            <span class="top-nav-item" data-section="sports">Sports</span>
            <span class="top-nav-item" data-section="challenges">Challenges</span>
        `;

        return `
            <section id="main" class="container mx-auto">
                <!-- HERO WRAPPER -->
                <div id="home-hero-wrapper" class="relative" style="height:75vh;max-height:820px;overflow:hidden;">
                    <!-- Overlay: Top bar and text nav -->
                    <div class="absolute inset-0 z-30 flex flex-col pointer-events-none">
                        <div class="h-12 sm:h-16 pointer-events-none"></div>
                        <div class="top-text-nav flex px-4 sm:px-6 pb-3 space-x-4 overflow-x-auto text-sm font-semibold pointer-events-auto" style="position: relative; z-index: 50;">
                            <!-- Keep top navigation visible over the hero banner -->
                            ${topNavItems}
                        </div>
                    </div>
                    <!-- Slider container -->
                    <div id="hero-slider" class="overflow-x-auto flex snap-x snap-mandatory scroll-smooth w-full relative h-full">
                        ${slidesHtml}
                        <!-- Hero dots positioned at bottom of slider -->
                        <div class="flex justify-center gap-2 hero-dots absolute bottom-4 left-0 right-0 z-40 pointer-events-none">
                            ${dotsHtml}
                        </div>
                    </div>
                </div>
                <!-- Secondary top navigation used when the hero is collapsed -->
                <div id="secondary-top-nav" class="top-text-nav hidden px-4 sm:px-6 space-x-4 overflow-x-auto text-sm font-semibold sticky top-0 z-30 bg-gray-900/80 backdrop-blur rounded-xl py-3" style="margin-top: 1.5rem;">
                    ${topNavItems}
                </div>
                <!-- CATEGORIES / SEARCH + GRID -->
                <div id="main-grid-wrapper" class="relative z-10 transition-all duration-300" style="padding: 0 1rem; margin-top: 1.25rem;">
                    <div class="flex items-center justify-between mb-3">
                        <h2 id="main-section-heading" class="text-xl sm:text-2xl font-bold">Featured</h2>
                    </div>
                    <div id="category-nav" class="flex items-center space-x-2 overflow-x-auto pb-4"></div>
                    <div id="sports-category-wrapper" class="hidden mt-6">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4">Sports Categories</h2>
                        <div id="sports-category-grid" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
                    </div>
                    <!-- Search bar for filtering current section -->
                    <div id="section-search-wrapper" class="mb-4 hidden">
                        <div class="relative text-gray-400 focus-within:text-gray-600">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i class="fas fa-search"></i></span>
                            <input type="text" id="movie-search-input" class="w-full bg-gray-700 text-white placeholder-gray-400 rounded-md py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-red-600" placeholder="${translations[currentLanguage]?.searchPlaceholder || 'Search'}">
                        </div>
                    </div>
                    <div id="movies-grid" class="grid gap-3 mt-4" style="grid-template-columns: repeat(2, minmax(0, 1fr));"></div>
                </div>
            </section>
        `;
    }

    function renderMovieDetailsPage(state) {
        const movie = movies.find(m => String(m.id) === String(state.movieId));
        if (!movie) {
            return `<div class="flex items-center justify-center h-screen"><i class="fas fa-spinner fa-spin text-white text-4xl"></i></div>`;
        }
        // Encode the movie title for use in a URL when linking to the ticket-purchase page.
        const movieIdStr = String(movie.id);
        let ratingCount = 0;
        // Compute average SND rating and vote count from localStorage if not already set on the movie
        try {
            const ratingsData = JSON.parse(localStorage.getItem('soundora-ratings')) || {};
            let totalRating = 0;
            for (const uid in ratingsData) {
                const val = ratingsData[uid]?.[movieIdStr];
                if (val) {
                    totalRating += val;
                    ratingCount++;
                }
            }
            {
                // Always compute the SND rating based on all user ratings to ensure consistency across profiles.
                const avgVal = ratingCount > 0 ? (totalRating / ratingCount) : 0;
                movie.sndRating = ratingCount > 0 ? avgVal.toFixed(1) : '0.0';
                movie.sndVotes = ratingCount;
            }
        } catch (err) {
            // If parsing fails, leave defaults
        }
        const aspectTotals = { direction: 0, plot: 0, spectacle: 0, actors: 0 };
        let aspectPercentages = { direction: 0, plot: 0, spectacle: 0, actors: 0 };
        try {
            const aspectData = JSON.parse(localStorage.getItem('soundora-rating-aspects')) || {};
            for (const uid in aspectData) {
                const entry = aspectData[uid]?.[movieIdStr];
                if (!entry) continue;
                if (entry.direction) aspectTotals.direction += 1;
                if (entry.plot) aspectTotals.plot += 1;
                if (entry.spectacle) aspectTotals.spectacle += 1;
                if (entry.actors) aspectTotals.actors += 1;
            }
            aspectPercentages = {
                direction: ratingCount > 0 ? Math.round((aspectTotals.direction / ratingCount) * 100) : 0,
                plot: ratingCount > 0 ? Math.round((aspectTotals.plot / ratingCount) * 100) : 0,
                spectacle: ratingCount > 0 ? Math.round((aspectTotals.spectacle / ratingCount) * 100) : 0,
                actors: ratingCount > 0 ? Math.round((aspectTotals.actors / ratingCount) * 100) : 0
            };
        } catch (err) {
            // Ignore aspect calculation failures
        }
        movie.aspectScores = aspectPercentages;
        // Quality tags and premium tag
        const qualityTags = movie.qualities && Array.isArray(movie.qualities)
            ? movie.qualities.map(q => `<div class="bg-black/50 text-white text-xs font-bold px-2 py-1 rounded-md">${q}</div>`).join('')
            : (movie.sources ? Object.keys(movie.sources).filter(s => movie.sources[s]).map(q => `<div class="bg-black/50 text-white text-xs font-bold px-2 py-1 rounded-md">${q}</div>`).join('') : '');

        const premiumTag = movie.isPremium
            ? `<div class="bg-gradient-to-r from-amber-500 to-yellow-400 text-white text-xs font-bold px-2 py-1 rounded-md" data-lang-key="premium"></div>`
            : `<div class="bg-green-600 text-white text-xs font-bold px-2 py-1 rounded-md" data-lang-key="free"></div>`;

        const isFavorited = currentUser?.favorites?.includes(movie.id);

        // Determine autoplay source (prefer higher quality)
        let autoPlayUrl = '';
        if (movie.sources) {
            const qualityOrder = ['1080p', '720p', '480p'];
            for (const q of qualityOrder) {
                if (movie.sources[q]) {
                    autoPlayUrl = movie.sources[q];
                    break;
                }
            }
        }
        const cardMedia = autoPlayUrl
            ? `<video id="card-video" class="w-full h-full object-cover" poster="${movie.poster || ''}" autoplay playsinline>
                    <source src="${autoPlayUrl}" type="video/mp4">
               </video>`
            : `<img src="${movie.poster || 'https://placehold.co/800x450/1f2937/ffffff?text=No+Image'}" onerror="this.onerror=null;this.src='https://placehold.co/800x450/ef4444/ffffff?text=Error';" alt="${movie.title}" class="w-full h-full object-cover">`;

        // Build the info grid (ratings, duration, country, studio, year, language). Likes/dislikes removed; SND rating shown next to IMDb rating.
        const imdbVal = movie.rating?.split('/') && movie.rating?.split('/')[0] ? movie.rating.split('/')[0] : 'N/A';
        const sndVal = typeof movie.sndRating === 'number' ? movie.sndRating.toFixed(1) : (movie.sndRating || '0.0');
        const durationVal = movie.duration?.split(' ') && movie.duration.split(' ')[0] ? movie.duration.split(' ')[0] : '-';
        const infoGrid = `
            <div class="my-4 p-3 bg-gray-800/50 rounded-lg flex flex-col space-y-3 text-xs">
                <!-- Rating row: IMDb, SND and duration side by side -->
                <div class="flex justify-around text-center">
                    <div class="flex flex-col items-center">
                        <span class="font-bold text-lg text-yellow-400">${imdbVal}</span>
                        <span>IMDB</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="font-bold text-lg text-red-500">${sndVal}</span>
                        <span>SND</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="font-bold text-lg">${durationVal}</span>
                        <span data-lang-key="duration"></span>
                    </div>
                </div>
                <!-- Additional info row: country, studio, year, language -->
                <div class="flex flex-wrap justify-around gap-x-4 gap-y-2 text-center">
                    <div class="flex items-center gap-1">
                        <i class="fas fa-globe text-lg text-gray-300"></i><span>${movie.country || ''}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <i class="fas fa-video text-lg text-gray-300"></i><span>${movie.studio || 'N/A'}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <i class="fas fa-calendar-alt text-lg text-gray-300"></i><span>${movie.year || ''}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <i class="fas fa-language text-lg text-gray-300"></i><span>${movie.language || ''}</span>
                    </div>
                </div>
            </div>`;

        // Series controls (mobile only) for series type
        const seriesControls = (movie.type === 'series' && Array.isArray(movie.episodes)) ? `
            <div id="series-controls-container" class="block md:hidden mb-4">
                <div id="season-row" class="flex gap-2 overflow-x-auto mb-3"></div>
                <div id="range-row" class="flex gap-2 overflow-x-auto mb-3"></div>
                <div id="episode-row" class="grid grid-cols-5 gap-2"></div>
            </div>
        ` : '';

        // Info tabs row
        const infoTabs = `
            <div id="info-tabs" class="flex gap-2 mb-4">
                <button class="info-tab-btn active px-4 py-2 rounded-lg bg-gray-800 text-white hover:bg-red-600 transition-colors" data-tab="description" data-lang-key="description"></button>
                <button class="info-tab-btn px-4 py-2 rounded-lg bg-gray-800 text-white hover:bg-red-600 transition-colors" data-tab="actors" data-lang-key="actorsTab"></button>
                <button class="info-tab-btn px-4 py-2 rounded-lg bg-gray-800 text-white hover:bg-red-600 transition-colors" data-tab="rating" data-lang-key="ratingTab"></button>
            </div>`;
        const computeInitials = (name) => {
            const cleaned = String(name || '').trim();
            if (!cleaned) return 'SND';
            const initials = cleaned.split(' ').filter(Boolean).map(part => part[0]).join('').slice(0, 2).toUpperCase();
            return initials || 'SND';
        };
        const castEntriesRaw = Array.isArray(movie.cast)
            ? movie.cast.map((member) => {
                if (typeof member === 'string') {
                    return { name: member, role: '', photo: '' };
                }
                if (member && typeof member === 'object') {
                    return {
                        name: member.name || member.fullName || member.title || '',
                        role: member.role || member.character || member.job || '',
                        photo: member.photo || member.image || member.avatar || ''
                    };
                }
                return null;
            }).filter(member => member && member.name)
            : [];
        const parseNameCollection = (value) => {
            const results = [];
            const appendFromString = (str) => {
                String(str || '')
                    .split(/[;,/]/)
                    .map(part => part.trim())
                    .filter(Boolean)
                    .forEach((part) => results.push(part));
            };
            if (Array.isArray(value)) {
                value.forEach((entry) => {
                    if (typeof entry === 'string') {
                        appendFromString(entry);
                    } else if (entry && typeof entry === 'object') {
                        appendFromString(entry.name || entry.fullName || entry.title || '');
                    }
                });
            } else if (typeof value === 'string') {
                appendFromString(value);
            }
            return results;
        };
        const peopleRegistry = new Map();
        const registerPerson = ({ name, photo, badgeKey, subtitle, type }) => {
            const safeName = String(name || '').trim();
            if (!safeName) return;
            const key = safeName.toLowerCase();
            const existing = peopleRegistry.get(key);
            if (existing) {
                if (badgeKey && !existing.badges.includes(badgeKey)) {
                    existing.badges.push(badgeKey);
                }
                if (!existing.subtitle && subtitle) {
                    existing.subtitle = subtitle;
                }
                if (!existing.photo && photo) {
                    existing.photo = photo;
                }
                if (type && !existing.types.includes(type)) {
                    existing.types.push(type);
                }
                return;
            }
            peopleRegistry.set(key, {
                name: safeName,
                photo: (photo || '').trim(),
                badges: badgeKey ? [badgeKey] : [],
                subtitle: subtitle || '',
                types: type ? [type] : []
            });
        };
        parseNameCollection(movie.directors || movie.director || '').forEach((name) => registerPerson({ name, badgeKey: 'directorTitle', type: 'director' }));
        parseNameCollection(movie.creators || movie.producer || movie.showrunner || movie.writer || movie.writers || '').forEach((name) => registerPerson({ name, badgeKey: 'creatorsTab', type: 'creator' }));
        castEntriesRaw.forEach((member) => registerPerson({ name: member.name, photo: member.photo, subtitle: member.role, type: 'cast' }));
        const castPeople = Array.from(peopleRegistry.values());
        const renderBadge = (badgeKey) => `<span class="snd-cast-badge" data-lang-key="${badgeKey}"></span>`;
        const renderPersonCard = (person) => {
            const safePhoto = person.photo ? person.photo.replace(/"/g, '"') : '';
            const badgesHtml = person.badges && person.badges.length
                ? `<div class="snd-cast-badges mt-2 flex flex-wrap justify-center gap-1">${person.badges.map(renderBadge).join('')}</div>`
                : '';
            const subtitleHtml = person.subtitle ? `<p class="text-xs text-gray-400 mt-1">${person.subtitle}</p>` : '';
            return `
                        <button type="button" class="snd-cast-card bg-gray-900/60 hover:bg-gray-800/70 rounded-2xl p-4 flex flex-col items-center text-center transition transform hover:-translate-y-1 focus:outline-none focus:ring-2 focus:ring-red-500"
                                data-person-name="${person.name.replace(/"/g, '"')}" data-person-types="${person.types.join(',')}">
                            <div class="w-20 h-20 rounded-full overflow-hidden bg-gray-800 flex items-center justify-center ring-2 ring-gray-700 flex-shrink-0">
                                ${safePhoto
                                    ? `<img src="${safePhoto}" alt="${person.name}" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/160x160/111827/ffffff?text=SND';">`
                                    : `<span class="text-red-400 font-semibold text-xl">${computeInitials(person.name)}</span>`}
                            </div>
                            <p class="mt-3 text-sm font-semibold text-white">${person.name}</p>
                            ${badgesHtml}
                            ${subtitleHtml}
                        </button>`;
        };
        const actorCardsHTML = castPeople.length > 0
            ? `<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    ${castPeople.map(renderPersonCard).join('')}
                </div>`
            : `<p class="text-sm text-gray-400" data-lang-key="noCastInfo"></p>`;
        const filmographySection = `
                <div id="cast-filmography" class="hidden mt-6 bg-gray-900/70 border border-gray-800 rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="text-xs uppercase tracking-wide text-red-400" data-lang-key="filmographyTitle"></p>
                            <h3 id="cast-filmography-name" class="text-lg font-semibold text-white mt-1"></h3>
                        </div>
                        <button id="cast-filmography-close" type="button" class="text-gray-400 hover:text-white transition"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="cast-filmography-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 text-left"></div>
                </div>`;
        const aspectBarMap = [
            { id: 'direction', labelKey: 'directionCheckbox' },
            { id: 'plot', labelKey: 'plotCheckbox' },
            { id: 'spectacle', labelKey: 'spectacleCheckbox' },
            { id: 'actors', labelKey: 'actorsCheckbox' }
        ];
        const ratingBarsHtml = aspectBarMap.map(({ id, labelKey }) => {
            const value = aspectPercentages[id] ?? 0;
            return `
                        <div class="flex items-center gap-3">
                            <span class="w-32 text-gray-400" data-lang-key="${labelKey}"></span>
                            <div class="flex-1 h-2 bg-gray-700/70 rounded-full overflow-hidden">
                                <div class="rating-bar-fill h-2 bg-red-500" data-aspect="${id}" data-final="${value}" style="width: ${value}%"></div>
                            </div>
                            <span class="text-xs text-gray-400 w-12 text-right" data-aspect-value="${id}">${value}%</span>
                        </div>`;
        }).join('');

        // Info contents (description, actors, rating)
        const infoContents = `
            <div id="info-description" class="info-tab-content">
                <h2 data-lang-key="description" class="text-xl font-bold mb-3 border-l-4 border-red-500 pl-3"></h2>
                <p class="text-gray-300 leading-relaxed text-sm">${movie.description || ''}</p>
            </div>
            <div id="info-actors" class="info-tab-content hidden">
                <h2 data-lang-key="actorsTab" class="text-xl font-bold mb-3 border-l-4 border-red-500 pl-3"></h2>
                ${actorCardsHTML}
                ${filmographySection}
            </div>
            <div id="info-rating" class="info-tab-content hidden">
                <h2 data-lang-key="ratingTab" class="text-xl font-bold mb-3 border-l-4 border-red-500 pl-3"></h2>
                <div class="flex flex-col sm:flex-row sm:items-center sm:gap-6 mb-4">
                    <div class="flex items-baseline gap-2">
                        <span class="rating-value text-5xl font-bold text-yellow-400">${sndVal}</span>
                        <span class="text-sm text-gray-400 ml-2"><span class="rating-votes-count">${movie.sndVotes ?? 0}</span> <span data-lang-key="votes"></span></span>
                    </div>
                    <div class="w-full mt-4 sm:mt-0 space-y-2">
                        ${ratingBarsHtml}
                    </div>
                </div>
                <button id="snd-rate-btn" data-movie-id="${movie.id}" class="mt-2 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg" data-lang-key="rateThisMovie"></button>
            </div>`;
        const sanitizeUrl = (src) => (typeof src === 'string' ? src.replace(/"/g, '"') : '');
        const screenshotCandidates = [movie.screenshots, movie.stills, movie.gallery, movie.images, movie.backdrops];
        const screenshotList = [];
        screenshotCandidates.forEach(list => {
            if (Array.isArray(list)) {
                list.forEach(item => {
                    if (typeof item === 'string' && item.trim()) {
                        screenshotList.push(item.trim());
                    }
                });
            }
        });
        const uniqueScreenshots = Array.from(new Set(screenshotList));
        const screenshotThumbnails = uniqueScreenshots.slice(0, 10).map(src => {
            const safeSrc = sanitizeUrl(src);
            return `
                        <button type="button" class="screenshot-thumb relative w-44 h-28 rounded-xl overflow-hidden flex-shrink-0 bg-gray-900/60 border border-gray-800 hover:border-red-500 transition-colors" data-screenshot="${safeSrc}">
                            <img src="${safeSrc}" alt="${movie.title} screenshot" class="w-full h-full object-cover transition-transform duration-300 hover:scale-105" onerror="this.onerror=null;this.src='https://placehold.co/320x180/111827/ffffff?text=SND';">
                        </button>`;
        }).join('');
        const screenshotsSection = uniqueScreenshots.length > 0
            ? `<div class="mb-6">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-xl font-bold" data-lang-key="screenshotsTitle"></h2>
                        <span class="text-xs text-gray-500">${uniqueScreenshots.length}</span>
                    </div>
                    <div class="flex gap-3 overflow-x-auto pb-2">
                        ${screenshotThumbnails}
                    </div>
                </div>`
            : '';

        // Final markup with video control panel on the card
        return `
            <div class="bg-black min-h-screen text-gray-100">
                                <div class="sticky top-0 z-30 bg-black/95 backdrop-blur-sm border-b border-gray-900/70 shadow-lg">
                    <div id="movie-details-card" data-movie-id="${movie.id}" class="relative mx-auto w-full max-w-5xl aspect-video max-h-[420px] min-h-[220px] overflow-hidden rounded-b-3xl bg-black">
                        ${cardMedia}
                        <!-- Back button -->
                        <button id="back-button" class="absolute top-4 left-4 bg-black/60 w-10 h-10 rounded-full text-white flex items-center justify-center shadow-lg"><i class="fas fa-arrow-left"></i></button>
                        <!-- Favorite button -->
                        <button id="fav-button" class="fav-button absolute top-4 right-16 bg-black/60 w-10 h-10 rounded-full text-white ${isFavorited ? 'favorited' : ''} shadow-lg" data-movie-id="${movie.id}">
                            <i class="fas fa-heart"></i>
                        </button>
                        <!-- Settings button -->
                        <button id="card-settings-button" class="absolute top-4 right-4 bg-black/60 w-10 h-10 rounded-full text-white flex items-center justify-center shadow-lg"><i class="fas fa-cog"></i></button>
                        <!-- Central play/pause overlay (hidden by default) -->
                        <div id="card-center-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none hidden">
                            <button id="card-play-pause-button" class="text-white text-5xl flex items-center justify-center pointer-events-auto"><i class="fas fa-play"></i></button>
                            <!-- Speed indicator shown during hold -->
                            <div id="card-speed-indicator" class="absolute top-1/3 inset-x-0 text-center text-4xl font-bold text-white opacity-0">2x</div>
                        </div>
                        <!-- Bottom controls: progress bar and fullscreen, hidden by default -->
                        <div id="card-bottom-controls" class="absolute inset-0 flex flex-col justify-end pointer-events-none hidden">
                            <div class="w-full bg-black/60 p-3 pointer-events-auto backdrop-blur-sm">
                                <div class="flex items-center gap-2">
                                    <span id="card-current-time" class="text-xs text-white min-w-[48px] text-center">00:00</span>
                                    <input id="card-progress" type="range" min="0" max="0" value="0" class="video-progress flex-grow h-1 cursor-pointer appearance-none">
                                    <span id="card-duration" class="text-xs text-white min-w-[48px] text-center">00:00</span>
                                    <button id="card-fullscreen-button" data-movie-id="${movie.id}" class="ml-1 text-white text-lg"><i class="fas fa-expand"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="card-settings-menu" class="fixed inset-0 z-[70] hidden">
                    <div id="card-settings-backdrop" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
                    <div class="absolute inset-x-0 bottom-0 pb-6 pointer-events-none">
                        <div class="mx-auto w-full max-w-md rounded-t-3xl bg-gray-900/95 border border-gray-800/70 shadow-2xl p-5 pointer-events-auto">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold" data-lang-key="settings"></h3>
                                <button id="card-settings-close" type="button" class="text-gray-400 hover:text-white transition"><i class="fas fa-times"></i></button>
                            </div>
                            <div class="space-y-5">
                                <div>
                                    <p class="text-xs uppercase tracking-wide text-gray-400 mb-2" data-lang-key="quality"></p>
                                    <div id="card-quality-options" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div>
                                    <p class="text-xs uppercase tracking-wide text-gray-400 mb-2" data-lang-key="playbackSpeed"></p>
                                    <div id="card-speed-options" class="flex flex-wrap gap-2"></div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs uppercase tracking-wide text-gray-400" data-lang-key="subtitles"></span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input id="card-subtitles-toggle" type="checkbox" class="sr-only">
                                        <span class="snd-toggle-track"></span>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs uppercase tracking-wide text-gray-400" data-lang-key="screenLock"></span>
                                    <button id="card-screenlock-btn" type="button" class="text-sm text-gray-300 hover:text-white transition">Lock</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container mx-auto px-4 pb-12 pt-8">
                    <h1 class="text-2xl md:text-3xl font-bold leading-tight mb-1">${movie.title || ''}</h1>
                    <p class="text-gray-400 text-sm mb-3">${movie.originalTitle || ''}</p>
                    <div class="flex flex-wrap items-center gap-2 mb-4">${premiumTag}${qualityTags}</div>
                    ${infoGrid}
                    <div class="flex flex-wrap gap-2 my-4">
                        <button id="cast-button" class="w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center gap-2">
                            <i class="fas fa-tv"></i>
                            <span class="sr-only">Cast</span>
                        </button>
                        <!-- Removed ticket purchase button. Previously, this button navigated to the kassa page with the movie title as a query parameter. -->
                        <!-- The button has been omitted as per request. -->
                    </div>
                    <div class="mt-8 space-y-6">
                        ${screenshotsSection}
                        ${seriesControls}
                        ${infoTabs}
                        ${infoContents}
                    </div>
                </div>
            </div>
        `;
    }

    function renderFavoritesPage() {
        const favoriteMovies = movies.filter(m => currentUser?.favorites?.includes(m.id));
        const content = favoriteMovies.length > 0 ? favoriteMovies.map(createMovieCardHTML).join('') : `<p class="col-span-full text-center text-gray-400 mt-8" data-lang-key="noFavorites"></p>`;
        return `
            <div class="container mx-auto px-4 py-6">
                <h1 class="text-2xl md:text-4xl font-bold mb-6 border-l-4 border-red-500 pl-4" data-lang-key="favorites"></h1>
                <div id="favorites-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">${content}</div>
            </div>`;
    }

    // Render page showing downloaded (offline) movies
    function renderDownloadsPage() {
        // Retrieve list of downloaded movie objects (or IDs for backward compatibility)
        let downloadedRaw;
        try {
            downloadedRaw = JSON.parse(localStorage.getItem('soundora-downloads')) || [];
        } catch (e) {
            downloadedRaw = [];
        }
        // Normalize to list of strings (IDs)
        const ids = downloadedRaw.map(item => (typeof item === 'object' ? String(item.id) : String(item)));
        const uniqueIds = Array.from(new Set(ids));
        // Use a safe check in case movies data has not loaded yet
        const downloadedMovies = Array.isArray(movies)
            ? movies.filter(m => uniqueIds.includes(String(m.id)))
            : [];
        const content = downloadedMovies.length > 0
            ? downloadedMovies.map(movie => {
                // Find corresponding download entry
                const dEntry = downloadedRaw.find(item => (typeof item === 'object' && String(item.id) === String(movie.id)));
                let progressHTML = '';
                if (dEntry && dEntry.status === 'downloading') {
                    const prog = dEntry.progress || 0;
                    progressHTML = `<div class="p-2"><div class="w-full bg-gray-600 rounded h-2"><div id="download-progress-${movie.id}" class="bg-red-500 h-2 rounded" style="width:${prog}%"></div></div><div id="download-progress-text-${movie.id}" class="text-xs text-gray-400 mt-1">${Math.round(prog)}%</div></div>`;
                } else if (dEntry && dEntry.status === 'completed') {
                    progressHTML = `<div class="p-2 text-green-400 text-xs" data-lang-key="downloadCompleted">Downloaded</div>`;
                }
                return `<div class="relative">${createMovieCardHTML(movie)}${progressHTML}</div>`;
            }).join('')
            : `<p class="col-span-full text-center text-gray-400 mt-8" data-lang-key="noDownloads"></p>`;
        return `
            <div class="container mx-auto px-4 py-6">
                <h1 class="text-2xl md:text-4xl font-bold mb-6 border-l-4 border-red-500 pl-4" data-lang-key="downloads"></h1>
                <div id="downloads-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">${content}</div>
            </div>`;
    }

    function renderProfilePage() {
        if (!currentUser) return '';
        return `
            <div class="container mx-auto px-4 py-6 flex flex-col" style="min-height: calc(100vh - 8rem);">
                <div class="flex-grow max-w-4xl mx-auto w-full">
                    <!-- Header with title and actions -->
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-red-500 to-pink-500 bg-clip-text text-transparent" data-lang-key="profile"></h1>
                        <div class="flex items-center gap-2">
                            <button id="profile-ai-chat-btn" class="w-10 h-10 rounded-full bg-gray-800/50 hover:bg-gray-700/50 flex items-center justify-center text-gray-400 hover:text-red-500 transition-all">
                                <i class="fas fa-comments text-lg"></i>
                            </button>
                            <button id="switch-account-btn" class="w-10 h-10 rounded-full bg-gray-800/50 hover:bg-gray-700/50 flex items-center justify-center text-gray-400 hover:text-red-500 transition-all">
                                <i class="fas fa-user-friends text-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Profile Card -->
                    <div class="bg-gray-800/60 backdrop-blur-sm rounded-xl p-5 sm:p-6 mb-6 border border-gray-700/30 shadow-lg">
                        <div class="flex items-start gap-4">
                            <!-- Avatar - chapda -->
                            <div class="flex-shrink-0 relative">
                                ${currentUser.photoURL
                                    ? `<div class="w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-gradient-to-br from-red-500 to-pink-600 p-0.5">
                                        <img src="${currentUser.photoURL}" alt="Avatar" class="w-full h-full rounded-full object-cover">
                                       </div>`
                                    : `<div class="w-20 h-20 sm:w-24 sm:h-24 rounded-full bg-gradient-to-br from-red-500 to-pink-600 flex items-center justify-center text-white text-3xl sm:text-4xl font-bold shadow-lg">
                                        ${currentUser.displayName?.charAt(0).toUpperCase() || 'U'}
                                       </div>`
                                }
                                ${currentUser.isPremium
                                    ? '<div class="absolute -top-1 -right-1 bg-gradient-to-r from-yellow-400 to-yellow-600 rounded-full p-1.5 sm:p-2 shadow-lg"><i class="fas fa-crown text-black text-xs sm:text-sm"></i></div>'
                                    : ''}
                            </div>

                            <!-- User Info - o'ng tomonda, yuqoridan pastga -->
                            <div class="flex-1 min-w-0">
                                <!-- Username -->
                                <h2 class="text-xl sm:text-2xl md:text-3xl font-bold mb-1.5 truncate">${currentUser.displayName || 'User'}</h2>

                                <!-- Email -->
                                <p class="text-gray-400 text-base sm:text-lg mb-2.5 truncate">${currentUser.email || currentUser.phoneNumber || ''}</p>

                                <!-- User ID -->
                                <button id="copy-id-btn" class="bg-gray-700/40 hover:bg-gray-600/50 text-gray-300 text-sm sm:text-base py-2 px-3 rounded-lg transition-all flex items-center gap-2 border border-gray-600/20 mb-2.5">
                                    <i class="fas fa-fingerprint text-base"></i>
                                    <span>ID: <span id="user-profile-id" class="font-mono">${currentUser.customId || currentUser.uid.substring(0, 8)}</span></span>
                                    <i class="fas fa-copy text-sm"></i>
                                </button>

                                <!-- Status badges -->
                                <div class="flex flex-wrap gap-2">
                                    ${currentUser.isPremium
                                        ? '<span class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-black text-sm font-bold px-3 py-1 rounded-full flex items-center gap-1.5"><i class="fas fa-crown text-xs"></i>Premium</span>'
                                        : '<span class="bg-gray-700/70 text-gray-300 text-sm font-medium px-3 py-1 rounded-full">Free</span>'
                                    }
                                    ${currentUser.role === 'admin'
                                        ? '<span class="bg-red-500/80 text-white text-sm font-bold px-3 py-1 rounded-full flex items-center gap-1.5"><i class="fas fa-shield-alt text-xs"></i>Admin</span>'
                                        : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Action Buttons -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 mb-6">
                        <!-- Settings -->
                        <button id="settings-btn" class="bg-gray-800/60 hover:bg-gray-700/70 backdrop-blur-sm text-white font-semibold py-4 px-5 rounded-xl transition-all flex items-center gap-4 border border-gray-700/30 hover:border-gray-600/50 group">
                            <div class="w-11 h-11 rounded-lg bg-gray-700/40 flex items-center justify-center group-hover:bg-gray-600/50 transition-all flex-shrink-0">
                                <i class="fas fa-cog text-xl text-gray-300"></i>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="font-bold text-base sm:text-lg" data-lang-key="settings"></div>
                                <div class="text-sm text-gray-400 hidden sm:block">Preferences & Options</div>
                            </div>
                            <i class="fas fa-chevron-right text-sm text-gray-500 transition-colors"></i>
                        </button>

                        <!-- Premium -->
                        <button id="premium-btn" class="bg-gray-800/60 hover:bg-gray-700/70 backdrop-blur-sm text-white font-semibold py-4 px-5 rounded-xl transition-all flex items-center gap-4 border border-gray-700/30 hover:border-yellow-500/30 group">
                            <div class="w-11 h-11 rounded-lg bg-gray-700/40 flex items-center justify-center group-hover:bg-yellow-500/20 transition-all flex-shrink-0">
                                <i class="fas fa-crown text-xl text-yellow-400"></i>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="font-bold text-base sm:text-lg" data-lang-key="premium"></div>
                                <div class="text-sm text-gray-400 hidden sm:block">Unlock all features</div>
                            </div>
                            <i class="fas fa-chevron-right text-sm text-gray-500 transition-colors"></i>
                        </button>

                        <!-- Downloads -->
                        <button id="downloads-btn" class="bg-gray-800/60 hover:bg-gray-700/70 backdrop-blur-sm text-white font-semibold py-4 px-5 rounded-xl transition-all flex items-center gap-4 border border-gray-700/30 hover:border-gray-600/50 group">
                            <div class="w-11 h-11 rounded-lg bg-gray-700/40 flex items-center justify-center group-hover:bg-gray-600/50 transition-all flex-shrink-0">
                                <i class="fas fa-download text-xl text-gray-300"></i>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="font-bold text-base sm:text-lg" data-lang-key="downloads"></div>
                                <div class="text-sm text-gray-400 hidden sm:block">Offline content</div>
                            </div>
                            <i class="fas fa-chevron-right text-sm text-gray-500 transition-colors"></i>
                        </button>

                        <!-- FAQ -->
                        <button id="faq-btn" class="bg-gray-800/60 hover:bg-gray-700/70 backdrop-blur-sm text-white font-semibold py-4 px-5 rounded-xl transition-all flex items-center gap-4 border border-gray-700/30 hover:border-gray-600/50 group">
                            <div class="w-11 h-11 rounded-lg bg-gray-700/40 flex items-center justify-center group-hover:bg-gray-600/50 transition-all flex-shrink-0">
                                <i class="fas fa-question-circle text-xl text-gray-300"></i>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="font-bold text-base sm:text-lg" data-lang-key="faq"></div>
                                <div class="text-sm text-gray-400 hidden sm:block">Help & Support</div>
                            </div>
                            <i class="fas fa-chevron-right text-sm text-gray-500 transition-colors"></i>
                        </button>
                    </div>

                    <!-- Additional Options -->
                    <div class="space-y-2 mb-6">
                        <button id="report-feedback-btn" class="w-full bg-gray-800/60 hover:bg-gray-700/70 text-white font-medium py-3 px-4 rounded-lg transition-all flex justify-between items-center border border-gray-700/30 text-base sm:text-lg">
                            <span class="flex items-center gap-3">
                                <i class="fas fa-bug text-gray-400 text-lg"></i>
                                <span>Report Bug / Feedback</span>
                            </span>
                            <i class="fas fa-chevron-right text-gray-500 text-sm"></i>
                        </button>

                        <button id="privacy-policy-btn" class="w-full bg-gray-800/60 hover:bg-gray-700/70 text-white font-medium py-3 px-4 rounded-lg transition-all flex justify-between items-center border border-gray-700/30 text-base sm:text-lg">
                            <span class="flex items-center gap-3">
                                <i class="fas fa-shield-alt text-gray-400 text-lg"></i>
                                <span data-lang-key="privacyPolicy"></span>
                            </span>
                            <i class="fas fa-chevron-right text-gray-500 text-sm"></i>
                        </button>

                        ${currentUser?.role === 'admin' ? `
                            <a id="ap-control-btn" href="./admin.html" target="_blank" class="w-full bg-gray-800/60 hover:bg-gray-700/70 text-white font-medium py-3 px-4 rounded-lg transition-all flex justify-between items-center border border-gray-700/30 text-base sm:text-lg">
                                <span class="flex items-center gap-3">
                                    <i class="fas fa-tools text-gray-400 text-lg"></i>
                                    <span data-lang-key="apControl"></span>
                                </span>
                                <i class="fas fa-external-link-alt text-gray-500 text-sm"></i>
                            </a>
                        ` : ''}
                    </div>

                    <!-- Account Actions -->
                    <div class="pt-6 border-t border-gray-700/40 space-y-2">
                        <!-- Connected Devices Section -->
                        <button id="connected-devices-btn" class="w-full bg-gray-800/60 hover:bg-gray-700/70 text-white font-medium py-3 px-4 rounded-lg transition-all flex justify-between items-center border border-gray-700/30 text-base sm:text-lg group">
                            <span class="flex items-center gap-3">
                                <i class="fas fa-mobile-alt text-gray-400 text-lg"></i>
                                <span>Connected Devices</span>
                            </span>
                            <span class="flex items-center gap-2">
                                <span id="devices-count" class="text-xs bg-gray-700/60 px-2 py-0.5 rounded-full text-gray-400">0</span>
                                <i class="fas fa-chevron-right text-gray-500 text-sm transition-colors"></i>
                            </span>
                        </button>

                        <button id="switch-account-btn-bottom" class="w-full bg-gray-800/60 hover:bg-gray-700/70 text-white font-medium py-3 px-4 rounded-lg transition-all flex justify-between items-center border border-gray-700/30 text-base sm:text-lg group">
                            <span class="flex items-center gap-3">
                                <i class="fas fa-user-friends text-gray-400 text-lg"></i>
                                <span data-lang-key="switchAccount"></span>
                            </span>
                            <i class="fas fa-chevron-right text-gray-500 text-sm transition-colors"></i>
                        </button>

                        <button id="logout-btn-bottom" class="w-full bg-gray-800/60 hover:bg-gray-700/70 text-red-400 hover:text-red-300 font-medium py-3 px-4 rounded-lg transition-all flex justify-between items-center border border-gray-700/30 hover:border-red-500/20 text-base sm:text-lg group">
                            <span class="flex items-center gap-3">
                                <i class="fas fa-sign-out-alt text-lg"></i>
                                <span data-lang-key="logout"></span>
                            </span>
                            <i class="fas fa-chevron-right text-sm transition-colors"></i>
                        </button>
                    </div>
                </div>

                <!-- Footer -->
                <p class="text-center text-gray-500 text-xs mt-6 flex-shrink-0">
                    <span data-lang-key="appVersion"></span>: ${APP_VERSION} • © 2025 SND
                </p>
            </div>`;
    }

    function renderGuestProfilePage() {
        return `
            <div class="container mx-auto px-4 py-6 flex flex-col" style="min-height: calc(100vh - 8rem);">
                <div class="flex justify-between items-center mb-8">
                    <h1 class="text-2xl md:text-4xl font-bold border-l-4 border-red-500 pl-4" data-lang-key="profile"></h1>
                    <div class="flex items-center gap-4">
                       <!-- Replace robot icon with chat icon for AI/chat button -->
                       <button id="guest-ai-chat-btn" class="text-gray-400 hover:text-red-500 transition-colors"><i class="fas fa-comments text-2xl"></i></button>
                    </div>
                </div>
                <div class="flex-grow flex flex-col items-center justify-center text-center">
                    <i class="fas fa-user-circle text-6xl text-gray-600 mb-4"></i>
                    <h2 class="text-2xl font-bold mb-2" data-lang-key="loginRequired"></h2>
                    <p class="text-gray-400 mb-6 max-w-sm" data-lang-key="loginToAccess"></p>
                    <button id="guest-login-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg transition-colors">
                        <span data-lang-key="login"></span>
                    </button>
                </div>
                 <p class="text-center text-gray-500 text-xs mt-8 flex-shrink-0"><span data-lang-key="appVersion"></span>: ${APP_VERSION}</p>
            </div>
        `;
    }

    function renderLoginPage() {
        return `
            <div class="container mx-auto px-4 py-8 flex flex-col items-center justify-center min-h-[calc(100vh-8rem)]">
                <div class="w-full max-w-lg bg-gray-900/70 border border-gray-800 rounded-2xl shadow-2xl px-6 py-8 md:px-10 md:py-12">
                    <div class="text-center">
                        <h1 class="text-3xl font-bold mb-2" data-lang-key="authWelcomeTitle"></h1>
                        <p class="text-gray-400" data-lang-key="authWelcomeSubtitle"></p>
                    </div>
                    <form id="login-form" class="mt-8 space-y-5">
                        <div>
                            <label for="login-email-input" class="block text-sm font-medium text-gray-400 mb-1" data-lang-key="email"></label>
                            <input type="email" id="login-email-input" class="w-full bg-gray-800/70 border border-gray-700 rounded-lg p-3 focus:border-red-500 focus:ring-red-500 transition" placeholder="name@email.com" required>
                        </div>
                        <div class="relative">
                            <label for="login-password-input" class="block text-sm font-medium text-gray-400 mb-1" data-lang-key="password"></label>
                            <input type="password" id="login-password-input" class="w-full bg-gray-800/70 border border-gray-700 rounded-lg p-3 pr-10 focus:border-red-500 focus:ring-red-500 transition" placeholder="********" required>
                            <button type="button" id="login-password-toggle" class="absolute right-2 top-9 text-gray-400 hover:text-gray-200 focus:outline-none" aria-label="Toggle password visibility">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition" data-lang-key="login"></button>
                    </form>
                    <div class="flex items-center gap-3 my-6">
                        <span class="flex-1 h-px bg-gray-800"></span>
                        <span class="text-xs uppercase tracking-widest text-gray-500" data-lang-key="or"></span>
                        <span class="flex-1 h-px bg-gray-800"></span>
                    </div>
                    <button id="login-google-btn" class="w-full flex items-center justify-center gap-3 bg-white/90 hover:bg-white text-gray-900 font-semibold py-3 rounded-lg transition">
                        <i class="fab fa-google text-lg"></i>
                        <span data-lang-key="loginWithGoogle"></span>
                    </button>

                    <!-- QR Code Login Button -->
                    <button id="qr-login-btn" class="w-full flex items-center justify-center gap-3 bg-gray-800/70 hover:bg-gray-700 border border-gray-700 text-white font-semibold py-3 rounded-lg transition mt-3">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M3 11h8V3H3v8zm2-6h4v4H5V5zm-2 8h8v8H3v-8zm2 2v4h4v-4H5zm8-12v8h8V3h-8zm2 2h4v4h-4V5zm4 8h-2v2h2v-2zm-6 0h2v2h-2v-2zm2 2h2v2h-2v-2zm-2 2h2v2h-2v-2zm6-2h2v2h-2v-2zm0 4h2v2h-2v-2zm-4 0h2v2h-2v-2z"/>
                        </svg>
                        <span data-lang-key="qrLogin"></span>
                    </button>

                    <p id="login-error" class="text-red-500 text-center text-sm h-4 mt-4"></p>
                    <div class="text-center text-sm text-gray-400 mt-6">
                        <span data-lang-key="dontHaveAccount"></span>
                        <button id="go-to-register-btn" class="font-semibold text-red-500 hover:text-red-400" data-lang-key="registerNow"></button>
                    </div>
                </div>
            </div>
        `;
    }

    function renderRegisterPage() {
        const defaultRegion = currentUser?.region || 'uzbekistan';
        const regionOptions = centralAsiaRegions.map(region => `<option value="${region.value}" ${region.value === defaultRegion ? 'selected' : ''}>${region.label}</option>`).join('');
        return `
            <div class="container mx-auto px-4 py-8 flex flex-col items-center justify-center min-h-[calc(100vh-8rem)]">
                <div class="w-full max-w-2xl bg-gray-900/70 border border-gray-800 rounded-2xl shadow-2xl px-6 py-8 md:px-10 md:py-12 relative">
                        <div class="absolute top-4 right-6">
                            <div class="relative inline-block">
                                <button id="lang-toggle-btn" class="px-3 py-1 rounded bg-gray-800/60 text-xs">EN ▾</button>
                                <div id="lang-menu" class="hidden absolute right-0 mt-2 w-40 bg-gray-900 border border-gray-800 rounded-md shadow-lg z-50">
                                    <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="en">English</button>
                                    <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="ru">Русский</button>
                                    <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="uz">O'zbekcha</button>
                                    <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="tj">Тоҷикӣ</button>
                                    <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="kz">Қазақша</button>
                                    <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="kg">Кыргызча</button>
                                </div>
                            </div>
                        </div>
                    <div class="text-center max-w-lg mx-auto">
                        <h1 class="text-3xl font-bold mb-2" data-lang-key="registerTitle"></h1>
                        <p class="text-gray-400" data-lang-key="registerHint"></p>
                    </div>
                    <form id="register-form" class="mt-8 space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label for="register-name-input" class="block text-sm font-medium text-gray-400 mb-1" data-lang-key="fullName"></label>
                                <input type="text" id="register-name-input" class="w-full bg-gray-800/70 border border-gray-700 rounded-lg p-3 focus:border-red-500 focus:ring-red-500 transition" placeholder="Name Surname" required>
                            </div>
                            <div>
                                <label for="register-email-input" class="block text-sm font-medium text-gray-400 mb-1" data-lang-key="email"></label>
                                <input type="email" id="register-email-input" class="w-full bg-gray-800/70 border border-gray-700 rounded-lg p-3 focus:border-red-500 focus:ring-red-500 transition" placeholder="name@email.com" required>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div class="relative">
                                <label for="register-password-input" class="block text-sm font-medium text-gray-400 mb-1" data-lang-key="password"></label>
                                <input type="password" id="register-password-input" class="w-full bg-gray-800/70 border border-gray-700 rounded-lg p-3 focus:border-red-500 focus:ring-red-500 transition" placeholder="********" required minlength="6">
                                <button type="button" id="register-password-toggle" class="absolute right-2 top-9 text-gray-400 hover:text-gray-200 focus:outline-none" aria-label="Toggle password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="relative">
                                <label for="register-password-confirm-input" class="block text-sm font-medium text-gray-400 mb-1" data-lang-key="confirmPassword"></label>
                                <input type="password" id="register-password-confirm-input" class="w-full bg-gray-800/70 border border-gray-700 rounded-lg p-3 focus:border-red-500 focus:ring-red-500 transition" placeholder="********" required minlength="6">
                                <button type="button" id="register-password-confirm-toggle" class="absolute right-2 top-9 text-gray-400 hover:text-gray-200 focus:outline-none" aria-label="Toggle password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label for="register-secret-input" class="block text-sm font-medium text-gray-400 mb-1" data-lang-key="secretWordLabel"></label>
                                <input type="text" id="register-secret-input" class="w-full bg-gray-800/70 border border-gray-700 rounded-lg p-3 focus:border-red-500 focus:ring-red-500 transition" placeholder="Recovery word" required>
                            </div>
                            <div>
                                <label for="register-region-select" class="block text-sm font-medium text-gray-400 mb-1" data-lang-key="regionLabel"></label>
                                <select id="register-region-select" class="w-full bg-gray-800/70 border border-gray-700 rounded-lg p-3 focus:border-red-500 focus:ring-red-500 transition">
                                    ${regionOptions}
                                </select>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500" data-lang-key="tosNote"></p>
                        <p id="register-error" class="text-red-500 text-center text-sm h-4"></p>
                        <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition">Continue</button>
                    </form>
                    <div class="flex items-center gap-3 my-6">
                        <span class="flex-1 h-px bg-gray-800"></span>
                        <span class="text-xs uppercase tracking-widest text-gray-500" data-lang-key="or"></span>
                        <span class="flex-1 h-px bg-gray-800"></span>
                    </div>
                    <button id="register-google-btn" class="w-full flex items-center justify-center gap-3 bg-white/90 hover:bg-white text-gray-900 font-semibold py-3 rounded-lg transition">
                        <i class="fab fa-google text-lg"></i>
                        <span data-lang-key="loginWithGoogle"></span>
                    </button>
                    <p id="register-page-error" class="text-red-500 text-center text-sm h-4 mt-4"></p>
                    <p class="text-center text-sm text-gray-400 mt-6">
                        <span data-lang-key="alreadyHaveAccount"></span>
                        <button id="go-to-login-btn" class="font-semibold text-red-500 hover:text-red-400" data-lang-key="loginNow"></button>
                    </p>
                </div>
            </div>
        `;
    }

    function renderGenreSurveyPage() {
        const selectedGenres = currentUser?.favoriteGenres || [];
        const genresHtml = genreSurveyOptions.map(option => {
            const isActive = selectedGenres.includes(option.value);
            return `
                <label class="flex items-center justify-between bg-gray-900/50 border ${isActive ? 'border-red-500' : 'border-gray-800'} rounded-xl px-4 py-3 cursor-pointer transition hover:border-red-500">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${option.icon}</span>
                        <span data-lang-key="${option.translationKey}"></span>
                    </div>
                    <input type="checkbox" name="genre" value="${option.value}" class="w-5 h-5 accent-red-500" ${isActive ? 'checked' : ''}>
                </label>
            `;
        }).join('');
        const regionOptions = centralAsiaRegions.map(region => {
            const selected = (currentUser?.region || '') === region.value ? 'selected' : '';
            return `<option value="${region.value}" ${selected}>${region.label}</option>`;
        }).join('');
        return `
            <div class="container mx-auto px-4 py-10 flex flex-col items-center min-h-[calc(100vh-8rem)]">
                <div class="w-full max-w-3xl bg-gray-900/80 border border-gray-800 rounded-2xl shadow-2xl px-6 py-8 md:px-10 md:py-12 space-y-8 relative">
                    <div class="absolute top-4 right-6">
                        <div class="relative inline-block">
                            <button id="lang-toggle-btn" class="px-3 py-1 rounded bg-gray-800/60 text-xs">EN ▾</button>
                            <div id="lang-menu" class="hidden absolute right-0 mt-2 w-40 bg-gray-900 border border-gray-800 rounded-md shadow-lg z-50">
                                <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="en">English</button>
                                <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="ru">Русский</button>
                                <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="uz">O'zbekcha</button>
                                <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="tj">Тоҷикӣ</button>
                                <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="kz">Қазақша</button>
                                <button class="lang-item w-full text-left px-3 py-2 hover:bg-gray-800" data-lang="kg">Кыргызча</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold mb-2" data-lang-key="genreSurveyTitle"></h1>
                        <p class="text-gray-400" data-lang-key="genreSurveySubtitle"></p>
                    </div>
                    <form id="genre-survey-form" class="space-y-6">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            ${genresHtml}
                        </div>
                        <p class="text-xs text-gray-500" data-lang-key="genreSurveyHelper"></p>
                        <div class="border border-gray-800 rounded-2xl p-4 bg-gray-900/60">
                            <h3 class="text-lg font-semibold mb-2">Qaysi platformalarni ishlatasiz?</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <label class="flex items-center gap-3"><input type="checkbox" name="platform" value="netflix" class="accent-red-500"> Netflix</label>
                                <label class="flex items-center gap-3"><input type="checkbox" name="platform" value="youtube" class="accent-red-500"> YouTube</label>
                                <label class="flex items-center gap-3"><input type="checkbox" name="platform" value="amazon" class="accent-red-500"> Amazon Prime</label>
                                <label class="flex items-center gap-3"><input type="checkbox" name="platform" value="local" class="accent-red-500"> Local/Regional</label>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Bu savol natijaga ta'sir qilmaydi, faqat filmlar ro'yxatini sizga moslashtirish uchun ishlatiladi.</p>
                        </div>
                        <div class="border border-gray-800 rounded-2xl p-4 space-y-4 bg-gray-900/60">
                            <h2 class="text-lg font-semibold" data-lang-key="editProfile"></h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="genre-survey-name" class="block text-sm text-gray-400 mb-1" data-lang-key="fullName"></label>
                                    <input id="genre-survey-name" type="text" class="w-full bg-gray-800/70 border border-gray-700 rounded-lg p-3 focus:border-red-500 focus:ring-red-500 transition" value="${currentUser?.displayName || ''}" placeholder="Name Surname">
                                </div>
                                <div>
                                    <label for="genre-survey-secret" class="block text-sm text-gray-400 mb-1" data-lang-key="secretWordLabel"></label>
                                    <input id="genre-survey-secret" type="text" class="w-full bg-gray-800/70 border border-gray-700 rounded-lg p-3 focus:border-red-500 focus:ring-red-500 transition" value="${currentUser?.secretWord || ''}" placeholder="Recovery word">
                                </div>
                            </div>
                            <div>
                                <label for="genre-survey-region" class="block text-sm text-gray-400 mb-1" data-lang-key="regionLabel"></label>
                                <select id="genre-survey-region" class="w-full bg-gray-800/70 border border-gray-700 rounded-lg p-3 focus:border-red-500 focus:ring-red-500 transition">
                                    ${regionOptions}
                                </select>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3 sm:justify-between">
                            <button type="button" id="genre-survey-skip" class="w-full sm:w-auto px-5 py-3 rounded-lg border border-gray-700 text-gray-300 hover:border-gray-500 transition" data-lang-key="genreSurveySkip"></button>
                            <button type="submit" class="w-full sm:w-auto px-5 py-3 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition" data-lang-key="genreSurveyCta"></button>
                        </div>
                        <p id="genre-survey-error" class="text-red-400 text-sm h-4"></p>
                    </form>
                </div>
            </div>
        `;
    }
    function renderSettingsPage() {
        return `
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center mb-8">
                    <button id="back-button" class="text-2xl mr-4"><i class="fas fa-arrow-left"></i></button>
                    <h1 class="text-2xl md:text-4xl font-bold" data-lang-key="settings"></h1>
                </div>
                <div class="space-y-4">
                    <button id="edit-profile-btn" class="w-full bg-gray-800/50 hover:bg-gray-700/50 text-white font-semibold py-4 px-5 rounded-lg transition-colors flex justify-between items-center text-left">
                        <span><i class="fas fa-user-edit w-6 text-center mr-3"></i><span data-lang-key="editProfile"></span></span><i class="fas fa-chevron-right text-gray-500"></i>
                    </button>
                    <button id="language-settings-btn" class="w-full bg-gray-800/50 hover:bg-gray-700/50 text-white font-semibold py-4 px-5 rounded-lg transition-colors flex justify-between items-center text-left">
                        <span><i class="fas fa-language w-6 text-center mr-3"></i><span data-lang-key="language"></span></span><i class="fas fa-chevron-right text-gray-500"></i>
                    </button>
                    <button id="playback-settings-btn" class="w-full bg-gray-800/50 hover:bg-gray-700/50 text-white font-semibold py-4 px-5 rounded-lg transition-colors flex justify-between items-center text-left">
                        <span><i class="fas fa-play-circle w-6 text-center mr-3"></i><span data-lang-key="playback"></span></span><i class="fas fa-chevron-right text-gray-500"></i>
                    </button>
                    <button id="content-settings-btn" class="w-full bg-gray-800/50 hover:bg-gray-700/50 text-white font-semibold py-4 px-5 rounded-lg transition-colors flex justify-between items-center text-left">
                        <span><i class="fas fa-eye w-6 text-center mr-3"></i><span data-lang-key="content"></span></span><i class="fas fa-chevron-right text-gray-500"></i>
                    </button>
                    <!-- Region settings button: allows users to change payment region -->
                    <button id="region-settings-btn" class="w-full bg-gray-800/50 hover:bg-gray-700/50 text-white font-semibold py-4 px-5 rounded-lg transition-colors flex justify-between items-center text-left">
                        <span><i class="fas fa-globe w-6 text-center mr-3"></i><span>Region</span></span><i class="fas fa-chevron-right text-gray-500"></i>
                    </button>
                </div>
            </div>`;
    }

    function renderPrivacyPolicyPage() {
        return `
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center mb-8">
                    <button id="back-button" class="text-2xl mr-4"><i class="fas fa-arrow-left"></i></button>
                    <h1 class="text-2xl md:text-4xl font-bold" data-lang-key="privacyTitle"></h1>
                </div>
                <p class="text-sm text-gray-500 mb-4" data-lang-key="privacyLastUpdated"></p>
                <div class="space-y-6 text-gray-300 leading-relaxed">
                    <div>
                        <h2 class="text-xl font-bold" data-lang-key="privacy1Title"></h2>
                        <p data-lang-key="privacy1Text"></p>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold" data-lang-key="privacy2Title"></h2>
                        <p data-lang-key="privacy2Text"></p>
                    </div>
                    <div>
                         <h2 class="text-xl font-bold" data-lang-key="privacy3Title"></h2>
                        <p data-lang-key="privacy3Text"></p>
                    </div>
                    <div>
                         <h2 class="text-xl font-bold" data-lang-key="privacy4Title"></h2>
                        <p data-lang-key="privacy4Text"></p>
                    </div>
                </div>
            </div>`;
    }

    function renderFaqPage() {
        return `
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center mb-8">
                    <button id="back-button" class="text-2xl mr-4"><i class="fas fa-arrow-left"></i></button>
                    <h1 class="text-2xl md:text-4xl font-bold" data-lang-key="faqTitle"></h1>
                </div>
                <div class="space-y-6 text-gray-300">
                    <div>
                        <h2 class="text-xl font-bold mb-2" data-lang-key="faq1Title"></h2>
                        <p data-lang-key="faq1Answer"></p>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold mb-2" data-lang-key="faq2Title"></h2>
                        <p data-lang-key="faq2Answer"></p>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold mb-2" data-lang-key="faq3Title"></h2>
                        <p data-lang-key="faq3Answer"></p>
                    </div>
                </div>
            </div>`;
    }

    function renderPlaybackSettingsPage() {
        return `
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center mb-8">
                    <button id="back-button" class="text-2xl mr-4"><i class="fas fa-arrow-left"></i></button>
                    <h1 class="text-2xl md:text-4xl font-bold" data-lang-key="playback"></h1>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-5">
                    <!-- Mini player toggle -->
                    <div class="flex justify-between items-center">
                        <div>
                            <label for="mini-player-toggle" class="text-white font-semibold" data-lang-key="enableMiniPlayer"></label>
                            <p class="text-gray-400 text-sm mt-1" data-lang-key="miniPlayerHint"></p>
                        </div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="mini-player-toggle" id="mini-player-toggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer" ${isMiniPlayerEnabled ? 'checked' : ''}/>
                            <label for="mini-player-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                    <!-- Resume prompt toggle -->
                    <div class="flex justify-between items-center mt-4">
                        <div>
                            <label for="resume-prompt-toggle" class="text-white font-semibold" data-lang-key="enableResumePrompt"></label>
                            <p class="text-gray-400 text-sm mt-1" data-lang-key="resumePromptHint"></p>
                        </div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="resume-prompt-toggle" id="resume-prompt-toggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer" ${isResumePromptEnabled ? 'checked' : ''}/>
                            <label for="resume-prompt-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    function renderEditProfilePage() {
        return `
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center mb-8">
                    <button id="back-button" class="text-2xl mr-4"><i class="fas fa-arrow-left"></i></button>
                    <h1 class="text-2xl md:text-4xl font-bold" data-lang-key="editProfile"></h1>
                </div>
                <div class="space-y-6">
                    <div>
                        <label for="username-input" class="block text-sm font-medium text-gray-400 mb-2" data-lang-key="name"></label>
                        <input type="text" id="username-input" value="${currentUser?.displayName || ''}" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg p-3 focus:border-red-500 focus:ring-red-500 transition">
                    </div>
                    <div>
                        <label for="email-input-display" class="block text-sm font-medium text-gray-400 mb-2" data-lang-key="email"></label>
                        <input type="email" id="email-input-display" value="${currentUser?.email || ''}" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg p-3" disabled>
                    </div>
                    <button id="save-profile-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                        <span data-lang-key="save"></span>
                    </button>
                </div>

                ${currentUser?.email ? `
                <div class="mt-8 pt-6 border-t border-gray-600">
                     <h2 class="text-xl font-bold mb-4" data-lang-key="changePassword"></h2>
                     <form id="change-password-form" class="space-y-4">
                        <input type="password" id="current-password-input" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg p-3" data-lang-key="password" placeholder="Joriy parol" required>
                        <input type="password" id="new-password-input" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg p-3" data-lang-key="newPassword" placeholder="Yangi parol" required>
                        <input type="password" id="confirm-password-input" class="w-full bg-gray-800/50 border border-gray-700 rounded-lg p-3" data-lang-key="confirmPassword" placeholder="Yangi parolni tasdiqlang" required>
                        <p id="password-error" class="text-red-500 text-sm h-4"></p>
                        <button type="submit" class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-colors">
                            <span data-lang-key="changePassword"></span>
                        </button>
                     </form>
                </div>` : ''}
            </div>`;
    }

    function renderLanguageSettingsPage() {
        return `
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center mb-8">
                    <button id="back-button" class="text-2xl mr-4"><i class="fas fa-arrow-left"></i></button>
                    <h1 class="text-2xl md:text-4xl font-bold" data-lang-key="languageSettingTitle"></h1>
                </div>
                <div class="flex flex-col space-y-3">
                    <button class="lang-btn text-left w-full p-4 rounded-md bg-gray-800/50 hover:bg-gray-700/50 transition-colors" data-lang="ru">Р СѓСЃСЃРєРёР№</button>
                    <button class="lang-btn text-left w-full p-4 rounded-md bg-gray-800/50 hover:bg-gray-700/50 transition-colors" data-lang="en">English</button>
                    <button class="lang-btn text-left w-full p-4 rounded-md bg-gray-800/50 hover:bg-gray-700/50 transition-colors" data-lang="uz">O'zbekcha</button>
                </div>
            </div>`;
    }

    function renderContentSettingsPage() {
        const show18Plus = JSON.parse(localStorage.getItem('soundora-show18plus')) || false;
        return `
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center mb-8">
                    <button id="back-button" class="text-2xl mr-4"><i class="fas fa-arrow-left"></i></button>
                    <h1 class="text-2xl md:text-4xl font-bold" data-lang-key="contentSettingsTitle"></h1>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-5 flex justify-between items-center">
                    <label for="content-toggle" class="text-white font-semibold" data-lang-key="show18Plus"></label>
                    <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="content-toggle" id="content-toggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer" ${show18Plus ? 'checked' : ''}/>
                        <label for="content-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-600 cursor-pointer"></label>
                    </div>
                </div>
            </div>`;
    }

    function renderPremiumPage() {
        const plans = [
            { months: 1, pricePerMonth: 199, tagKey: null },
            { months: 3, pricePerMonth: 169, tagKey: 'mostPopular' },
            { months: 7, pricePerMonth: 149, tagKey: null },
            { months: 12, pricePerMonth: 129, tagKey: 'bestValue' }
        ];

        // Build the markup for each plan.  A purchase button has been added so that
        // users can proceed to the ticket-purchase page.  The button simply
        // navigates to kassa.html when clicked.  Each card is a flex container
        // to push the button to the bottom of the card for consistent spacing.
        const plansHTML = plans.map(plan => `
            <div class="bg-gray-700/50 rounded-lg p-4 relative flex flex-col justify-between">
                ${plan.tagKey ? `<div class="absolute top-0 -right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full" data-lang-key="${plan.tagKey}"></div>` : ''}
                <div>
                    <h3 class="text-xl font-bold" data-lang-key="plan${plan.months}Months"></h3>
                    <p class="text-3xl font-black my-2">${plan.pricePerMonth} в‚Ѕ<span class="text-base font-normal text-gray-400" data-lang-key="pricePerMonth"></span></p>
                    <p class="text-sm text-gray-400"><span data-lang-key="total"></span>: ${plan.months * plan.pricePerMonth} в‚Ѕ</p>
                </div>
                <button class="mt-4 w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors" onclick="openKassa(${plan.months}, ${plan.months * plan.pricePerMonth}); return false;">
                    Sotib olish
                </button>
            </div>
        `).join('');

        // Build current subscription status card
        const isPremiumUser = currentUser?.isPremium;
        let statusHTML = '';
        if (isPremiumUser) {
            let expiresDate;
            const expiresData = currentUser?.premiumExpiresAt;
            try {
                if (expiresData && typeof expiresData.toDate === 'function') {
                    expiresDate = expiresData.toDate();
                } else if (expiresData?.seconds) {
                    expiresDate = new Date(expiresData.seconds * 1000);
                } else if (expiresData) {
                    expiresDate = new Date(expiresData);
                }
            } catch (err) {
                expiresDate = null;
            }
            let daysLeft = '';
            let expStr = '';
            if (expiresDate) {
                const diffMs = expiresDate.getTime() - Date.now();
                const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                if (!isNaN(diffDays)) {
                    daysLeft = diffDays > 0 ? diffDays : 0;
                }
                expStr = expiresDate.toLocaleDateString();
            }
            const expLabel = translations[currentLanguage]?.expiresOn || 'Expires on';
            const daysLabel = translations[currentLanguage]?.daysLeft || 'days left';
            statusHTML = `<h2 class="text-2xl font-bold mb-2">${translations[currentLanguage]?.premium || 'Premium'}</h2><p class="text-gray-400">${expLabel}: ${expStr}${daysLeft !== '' ? ' (' + daysLeft + ' ' + daysLabel + ')' : ''}</p>`;
        } else {
            statusHTML = `<h2 class="text-2xl font-bold mb-2" data-lang-key="getPremium"></h2><p class="text-gray-400" data-lang-key="premiumHint"></p>`;
        }
        return `
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center mb-8">
                    <button id="back-button" class="text-2xl mr-4"><i class="fas fa-arrow-left"></i></button>
                    <h1 class="text-2xl md:text-4xl font-bold" data-lang-key="premium"></h1>
                </div>
                <!-- Promo code and status section -->
                <div class="md:flex md:gap-4 mb-8">
                    <!-- Promo code input -->
                    <div class="md:w-1/2 order-2 md:order-1 mb-6 md:mb-0">
                        <div class="bg-gray-800/50 rounded-lg p-6">
                            <h3 class="text-lg font-bold mb-2" data-lang-key="promoCode"></h3>
                            <input id="promo-code-input" type="text" class="w-full bg-gray-700/50 border border-gray-600 rounded-lg p-3 text-white focus:outline-none focus:border-red-500" placeholder="${translations[currentLanguage]?.enterPromoCode || 'Enter promo code'}">
                            <button id="redeem-promo-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors mt-4" data-lang-key="activatePromo"></button>
                            <p id="promo-feedback" class="text-sm mt-2"></p>
                        </div>
                    </div>
                    <!-- Status and hero -->
                    <div class="md:w-1/2 order-1 md:order-2">
                        <div class="bg-gray-800/50 rounded-lg p-6 text-center">
                            <i class="fas fa-crown text-5xl text-yellow-400 mb-4"></i>
                            ${statusHTML}
                        </div>
                    </div>
                </div>
                <!-- Plans and subscription steps (only for free users) -->
                ${!isPremiumUser ? `<div class="grid grid-cols-2 gap-4 mb-8">${plansHTML}</div><div class="bg-gray-800/50 rounded-lg p-6"><h3 class="text-lg font-bold mb-4" data-lang-key="howToSubscribe"></h3><ol class="list-decimal list-inside space-y-2 text-gray-300"><li data-lang-key="subscribeStep1"></li><li data-lang-key="subscribeStep2"></li><li data-lang-key="subscribeStep3"></li></ol></div>` : ''}
            </div>`;
    }

    function renderPlayerPage(state) {
        const movie = movies.find(m => String(m.id) === String(state.movieId));
        if (!movie) return '';
        const episodeIndex = state.episodeIndex || 0;
        const sources = movie.type === 'series' && movie.episodes ? movie.episodes[episodeIndex].sources : movie.sources;
        if (!sources) { console.error("Video sources not found!"); return ''; }

        const episodesHTML = movie.type === 'series' && Array.isArray(movie.episodes) ? `
            <div id="episode-list-panel" class="fixed top-0 right-0 h-full w-full sm:w-80 bg-gray-900 shadow-lg z-50 transform translate-x-full lg:relative lg:translate-x-0 lg:w-80 lg:flex-shrink-0 flex flex-col">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-bold" data-lang-key="episodes"></h3><button id="close-episodes-btn" class="lg:hidden text-2xl">×</button>
                </div>
                <div id="episode-list" class="flex-grow overflow-y-auto">
                    ${movie.episodes.map((ep, i) => `<div class="episode-item p-4 border-b border-gray-800 hover:bg-gray-700 cursor-pointer flex items-center space-x-4 ${i === episodeIndex ? 'active' : ''}" data-movie-id="${movie.id}" data-episode-index="${i}"><span class="text-red-400 font-bold w-8 text-center">${i + 1}</span><div class="flex-grow"><p data-lang-key="episode"></p></div><i class="fas fa-play text-gray-500"></i></div>`).join('')}
                </div>
            </div>` : '';

        return `
            <div class="w-full h-full flex flex-col lg:flex-row bg-black">
                <div class="flex-grow flex flex-col relative overflow-hidden">
                    <div id="player-container" class="player-container w-full h-full bg-black relative overflow-hidden">
                         <div id="player-loading-spinner" class="hidden absolute inset-0 z-30 flex items-center justify-center bg-transparent">
                             <div class="player-loader"></div>
                         </div>
                        <!-- Controls Panel -->
                        <div class="player-controls absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent flex flex-col justify-between p-4 z-20">
                            <div class="flex justify-between items-center">
                                <button id="player-back-button" class="bg-black/50 hover:bg-black/70 w-10 h-10 rounded-full text-white transition-colors"><i class="fas fa-arrow-left"></i></button>
                                <div><h3 class="text-white text-lg font-bold truncate max-w-[50vw]">${movie.title} ${movie.type === 'series' ? `- <span data-lang-key="episode"></span> ${episodeIndex + 1}` : ''}</h3></div>
                                <div class="flex items-center gap-4">
                                    <!-- Cast tugmasi qo'shildi -->
                                    <button id="cast-btn" class="text-white text-xl"><i class="fas fa-tv"></i></button>
                                    <button id="player-settings-btn" class="text-white text-xl"><i class="fas fa-cog"></i></button>
                                    ${movie.type === 'series' ? `<button id="toggle-episodes-btn" class="bg-black/50 hover:bg-black/70 w-10 h-10 rounded-full text-white transition-colors lg:hidden"><i class="fas fa-list-ul"></i></button>` : ''}
                                </div>
                            </div>

                            <!-- Center indicators and button -->
                            <div class="absolute inset-0 flex items-center justify-around pointer-events-none">
                                <div id="rewind-indicator" class="seek-indicator left-1/4"><i class="fas fa-undo"></i> -10s</div>
                                <div class="flex items-center gap-12 pointer-events-auto">
                                    <button id="center-play-btn" class="text-white text-5xl bg-black/40 rounded-full w-20 h-20 flex items-center justify-center hover:bg-black/60 transition-all"><i class="fas fa-play"></i></button>
                                    <button id="center-pause-btn" class="text-white text-5xl bg-black/40 rounded-full w-20 h-20 flex items-center justify-center hover:bg-black/60 transition-all hidden"><i class="fas fa-pause"></i></button>
                                </div>
                                <div id="forward-indicator" class="seek-indicator right-1/4">+10s <i class="fas fa-redo"></i></div>
                            </div>

                            <!-- Bottom controls -->
                            <div class="w-full">
                                <div class="flex items-center gap-2"><span id="current-time" class="text-white text-xs">00:00</span><input type="range" id="seek-bar" value="0" min="0" class="w-full"><span id="total-time" class="text-white text-xs">00:00</span></div>
                                <div class="flex justify-between items-center mt-2">
                                    <div class="flex items-center gap-4">
                                        <button id="play-pause-btn" class="text-white text-2xl w-8 text-center"><i class="fas fa-play"></i></button>
                                        <button id="volume-btn" class="text-white text-xl w-8 text-center"><i class="fas fa-volume-up"></i></button>
                                    </div>
                                    <button id="fullscreen-btn" class="text-white text-xl w-8 text-center"><i class="fas fa-expand"></i></button>
                                </div>
                            </div>
                        </div>
                        <!-- Settings Panel -->
                        <div id="player-settings-panel">
                            <div id="settings-main-view">
                                <div class="p-4 border-b border-gray-700/50 flex items-center">
                                    <h3 class="font-bold text-lg" data-lang-key="playerSettings"></h3>
                                </div>
                                <div class="flex-grow overflow-y-auto">
                                    <div id="quality-settings-btn" class="settings-item"><div class="flex items-center gap-4"><i class="fas fa-high-definition"></i> <span data-lang-key="quality"></span></div> <div class="flex items-center gap-2"><span id="current-quality-label" class="text-gray-400 text-sm">720p</span><i class="fas fa-chevron-right text-gray-500"></i></div></div>
                                    <div id="speed-settings-btn" class="settings-item"><div class="flex items-center gap-4"><i class="fas fa-tachometer-alt"></i> <span data-lang-key="playbackSpeed"></span></div> <div class="flex items-center gap-2"><span id="current-speed-label" class="text-gray-400 text-sm" data-lang-key="normalSpeed"></span><i class="fas fa-chevron-right text-gray-500"></i></div></div>
                                    <!-- Audio settings: foydalanuvchi uchun audio trekni tanlash -->
                                    <div id="audio-settings-btn" class="settings-item"><div class="flex items-center gap-4"><i class="fas fa-headphones"></i> <span>Audio</span></div> <div class="flex items-center gap-2"><span id="current-audio-label" class="text-gray-400 text-sm">Auto</span><i class="fas fa-chevron-right text-gray-500"></i></div></div>
                                    <div id="subtitles-settings-btn" class="settings-item"><div class="flex items-center gap-4"><i class="fas fa-closed-captioning"></i> <span data-lang-key="subtitles"></span></div> <div class="flex items-center gap-2"><span id="current-subtitle-label" class="text-gray-400 text-sm" data-lang-key="noSubtitles"></span><i class="fas fa-chevron-right text-gray-500"></i></div></div>
                                    <div id="more-settings-btn" class="settings-item"><div class="flex items-center gap-4"><i class="fas fa-ellipsis-h"></i> <span data-lang-key="more"></span></div> <i class="fas fa-chevron-right text-gray-500"></i></div>
                                </div>
                            </div>
                            <div id="settings-quality-view" class="hidden flex-grow flex-col"></div>
                            <div id="settings-speed-view" class="hidden flex-grow flex-col"></div>
                            <!-- Audio settings view container -->
                            <div id="settings-audio-view" class="hidden flex-grow flex-col"></div>
                            <div id="settings-subtitles-view" class="hidden flex-grow flex-col"></div>
                            <div id="settings-more-view" class="hidden flex-grow flex-col"></div>
                        </div>
                    </div>
                </div>
                ${episodesHTML}
            </div>`;
    }


    function setupPageEventListeners(state) {
        const pageContainer = document.getElementById(state.page);
        if (!pageContainer) return;

        const pageId = state.page;
        if (pageId === 'main') {
            // Populate categories and filter movies on load
            if (movies.length > 0) {
                populateCategories();
                const activeCategoryButton = document.querySelector('#category-nav .category-btn.active');
                const currentCategory = activeCategoryButton ? activeCategoryButton.dataset.categoryValue : 'categoryAll';
                filterAndDisplayMovies(currentCategory);
            }
            // Hero slide click navigates to movie details
            pageContainer.querySelectorAll('.hero-slide-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = e.currentTarget.dataset.movieId;
                    if (id) navigate({ page: 'movie-details', movieId: id });
                });
            });
            // Update dots based on scroll position
            const slider = pageContainer.querySelector('#hero-slider');
            const dots = pageContainer.querySelectorAll('.hero-dots .dot');
            if (slider && dots && dots.length > 0) {
                slider.addEventListener('scroll', () => {
                    const width = slider.clientWidth || 1;
                    const index = Math.round(slider.scrollLeft / width);
                    dots.forEach((d, i) => {
                        if (i === index) d.classList.add('active'); else d.classList.remove('active');
                    });
                });
            }
            // Attach click handlers to top navigation tabs.  When a tab is clicked
            // (e.g. Home, Series, Movies, SND, Sports, Challenges), call
            // applyTopSection() with the appropriate section.  This will hide or
            // show the hero banner, filter the movie list and update the active
            // underline on the tab.
            // Using event delegation to handle both primary and secondary nav items
            if (!topNavHandlerAttached) {
                topNavHandlerAttached = true;
                document.addEventListener('click', (ev) => {
                    const navItem = ev.target.closest('.top-nav-item');
                    if (navItem) {
                        ev.preventDefault();
                        ev.stopPropagation();
                        const sect = navItem.dataset.section;
                        if (sect) {
                            console.log('Nav clicked:', sect); // Debug
                            applyTopSection(sect);
                        }
                    }
                }, false);
            }

            // Movie search input filters displayed movies in current section
            const searchInput = pageContainer.querySelector('#movie-search-input');
            if (searchInput) {
                searchInput.addEventListener('input', () => {
                    const query = searchInput.value.trim().toLowerCase();
                    const moviesGrid = document.getElementById('movies-grid');
                    if (!moviesGrid) return;

                    if (!query) {
                        // If no search query, reapply current section filter
                        applyTopSection(selectedSection);
                    } else {
                        // Filter movies based on current section and search query
                        const show18Plus = JSON.parse(localStorage.getItem('soundora-show18plus')) || false;
                        let baseMovies = show18Plus ? movies : movies.filter(m => !m.is18Plus);

                        // Apply section filter first
                        let sectionFiltered = [];
                        switch (selectedSection) {
                            case 'home':
                                sectionFiltered = baseMovies.filter(m => {
                                    const primary = String(m.primaryCategory || '').toLowerCase();
                                    return primary !== 'sports' && primary !== 'challenge';
                                });
                                break;
                            case 'series':
                                sectionFiltered = baseMovies.filter(m => {
                                    const primary = String(m.primaryCategory || '').toLowerCase();
                                    return primary !== 'sports' && primary !== 'challenge' && String(m.type || '').toLowerCase() === 'series';
                                });
                                break;
                            case 'movies':
                                sectionFiltered = baseMovies.filter(m => {
                                    const primary = String(m.primaryCategory || '').toLowerCase();
                                    return primary !== 'sports' && primary !== 'challenge' && String(m.type || '').toLowerCase() !== 'series';
                                });
                                break;
                            case 'snd':
                                sectionFiltered = baseMovies.filter(m => {
                                    const primary = String(m.primaryCategory || '').toLowerCase();
                                    if (primary === 'snd') return true;
                                    const genre = String(m.genre || '').toLowerCase();
                                    const studio = String(m.studio || '').toLowerCase();
                                    return genre.includes('snd') || studio.includes('snd');
                                });
                                break;
                            case 'sports':
                                sectionFiltered = filterSportsMovies(baseMovies, selectedSportsCategory);
                                break;
                            case 'challenges':
                                sectionFiltered = baseMovies.filter(m => {
                                    const primary = String(m.primaryCategory || '').toLowerCase();
                                    if (primary === 'challenge') return true;
                                    const genre = String(m.genre || '').toLowerCase();
                                    return genre.includes('challenge');
                                });
                                break;
                            default:
                                sectionFiltered = baseMovies;
                        }

                        // Then apply search query
                        const filtered = sectionFiltered.filter(m =>
                            (m.title && m.title.toLowerCase().includes(query)) ||
                            (m.originalTitle && m.originalTitle.toLowerCase().includes(query)) ||
                            (m.description && m.description.toLowerCase().includes(query))
                        );

                        moviesGrid.innerHTML = filtered.length > 0 ? filtered.map(createMovieCardHTML).join('') : `<p class="col-span-full text-center text-gray-400 mt-8" data-lang-key="noResults"></p>`;
                        window.handleMovieCardClick = (e) => { e.preventDefault(); navigate({ page: 'movie-details', movieId: e.currentTarget.dataset.movieId }); };
                        setLanguage(currentLanguage);
                    }
                });
            }
        } else if (pageId === 'movie-details') {
            const detailsMovie = movies.find(m => String(m.id) === String(state.movieId));
            // Back button
            const backBtn = pageContainer.querySelector('#back-button');
            backBtn?.addEventListener('click', () => history.back());
            // Episode items (if series controls rendered)
            pageContainer.querySelectorAll('.episode-item').forEach(item => item.addEventListener('click', handlePlayClick));
            // Favorite button
            pageContainer.querySelector('#fav-button')?.addEventListener('click', handleFavoriteClick);
            // Download button
            pageContainer.querySelector('#download-button')?.addEventListener('click', handleDownloadClick);
            // SND rating button event
            const rateBtn = pageContainer.querySelector('#snd-rate-btn');
            if (rateBtn) {
                rateBtn.addEventListener('click', () => {
                    openRatingModal(state.movieId);
                });
            }
            pageContainer.querySelectorAll('.screenshot-thumb').forEach(btn => {
                btn.addEventListener('click', () => {
                    const src = btn.dataset.screenshot;
                    if (!src) return;
                    const title = detailsMovie?.title || 'Screenshot';
                    showModal(`
                        <div class="relative bg-black rounded-2xl overflow-hidden w-[90vw] max-w-3xl">
                            <button class="close-modal-btn absolute top-3 right-3 text-gray-400 hover:text-white text-3xl leading-none">×</button>
                            <img src="${src}" alt="${title} screenshot" class="w-full h-full object-contain max-h-[80vh] bg-black" onerror="this.onerror=null;this.src='https://placehold.co/1280x720/111827/ffffff?text=SND';">
                        </div>
                    `);
                });
            });
            // Cast button event
            const castBtn = pageContainer.querySelector('#cast-button');
            if (castBtn) {
                castBtn.addEventListener('click', requestCastingSession);
            }
            // Info tab buttons (description, actors, rating)
            const tabButtons = pageContainer.querySelectorAll('.info-tab-btn');
            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.dataset.tab;
                    // update active classes on buttons
                    tabButtons.forEach(b => {
                        b.classList.remove('bg-red-600', 'active');
                        b.classList.add('bg-gray-800');
                    });
                    btn.classList.remove('bg-gray-800');
                    btn.classList.add('bg-red-600', 'active');
                    // hide all sections
                    pageContainer.querySelectorAll('.info-tab-content').forEach(div => div.classList.add('hidden'));
                    const section = pageContainer.querySelector(`#info-${tab}`);
                    section?.classList.remove('hidden');
                    // If the rating tab is activated, animate the rating bars to their final widths
                    if (tab === 'rating' && section) {
                        const bars = section.querySelectorAll('.rating-bar-fill');
                        bars.forEach(bar => {
                            const finalWidth = bar.dataset.final || '0';
                            // Reset width to 0 then animate to final width after a tiny delay
                            bar.style.width = '0%';
                            setTimeout(() => {
                                bar.style.width = `${finalWidth}%`;
                            }, 10);
                        });
                    }
                });
            });
            // Initialize series controls for series-type movies on mobile
            initializeSeriesControls(state.movieId);

            // Video control panel events for the sticky card
            const videoEl = pageContainer.querySelector('#card-video');
            // Guests should not get autoplaying previews — enable autoplay only when user is authenticated
            try { if (videoEl) videoEl.autoplay = !!currentUser; } catch (err) {}
            // Overlays and controls
            const centerOverlay = pageContainer.querySelector('#card-center-overlay');
            const bottomControls = pageContainer.querySelector('#card-bottom-controls');
            const progress = pageContainer.querySelector('#card-progress');
            const currentTimeEl = pageContainer.querySelector('#card-current-time');
            const durationEl = pageContainer.querySelector('#card-duration');
            const playPauseBtn = pageContainer.querySelector('#card-play-pause-button');
            const speedIndicator = pageContainer.querySelector('#card-speed-indicator');
            const fullscreenBtn = pageContainer.querySelector('#card-fullscreen-button');
            const settingsTopBtn = pageContainer.querySelector('#card-settings-button');
            const settingsMenu = pageContainer.querySelector('#card-settings-menu');
            const miniToggle = pageContainer.querySelector('#card-mini-toggle');

            // Format time helper for video controls
            const formatTime = (secs) => {
                if (secs === undefined || secs === null || isNaN(secs)) return '00:00';
                const m = Math.floor(secs / 60);
                const s = Math.floor(secs % 60);
                return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
            };

            // Show/hide overlay and bottom controls
            let hideControlsTimeout;
            const showControls = () => {
                if (centerOverlay) centerOverlay.classList.remove('hidden');
                if (bottomControls) bottomControls.classList.remove('hidden');
                // reset hide timer
                if (hideControlsTimeout) clearTimeout(hideControlsTimeout);
                hideControlsTimeout = setTimeout(() => {
                    if (centerOverlay) centerOverlay.classList.add('hidden');
                    if (bottomControls) bottomControls.classList.add('hidden');
                }, 5000);
            };
            const hideControls = () => {
                if (centerOverlay) centerOverlay.classList.add('hidden');
                if (bottomControls) bottomControls.classList.add('hidden');
                if (hideControlsTimeout) clearTimeout(hideControlsTimeout);
            };

            // Double tap and hold detection variables
            let lastTapTime = 0;
            let holdTimeout;
            let isHolding = false;

            // Resume handling logic will be applied after video element is initialized

            if (videoEl) {
                const updateProgressVisual = () => {
                    if (!progress) return;
                    const duration = videoEl.duration || 1;
                    const current = Math.max(0, Math.min(videoEl.currentTime || 0, duration));
                    const watchedRatio = duration ? current / duration : 0;
                    let bufferedRatio = watchedRatio;
                    if (videoEl.buffered && videoEl.buffered.length) {
                        try {
                            const bufferedEnd = videoEl.buffered.end(videoEl.buffered.length - 1);
                            bufferedRatio = duration ? Math.max(watchedRatio, Math.min(bufferedEnd / duration, 1)) : watchedRatio;
                        } catch (_) {}
                    }
                    progress.style.setProperty('--watched-percent', `${(watchedRatio * 100).toFixed(2)}%`);
                    progress.style.setProperty('--buffered-percent', `${(bufferedRatio * 100).toFixed(2)}%`);
                };

                // Check for saved position and whether returning from the full player
                if (state.movieId) {
                    try {
                        const savedTimeRaw2 = localStorage.getItem(`soundora-play-position-${state.movieId}`);
                        const savedPos = savedTimeRaw2 ? parseFloat(savedTimeRaw2) : 0;
                        if (savedPos && savedPos > 0.1 && !isNaN(savedPos)) {
                            const returningFlag = sessionStorage.getItem('returnFromPlayer');
                            if (returningFlag === 'true') {
                                // If returning from full player, automatically resume at saved position and pause
                                videoEl.currentTime = savedPos;
                                videoEl.pause();
                                sessionStorage.removeItem('returnFromPlayer');
                                // Show controls to indicate position
                                showControls();
                            } else if (isResumePromptEnabled && !miniPlayerState.active) {
                                        // Automatically resume from saved position without showing any overlay
                                        videoEl.currentTime = savedPos;
                                        // Auto-play resume only for logged-in users; guests must sign in to play
                                        try {
                                            if (currentUser) {
                                                videoEl.play();
                                            } else {
                                                // make sure we don't leave a spinner for guests
                                                try { playerLoadingSpinner.classList.add('hidden'); } catch(_) {}
                                                if (centerPlayBtn) centerPlayBtn.classList.remove('hidden');
                                            }
                                        } catch (err) {}
                                        showControls();
                                    }
                        }
                    } catch (err) {}
                }

                // Ensure audio not muted by default
                videoEl.muted = false;
                // On loaded metadata, set duration
                videoEl.addEventListener('loadedmetadata', () => {
                    progress.max = videoEl.duration || 0;
                    durationEl.textContent = formatTime(videoEl.duration || 0);
                    currentTimeEl.textContent = formatTime(videoEl.currentTime || 0);
                    updateProgressVisual();
                });
                // Update current time, progress bar and save position
                videoEl.addEventListener('timeupdate', () => {
                    if (!isNaN(videoEl.currentTime)) {
                        progress.value = videoEl.currentTime;
                        currentTimeEl.textContent = formatTime(videoEl.currentTime);
                        // Persist current position to allow resume later
                        try {
                            if (state.movieId) {
                                localStorage.setItem(`soundora-play-position-${state.movieId}`, videoEl.currentTime);
                            }
                        } catch (err) {}
                    }
                    updateProgressVisual();
                });
                videoEl.addEventListener('progress', updateProgressVisual);
                // Play/pause overlay behaviour: update icon on play/pause events
                const updatePlayIcon = () => {
                    if (!playPauseBtn) return;
                    if (videoEl.paused) {
                        playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    } else {
                        playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    }
                };
                videoEl.addEventListener('play', updatePlayIcon);
                videoEl.addEventListener('pause', updatePlayIcon);
                // Progress slider input sets current time
                progress?.addEventListener('input', () => {
                    try {
                        videoEl.currentTime = parseFloat(progress.value);
                    } catch (err) {}
                    updateProgressVisual();
                });
                // Play/Pause button click toggles play. Require authentication to start playback for guests.
                playPauseBtn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (videoEl.paused) {
                        if (!currentUser) {
                            // Save desired destination and send user to login
                            try { postLoginRedirect = { page: 'player', movieId: state.movieId, episodeIndex: state.episodeIndex ? parseInt(state.episodeIndex, 10) : 0 }; } catch(_) {}
                            showToast(translations[currentLanguage].loginRequired);
                            navigate({ page: 'login' });
                            return;
                        }
                        videoEl.play();
                    } else {
                        videoEl.pause();
                    }
                    showControls();
                });
                // Fullscreen button to open full player
                fullscreenBtn?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Save current playback position before navigating to full player
                    try {
                        const movieId = state.movieId;
                        if (videoEl && movieId) {
                            localStorage.setItem(`soundora-play-position-${movieId}`, videoEl.currentTime);
                        }
                    } catch (err) {}
                    handlePlayClick(e);
                });

                // When video plays or pauses, adjust control visibility
                videoEl.addEventListener('pause', () => {
                    // Show controls and keep overlay visible while paused
                    showControls();
                    if (hideControlsTimeout) clearTimeout(hideControlsTimeout);
                });
                videoEl.addEventListener('play', () => {
                    // Show controls and allow auto-hide after delay
                    showControls();
                });

                // Show controls on tap/click
                const handleTap = (event) => {
                    const now = Date.now();
                    const rect = videoEl.getBoundingClientRect();
                    const x = event instanceof TouchEvent ? event.touches[0].clientX : event.clientX;
                    const isDoubleTap = now - lastTapTime < 300;
                    lastTapTime = now;
                    if (isDoubleTap) {
                        // Determine left or right half
                        if (x < rect.left + rect.width / 2) {
                            // skip back 10 seconds
                            try {
                                videoEl.currentTime = Math.max(videoEl.currentTime - 10, 0);
                            } catch (err) {}
                        } else {
                            // skip forward 10 seconds
                            try {
                                const dur = videoEl.duration || 0;
                                const newTime = videoEl.currentTime + 10;
                                videoEl.currentTime = dur ? Math.min(newTime, dur) : newTime;
                            } catch (err) {}
                        }
                        showControls();
                    } else {
                        showControls();
                    }
                };

                // Hold detection for 2x speed on card (touch or mouse)
                const startHold = () => {
                    if (holdTimeout) clearTimeout(holdTimeout);
                    holdTimeout = setTimeout(() => {
                        isHolding = true;
                        videoEl.playbackRate = 2;
                        if (speedIndicator) {
                            speedIndicator.style.opacity = '1';
                        }
                    }, 300); // start 2x after long press of 300ms
                };
                const endHold = () => {
                    if (holdTimeout) clearTimeout(holdTimeout);
                    if (isHolding) {
                        isHolding = false;
                        videoEl.playbackRate = 1;
                        if (speedIndicator) {
                            speedIndicator.style.opacity = '0';
                        }
                    }
                };

                // Bind events for tap, hold
                videoEl.addEventListener('click', handleTap);
                videoEl.addEventListener('touchend', handleTap);
                videoEl.addEventListener('mousedown', startHold);
                videoEl.addEventListener('touchstart', startHold);
                videoEl.addEventListener('mouseup', endHold);
                videoEl.addEventListener('mouseleave', endHold);
                videoEl.addEventListener('touchend', endHold);
                videoEl.addEventListener('touchcancel', endHold);
        }
        // Language dropdown toggle/menu inside page cards (register/genre-survey etc.)
        const langToggle = pageContainer.querySelector('#lang-toggle-btn');
        const langMenu = pageContainer.querySelector('#lang-menu');
        if (langToggle && langMenu) {
            const hideMenu = () => {
                langMenu.classList.add('hidden');
                langMenu.style.display = 'none';
            };
            const showMenu = () => {
                langMenu.classList.remove('hidden');
                langMenu.style.display = 'block';
            };

            langToggle.addEventListener('click', (ev) => {
                ev.stopPropagation();
                const isHidden = langMenu.classList.contains('hidden') || getComputedStyle(langMenu).display === 'none';
                if (isHidden) {
                    showMenu();
                    // add one-time outside click listener to close menu
                    const onDocClick = (e) => {
                        if (!pageContainer.contains(e.target)) {
                            hideMenu();
                            document.removeEventListener('click', onDocClick);
                        }
                    };
                    // Use capture false; it will remove itself when triggered
                    document.addEventListener('click', onDocClick);
                } else {
                    hideMenu();
                }
            });

            // Language selection
            langMenu.querySelectorAll('.lang-item').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const chosen = e.currentTarget.dataset.lang;
                    setLanguage(chosen);
                    // update toggle label
                    const label = { en: 'EN ▾', ru: 'RU ▾', uz: 'UZ ▾', tj: 'TJ ▾', kz: 'KZ ▾', kg: 'KG ▾' }[chosen] || 'EN ▾';
                    langToggle.textContent = label;
                    hideMenu();
                });
            });

            // Ensure menu hidden initially via style for reliability
            hideMenu();
        }

            const settingsBackdrop = pageContainer.querySelector('#card-settings-backdrop');
            const settingsCloseBtn = pageContainer.querySelector('#card-settings-close');
            const qualityOptionsWrap = pageContainer.querySelector('#card-quality-options');
            const speedOptionsWrap = pageContainer.querySelector('#card-speed-options');
            const subtitlesToggle = pageContainer.querySelector('#card-subtitles-toggle');
            const screenLockBtn = pageContainer.querySelector('#card-screenlock-btn');

            let isSettingsOpen = false;
            let settingsKeydownHandler = null;

            const closeSettingsMenu = () => {
                if (!settingsMenu || !isSettingsOpen) return;
                settingsMenu.classList.add('hidden');
                document.body.classList.remove('snd-modal-locked');
                isSettingsOpen = false;
                if (settingsKeydownHandler) {
                    document.removeEventListener('keydown', settingsKeydownHandler);
                    settingsKeydownHandler = null;
                }
            };

            const openSettingsMenu = () => {
                if (!settingsMenu || isSettingsOpen) return;
                settingsMenu.classList.remove('hidden');
                document.body.classList.add('snd-modal-locked');
                isSettingsOpen = true;
                settingsKeydownHandler = (evt) => {
                    if (evt.key === 'Escape') {
                        evt.preventDefault();
                        closeSettingsMenu();
                    }
                };
                document.addEventListener('keydown', settingsKeydownHandler);
            };

            settingsTopBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                openSettingsMenu();
            });
            settingsBackdrop?.addEventListener('click', closeSettingsMenu);
            settingsCloseBtn?.addEventListener('click', closeSettingsMenu);

            if (miniToggle) {
                miniToggle.checked = isMiniPlayerEnabled;
                miniToggle.addEventListener('change', (e) => {
                    isMiniPlayerEnabled = e.target.checked;
                    localStorage.setItem('soundora-miniPlayerEnabled', JSON.stringify(isMiniPlayerEnabled));
                });
            }

            const getSourcesForMovie = () => {
                const currentMovie = movies.find(m => String(m.id) === String(state.movieId));
                if (!currentMovie) return null;
                if (currentMovie.type === 'series' && Array.isArray(currentMovie.episodes)) {
                    const index = Number.isInteger(state?.episodeIndex) ? Number(state.episodeIndex) : 0;
                    const episode = currentMovie.episodes[index] || currentMovie.episodes[0];
                    return episode?.sources || null;
                }
                return currentMovie.sources || null;
            };

            const qualityOrder = ['1080p', '720p', '480p', '360p', '240p', '144p'];
            const sources = getSourcesForMovie();
            const availableQualities = sources ? Array.from(new Set([...qualityOrder.filter(q => sources[q]), ...Object.keys(sources)])) : [];
            const autoQualities = availableQualities.slice();
            let selectedQuality = 'auto';
            let activeQuality = autoQualities[0] || null;
            let autoQualityIndex = 0;
            let autoFallbackTimer = null;

            const setQualityButtonState = () => {
                if (!qualityOptionsWrap) return;
                const autoLabel = translations[currentLanguage]?.autoQuality || 'Auto';
                qualityOptionsWrap.querySelectorAll('button').forEach((btn) => {
                    const value = btn.dataset.quality;
                    if (value === 'auto') {
                        btn.textContent = selectedQuality === 'auto' && activeQuality ? `${autoLabel} (${activeQuality})` : autoLabel;
                    }
                    btn.classList.toggle('active', selectedQuality === value || (value === 'auto' && selectedQuality === 'auto'));
                });
            };

            const switchToQuality = (quality, { fromAuto } = {}) => {
                const map = getSourcesForMovie();
                if (!map || !map[quality] || !videoEl) return;
                const wasPaused = videoEl.paused;
                const currentTime = videoEl.currentTime || 0;
                const currentRate = videoEl.playbackRate || 1;
                const restore = () => {
                    try { videoEl.currentTime = currentTime; } catch {}
                    try { videoEl.playbackRate = currentRate; } catch {}
                    videoEl.removeEventListener('loadedmetadata', restore);
                };
                videoEl.addEventListener('loadedmetadata', restore);
                videoEl.src = map[quality];
                if (!wasPaused) {
                    try { if (currentUser) videoEl.play().catch(() => {}); } catch(_) {}
                }
                activeQuality = quality;
                if (!fromAuto) {
                    selectedQuality = quality;
                }
                setQualityButtonState();
            };

            const degradeAutoQuality = () => {
                if (selectedQuality !== 'auto') return;
                if (autoQualityIndex < autoQualities.length - 1) {
                    autoQualityIndex += 1;
                    const nextQuality = autoQualities[autoQualityIndex];
                    if (nextQuality) {
                        switchToQuality(nextQuality, { fromAuto: true });
                    }
                }
            };

            const cancelAutoFallback = () => {
                if (autoFallbackTimer) {
                    clearTimeout(autoFallbackTimer);
                    autoFallbackTimer = null;
                }
            };

            const scheduleAutoFallback = () => {
                if (selectedQuality !== 'auto' || autoFallbackTimer) return;
                autoFallbackTimer = setTimeout(() => {
                    autoFallbackTimer = null;
                    degradeAutoQuality();
                }, 3500);
            };

            if (videoEl) {
                videoEl.addEventListener('waiting', scheduleAutoFallback);
                videoEl.addEventListener('playing', cancelAutoFallback);
            }

            if (qualityOptionsWrap) {
                const autoLabel = translations[currentLanguage]?.autoQuality || 'Auto';
                const buttons = [];
                buttons.push(`<button type=\"button\" class=\"snd-chip-option\" data-quality=\"auto\">${autoLabel}</button>`);
                availableQualities.forEach((quality) => {
                    buttons.push(`<button type=\"button\" class=\"snd-chip-option\" data-quality=\"${quality}\">${quality}</button>`);
                });
                qualityOptionsWrap.innerHTML = buttons.join('');
                qualityOptionsWrap.querySelectorAll('button').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const value = btn.dataset.quality;
                        cancelAutoFallback();
                        if (value === 'auto') {
                            selectedQuality = 'auto';
                            autoQualityIndex = 0;
                            const firstQuality = autoQualities[autoQualityIndex];
                            if (firstQuality) {
                                switchToQuality(firstQuality, { fromAuto: true });
                            }
                        } else if (sources && sources[value]) {
                            selectedQuality = value;
                            switchToQuality(value, { fromAuto: false });
                        }
                        setQualityButtonState();
                    });
                });
                setQualityButtonState();
            }

            const playbackSpeeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
            if (speedOptionsWrap) {
                const chips = playbackSpeeds.map((rate) => {
                    const label = rate === 1 ? (translations[currentLanguage]?.normalSpeed || 'Normal') : `${rate}x`;
                    return `<button type=\"button\" class=\"snd-chip-option\" data-speed=\"${rate}\">${label}</button>`;
                });
                speedOptionsWrap.innerHTML = chips.join('');
                const updateSpeedState = () => {
                    speedOptionsWrap.querySelectorAll('button').forEach((btn) => {
                        const rate = parseFloat(btn.dataset.speed);
                        btn.classList.toggle('active', Math.abs((videoEl?.playbackRate || 1) - rate) < 0.01);
                    });
                };
                speedOptionsWrap.querySelectorAll('button').forEach((btn) => {
                    btn.addEventListener('click', () => {
                        const rate = parseFloat(btn.dataset.speed);
                        if (videoEl && !isNaN(rate)) {
                            videoEl.playbackRate = rate;
                            updateSpeedState();
                        }
                    });
                });
                if (videoEl) {
                    videoEl.addEventListener('ratechange', updateSpeedState);
                }
                updateSpeedState();
            }

            subtitlesToggle?.addEventListener('change', () => {
                subtitlesToggle.checked = false;
                showToast(translations[currentLanguage]?.noSubtitles || 'Subtitles are not available.');
            });
            screenLockBtn?.addEventListener('click', () => {
                showToast('Screen lock is not available yet.');
            });

            window.refreshCardSettingsLabels = () => {
                setQualityButtonState();
                if (speedOptionsWrap) {
                    speedOptionsWrap.querySelectorAll('button').forEach((btn) => {
                        const rate = parseFloat(btn.dataset.speed);
                        if (rate === 1) {
                            btn.textContent = translations[currentLanguage]?.normalSpeed || 'Normal';
                        }
                    });
                }
            };

            const filmographySection = pageContainer.querySelector('#cast-filmography');
            const filmographyNameEl = pageContainer.querySelector('#cast-filmography-name');
            const filmographyGrid = pageContainer.querySelector('#cast-filmography-grid');
            const filmographyClose = pageContainer.querySelector('#cast-filmography-close');
            const castCards = pageContainer.querySelectorAll('.snd-cast-card');

            const normalizeName = (value) => String(value || '').trim().toLowerCase();
            const splitNames = (value) => {
                const results = [];
                const append = (str) => {
                    String(str || '')
                        .split(/[;,/]/)
                        .map(part => part.trim())
                        .filter(Boolean)
                        .forEach((part) => results.push(part));
                };
                if (Array.isArray(value)) {
                    value.forEach((entry) => {
                        if (typeof entry === 'string') {
                            append(entry);
                        } else if (entry && typeof entry === 'object') {
                            append(entry.name || entry.fullName || entry.title || '');
                        }
                    });
                } else if (typeof value === 'string') {
                    append(value);
                }
                return results;
            };
            const extractCastNames = (castList) => {
                if (!Array.isArray(castList)) return [];
                return castList.map((member) => {
                    if (typeof member === 'string') return member;
                    if (member && typeof member === 'object') {
                        return member.name || member.fullName || member.title || '';
                    }
                    return '';
                }).filter(Boolean);
            };
            const filterMoviesByPerson = (personName, types) => {
                const normalized = normalizeName(personName);
                if (!normalized) return [];
                const allowed = new Set(types && types.length ? types : ['cast']);
                return movies.filter((movieItem) => {
                    if (!movieItem) return false;
                    if (allowed.has('cast')) {
                        if (extractCastNames(movieItem.cast).some(name => normalizeName(name) === normalized)) return true;
                    }
                    if (allowed.has('director')) {
                        if (splitNames(movieItem.directors || movieItem.director || '').some(name => normalizeName(name) === normalized)) return true;
                    }
                    if (allowed.has('creator')) {
                        if (splitNames(movieItem.creators || movieItem.producer || movieItem.showrunner || movieItem.writer || movieItem.writers || '').some(name => normalizeName(name) === normalized)) return true;
                    }
                    return false;
                });
            };
            const renderFilmographyCard = (movieItem) => {
                const safePoster = (movieItem.poster || `https://placehold.co/200x300/111827/ffffff?text=${encodeURIComponent(movieItem.title || 'Movie')}`).replace(/\"/g, '"');
                return `
                    <a href=\"#\" class=\"filmography-card group flex items-center gap-3 rounded-2xl bg-gray-900/60 hover:bg-gray-800/70 transition-colors p-3\" data-movie-id=\"${movieItem.id}\">
                        <div class=\"w-14 h-20 rounded-xl overflow-hidden bg-gray-800 flex-shrink-0\">
                            <img src=\"${safePoster}\" alt=\"${movieItem.title || ''}\" class=\"w-full h-full object-cover\" onerror=\"this.onerror=null;this.src='https://placehold.co/200x300/111827/ffffff?text=SND';\">
                        </div>
                        <div class=\"flex-1 min-w-0\">
                            <p class=\"text-sm font-semibold text-white truncate\">${movieItem.title || ''}</p>
                            <p class=\"text-xs text-gray-400\">${movieItem.year || ''}</p>
                        </div>
                        <i class=\"fas fa-chevron-right text-gray-600\"></i>
                    </a>`;
            };
            const showFilmography = (personName, types) => {
                if (!filmographySection || !filmographyGrid || !filmographyNameEl) return;
                const related = filterMoviesByPerson(personName, types).slice(0, 8);
                filmographyNameEl.textContent = personName;
                if (related.length === 0) {
                    filmographyGrid.innerHTML = `<p class=\"text-sm text-gray-400\">${translations[currentLanguage]?.filmographyEmpty || 'No other titles yet.'}</p>`;
                } else {
                    filmographyGrid.innerHTML = related.map(renderFilmographyCard).join('');
                    filmographyGrid.querySelectorAll('[data-movie-id]').forEach((link) => {
                        link.addEventListener('click', (event) => {
                            event.preventDefault();
                            const targetId = link.dataset.movieId;
                            if (targetId) {
                                navigate({ page: 'movie-details', movieId: targetId });
                                filmographySection.classList.add('hidden');
                                castCards.forEach((btn) => btn.classList.remove('active'));
                            }
                        });
                    });
                }
                filmographySection.classList.remove('hidden');
            };
            filmographyClose?.addEventListener('click', () => {
                filmographySection?.classList.add('hidden');
                castCards.forEach((btn) => btn.classList.remove('active'));
            });
            castCards.forEach((card) => {
                card.addEventListener('click', () => {
                    const alreadyActive = card.classList.contains('active');
                    castCards.forEach((btn) => btn.classList.remove('active'));
                    if (alreadyActive) {
                        filmographySection?.classList.add('hidden');
                        return;
                    }
                    card.classList.add('active');
                    const personName = card.dataset.personName || '';
                    const types = (card.dataset.personTypes || '').split(',').map((type) => type.trim().toLowerCase()).filter(Boolean);
                    showFilmography(personName, types);
                });
            });

            // Bind fullscreen button. If video is present, open full player; otherwise, use fallback
            const fullscreenButton = pageContainer.querySelector('#card-fullscreen-button');
            if (fullscreenButton) {
                fullscreenButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // If video exists, navigate to full player page using movieId and episodeIndex
                    if (videoEl) {
                        const movieId = e.currentTarget.dataset.movieId || ((state && state.movieId) ? state.movieId : undefined);
                        const epIndex = e.currentTarget.dataset.episodeIndex ? parseInt(e.currentTarget.dataset.episodeIndex, 10) : ((state && state.episodeIndex) || 0);
                        if (movieId) {
                            navigate({ page: 'player', movieId: movieId, episodeIndex: epIndex });
                        }
                    } else {
                        // Fallback for image-based card
                        handlePlayClick(e);
                    }
                });
            }
        } else if (pageId === 'favorites') {
            pageContainer.querySelectorAll('.movie-card-link').forEach(card => card.addEventListener('click', handleMovieCardClick));
        } else if (pageId === 'downloads') {
            // Attach movie card click handlers on downloads page
            pageContainer.querySelectorAll('.movie-card-link').forEach(card => card.addEventListener('click', handleMovieCardClick));
        } else if (pageId === 'profile') {
            pageContainer.querySelector('#settings-btn').addEventListener('click', () => navigate({ page: 'settings' }));
            pageContainer.querySelector('#premium-btn').addEventListener('click', () => navigate({ page: 'premium' }));
            pageContainer.querySelector('#privacy-policy-btn').addEventListener('click', () => navigate({ page: 'privacy-policy' }));
            pageContainer.querySelector('#faq-btn').addEventListener('click', () => navigate({ page: 'faq' }));
            pageContainer.querySelector('#copy-id-btn').addEventListener('click', copyUserId);
            pageContainer.querySelector('#report-feedback-btn')?.addEventListener('click', openFeedbackModal);
            // Replace AI chat with a full-page support chat. Instead of opening a modal,
            // clicking the chat button in the profile section navigates to support.html.
            pageContainer.querySelector('#profile-ai-chat-btn').addEventListener('click', () => {
                window.location.href = 'support.html';
            });
            // New account switch and logout handlers
            const switchTop = pageContainer.querySelector('#switch-account-btn');
            const switchBottom = pageContainer.querySelector('#switch-account-btn-bottom');
            const logoutBottom = pageContainer.querySelector('#logout-btn-bottom');
            const devicesBtn = pageContainer.querySelector('#connected-devices-btn');

            switchTop?.addEventListener('click', openAccountSwitchModal);
            switchBottom?.addEventListener('click', openAccountSwitchModal);
            logoutBottom?.addEventListener('click', () => handleLogout({ preserveAccounts: true }));
            devicesBtn?.addEventListener('click', openDevicesModal);

            // Backwards compatibility for existing logout button
            pageContainer.querySelector('#logout-btn')?.addEventListener('click', () => handleLogout({ preserveAccounts: true }));

            // Navigate to Downloads page when the downloads button is clicked
            pageContainer.querySelector('#downloads-btn')?.addEventListener('click', () => navigate({ page: 'downloads' }));
        } else if (pageId === 'guest-profile') {
            // Replace AI chat with a full-page support chat for guests as well.
            pageContainer.querySelector('#guest-ai-chat-btn').addEventListener('click', () => {
                window.location.href = 'support.html';
            });
            pageContainer.querySelector('#guest-login-btn').addEventListener('click', () => navigate({ page: 'login' }));
        } else if (pageId === 'login') {
            pageContainer.querySelector('#login-form')?.addEventListener('submit', handleLoginSubmit);
            // Attach show/hide password toggle
            const pwToggle = pageContainer.querySelector('#login-password-toggle');
            const pwInput = pageContainer.querySelector('#login-password-input');
            if (pwToggle && pwInput) {
                pwToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    const isHidden = pwInput.getAttribute('type') === 'password';
                    pwInput.setAttribute('type', isHidden ? 'text' : 'password');
                    const icon = pwToggle.querySelector('i');
                    if (icon) {
                        icon.className = isHidden ? 'fas fa-eye-slash' : 'fas fa-eye';
                    }
                });
            }
            pageContainer.querySelector('#go-to-register-btn')?.addEventListener('click', () => navigate({ page: 'register' }));
            pageContainer.querySelector('#login-google-btn')?.addEventListener('click', (event) => handleGoogleAuth(event));
            pageContainer.querySelector('#qr-login-btn')?.addEventListener('click', openQRScanner);

        } else if (pageId === 'register') {
            pageContainer.querySelector('#register-form')?.addEventListener('submit', handleRegisterSubmit);
            pageContainer.querySelector('#go-to-login-btn')?.addEventListener('click', () => navigate({ page: 'login' }));
            pageContainer.querySelector('#register-google-btn')?.addEventListener('click', (event) => handleGoogleAuth(event));
            // Register password toggles
            const regToggle = pageContainer.querySelector('#register-password-toggle');
            const regInput = pageContainer.querySelector('#register-password-input');
            if (regToggle && regInput) {
                regToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    const isHidden = regInput.getAttribute('type') === 'password';
                    regInput.setAttribute('type', isHidden ? 'text' : 'password');
                    const icon = regToggle.querySelector('i');
                    if (icon) icon.className = isHidden ? 'fas fa-eye-slash' : 'fas fa-eye';
                });
            }
            const regConfirmToggle = pageContainer.querySelector('#register-password-confirm-toggle');
            const regConfirmInput = pageContainer.querySelector('#register-password-confirm-input');
            if (regConfirmToggle && regConfirmInput) {
                regConfirmToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    const isHidden = regConfirmInput.getAttribute('type') === 'password';
                    regConfirmInput.setAttribute('type', isHidden ? 'text' : 'password');
                    const icon = regConfirmToggle.querySelector('i');
                    if (icon) icon.className = isHidden ? 'fas fa-eye-slash' : 'fas fa-eye';
                });
            }

        } else if (pageId === 'genre-survey') {
            pageContainer.querySelector('#genre-survey-form')?.addEventListener('submit', handleGenreSurveySubmit);
            pageContainer.querySelector('#genre-survey-skip')?.addEventListener('click', handleGenreSurveySkip);
        } else if (pageId === 'settings') {
            pageContainer.querySelector('#back-button').addEventListener('click', () => history.back());
            pageContainer.querySelector('#edit-profile-btn').addEventListener('click', () => navigate({ page: 'edit-profile' }));
            pageContainer.querySelector('#language-settings-btn').addEventListener('click', () => navigate({ page: 'language-settings' }));
            pageContainer.querySelector('#playback-settings-btn').addEventListener('click', () => navigate({ page: 'playback-settings' }));
            pageContainer.querySelector('#content-settings-btn').addEventListener('click', () => navigate({ page: 'content-settings' }));
            // Navigate to region settings when region-settings button is clicked
            const regionBtn = pageContainer.querySelector('#region-settings-btn');
            if (regionBtn) {
                regionBtn.addEventListener('click', () => navigate({ page: 'region-settings' }));
            }
        } else if (pageId === 'playback-settings') {
            pageContainer.querySelector('#back-button').addEventListener('click', () => history.back());
            // Mini-player toggle change handler
            pageContainer.querySelector('#mini-player-toggle').addEventListener('change', (e) => {
                isMiniPlayerEnabled = e.target.checked;
                localStorage.setItem('soundora-miniPlayerEnabled', JSON.stringify(isMiniPlayerEnabled));
            });
            // Resume prompt toggle change handler
            const resumeToggle = pageContainer.querySelector('#resume-prompt-toggle');
            if (resumeToggle) {
                resumeToggle.addEventListener('change', (e) => {
                    isResumePromptEnabled = e.target.checked;
                    localStorage.setItem('soundora-resumePromptEnabled', JSON.stringify(isResumePromptEnabled));
                });
            }
        } else if (pageId === 'region-settings') {
            // Region settings page handlers
            pageContainer.querySelector('#back-button').addEventListener('click', () => history.back());
            const selectEl = pageContainer.querySelector('#region-select-setting');
            const saveBtn = pageContainer.querySelector('#save-region-btn');
            if (saveBtn && selectEl) {
                saveBtn.addEventListener('click', () => {
                    const selectedRegion = selectEl.value;
                    localStorage.setItem('soundora-region', selectedRegion);
                    // After saving, return to settings page
                    navigate({ page: 'settings' });
                });
            }
        } else if (['privacy-policy', 'faq', 'premium'].includes(pageId)) {
            pageContainer.querySelector('#back-button').addEventListener('click', () => history.back());
            // Setup promo code redemption on premium page
            if (pageId === 'premium') {
                const redeemBtn = pageContainer.querySelector('#redeem-promo-btn');
                redeemBtn?.addEventListener('click', async () => {
                    const inputEl = pageContainer.querySelector('#promo-code-input');
                    const feedbackEl = pageContainer.querySelector('#promo-feedback');
                    if (!inputEl || !feedbackEl) return;
                    const code = inputEl.value.trim();
                    feedbackEl.className = 'text-sm mt-2';
                    feedbackEl.textContent = '';
                    if (!code) {
                        feedbackEl.textContent = 'Р’РІРµРґРёС‚Рµ РїСЂРѕРјРѕРєРѕРґ';
                        feedbackEl.classList.add('text-red-500');
                        return;
                    }
                    try {
                        if (!(currentUser && currentUser.uid)) {
                            feedbackEl.textContent = 'РђРІС‚РѕСЂРёР·СѓР№С‚РµСЃСЊ, С‡С‚РѕР±С‹ Р°РєС‚РёРІРёСЂРѕРІР°С‚СЊ';
                            feedbackEl.classList.add('text-red-500');
                            return;
                        }
                        // Promo codes are stored in Firestore using the code itself as the document ID.
                        // Therefore, fetch the document directly by its ID and ensure it hasn't been used yet.
                        const promoRef = doc(db, 'promo_codes', code);
                        const promoDocSnap = await getDoc(promoRef);
                        if (!promoDocSnap.exists()) {
                            feedbackEl.textContent = 'РќРµРІРµСЂРЅС‹Р№ РёР»Рё РёСЃРїРѕР»СЊР·РѕРІР°РЅРЅС‹Р№ РєРѕРґ';
                            feedbackEl.classList.add('text-red-500');
                            return;
                        }
                        const promoData = promoDocSnap.data();
                        // For multi-use promo codes, check usage limits
                        const maxUses = promoData.maxUses || 1;
                        const usedCount = promoData.usedCount || 0;
                        const usedBy = Array.isArray(promoData.usedBy) ? promoData.usedBy : (promoData.usedBy ? [promoData.usedBy] : []);
                        // If the promo is flagged as used or usage limit reached, treat as invalid
                        if (promoData.used || usedCount >= maxUses) {
                            feedbackEl.textContent = 'РќРµРІРµСЂРЅС‹Р№ РёР»Рё РёСЃРїРѕР»СЊР·РѕРІР°РЅРЅС‹Р№ РєРѕРґ';
                            feedbackEl.classList.add('text-red-500');
                            return;
                        }
                        // Prevent the same user from redeeming the same code multiple times
                        if (usedBy.includes(currentUser.uid)) {
                            feedbackEl.textContent = 'Р’С‹ СѓР¶Рµ РёСЃРїРѕР»СЊР·РѕРІР°Р»Рё СЌС‚РѕС‚ РїСЂРѕРјРѕРєРѕРґ';
                            feedbackEl.classList.add('text-red-500');
                            return;
                        }
                        // Determine duration in milliseconds
                        let ms = 0;
                        switch (promoData.duration) {
                            case '3d': ms = 3 * 24 * 60 * 60 * 1000; break;
                            case '1m': ms = 30 * 24 * 60 * 60 * 1000; break;
                            case '3m': ms = 90 * 24 * 60 * 60 * 1000; break;
                            case '7m': ms = 210 * 24 * 60 * 60 * 1000; break;
                            case '12m': ms = 365 * 24 * 60 * 60 * 1000; break;
                            default: ms = 0; break;
                        }
                        const expiresAtDate = new Date(Date.now() + ms);
                        // Update user doc with premium status and expiry
                        await updateDoc(doc(db, 'users', currentUser.uid), { isPremium: true, premiumExpiresAt: expiresAtDate });
                        // Increment usage count and record the user; mark as used if limit reached
                        const newCount = usedCount + 1;
                        const newUsed = newCount >= maxUses;
                        await updateDoc(promoRef, {
                            usedCount: newCount,
                            used: newUsed,
                            usedBy: arrayUnion(currentUser.uid),
                            usedAt: serverTimestamp()
                        });
                        currentUser.isPremium = true;
                        feedbackEl.textContent = 'РџСЂРѕРјРѕРєРѕРґ Р°РєС‚РёРІРёСЂРѕРІР°РЅ!';
                        feedbackEl.classList.add('text-green-500');
                        showToast('РџСЂРµРјРёСѓРј Р°РєС‚РёРІРёСЂРѕРІР°РЅ!', false);
                    } catch (e) {
                        console.error('Error redeeming promo code', e);
                        feedbackEl.textContent = 'РћС€РёР±РєР°, РїРѕРїСЂРѕР±СѓР№С‚Рµ РїРѕР·Р¶Рµ';
                        feedbackEl.classList.add('text-red-500');
                    }
                });
            }
        } else if (['language-settings', 'content-settings'].includes(pageId)) {
            pageContainer.querySelector('#back-button').addEventListener('click', () => history.back());
            if (pageId === 'language-settings') {
                pageContainer.querySelectorAll('.lang-btn').forEach(btn => btn.addEventListener('click', (e) => setLanguage(e.currentTarget.dataset.lang)));
                // Fix corrupted Russian button text
                pageContainer.querySelectorAll('.lang-btn').forEach(btn => {
                    const lang = btn.dataset.lang;
                    if (lang === 'ru') btn.textContent = 'Русский';
                    else if (lang === 'en') btn.textContent = 'English';
                    else if (lang === 'uz') btn.textContent = "O'zbekcha";
                });
            }
            if (pageId === 'content-settings') {
                pageContainer.querySelector('#content-toggle').addEventListener('change', (e) => {
                    localStorage.setItem('soundora-show18plus', e.target.checked);
                });
            }
        } else if (pageId === 'edit-profile') {
            pageContainer.querySelector('#back-button').addEventListener('click', () => history.back());
            pageContainer.querySelector('#save-profile-btn').addEventListener('click', handleSaveProfile);
            const changePasswordForm = pageContainer.querySelector('#change-password-form');
            if (changePasswordForm) {
                changePasswordForm.addEventListener('submit', handleChangePassword);
            }
        } else if (pageId === 'player') {
            setupPlayerControls(state);
        }
    }

    function handleMovieCardClick(e) { e.preventDefault(); navigate({ page: 'movie-details', movieId: e.currentTarget.dataset.movieId }); }

    async function handleFavoriteClick(e) {
        e.stopPropagation();
        if (!currentUser) {
            showToast(translations[currentLanguage].loginRequired);
            postLoginRedirect = { page: 'movie-details', movieId: e.currentTarget.dataset.movieId };
            navigate({ page: 'login' });
            return;
        }
        const button = e.currentTarget;
        button.disabled = true;
        const movieId = button.dataset.movieId;
        const userRef = doc(db, "users", currentUser.uid);
        const newFavorites = [...(currentUser.favorites || [])];
        const index = newFavorites.indexOf(movieId);

        if (index > -1) newFavorites.splice(index, 1);
        else newFavorites.push(movieId);

        try {
            await updateDoc(userRef, { favorites: newFavorites });
            showToast(index > -1 ? translations[currentLanguage].removeFromFavorites : translations[currentLanguage].addToFavorites);
        } catch (error) {
            console.error("Error updating favorites:", error);
        } finally {
            button.disabled = false;
        }
    }

    function handlePlayClick(e) {
        const movieId = e.currentTarget.dataset.movieId;
        const episodeIndex = e.currentTarget.dataset.episodeIndex;
        const targetState = { page: 'player', movieId: movieId, episodeIndex: episodeIndex ? parseInt(episodeIndex, 10) : 0 };

        const movie = movies.find(m => String(m.id) === String(movieId));
        if (!movie) return;

        if (!currentUser) {
            postLoginRedirect = targetState;
            showToast(translations[currentLanguage].loginRequired);
            navigate({ page: 'login' });
            return;
        }

        if (movie.isPremium && !currentUser.isPremium) {
            showPremiumRequiredModal();
            return;
        }

        if(miniPlayerState.active && miniPlayerState.state.movieId === movieId) {
            hideMiniPlayer();
        }
        navigate(targetState);
    }

    async function handleLoginSubmit(e) {
        e.preventDefault();
        const email = document.getElementById('login-email-input').value;
        const password = document.getElementById('login-password-input').value;
        const errorEl = document.getElementById('login-error');
        errorEl.textContent = '';
        loadingOverlay.classList.remove('hidden');

        try {
            await signInWithEmailAndPassword(auth, email, password);

            // After successful login, store or update account info including password for quick switch
            try {
                const user = auth.currentUser;
                if (user) {
                    upsertLocalAccount({
                        uid: user.uid,
                        displayName: user.displayName,
                        email: user.email,
                        phoneNumber: user.phoneNumber,
                        photoURL: user.photoURL || '',
                        password: password
                    });
                }
            } catch (e) {
                console.error('Error updating account list on login', e);
            }
        } catch (error) {
            errorEl.textContent = translations[currentLanguage].invalidCredentials;
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function handleGoogleAuth(event) {
        event?.preventDefault();
        loadingOverlay.classList.remove('hidden');
        try {
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' });
            const result = await signInWithPopup(auth, provider);
            const user = result.user;
            await createUserData(user, {
                name: user.displayName || user.email?.split('@')[0] || 'Guest',
                region: currentUser?.region || 'uzbekistan'
            });
            postLoginRedirect = postLoginRedirect || { page: 'genre-survey' };
        } catch (error) {
            console.error('Google auth error:', error);
            const messageKey = error.code === 'auth/popup-closed-by-user' ? 'googlePopupClosed' : 'invalidCredentials';
            showToast(translations[currentLanguage]?.[messageKey] || 'Authentication error.', true);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    // --- Telefon raqami orqali kirish/ro'yxatdan o'tish funksiyalari ---
    function setupRecaptcha(containerId) {
        const recaptchaContainer = document.getElementById(containerId);
        if (!recaptchaContainer) {
            console.error("reCAPTCHA container not found:", containerId);
            return;
        }
        // Oldingi verifierni tozalash
        if (window.recaptchaVerifier && window.recaptchaVerifier.clear) {
            window.recaptchaVerifier.clear();
        }

        window.recaptchaVerifier = new RecaptchaVerifier(auth, containerId, {
            'size': 'invisible',
            'callback': (response) => {
                // reCAPTCHA solved, allow signInWithPhoneNumber.
            },
            'expired-callback': () => {
                // Response expired. Ask user to solve reCAPTCHA again.
                showToast("reCAPTCHA muddati tugadi. Qaytadan urining.", true);
            }
        });
        window.recaptchaVerifier.render(); // reCAPTCHAni darhol ishga tushirish
    }

    // Davlat tanlash menyusini to'ldirish
    function populateCountrySelector(selectId) {
        const selectElement = document.getElementById(selectId);
        if (!selectElement) return;
        selectElement.innerHTML = ''; // Oldingi optionlarni tozalash
        countries.forEach(country => {
            const option = document.createElement('option');
            option.value = country.code;
            option.textContent = `${country.flag} ${country.code}`;
            // Set Russia (+7) as the default selection instead of Uzbekistan
            if (country.code === '+7') {
                option.selected = true;
            }
            selectElement.appendChild(option);
        });
    }

    async function handleSendCode(pageType) { // pageType: 'login' or 'register'
        const countryCode = document.getElementById(`${pageType}-country-code`).value;
        const phoneNumberInput = document.getElementById(`${pageType}-phone-number-input`);
        const errorEl = document.getElementById(pageType === 'login' ? 'login-error' : 'register-page-error');
        const phoneNumber = countryCode + phoneNumberInput.value.replace(/\D/g, '');
        errorEl.textContent = '';

        if (phoneNumber.length < 10) { // Umumiyroq tekshiruv
            errorEl.textContent = translations[currentLanguage].invalidPhoneNumber;
            return;
        }

        loadingOverlay.classList.remove('hidden');
        setupRecaptcha(pageType === 'login' ? 'recaptcha-container' : 'register-recaptcha-container');
        const appVerifier = window.recaptchaVerifier;

        try {
            window.confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
            showToast(translations[currentLanguage].smsSent);
            document.getElementById(`${pageType}-phone-entry-view`).classList.add('hidden');
            document.getElementById(`${pageType}-code-entry-view`).classList.remove('hidden');
            document.getElementById(`${pageType}-verification-code-input`).focus();
        } catch (error) {
            console.error("SMS yuborishda xatolik:", error);
            if (error.code === 'auth/operation-not-allowed') {
                 errorEl.textContent = "SMS yuborish uchun ruxsat yo'q. Administrator bilan bog'laning.";
            } else {
                 errorEl.textContent = "SMS yuborishda xatolik. Qaytadan urining.";
            }
            if (window.recaptchaVerifier) {
                window.recaptchaVerifier.render().then(widgetId => {
                    grecaptcha.reset(widgetId);
                });
            }
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function handleVerifyCode(pageType) {
        const codeInput = document.getElementById(`${pageType}-verification-code-input`);
        const code = codeInput.value;
        const errorEl = document.getElementById(pageType === 'login' ? 'login-error' : 'register-page-error');
        errorEl.textContent = '';

        if (code.length < 6) {
            errorEl.textContent = translations[currentLanguage].invalidCode;
            return;
        }

        loadingOverlay.classList.remove('hidden');
        try {
            await window.confirmationResult.confirm(code);
            // onAuthStateChanged qolgan ishlarni bajaradi
            // Yangi ro'yxatdan o'tgan bo'lsa, onAuthStateChanged ichida createUserData chaqiriladi
        } catch (error) {
            console.error("Kodni tasdiqlashda xatolik:", error);
            errorEl.textContent = translations[currentLanguage].invalidCode;
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }
    // --- Telefon raqami funksiyalari tugadi ---

    async function handleRegisterSubmit(e) {
        e.preventDefault();
        const name = document.getElementById('register-name-input')?.value.trim();
        const email = document.getElementById('register-email-input')?.value.trim();
        const password = document.getElementById('register-password-input')?.value;
        const confirmPassword = document.getElementById('register-password-confirm-input')?.value;
        const secretWord = document.getElementById('register-secret-input')?.value.trim();
        const region = document.getElementById('register-region-select')?.value || '';
        const errorEl = document.getElementById('register-error');
        errorEl.textContent = '';

        if (!name || !email || !password || !confirmPassword || !secretWord || !region) {
            errorEl.textContent = translations[currentLanguage]?.registerFieldMissing || 'Fill all required fields.';
            return;
        }
        if (password !== confirmPassword) {
            errorEl.textContent = translations[currentLanguage]?.passwordMismatch || 'Passwords do not match.';
            return;
        }
        if (password.length < 6) {
            errorEl.textContent = translations[currentLanguage]?.weakPassword || 'Password must contain at least 6 characters.';
            return;
        }

        // Instead of creating the user right away, save the registration details to sessionStorage
        // and continue to the genre survey. The account will be created after the survey or when
        // the user skips the survey.
        try {
            const pending = { name, email, password, secretWord, region };
            sessionStorage.setItem('pendingRegistration', JSON.stringify(pending));
            postLoginRedirect = { page: 'genre-survey' };
            showToast('Continue to the next step');
            // Ensure navigation happens even if some code around navigation didn't run
            navigate({ page: 'genre-survey' });
        } catch (err) {
            console.error('Failed to save pending registration', err);
            errorEl.textContent = translations[currentLanguage]?.unknown || 'Unexpected error. Please try again.';
        }
    }

    function updateGenrePreferencesLocally(genres = [], profileUpdates = {}) {
        if (!currentUser) return;
        currentUser.favoriteGenres = Array.isArray(genres) ? genres : [];
        // Support storing preferred platforms locally as well
        if (Array.isArray(profileUpdates.favoritePlatforms)) {
            currentUser.favoritePlatforms = profileUpdates.favoritePlatforms;
        } else if (!currentUser.favoritePlatforms) {
            currentUser.favoritePlatforms = currentUser.favoritePlatforms || [];
        }
        currentUser.hasCompletedSurvey = profileUpdates.hasCompletedSurvey ?? currentUser.hasCompletedSurvey ?? false;
        if (profileUpdates.displayName) {
            currentUser.displayName = profileUpdates.displayName;
        }
        if (profileUpdates.secretWord) {
            currentUser.secretWord = profileUpdates.secretWord;
        }
        if (profileUpdates.region) {
            currentUser.region = profileUpdates.region;
        }
    }

    async function handleGenreSurveySubmit(e) {
        e.preventDefault();
        // If the user is not yet created (pending registration), finalize registration first.
        const pendingRaw = sessionStorage.getItem('pendingRegistration');
        let pending = null;
        if (!currentUser || !currentUser.uid) {
            if (!pendingRaw) {
                navigate({ page: 'login' });
                return;
            }
            try {
                pending = JSON.parse(pendingRaw);
            } catch (err) {
                console.error('Invalid pending registration data', err);
            }
        }
    const checked = Array.from(document.querySelectorAll('input[name="genre"]:checked')).map(input => input.value);
    const selectedPlatforms = Array.from(document.querySelectorAll('input[name="platform"]:checked')).map(i => i.value);
        const name = document.getElementById('genre-survey-name')?.value.trim();
        const secretWord = document.getElementById('genre-survey-secret')?.value.trim();
        const region = document.getElementById('genre-survey-region')?.value || currentUser.region || 'uzbekistan';
        const errorEl = document.getElementById('genre-survey-error');
        errorEl.textContent = '';

        if (checked.length < 3) {
            errorEl.textContent = translations[currentLanguage]?.genreSurveyHelper || 'Select at least three genres.';
            return;
        }

        loadingOverlay.classList.remove('hidden');
        try {
            // If we have pending registration data, create the auth user first
            if (pending) {
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, pending.email, pending.password);
                    const user = userCredential.user;
                    // Create user document with the survey answers
                    await createUserData(user, {
                        name: pending.name || name,
                        secretWord: pending.secretWord || secretWord,
                        region: pending.region || region,
                        favoriteGenres: checked,
                        favoritePlatforms: selectedPlatforms,
                        hasCompletedSurvey: true
                    });
                    try {
                        upsertLocalAccount({
                            uid: user.uid,
                            displayName: pending.name || name,
                            email: pending.email,
                            phoneNumber: user.phoneNumber,
                            photoURL: user.photoURL || '',
                            password: pending.password,
                            isPremium: false
                        });
                    } catch (accErr) {
                        console.error('Error storing new account', accErr);
                    }
                    // Clear pending registration
                    sessionStorage.removeItem('pendingRegistration');
                    // Wait for onAuthStateChanged to pick up the user and set currentUser via onSnapshot
                } catch (authErr) {
                    console.error('Error creating user during survey submit:', authErr);
                    if (authErr.code === 'auth/email-already-in-use') {
                        errorEl.textContent = translations[currentLanguage]?.emailAlreadyUsed || 'Email is already registered.';
                        return;
                    }
                    errorEl.textContent = translations[currentLanguage]?.unknown || 'Unexpected error. Please try again.';
                    return;
                }
            } else {
                // No pending registration; update existing authenticated user
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    favoriteGenres: checked,
                    favoritePlatforms: selectedPlatforms,
                    displayName: name || currentUser.displayName || '',
                    secretWord: secretWord || currentUser.secretWord || '',
                    region,
                    hasCompletedSurvey: true
                });
                    updateGenrePreferencesLocally(checked, {
                        displayName: name || currentUser.displayName,
                        secretWord: secretWord || currentUser.secretWord,
                        region,
                        favoritePlatforms: selectedPlatforms,
                        hasCompletedSurvey: true
                    });
            }
            showToast(translations[currentLanguage]?.genreSurveySaved || 'Preferences saved');
            // Navigate to main after finishing
            navigate({ page: 'main' });
        } catch (error) {
            console.error('Genre survey error:', error);
            errorEl.textContent = translations[currentLanguage]?.unknown || 'Unexpected error. Please try again.';
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function handleGenreSurveySkip() {
        // If there's a pending registration, finalize it without favorite genres
        const pendingRaw = sessionStorage.getItem('pendingRegistration');
        let pending = null;
        if (!currentUser || !currentUser.uid) {
            if (!pendingRaw) {
                navigate({ page: 'login' });
                return;
            }
            try { pending = JSON.parse(pendingRaw); } catch (err) { console.error('Invalid pending registration', err); }
        }
        loadingOverlay.classList.remove('hidden');
        try {
            if (pending) {
                const userCredential = await createUserWithEmailAndPassword(auth, pending.email, pending.password);
                const user = userCredential.user;
                await createUserData(user, {
                    name: pending.name,
                    secretWord: pending.secretWord,
                    region: pending.region,
                    favoriteGenres: [],
                    favoritePlatforms: [],
                    hasCompletedSurvey: true
                });
                try {
                    upsertLocalAccount({
                        uid: user.uid,
                        displayName: pending.name,
                        email: pending.email,
                        phoneNumber: user.phoneNumber,
                        photoURL: user.photoURL || '',
                        password: pending.password,
                        isPremium: false
                    });
                } catch (accErr) { console.error('Error storing new account', accErr); }
                sessionStorage.removeItem('pendingRegistration');
            } else {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, { hasCompletedSurvey: true });
                updateGenrePreferencesLocally(currentUser.favoriteGenres || [], { hasCompletedSurvey: true });
            }
            navigate({ page: 'main' });
        } catch (error) {
            console.error('Genre survey skip error:', error);
            showToast(translations[currentLanguage]?.unknown || 'Unexpected error. Please try again.', true);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function handleLogout(options = {}) {
        const { preserveAccounts = false } = options || {};
        const uid = currentUser?.uid;
        isAccountSwitchInProgress = false;

        // Get stored accounts before logout
        let storedAccounts = [];
        try {
            storedAccounts = JSON.parse(localStorage.getItem('soundora-accounts') || '[]');
        } catch (e) {
            console.error('Error loading accounts', e);
        }

        try {
            await signOut(auth);
        } catch (error) {
            console.error("Logout Error:", error);
        } finally {
            try { localStorage.removeItem('soundora-lastUid'); } catch (_) {}

            // Remove current user's profile
            if (uid) {
                localStorage.removeItem(`soundora-profiles-${uid}`);
            }

            if (!preserveAccounts) {
                localStorage.removeItem('soundora-accounts');
                localStorage.removeItem('soundora-selected-account');
                navigate({ page: 'login' });
            } else {
                // Remove current account from stored accounts
                const updatedAccounts = storedAccounts.filter(acc => acc.uid !== uid);
                if (updatedAccounts.length > 0) {
                    localStorage.setItem('soundora-accounts', JSON.stringify(updatedAccounts));
                } else {
                    localStorage.removeItem('soundora-accounts');
                }

                // Auto-switch to another account if available
                const otherAccount = updatedAccounts[0];
                if (otherAccount && otherAccount.email && otherAccount.password) {
                    loadingOverlay?.classList.remove('hidden');
                    try {
                        await signInWithEmailAndPassword(auth, otherAccount.email, otherAccount.password);
                        localStorage.setItem('soundora-selected-account', otherAccount.uid);
                        const accountName = otherAccount.displayName || otherAccount.email || 'User';
                        showToast((translations[currentLanguage]?.switchedToAccount || 'Switched to') + ' ' + accountName);
                    } catch (err) {
                        console.error('Auto-switch failed', err);
                        navigate({ page: 'login' });
                    } finally {
                        loadingOverlay?.classList.add('hidden');
                    }
                } else {
                    localStorage.removeItem('soundora-selected-account');
                    navigate({ page: 'login' });
                }
            }
        }
    }
    async function handleSaveProfile() {
        const usernameInput = document.getElementById('username-input');
        if (!usernameInput || !currentUser) return;

        const newName = usernameInput.value.trim();
        if (newName === '' || newName === currentUser.displayName) {
            return;
        }

        loadingOverlay.classList.remove('hidden');
        const userRef = doc(db, "users", currentUser.uid);
        try {
            await updateDoc(userRef, { displayName: newName });
            showToast(translations[currentLanguage].profileUpdateSuccess);
        } catch (error) {
            showToast(translations[currentLanguage].profileUpdateError, true);
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    async function handleChangePassword(e) {
        e.preventDefault();
        const currentPassword = document.getElementById('current-password-input').value;
        const newPassword = document.getElementById('new-password-input').value;
        const confirmPassword = document.getElementById('confirm-password-input').value;
        const errorEl = document.getElementById('password-error');
        errorEl.textContent = '';

        if (newPassword !== confirmPassword) {
            errorEl.textContent = translations[currentLanguage].passwordsDoNotMatch;
            return;
        }
        if (newPassword.length < 6) {
            errorEl.textContent = "Parol kamida 6 belgidan iborat bo'lishi kerak.";
            return;
        }

        loadingOverlay.classList.remove('hidden');
        try {
            const user = auth.currentUser;
            const credential = EmailAuthProvider.credential(user.email, currentPassword);
            await reauthenticateWithCredential(user, credential);
            await updatePassword(user, newPassword);
            showToast(translations[currentLanguage].passwordUpdateSuccess);
            e.target.reset();
        } catch (error) {
            console.error("Parolni o'zgartirish xatosi:", error);
            errorEl.textContent = translations[currentLanguage].passwordUpdateError;
        } finally {
            loadingOverlay.classList.add('hidden');
        }
    }

    function copyUserId() {
        const idElement = document.getElementById('user-profile-id');
        if (idElement && currentUser) {
            const userId = currentUser.customId || currentUser.uid.substring(0, 8);
            navigator.clipboard.writeText(userId).then(() => {
                showToast(translations[currentLanguage]?.idCopied || 'ID copied!');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('Failed to copy ID', true);
            });
        }
    }

    // Feedback modal function
    function openFeedbackModal() {
        if (!currentUser) {
            showToast('Please login to submit feedback', true);
            return;
        }

        const modalHTML = `
            <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                <div class="bg-gray-900 rounded-xl shadow-2xl w-full max-w-lg p-6 relative border border-gray-800">
                    <button id="close-feedback-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>

                    <h2 class="text-2xl font-bold text-white mb-2 flex items-center gap-2">
                        <i class="fas fa-bug text-red-500"></i>
                        Report Bug / Feedback
                    </h2>
                    <p class="text-gray-400 text-sm mb-6">Help us improve by reporting bugs or suggesting features</p>

                    <form id="feedback-form" class="space-y-4">
                        <!-- Type Selection -->
                        <div>
                            <label class="block text-gray-300 font-medium mb-2">Feedback Type *</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="feedback-type-option cursor-pointer">
                                    <input type="radio" name="feedbackType" value="bug" class="hidden" required>
                                    <div class="feedback-type-card p-3 rounded-lg border-2 border-gray-700 hover:border-red-500 transition-all text-center">
                                        <i class="fas fa-bug text-2xl text-red-500 mb-1"></i>
                                        <p class="text-sm font-medium text-white">Bug</p>
                                    </div>
                                </label>
                                <label class="feedback-type-option cursor-pointer">
                                    <input type="radio" name="feedbackType" value="error" class="hidden" required>
                                    <div class="feedback-type-card p-3 rounded-lg border-2 border-gray-700 hover:border-orange-500 transition-all text-center">
                                        <i class="fas fa-exclamation-triangle text-2xl text-orange-500 mb-1"></i>
                                        <p class="text-sm font-medium text-white">Error</p>
                                    </div>
                                </label>
                                <label class="feedback-type-option cursor-pointer">
                                    <input type="radio" name="feedbackType" value="feature" class="hidden" required>
                                    <div class="feedback-type-card p-3 rounded-lg border-2 border-gray-700 hover:border-blue-500 transition-all text-center">
                                        <i class="fas fa-lightbulb text-2xl text-blue-500 mb-1"></i>
                                        <p class="text-sm font-medium text-white">Feature Request</p>
                                    </div>
                                </label>
                                <label class="feedback-type-option cursor-pointer">
                                    <input type="radio" name="feedbackType" value="improvement" class="hidden" required>
                                    <div class="feedback-type-card p-3 rounded-lg border-2 border-gray-700 hover:border-green-500 transition-all text-center">
                                        <i class="fas fa-tools text-2xl text-green-500 mb-1"></i>
                                        <p class="text-sm font-medium text-white">Improvement</p>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-gray-300 font-medium mb-2">Description *</label>
                            <textarea id="feedback-description" rows="5" required
                                class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-red-500 focus:ring-2 focus:ring-red-500/20 resize-none"
                                placeholder="Describe the issue or suggestion in detail..."></textarea>
                            <p class="text-xs text-gray-500 mt-1">Please provide as much detail as possible</p>
                        </div>

                        <!-- Submit Button -->
                        <div class="flex gap-3 pt-2">
                            <button type="button" id="cancel-feedback-btn" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-all">
                                Cancel
                            </button>
                            <button type="submit" class="flex-1 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white font-bold py-3 px-4 rounded-lg transition-all shadow-lg">
                                <i class="fas fa-paper-plane mr-2"></i>
                                Submit Feedback
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        // Add modal to body
        const modalContainer = document.createElement('div');
        modalContainer.id = 'feedback-modal-container';
        modalContainer.innerHTML = modalHTML;
        document.body.appendChild(modalContainer);

        // Add CSS for selected state
        const style = document.createElement('style');
        style.textContent = `
            .feedback-type-option input:checked + .feedback-type-card {
                border-color: currentColor !important;
                background-color: rgba(239, 68, 68, 0.1);
            }
        `;
        document.head.appendChild(style);

        // Close handlers
        const closeModal = () => {
            modalContainer.remove();
            style.remove();
        };

        document.getElementById('close-feedback-modal').addEventListener('click', closeModal);
        document.getElementById('cancel-feedback-btn').addEventListener('click', closeModal);
        modalContainer.addEventListener('click', (e) => {
            if (e.target === modalContainer.querySelector('.fixed')) closeModal();
        });

        // Form submit handler
        document.getElementById('feedback-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectedType = document.querySelector('input[name="feedbackType"]:checked')?.value;
            const description = document.getElementById('feedback-description').value.trim();

            if (!selectedType || !description) {
                showToast('Please fill in all required fields', true);
                return;
            }

            try {
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Submitting...';

                // Add to Firestore
                await addDoc(collection(db, 'userFeedback'), {
                    userId: currentUser.uid,
                    type: selectedType,
                    description: description,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    userInfo: {
                        displayName: currentUser.displayName || 'Unknown',
                        email: currentUser.email || '',
                        customId: currentUser.customId || ''
                    }
                });

                showToast('Feedback submitted successfully! Thank you.');
                closeModal();
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showToast('Failed to submit feedback. Please try again.', true);
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit Feedback';
            }
        });
    }

    function handleDownloadClick(e) {
        const movieId = e.currentTarget.dataset.movieId;
        const movie = movies.find(m => String(m.id) === String(movieId));
        if (!movie || !movie.sources) {
            showToast("Yuklab olish manbasi topilmadi.", true);
            return;
        }

        const availableQualities = ['1080p', '720p', '480p'];
        let downloadUrl = '';
        for (const quality of availableQualities) {
            if (movie.sources[quality]) {
                downloadUrl = movie.sources[quality];
                break;
            }
        }

        if (!downloadUrl) {
            showToast("Yuklab olish manbasi topilmadi.", true);
            return;
        }

        // Save movie information to local storage for offline downloads. Include status and progress.
        try {
            const storageKey = 'soundora-downloads';
            let downloaded = JSON.parse(localStorage.getItem(storageKey)) || [];
            const idStr = String(movie.id);
            // Avoid duplicates by checking existing entries
            if (!downloaded.some(item => (typeof item === 'object' ? item.id : item) === idStr)) {
                downloaded.push({ id: idStr, title: movie.title, url: downloadUrl, status: 'downloading', progress: 0 });
                localStorage.setItem(storageKey, JSON.stringify(downloaded));
            }
        } catch (err) {
            console.error('Error storing download', err);
        }

        // Notify user that download has started and is added to downloads page
        const startedMsg = translations[currentLanguage]?.downloadStarted || 'Download started. Check downloads page.';
        showToast(startedMsg);
        // Show toast that movie added to downloads
        const message = translations[currentLanguage]?.downloadAdded || 'Added to downloads';
        showToast(message);

        // Reference to progress bar elements inside modal (optional). We do not display the modal during download.
        const progressModal = document.getElementById('download-progress-modal');
        const progressBar   = document.getElementById('download-progress-bar');
        const progressText  = document.getElementById('download-progress-text');
        downloadVideoWithProgress(downloadUrl, (received, total) => {
            if (total) {
                const percent = (received / total) * 100;
                // Update progress bar in the modal
                if (progressBar && progressText) {
                    progressBar.style.width = `${percent.toFixed(2)}%`;
                    const receivedMB = (received / (1024 * 1024)).toFixed(1);
                    const totalMB    = (total / (1024 * 1024)).toFixed(1);
                    progressText.textContent = `${receivedMB} MB / ${totalMB} MB`;
                }
                // Persist progress state for this movie so downloads page can reflect it
                updateDownloadEntry(movie.id, { progress: Math.min(100, percent), status: 'downloading' });
                // Also update progress bar in downloads page if present
                const bar = document.getElementById(`download-progress-${movie.id}`);
                const label = document.getElementById(`download-progress-text-${movie.id}`);
                if (bar) {
                    bar.style.width = `${percent.toFixed(2)}%`;
                }
                if (label) {
                    label.textContent = `${percent.toFixed(0)}%`;
                }
            }
        }).then(blob => {
            // Save the video blob to IndexedDB for offline playback
            saveVideoToDB(movie.id, blob).then(() => {
                // Update status to completed and progress to 100%
                updateDownloadEntry(movie.id, { status: 'completed', progress: 100 });
                // Hide modal
                if (progressModal) {
                    progressModal.classList.add('hidden');
                    progressBar.style.width = '0%';
                    progressText.textContent = '0 MB / 0 MB';
                }
                const message = translations[currentLanguage]?.downloadAdded || 'Added to downloads';
                showToast(message);
                // Update downloads page UI to mark completed
                const bar = document.getElementById(`download-progress-${movie.id}`);
                const label = document.getElementById(`download-progress-text-${movie.id}`);
                if (bar) bar.style.width = '100%';
                if (label) label.textContent = '100%';
            }).catch(err => {
                console.error('Error saving video to DB:', err);
                if (progressModal) progressModal.classList.add('hidden');
            });
        }).catch(err => {
            console.error('Error downloading video:', err);
            if (progressModal) progressModal.classList.add('hidden');
        });
    }

    /**
     * Opens (and upgrades if necessary) the IndexedDB database used for storing
     * downloaded videos. Returns a promise that resolves with the database instance.
     */
    function openDownloadsDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open('soundoraDownloads', 1);
            request.onupgradeneeded = (ev) => {
                const db = ev.target.result;
                if (!db.objectStoreNames.contains('videos')) {
                    db.createObjectStore('videos');
                }
            };
            request.onsuccess = (ev) => resolve(ev.target.result);
            request.onerror = (ev) => reject(ev.target.error);
        });
    }

    /**
     * Saves a video Blob to the IndexedDB under the given movie ID key.
     */
    function saveVideoToDB(movieId, blob) {
        return openDownloadsDB().then((db) => {
            return new Promise((resolve, reject) => {
                const tx = db.transaction('videos', 'readwrite');
                const store = tx.objectStore('videos');
                store.put(blob, String(movieId));
                tx.oncomplete = () => resolve();
                tx.onerror = (ev) => reject(ev.target.error);
            });
        });
    }

    /**
     * Updates an existing entry in the downloads list stored in localStorage.
     * Accepts a movieId and an object containing the fields to update (e.g., { progress: 50, status: 'downloading' }).
     */
    function updateDownloadEntry(movieId, updates) {
        try {
            const storageKey = 'soundora-downloads';
            let downloaded = JSON.parse(localStorage.getItem(storageKey)) || [];
            const idStr = String(movieId);
            downloaded = downloaded.map(item => {
                if ((typeof item === 'object' ? item.id : item) === idStr) {
                    if (typeof item === 'object') {
                        return Object.assign({}, item, updates);
                    }
                    // If item is string (legacy), convert to object
                    return Object.assign({ id: idStr }, updates);
                }
                return item;
            });
            localStorage.setItem(storageKey, JSON.stringify(downloaded));
        } catch (err) {
            console.error('Failed to update download entry', err);
        }
    }

    /**
     * Downloads a file using Fetch and reports progress via a callback. Returns a promise
     * that resolves with the resulting Blob once the download completes.
     */
    function downloadVideoWithProgress(url, onProgress) {
        return fetch(url).then((response) => {
            if (!response.ok) throw new Error('Network response was not ok');
            const contentLength = response.headers.get('Content-Length');
            const total = contentLength ? parseInt(contentLength, 10) : 0;
            const reader = response.body.getReader();
            let received = 0;
            const chunks = [];
            function pump() {
                return reader.read().then(({ done, value }) => {
                    if (done) {
                        return new Blob(chunks);
                    }
                    chunks.push(value);
                    received += value.length;
                    if (onProgress && total) {
                        onProgress(received, total);
                    }
                    return pump();
                });
            }
            return pump();
        });
    }

    /**
     * Generate a shareable promo code for the current user. Free users may generate
     * up to 2 promo codes, while premium users may generate up to 4 codes. Each
     * generated code contains an expiry timestamp (7 days from now) and is stored
     * in localStorage under the key `soundora-promo-codes`. If the user has
     * reached the limit, a toast message is shown and no new code is created.
     * Otherwise a new code is generated, saved, copied to the clipboard and a
     * success toast is displayed.
     */
    function setLanguage(lang) {
        currentLanguage = ['en', 'ru', 'uz'].includes(lang) ? lang : 'ru';
        localStorage.setItem('soundora-lang', currentLanguage);
        document.documentElement.lang = lang;

        // Merge extra translations into main translations
        if (extraTranslations[currentLanguage]) {
            Object.assign(translations[currentLanguage], extraTranslations[currentLanguage]);
        }

        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            let translation = translations[currentLanguage]?.[key];
            if (translation === undefined) return;

            if (key === 'deviceLimitInfo') {
                const current = el.dataset.current;
                const max = el.dataset.max;
                translation = translation.replace('{CURRENT}', current).replace('{MAX}', max);
            }

            if (el.tagName === 'INPUT' && !['checkbox', 'radio', 'submit'].includes(el.type)) {
                el.placeholder = translation;
            } else {
                el.textContent = translation;
            }
        });

        // If the premium kassa modal is present, reapply its translations when the language changes
        try {
            if (typeof kassaApplyTranslations === 'function') {
                kassaApplyTranslations();
            }
        } catch (err) {
            console.warn('Kassa translation update failed:', err);
        }
        if (typeof window.sndRefreshSearchLocale === 'function') {
            try {
                window.sndRefreshSearchLocale();
            } catch (err) {
                console.warn('Search overlay translation update failed:', err);
            }
        }
        if (typeof window.refreshCardSettingsLabels === 'function') {
            try {
                window.refreshCardSettingsLabels();
            } catch (err) {
                console.warn('Card settings translation update failed:', err);
            }
        }
    }

    function createMovieCardHTML(movie) {
        const posterSrc = movie.poster || `https://placehold.co/400x600/1f2937/ffffff?text=${encodeURIComponent(movie.title)}`;
        const primary = String(movie.primaryCategory || '').toLowerCase();
        const primaryLabel = PRIMARY_CATEGORY_LABELS[primary] || '';
        const sportCategory = String(movie.sportCategory || '').toLowerCase();
        const sportLabel = primary === 'sports'
            ? (SPORTS_CATEGORIES.find(cat => cat.id === sportCategory)?.label || (sportCategory ? sportCategory.charAt(0).toUpperCase() + sportCategory.slice(1) : PRIMARY_CATEGORY_LABELS.sports))
            : '';
        const categoryLine = primaryLabel
            ? `<p class="text-[0.65rem] uppercase tracking-wide text-gray-300">${primaryLabel}${sportLabel && sportLabel !== primaryLabel ? ` / ${sportLabel}` : ''}</p>`
            : '';
        return `
            <a href="#" class="movie-card-link group relative overflow-hidden rounded-lg shadow-lg cursor-pointer block" data-movie-id="${movie.id}" onclick="event.preventDefault(); handleMovieCardClick(event)" style="aspect-ratio: 2/3;">
                <img src="${posterSrc}" onerror="this.onerror=null;this.src='https://placehold.co/400x600/ef4444/ffffff?text=Error';" alt="${movie.title}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110">
                ${movie.isPremium ? `<div class="absolute top-2 left-2 bg-gradient-to-r from-amber-500 to-yellow-400 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1" style="font-size: 0.7rem;"><i class="fas fa-crown" style="font-size: 0.65rem;"></i><span data-lang-key="premium">Premium</span></div>` : ''}
                ${movie.type === 'series' ? `<span class="absolute top-2 right-2 bg-blue-600 text-white font-bold px-2 py-1 rounded-full" data-lang-key="series" style="font-size: 0.7rem;">Series</span>` : ''}
                <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-play-circle text-white" style="font-size: 2.5rem;"></i></div>
                <div class="absolute bottom-0 left-0 right-0 p-2 bg-gradient-to-t from-black to-transparent">
                    <h3 class="text-white font-semibold truncate" style="font-size: 0.875rem; line-height: 1.25rem;">${movie.title}</h3>
                    <p class="text-gray-400" style="font-size: 0.7rem;">${movie.year || ''}</p>
                    ${categoryLine}
                </div>
            </a>`;
    }

    function populateCategories() {
        const categoryNav = document.getElementById('category-nav');
        if (!categoryNav) return;
        const years = [...new Set(movies.map(m => String(m.year)))].sort((a, b) => b.localeCompare(a)).filter(y => y && y !== 'undefined');
        const categories = [ { key: 'categoryAll' }, { key: 'categoryNew' }, { key: 'categoryTrending' }, ...years ];
        categoryNav.innerHTML = categories.map((cat, index) => {
            const isYear = typeof cat === 'string';
            const value = isYear ? cat : cat.key;
            const text = isYear ? cat : (translations[currentLanguage][cat.key] || cat.key);
            const langKeyAttr = isYear ? '' : `data-lang-key="${cat.key}"`;
            return `<button class="category-btn shrink-0 px-4 py-2 text-sm font-semibold rounded-full bg-gray-700 text-gray-300 ${index === 0 ? 'active' : ''}" data-category-value="${value}" ${langKeyAttr}>${text}</button>`;
        }).join('');

        categoryNav.querySelectorAll('.category-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelector('#category-nav .category-btn.active')?.classList.remove('active');
                e.currentTarget.classList.add('active');
                filterAndDisplayMovies(e.currentTarget.dataset.categoryValue);
            });
        });

    }
    function filterAndDisplayMovies(category) {
        const moviesGrid = document.getElementById('movies-grid');
        if (!moviesGrid) return;
        let filteredMovies;
        const show18Plus = JSON.parse(localStorage.getItem('soundora-show18plus')) || false;
        let baseMovies = show18Plus ? movies : movies.filter(m => !m.is18Plus);

        // Apply profile-specific filters (Kids profile)
        baseMovies = filterMoviesForProfile(baseMovies);

        switch(category) {
            case 'categoryAll': filteredMovies = baseMovies; break;
            case 'categoryNew': filteredMovies = [...baseMovies].sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0)).slice(0, 30); break;
            case 'categoryTrending': filteredMovies = baseMovies.filter(m => m.isTrending); break;
            default: filteredMovies = baseMovies.filter(m => String(m.year) === String(category)); break;
        }
        // Til bo'yicha filtrlash: agar tanlangan til 'all' bo'lmasa, quyidagi shartlar bo'yicha filtrlaymiz:
        // 1) Filmning asosiy tili (m.language) tanlangan tilga teng bo'lsa;
        // 2) audioLangs yoki subtitleLangs massivlarida ushbu til mavjud bo'lsa.
        if (selectedLangFilter && selectedLangFilter !== 'all') {
            const sel = String(selectedLangFilter).toLowerCase();
            filteredMovies = filteredMovies.filter(m => {
                // Asosiy tilni tekshiramiz
                const langMatch = m.language && String(m.language).toLowerCase() === sel;
                // Audio tillari orasida bor-yo'qligini tekshiramiz
                const audioMatch = Array.isArray(m.audioLangs) && m.audioLangs.map(l => String(l).toLowerCase()).includes(sel);
                // Subtitr tillari orasida bor-yo'qligini tekshiramiz
                const subMatch = Array.isArray(m.subtitleLangs) && m.subtitleLangs.map(l => String(l).toLowerCase()).includes(sel);
                return langMatch || audioMatch || subMatch;
            });
        }
        moviesGrid.innerHTML = filteredMovies.length > 0 ? filteredMovies.map(createMovieCardHTML).join('') : `<p class="col-span-full text-center text-gray-400 mt-8" data-lang-key="noResults"></p>`;
        window.handleMovieCardClick = (e) => { e.preventDefault(); navigate({ page: 'movie-details', movieId: e.currentTarget.dataset.movieId }); };
        setLanguage(currentLanguage);
    }

    /**
     * Apply a top navigation section.  When the user clicks on Home, Series,
     * Movies, SND, Sports or Challenges, this function updates the active
     * highlight, shows/hides the hero banner and category navigation, filters
     * the list of movies accordingly and updates the grid.  Filtering is
     * performed on the in-memory movies array and takes into account the
     * selected language and 18+ visibility preferences.  If no movies match
     * the selected section, a "no results" message is shown.  The hero and
     * category navigation are only visible on the Home section.
     *
     * @param {string} section The section identifier (home, series, movies,
     *                         snd, sports, challenges).
     */
    function ensureSportsCategoriesRendered() {
        const container = document.getElementById('sports-category-grid');
        if (!container) return;
        if (container.dataset.rendered === 'true') {
            updateSportsCategoryCards();
            return;
        }
        container.innerHTML = SPORTS_CATEGORIES.map(cat => `
            <button type="button" class="sports-category-card" data-category="${cat.id}">
                <i class="${cat.icon}"></i>
                <div>
                    <p class="text-lg font-semibold">${cat.label}</p>
                    <p class="text-sm text-gray-400">${cat.id === 'all' ? 'Browse every sports event available on SND.' : 'Discover the best of ' + cat.label.toLowerCase() + '.'}</p>
                </div>
            </button>
        `).join('');
        container.dataset.rendered = 'true';
        container.querySelectorAll('.sports-category-card').forEach(card => {
            card.addEventListener('click', () => {
                const categoryId = card.dataset.category || 'all';
                if (selectedSportsCategory !== categoryId) {
                    selectedSportsCategory = categoryId;
                    updateSportsCategoryCards();
                    applyTopSection('sports');
                }
            });
        });
        updateSportsCategoryCards();
    }

    function updateSportsCategoryCards() {
        const cards = document.querySelectorAll('.sports-category-card');
        cards.forEach(card => {
            const id = card.dataset.category || 'all';
            if (id === selectedSportsCategory) card.classList.add('active');
            else card.classList.remove('active');
        });
    }

    function filterSportsMovies(baseMovies, categoryId) {
        const keywordFallback = ['sport', 'sports', 'football', 'soccer', 'basketball', 'volleyball', 'mma', 'boxing', 'ufc', 'fight', 'racing', 'motorsport', 'formula', 'f1'];
        const sportsMovies = baseMovies.filter(m => {
            const primary = String(m.primaryCategory || '').toLowerCase();
            if (primary === 'sports') return true;
            const categories = (Array.isArray(m.categories) ? m.categories : String(m.categories || '').split(',')).map(val => String(val || '').toLowerCase().trim());
            if (categories.includes('sports')) return true;
            const marker = [
                Array.isArray(m.genre) ? m.genre.join(' ') : String(m.genre || ''),
                Array.isArray(m.tags) ? m.tags.join(' ') : String(m.tags || ''),
                categories.join(' '),
                String(m.title || ''),
                String(m.description || '')
            ].join(' ').toLowerCase();
            return keywordFallback.some(keyword => marker.includes(keyword));
        });
        if (categoryId === 'all') return sportsMovies;
        const normalizedCategory = String(categoryId || '').toLowerCase();
        const category = SPORTS_CATEGORIES.find(cat => cat.id === normalizedCategory);
        const catKeywords = category?.keywords?.map(k => k.toLowerCase()) || [];
        return sportsMovies.filter(movie => {
            const primary = String(movie.primaryCategory || '').toLowerCase();
            const sportCategory = String(movie.sportCategory || '').toLowerCase();
            if (primary === 'sports' && sportCategory === normalizedCategory) return true;
            const categories = Array.isArray(movie.categories) ? movie.categories.map(c => String(c || '').toLowerCase()) : [];
            if (categories.includes(`sports-${normalizedCategory}`)) return true;
            const haystack = [
                Array.isArray(movie.genre) ? movie.genre.join(' ') : String(movie.genre || ''),
                Array.isArray(movie.tags) ? movie.tags.join(' ') : String(movie.tags || ''),
                categories.join(' '),
                sportCategory,
                String(movie.title || ''),
                String(movie.description || '')
            ].join(' ').toLowerCase();
            if (sportCategory && sportCategory.includes(normalizedCategory)) return true;
            return catKeywords.some(keyword => haystack.includes(keyword));
        });
    }

    function applyTopSection(section) {
        const previousSection = selectedSection;
        selectedSection = section;
        // Update active class on each tab
        const navItems = document.querySelectorAll('.top-text-nav .top-nav-item');
        navItems.forEach(item => {
            item.classList.toggle('active', item.dataset.section === section);
        });
        // Show or hide hero and category navigation depending on section
        const heroWrapper = document.getElementById('home-hero-wrapper');
        const categoryNav = document.getElementById('category-nav');
        const secondaryNav = document.getElementById('secondary-top-nav');
        const gridWrapper = document.getElementById('main-grid-wrapper');
        const sportsWrapper = document.getElementById('sports-category-wrapper');
        const sectionHeading = document.getElementById('main-section-heading');
        const searchWrapper = document.getElementById('section-search-wrapper');
        const searchInput = document.getElementById('movie-search-input');

        // Clear search input when switching sections
        if (searchInput) searchInput.value = '';

        if (sectionHeading) {
            const headingMap = {
                home: 'Featured',
                series: 'Series',
                movies: 'Movies',
                snd: 'SND Originals',
                sports: 'Sports Highlights',
                challenges: 'Challenges'
            };
            sectionHeading.textContent = headingMap[section] || headingMap.home;
        }
        if (section === 'home') {
            heroWrapper?.classList.remove('hidden');
            categoryNav?.classList.remove('hidden');
            secondaryNav?.classList.add('hidden');
            gridWrapper?.classList.add('-mt-4');
            gridWrapper?.classList.remove('mt-6');
            sportsWrapper?.classList.add('hidden');
            searchWrapper?.classList.add('hidden'); // Hide search on home
            // Rebuild categories to ensure the selected year/trending remains in sync
            populateCategories();
        } else {
            heroWrapper?.classList.add('hidden');
            categoryNav?.classList.add('hidden');
            secondaryNav?.classList.remove('hidden');
            gridWrapper?.classList.remove('-mt-4');
            gridWrapper?.classList.add('mt-6');
            searchWrapper?.classList.remove('hidden'); // Show search on other sections
            if (section === 'sports') {
                if (previousSection !== 'sports') {
                    selectedSportsCategory = 'all';
                }
                sportsWrapper?.classList.remove('hidden');
                ensureSportsCategoriesRendered();
                updateSportsCategoryCards();
            } else {
                sportsWrapper?.classList.add('hidden');
            }
        }
        if (section === 'sports' && sectionHeading) {
            const activeCategory = selectedSportsCategory === 'all'
                ? null
                : SPORTS_CATEGORIES.find(cat => cat.id === selectedSportsCategory);
            sectionHeading.textContent = activeCategory ? `${activeCategory.label} Highlights` : 'Sports Highlights';
        }
        const moviesGrid = document.getElementById('movies-grid');
        if (!moviesGrid) return;
        const show18Plus = JSON.parse(localStorage.getItem('soundora-show18plus')) || false;
        let baseMovies = show18Plus ? movies : movies.filter(m => !m.is18Plus);
        let filtered = [];
        switch (section) {
            case 'home':
                filtered = baseMovies.filter(m => {
                    const primary = String(m.primaryCategory || '').toLowerCase();
                    return primary !== 'sports' && primary !== 'challenge';
                });
                break;
            case 'series':
                filtered = baseMovies.filter(m => {
                    const primary = String(m.primaryCategory || '').toLowerCase();
                    return primary !== 'sports' && primary !== 'challenge' && String(m.type || '').toLowerCase() === 'series';
                });
                break;
            case 'movies':
                filtered = baseMovies.filter(m => {
                    const primary = String(m.primaryCategory || '').toLowerCase();
                    return primary !== 'sports' && primary !== 'challenge' && String(m.type || '').toLowerCase() !== 'series';
                });
                break;
            case 'snd':
                filtered = baseMovies.filter(m => {
                    const primary = String(m.primaryCategory || '').toLowerCase();
                    if (primary === 'snd') return true;
                    const genre = String(m.genre || '').toLowerCase();
                    const studio = String(m.studio || '').toLowerCase();
                    return genre.includes('snd') || studio.includes('snd');
                });
                break;
            case 'sports':
                filtered = filterSportsMovies(baseMovies, selectedSportsCategory);
                break;
            case 'challenges':
                filtered = baseMovies.filter(m => {
                    const primary = String(m.primaryCategory || '').toLowerCase();
                    if (primary === 'challenge') return true;
                    const genre = String(m.genre || '').toLowerCase();
                    return genre.includes('challenge');
                });
                break;
            default:
                filtered = baseMovies;
        }
        // Apply language filter
        if (selectedLangFilter && selectedLangFilter !== 'all') {
            const sel = String(selectedLangFilter).toLowerCase();
            filtered = filtered.filter(m => {
                const langMatch = m.language && String(m.language).toLowerCase() === sel;
                const audioMatch = Array.isArray(m.audioLangs) && m.audioLangs.map(l => String(l).toLowerCase()).includes(sel);
                const subMatch = Array.isArray(m.subtitleLangs) && m.subtitleLangs.map(l => String(l).toLowerCase()).includes(sel);
                return langMatch || audioMatch || subMatch;
            });
        }
        moviesGrid.innerHTML = filtered.length > 0 ? filtered.map(createMovieCardHTML).join('') : `<p class="col-span-full text-center text-gray-400 mt-8" data-lang-key="noResults"></p>`;
        // Rebind click handler for the dynamically created cards
        window.handleMovieCardClick = (e) => {
            e.preventDefault();
            navigate({ page: 'movie-details', movieId: e.currentTarget.dataset.movieId });
        };
        setLanguage(currentLanguage);
    }

    /**
     * Listen for admin alerts stored in Firestore.  Administrators can
     * broadcast system-wide announcements via a document in the `config`
     * collection (e.g. doc id `adminAlerts`).  The document is expected
     * to have a field called `alerts` that is an array of objects with
     * `id`, `message` and `timestamp` properties.  Each new alert is
     * transformed into a notification of type "admin" and appended to
     * the notifications array.  The listener is only registered once
     * (via the `adminAlertsUnsub` guard) to avoid duplicate subscriptions.
     */
    function subscribeToAdminAlerts() {
        try {
            // If already subscribed, do not register again
            if (adminAlertsUnsub) return;
            const alertRef = doc(db, 'config', 'adminAlerts');
            adminAlertsUnsub = onSnapshot(alertRef, (docSnap) => {
                const data = docSnap.data();
                const alerts = Array.isArray(data?.alerts) ? data.alerts : [];

                const now = Date.now();
                const isUserLoggedIn = !!auth.currentUser;

                // Filter by expiry and audience (registered/unregistered/all)
                const allowedAlerts = alerts.filter(alert => {
                    // Expiry check
                    if (alert.expiresAt) {
                        const expiryTime = new Date(alert.expiresAt).getTime();
                        if (now > expiryTime) return false;
                    }
                    // Audience check
                    const aud = alert.audience;
                    if (aud === 'registered' && !isUserLoggedIn) return false;
                    if (aud === 'unregistered' && isUserLoggedIn) return false;
                    if (aud && aud !== 'all' && aud !== 'registered' && aud !== 'unregistered') return false;
                    return true;
                });

                // Allowed IDs (after audience + expiry filtering)
                const allowedIds = new Set();
                allowedAlerts.forEach(alert => {
                    const id = alert.id || (alert.timestamp && typeof alert.timestamp.toMillis === 'function' ? alert.timestamp.toMillis() : String(alert.timestamp || ''));
                    allowedIds.add(String(id));
                });

                // 1) Remove legacy admin notifications that are no longer present or not allowed for this audience
                const beforeCount = notifications.length;
                notifications = notifications.filter(n => {
                    if (!n.id) return true;
                    if (n.id.startsWith('admin_')) {
                        return allowedIds.has(String(n.alertId));
                    }
                    return true; // keep non-admin notifications
                });
                const removedCount = beforeCount - notifications.length;
                if (removedCount > 0 && debugMode) {
                    console.log(`🧹 Removed ${removedCount} legacy admin alerts not allowed for this audience or deleted in Firestore`);
                }

                // 2) Add any new allowed alerts from Firestore that aren't already in notifications
                allowedAlerts.forEach(alert => {
                    const alertId = alert.id || (alert.timestamp && typeof alert.timestamp.toMillis === 'function' ? alert.timestamp.toMillis() : String(alert.timestamp || ''));
                    // Prevent duplicates by checking existing notifications by alertId (regardless of type or source)
                    if (!notifications.some(n => String(n.alertId) === String(alertId))) {
                        notifications.push({
                            id: 'admin_' + alertId,
                            type: alert.type || 'admin',
                            alertId: String(alertId),
                            content: alert.message,
                            audience: alert.audience || 'all',
                            timestamp: (alert.timestamp && typeof alert.timestamp.toDate === 'function') ? alert.timestamp.toDate().toISOString() : (alert.timestamp || new Date()).toString()
                        });
                    }
                });

                persistNotifications();
                updateNotificationDot();
                if (isNotificationPanelOpen) {
                    renderNotificationPanel();
                }
            });
        } catch (e) {
            console.warn('Failed to subscribe to admin alerts', e);
        }
    }

    /**
     * Listen for broadcast admin messages sent to all users.
     * Admin can send messages to everyone via a single Firestore document.
     * Document path: config/adminMessages
     * Expected fields: { messages: [{ id, content, timestamp }] }
     * All logged-in users will receive these notifications in real-time.
     */
    function subscribeToAdminMessages() {
        try {
            if (adminMessagesUnsub) {
                console.log('⚠️ Already subscribed to admin messages');
                return; // Already subscribed
            }

            console.log('📡 Starting admin messages subscription...');

            // Flag birinchi listener snapshot'i uchun - popup ko'rsatmaslik
            let isFirstSnapshot = true;

            // IMPORTANT: Save a snapshot of existing admin message IDs BEFORE cleaning
            // This allows us to detect truly NEW messages when the first snapshot arrives
            const existingAdminMsgIds = new Set();
            try {
                const storedNotifs = JSON.parse(localStorage.getItem('soundora-notifications') || '[]');
                if (Array.isArray(storedNotifs)) {
                    storedNotifs.forEach(n => {
                        if (n.id && n.id.startsWith('adminMsg_') && n.alertId) {
                            existingAdminMsgIds.add(String(n.alertId));
                        }
                    });
                }
            } catch(e) {}
            console.log(`📋 Found ${existingAdminMsgIds.size} existing admin messages in localStorage before subscribing`);

            // Now clean up ALL old admin messages from the in-memory array
            // This ensures we start fresh and only show what's currently in Firebase
            const beforeCleanup = notifications.length;
            notifications = notifications.filter(n => !n.id || !n.id.startsWith('adminMsg_'));
            const cleanedCount = beforeCleanup - notifications.length;
            if (cleanedCount > 0) {
                console.log(`🧹 Cleaned ${cleanedCount} old admin messages from memory before subscribing`);
                persistNotifications();
                updateNotificationDot();
            }

            // Listen to a single document that all users read
            const messagesRef = doc(db, 'config', 'adminMessages');

            adminMessagesUnsub = onSnapshot(messagesRef, (docSnap) => {
                const snapshotTime = new Date().toLocaleTimeString();
                console.log('📨 Admin messages snapshot received at:', snapshotTime);
                console.log('📦 Full snapshot data:', docSnap.exists() ? docSnap.data() : 'NO DATA');
                console.log('🔍 Snapshot metadata:', {
                    hasPendingWrites: docSnap.metadata.hasPendingWrites,
                    fromCache: docSnap.metadata.fromCache
                });
                const data = docSnap.data();
                const now = Date.now();

                // Track which messages were in notifications BEFORE this snapshot
                const previousAdminMsgIds = new Set();
                notifications.forEach(n => {
                    if (n.id && n.id.startsWith('adminMsg_') && n.alertId) {
                        previousAdminMsgIds.add(String(n.alertId));
                    }
                });
                console.log(`📋 Messages already in memory before snapshot: ${previousAdminMsgIds.size}`);

                if (!data || !Array.isArray(data.messages)) {
                    console.log('📭 No messages in snapshot');
                    console.log('🗂️ Current notifications before cleanup:', notifications.map(n => ({ id: n.id, type: n.type })));
                    // No messages - remove only admin message notifications (those starting with 'adminMsg_')
                    const beforeCount = notifications.length;
                    notifications = notifications.filter(n => !n.id || !n.id.startsWith('adminMsg_'));
                    console.log(`🗑️ Removed ${beforeCount - notifications.length} admin notifications`);
                    console.log('🗂️ Notifications after cleanup:', notifications.map(n => ({ id: n.id, type: n.type })));
                    persistNotifications();
                    updateNotificationDot();
                    if (isNotificationPanelOpen) {
                        renderNotificationPanel();
                    }
                    return;
                }

                const messages = data.messages;
                if (debugMode) {
                    console.log(`📬 Received ${messages.length} messages from admin`);
                    console.log('📋 Full messages data:', JSON.stringify(messages, null, 2));
                    console.log('📋 Message IDs and audiences:', messages.map(m => ({ id: m.id, audience: m.audience, type: m.type })));
                    console.log('🔐 Current user login status:', !!auth.currentUser);
                }

                // STEP 1: Remove ALL existing admin messages from notifications
                // This ensures we only show what's currently in Firebase
                const beforeCleanup = notifications.length;
                notifications = notifications.filter(n => !n.id || !n.id.startsWith('adminMsg_'));
                const cleanedCount = beforeCleanup - notifications.length;
                if (debugMode) console.log(`🧹 Cleaned ${cleanedCount} old admin messages`);

                // STEP 2: Add fresh messages from Firebase
                const newNotifications = [];

                messages.forEach(msg => {
                    // Check if message has expired
                    if (msg.expiresAt) {
                        const expiryTime = new Date(msg.expiresAt).getTime();
                        if (now > expiryTime) {
                            console.log('⏰ Skipping expired message:', msg.id);
                            return; // Skip expired messages
                        }
                    }

                    // Check audience targeting
                    const isUserLoggedIn = !!auth.currentUser;
                    const msgAudience = msg.audience; // No default

                    // Debug info
                    if (debugMode) {
                        console.log(`🔍 Processing message: ${msg.id}`);
                        console.log(`   - Audience: ${msgAudience}`);
                        console.log(`   - isUserLoggedIn: ${isUserLoggedIn}`);
                    }

                    // Apply STRICT audience filtering - only if audience is explicitly set
                    if (msgAudience) {
                        if (msgAudience === 'registered' && !isUserLoggedIn) {
                            if (debugMode) console.log('👤 ❌ Skipping registered-only message for unregistered user:', msg.id);
                            return; // Skip registered-only messages for unregistered users
                        }

                        if (msgAudience === 'unregistered' && isUserLoggedIn) {
                            if (debugMode) console.log('👤 ❌ Skipping unregistered-only message for registered user:', msg.id);
                            return; // Skip unregistered-only messages for registered users
                        }

                        // Only allow known audience types
                        if (msgAudience !== 'all' && msgAudience !== 'registered' && msgAudience !== 'unregistered') {
                            if (debugMode) console.log('👤 ❌ Unknown audience type, skipping message:', msg.id, msgAudience);
                            return; // Skip messages with unknown audience
                        }
                    } else {
                        // If no audience is set, this is an old message - show to everyone
                        if (debugMode) console.log('👤 ⚠️ Old message with no audience, showing to everyone:', msg.id);
                    }

                    if (debugMode) console.log(`✅ Message passed filtering: ${msg.id}, will be shown`);

                    const msgId = msg.id || String(msg.timestamp || Date.now());
                    const notifId = 'adminMsg_' + msgId;
                    if (debugMode) console.log('✅ Adding message:', notifId);

                    // Create notification (all are new since we cleaned before)
                    const notification = {
                        id: notifId,
                        type: msg.type || 'admin',
                        alertId: msgId,
                        audience: msgAudience || 'all', // Store audience info, default to 'all' for old messages
                        timestamp: (msg.timestamp && typeof msg.timestamp.toDate === 'function')
                            ? msg.timestamp.toDate().toISOString()
                            : (msg.timestamp || new Date().toISOString())
                    };

                    // Add type-specific fields
                    if (msg.type === 'movie') {
                        notification.movieId = msg.movieId;
                        notification.title = msg.title;
                        notification.description = msg.description;
                        notification.poster = msg.poster;
                    } else {
                        notification.content = msg.content || msg.message || '';
                    }

                    newNotifications.push(notification);
                });

                console.log(`📊 Total messages from Firebase: ${messages.length}`);
                console.log(`📊 New notifications to add: ${newNotifications.length}`);

                // STEP 3: Determine which messages are truly NEW
                // Compare with messages that were in memory BEFORE this snapshot
                if (newNotifications.length > 0) {
                    if (debugMode) console.log(`✨ Adding ${newNotifications.length} notifications to memory`);

                    // Find truly NEW messages (not in previousAdminMsgIds - what was in memory before this snapshot)
                    const trulyNewNotifs = newNotifications.filter(n => !previousAdminMsgIds.has(String(n.alertId)));
                    if (debugMode) {
                        console.log(`🆕 Truly new notifications (not in memory before snapshot): ${trulyNewNotifs.length}`);
                        console.log(`📝 Previous IDs in memory: [${Array.from(previousAdminMsgIds).join(', ')}]`);
                        console.log(`📝 New notification IDs: [${newNotifications.map(n => n.alertId).join(', ')}]`);
                        console.log(`📝 Truly new IDs: [${trulyNewNotifs.map(n => n.alertId).join(', ')}]`);
                    }

                    // Dedupe: remove any legacy adminAlerts notifications with the same alertId
                    const incomingIds = new Set(newNotifications.map(n => String(n.alertId)));
                    const beforeCount = notifications.length;
                    notifications = notifications.filter(n => {
                        if (!n || !n.id) return true;
                        // Drop legacy adminAlerts entries (id starts with 'admin_') that match incoming adminMessages alertIds
                        if (n.id.startsWith('admin_') && n.alertId && incomingIds.has(String(n.alertId))) {
                            return false;
                        }
                        return true;
                    });
                    const removedLegacy = beforeCount - notifications.length;
                    if (removedLegacy > 0 && debugMode) console.log(`🧽 Removed ${removedLegacy} legacy adminAlerts duplicates by alertId`);

                    notifications.push(...newNotifications);

                    // Show popup for NEW notifications - faqat birinchi snapshot'dan keyin
                    // isInitialAuthCheckDone ensures user is logged in and page is ready
                    if (isInitialAuthCheckDone && trulyNewNotifs.length > 0 && !isFirstSnapshot) {
                        console.log('🎉 Showing popup for newest notification');
                        // Show the most recent NEW notification
                        const newestNotif = trulyNewNotifs[trulyNewNotifs.length - 1];
                        showNotificationPopup(newestNotif);
                    } else {
                        const reason = !isInitialAuthCheckDone ? 'auth not done' :
                                      trulyNewNotifs.length === 0 ? 'no new notifs' :
                                      isFirstSnapshot ? 'first snapshot' : 'unknown';
                        console.log('⏳ No popup shown (isInitialAuthCheckDone:', isInitialAuthCheckDone, ', trulyNew:', trulyNewNotifs.length, ', reason:', reason, ')');
                    }
                }

                // Birinchi snapshot'dan keyin flag o'zgaradi
                isFirstSnapshot = false;

                persistNotifications();
                updateNotificationDot();
                if (isNotificationPanelOpen) {
                    renderNotificationPanel();
                }

                console.log(`📱 Current notifications count: ${notifications.length}`, notifications.map(n => ({ id: n.id, type: n.type })));
            }, (error) => {
                console.warn('Failed to listen to admin messages', error);
            });
        } catch (e) {
            console.warn('Failed to subscribe to admin messages', e);
        }
    }

    function updateActiveNav(pageId) {
        document.querySelectorAll('.bottom-nav-link').forEach(link => {
            link.classList.remove('active');
            link.removeAttribute('aria-current');
        });
        let selector;
        if (pageId === 'main') selector = '#home-link-bottom';
        else if (pageId === 'favorites') selector = '#favorites-link-bottom';
        else if (pageId === 'support') selector = '#support-link-bottom';
        else if (['profile', 'guest-profile', 'settings', 'edit-profile', 'language-settings', 'playback-settings', 'content-settings', 'privacy-policy', 'faq', 'login', 'register', 'premium'].includes(pageId)) selector = '#profile-link-bottom';
        if (selector) {
            const activeLink = document.querySelector(selector);
            if (activeLink) {
                activeLink.classList.add('active');
                activeLink.setAttribute('aria-current', 'page');
            }
        }
    }

    function showModal(contentHTML, onOpen = null) {
        modalOverlay.innerHTML = contentHTML;
        modalOverlay.classList.remove('hidden');
        modalOverlay.querySelector('.close-modal-btn')?.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
        setLanguage(currentLanguage);
        if (onOpen) onOpen();
    }

    function closeModal() {
        modalOverlay.classList.add('hidden');
        modalOverlay.innerHTML = '';
    }

    function renderRegionSettingsPage() {
        const saved = localStorage.getItem('soundora-region') || 'kz';
        return `
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center mb-8">
                    <button id="back-button" class="text-2xl mr-4"><i class="fas fa-arrow-left"></i></button>
                    <h1 class="text-2xl md:text-4xl font-bold">Payment Region</h1>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-5 space-y-4">
                    <label for="region-select-setting" class="block text-sm font-medium text-gray-400 mb-2">Select Region</label>
                    <select id="region-select-setting" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 focus:border-red-500 focus:ring-red-500">
                        <option value="ru" ${saved === 'ru' ? 'selected' : ''}>Russia</option>
                        <option value="kz" ${saved === 'kz' ? 'selected' : ''}>Kazakhstan</option>
                        <option value="uz" ${saved === 'uz' ? 'selected' : ''}>Uzbekistan</option>
                        <option value="kg" ${saved === 'kg' ? 'selected' : ''}>Kyrgyzstan</option>
                        <option value="tj" ${saved === 'tj' ? 'selected' : ''}>Tajikistan</option>
                        <option value="tm" ${saved === 'tm' ? 'selected' : ''}>Turkmenistan</option>
                    </select>
                    <button id="save-region-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg w-full">Save</button>
                </div>
            </div>`;
    }

    function showPremiumRequiredModal() {
        const content = `
            <div class="relative bg-gray-900 rounded-lg p-6 text-center shadow-xl max-w-sm w-full">
                <button class="close-modal-btn absolute top-2 right-3 text-gray-500 hover:text-white text-3xl">×</button>
                <i class="fas fa-gem text-4xl text-amber-400 mb-4"></i>
                <h3 class="text-xl font-bold mb-2" data-lang-key="premiumRequiredTitle"></h3>
                <p class="text-gray-400 mb-6" data-lang-key="premiumRequiredText"></p>
                <button id="modal-go-premium-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                    <span data-lang-key="goToPremium"></span>
                </button>
            </div>`;
        showModal(content);
        document.getElementById('modal-go-premium-btn').addEventListener('click', () => {
            closeModal();
            navigate({ page: 'premium' });
        });
    }

    function showSearchModal() {
        const content = `
            <div class="relative bg-gray-900 rounded-lg w-11/12 max-w-lg shadow-xl">
                <button class="close-modal-btn absolute top-4 right-4 text-gray-500 hover:text-white text-2xl">×</button>
                <div class="p-6">
                    <div class="flex items-center border-b-2 border-red-500 pb-2 mb-6">
                        <i class="fas fa-search text-gray-500 mr-3"></i>
                        <input type="text" id="search-input" data-lang-key="searchPlaceholder" class="w-full bg-transparent text-white text-xl focus:outline-none">
                    </div>
                    <div id="search-results" class="max-h-[60vh] overflow-y-auto"></div>
                </div>
            </div>`;
        showModal(content, () => {
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', debounce(handleSearchInput, 300));
            searchInput.focus();
        });
    }

    function handleSearchInput(e) {
        const query = e.target.value.trim().toLowerCase();
        const resultsEl = document.getElementById('search-results');
        if (!resultsEl) return;
        if (!query) {
            resultsEl.innerHTML = '';
            return;
        }
        const filteredMovies = movies.filter(m =>
            (m.title?.toLowerCase().includes(query)) ||
            (m.originalTitle?.toLowerCase().includes(query))
        );
        const uniqueIds = new Set();
        const uniqueMovies = filteredMovies.filter(movie => {
            if (uniqueIds.has(movie.id)) {
                return false;
            } else {
                uniqueIds.add(movie.id);
                return true;
            }
        });
        displaySearchResults(uniqueMovies, resultsEl);
    }

    function displaySearchResults(results, container) {
        if (results.length === 0) {
            container.innerHTML = `<p class="text-gray-400 text-center" data-lang-key="noResults"></p>`;
            setLanguage(currentLanguage);
            return;
        }
        container.innerHTML = results.map(movie => `
            <a href="#" class="search-result-item flex items-center p-3 hover:bg-gray-800 rounded-md transition-colors" data-movie-id="${movie.id}">
                <img src="${movie.poster}" onerror="this.onerror=null;this.src='https://placehold.co/150x225/ef4444/ffffff?text=Error';" alt="${movie.title}" class="w-16 h-24 object-cover rounded-md mr-4">
                <div><h3 class="text-white font-bold text-lg">${movie.title}</h3><p class="text-gray-400 text-sm">${movie.genre} - ${movie.year}</p></div>
            </a>`).join('');
        container.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                closeModal();
                navigate({ page: 'movie-details', movieId: item.dataset.movieId });
            });
        });
    }

    function copyToClipboard(text) {
        navigator.clipboard?.writeText(text).catch(err => console.error(err));
    }

    function showToast(message, isError = false) {
        toastNotification.textContent = message;
        toastNotification.className = `toast-notification fixed bottom-20 left-1/2 -translate-x-1/2 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transform translate-y-4 ${isError ? 'bg-red-600' : 'bg-gray-800'}`;
        toastNotification.classList.remove('hidden');
        setTimeout(() => toastNotification.classList.remove('opacity-0', 'translate-y-4'), 10);
        setTimeout(() => {
            toastNotification.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => toastNotification.classList.add('hidden'), 3000);
        }, 3000);
    }

    function formatTime(time) {
        if (isNaN(time)) return "00:00";
        const mins = Math.floor(time / 60);
        const secs = Math.floor(time % 60);
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    function showMiniPlayer(state) {
        if (!activeVideoElement) return;
        miniPlayerState = { active: true, state: state };

        const movie = movies.find(m => String(m.id) === String(state.movieId));
        miniPlayerContainer.innerHTML = `
            <div id="mini-player-video-wrapper" class="w-full h-full"></div>
            <div class="absolute inset-0 bg-black/20 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                <button id="mini-player-expand" class="w-10 h-10 bg-black/50 text-white rounded-full flex items-center justify-center text-lg"><i class="fas fa-expand-arrows-alt"></i></button>
            </div>
            <button id="mini-player-close" class="absolute top-1 right-1 w-6 h-6 bg-black/50 text-white rounded-full flex items-center justify-center text-xs opacity-70 hover:opacity-100">×</button>
            <div class="absolute bottom-1 left-1 text-white text-xs font-bold bg-black/50 px-1 rounded truncate max-w-[90%]">${movie?.title || ''}</div>
        `;

        document.getElementById('mini-player-video-wrapper').appendChild(activeVideoElement);
        miniPlayerContainer.classList.remove('hidden');

        document.getElementById('mini-player-close').addEventListener('click', (e) => { e.stopPropagation(); hideMiniPlayer(true); });
        document.getElementById('mini-player-expand').addEventListener('click', (e) => { e.stopPropagation(); navigate(miniPlayerState.state); });

        makeDraggable(miniPlayerContainer);
    }

    function hideMiniPlayer(shouldStop = false) {
        if (shouldStop && activeVideoElement) {
            activeVideoElement.pause();
            activeVideoElement.src = '';
            activeVideoElement.remove();
            activeVideoElement = null;
        }
        miniPlayerState.active = false;
        miniPlayerContainer.classList.add('hidden');
        miniPlayerContainer.innerHTML = '';
    }

    function makeDraggable(elmnt) {
        let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

        const dragMouseDown = (e) => {
            if (e.target.closest('#mini-player-close') || e.target.closest('#mini-player-expand')) {
                return;
            }

            e = e || window.event;
            if (e.type === 'touchstart') {
                // e.preventDefault();
            }

            elmnt.classList.add('grabbing');

            pos3 = e.clientX || e.touches[0].clientX;
            pos4 = e.clientY || e.touches[0].clientY;

            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;

            document.ontouchend = closeDragElement;
            document.ontouchmove = elementDrag;
        };

        const elementDrag = (e) => {
            e = e || window.event;
            if (e.type === 'touchmove'){
                 e.preventDefault();
            }

            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;

            pos1 = pos3 - clientX;
            pos2 = pos4 - clientY;
            pos3 = clientX;
            pos4 = clientY;

            let newTop = elmnt.offsetTop - pos2;
            let newLeft = elmnt.offsetLeft - pos1;

            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const elmntWidth = elmnt.offsetWidth;
            const elmntHeight = elmnt.offsetHeight;

            newTop = Math.max(0, newTop);
            newLeft = Math.max(0, newLeft);
            newTop = Math.min(screenHeight - elmntHeight, newTop);
            newLeft = Math.min(screenWidth - elmntWidth, newLeft);

            elmnt.style.top = newTop + "px";
            elmnt.style.left = newLeft + "px";
        };

        const closeDragElement = () => {
            elmnt.classList.remove('grabbing');
            document.onmouseup = null;
            document.onmousemove = null;
            document.ontouchend = null;
            document.ontouchmove = null;
        };

        elmnt.onmousedown = dragMouseDown;
        elmnt.ontouchstart = dragMouseDown;
    }

    function setupPlayerControls(state) {
        const playerPage = document.getElementById('player');
        const playerContainer = playerPage.querySelector('#player-container');
        const controls = playerPage.querySelector('.player-controls');
        const playerLoadingSpinner = playerPage.querySelector('#player-loading-spinner');

        if (activeVideoElement) {
            activeVideoElement.remove();
            activeVideoElement = null;
        }

        let video = null;
        let isVideoInitialized = false;
        let isNativeFullscreen = false;

        window.exitNativeFullscreen = () => {
            isNativeFullscreen = false;
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        };

        const movie = movies.find(m => String(m.id) === String(state.movieId));
        const episodeIndex = state.episodeIndex || 0;
        const sources = movie.type === 'series' && movie.episodes ? movie.episodes[episodeIndex].sources : movie.sources;
        const defaultQuality = '720p';

        const playPauseBtn = playerPage.querySelector('#play-pause-btn');
        const centerPlayBtn = playerPage.querySelector('#center-play-btn');
        const centerPauseBtn = playerPage.querySelector('#center-pause-btn');
        const seekBar = playerPage.querySelector('#seek-bar');
        const currentTimeEl = playerPage.querySelector('#current-time');
        const totalTimeEl = playerPage.querySelector('#total-time');
        const volumeBtn = playerPage.querySelector('#volume-btn');
        const fullscreenBtn = playerPage.querySelector('#fullscreen-btn');
        const backBtn = playerPage.querySelector('#player-back-button');
        const rewindIndicator = playerPage.querySelector('#rewind-indicator');
        const forwardIndicator = playerPage.querySelector('#forward-indicator');
        const settingsBtn = playerPage.querySelector('#player-settings-btn');
        const settingsPanel = playerPage.querySelector('#player-settings-panel');

        // Cast tugmasi
        const castBtn = playerPage.querySelector('#cast-btn');

        let touchTimer = null;
        let lastTap = 0;
        let pressTimer = null;
        let originalPlaybackRate = 1.0;
        let startX = 0;
        let startY = 0;
        const speedIndicator = document.createElement('div');
        speedIndicator.className = 'speed-indicator';
        speedIndicator.textContent = '2x';
        playerContainer.appendChild(speedIndicator);

        // Initialize video playback. This implementation mirrors the behavior in the
        // original (films.html) version of the player. It simply assigns the
        // selected movie URL to the video element and does not attach any extra
        // error or CORS handling logic. This avoids false error messages when
        // closing the mini-player or switching episodes.
        const initializeVideoPlayback = () => {
            if (isVideoInitialized) return;
            isVideoInitialized = true;

            playerLoadingSpinner.classList.remove('hidden');
            centerPlayBtn.classList.add('hidden');

            video = document.createElement('video');
            activeVideoElement = video;

            // Determine the best available source (fall back to any available quality).
            const movieUrl = sources[defaultQuality] || Object.values(sources).find(s => s);
            video.src = movieUrl;
            video.id = 'main-video';
            video.className = 'w-full h-full';
            video.style.objectFit = 'contain';
            // Only autoplay the main player for authenticated users
            try { video.autoplay = !!currentUser; } catch (err) { video.autoplay = false; }
            video.controls = false;
            // Ensure inline playback on mobile devices
            video.setAttribute('playsinline', '');

            // Append subtitle tracks if available
            if (movie.subtitles && typeof movie.subtitles === 'object') {
                Object.keys(movie.subtitles).forEach(lang => {
                    if (movie.subtitles[lang]) {
                        const track = document.createElement('track');
                        track.kind = 'subtitles';
                        track.label = lang.toUpperCase();
                        track.srclang = lang;
                        track.src = movie.subtitles[lang];
                        video.appendChild(track);
                    }
                });
            }

            // Insert the video into the player container (as the first element)
            playerContainer.prepend(video);

            // Restore the saved playback position, if any
            try {
                const savedTime = localStorage.getItem(`soundora-play-position-${movie.id}`);
                if (savedTime) {
                    video.currentTime = parseFloat(savedTime);
                }
            } catch (e) {
                // Ignore errors reading from localStorage
            }

            // Attach event listeners for playback state updates
            video.addEventListener('waiting', onWaiting);
            video.addEventListener('playing', onPlaying);
            video.addEventListener('play', onPlay);
            video.addEventListener('pause', onPause);
            video.addEventListener('timeupdate', onTimeUpdate);
            video.addEventListener('loadedmetadata', onLoadedMetadata);
            video.addEventListener('ended', onEnded);
            video.addEventListener('volumechange', onVolumeChange);


            // --- Ad insertion logic ---
            // Ad state: at most 2 ads per movie. Ads are loaded from Firestore 'ads' collection.
            let adCount = 0;
            const MAX_ADS_PER_MOVIE = 2;
            let adOverlay = null;
            let adsList = [];
            // adShown flags per scheduled slot (0=first ad at 5min, 1=midpoint)
            const adShown = [false, false];

            async function loadAds() {
                try {
                    const snapshot = await getDocs(collection(db, 'ads'));
                    adsList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    console.debug('loadAds: fetched', adsList.length, 'ads');
                } catch (err) {
                    console.error('Failed to load ads from Firestore', err);
                    adsList = [];
                }
            }

            // visitor id for unique click/impression counting
            function getVisitorId() {
                try {
                    let id = localStorage.getItem('snd-visitor-id');
                    if (!id) {
                        id = 'v_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36);
                        localStorage.setItem('snd-visitor-id', id);
                    }
                    return id;
                } catch (e) { return 'anon'; }
            }

            function createAdOverlay() {
                if (adOverlay) return adOverlay;
                adOverlay = document.createElement('div');
                adOverlay.id = 'ad-overlay';
                adOverlay.className = 'absolute inset-0 z-50 flex items-center justify-center';
                adOverlay.style.pointerEvents = 'auto';
                adOverlay.style.display = 'none';
                // Full-size ad video plus UI chrome: logo top-left, title top-center, link bottom-left, skip bottom-right
                adOverlay.innerHTML = `
                    <video id="ad-video" playsinline webkit-playsinline style="width:100%;height:100%;object-fit:cover;background:#000"></video>
                    <div id="ad-ui" class="absolute inset-0 pointer-events-none">
                        <div class="absolute" style="top:12px;left:12px;pointer-events:auto;">
                            <img id="ad-logo" src="" alt="ad logo" style="width:72px;height:72px;object-fit:cover;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6)">
                        </div>
                        <div class="absolute left-0 right-0 flex justify-center pointer-events-auto" style="top:36px;">
                            <div id="ad-title" class="text-white text-lg font-extrabold bg-black/40 px-4 py-1 rounded">Advertisement</div>
                        </div>
                        <div class="absolute" style="bottom:6.5rem;left:12px;pointer-events:auto;">
                            <a id="ad-link-btn" class="text-white font-extrabold px-4 py-2 rounded border-2 border-white/60 bg-black/50 hover:bg-black/40" target="_blank">Visit</a>
                        </div>
                        <div class="absolute" style="bottom:6.5rem;right:12px;pointer-events:auto;">
                            <button id="ad-skip-btn" class="text-white font-extrabold px-4 py-2 rounded border-2 border-white/60 bg-black/50 disabled:opacity-50" disabled>Skip</button>
                        </div>
                        <div class="absolute" style="bottom:5.25rem;right:12px;color:#e5e7eb;font-size:12px;pointer-events:none">Skip available in <span id="ad-skip-timer">5</span>s</div>
                    </div>
                `;
                playerContainer.appendChild(adOverlay);
                return adOverlay;
            }

            // Show ad for a given scheduled slot index (0 = first 5min ad, 1 = midpoint)
            function showAd(slotIndex, triggeredBySeek = false) {
                try {
                    if (!video || adCount >= MAX_ADS_PER_MOVIE) return;
                    if (adShown[slotIndex]) return;
                    adShown[slotIndex] = true;
                    adCount++;

                    const adMeta = (adsList && adsList.length) ? adsList[(adCount - 1) % adsList.length] : null;
                    const adTimeSec = (slotIndex === 0) ? (5 * 60) : Math.floor((video.duration || 0) / 2);
                    const resumePosition = Math.max(0, adTimeSec - 5);

                    // Create overlay and hide main player chrome
                    const overlay = createAdOverlay();
                    const adVideo = overlay.querySelector('#ad-video');
                    const adLogo = overlay.querySelector('#ad-logo');
                    const adTitle = overlay.querySelector('#ad-title');
                    const adLink = overlay.querySelector('#ad-link-btn');
                    const skipBtn = overlay.querySelector('#ad-skip-btn');
                    const skipTimerEl = overlay.querySelector('#ad-skip-timer');

                    // Populate UI
                    adLogo.src = (adMeta && adMeta.thumbUrl) ? adMeta.thumbUrl : (movie.poster || '');
                    adTitle.textContent = (adMeta && adMeta.title) ? adMeta.title : `Advertisement`;
                    adLink.href = (adMeta && adMeta.linkUrl) ? adMeta.linkUrl : '#';

                    // Pause main content and hide controls
                    video.pause();
                    if (controls) controls.style.display = 'none';
                    try { playerLoadingSpinner.classList.add('hidden'); } catch(_) {}
                    try { centerPlayBtn.classList.add('hidden'); } catch(_) {}

                    // Show overlay and start ad video if available
                    overlay.style.display = 'block';
                    // Log impression (event + increment counter)
                    try {
                        const visitorId = getVisitorId();
                        const impPayload = { adId: (adMeta && adMeta.id) ? adMeta.id : null, slotIndex, movieId: (movie && movie.id) ? movie.id : null, timestamp: Date.now(), visitorId };
                        addDoc(collection(db, 'ad_impressions'), impPayload).catch(e => console.warn('ad_impression addDoc failed', e));
                        if (adMeta && adMeta.id) {
                            try { updateDoc(doc(db, 'ads', adMeta.id), { impressions: increment(1) }); } catch (e) { console.warn('impression increment failed', e); }
                        }
                    } catch (e) { console.warn('log impression failed', e); }
                    let usingVideoAd = false;
                    if (adMeta && adMeta.videoUrl) {
                        usingVideoAd = true;
                        adVideo.src = adMeta.videoUrl;
                        adVideo.currentTime = 0;
                        adVideo.play().catch(() => {
                            // autoplay may be blocked, but overlay still visible
                        });
                    }

                    // Skip timer (use per-ad setting or global default)
                    let skipCountdown = (adMeta && Number.isFinite(adMeta.skipDelaySeconds)) ? adMeta.skipDelaySeconds : (window._adsDefaultSkip || 5);
                    skipBtn.disabled = true;
                    skipTimerEl.textContent = String(skipCountdown);
                    const countdownInterval = setInterval(() => {
                        skipCountdown -= 1;
                        skipTimerEl.textContent = String(skipCountdown);
                        if (skipCountdown <= 0) {
                            clearInterval(countdownInterval);
                            skipBtn.disabled = false;
                            skipTimerEl.textContent = '0';
                        }
                    }, 1000);

                    const adDurationSec = (adMeta && Number.isFinite(adMeta.durationSeconds)) ? adMeta.durationSeconds : 30;

                    // Handlers
                    const onSkip = () => {
                        cleanup();
                        video.currentTime = resumePosition;
                        video.play();
                    };

                    const onAdEnded = () => {
                        cleanup();
                        video.currentTime = resumePosition;
                        video.play();
                    };

                    let autoEndTimeout = setTimeout(() => {
                        // If ad video is playing, pause it then end
                        try { if (usingVideoAd) adVideo.pause(); } catch(_) {}
                        onAdEnded();
                    }, adDurationSec * 1000);

                    function cleanup() {
                        clearTimeout(autoEndTimeout);
                        clearInterval(countdownInterval);
                        skipBtn.removeEventListener('click', onSkip);
                        try { adVideo.removeEventListener('ended', onAdEnded); } catch(_) {}
                        try { adVideo.pause(); adVideo.src = ''; } catch(_) {}
                        overlay.style.display = 'none';
                        // restore controls
                        if (controls) controls.style.display = '';
                        try { centerPlayBtn.classList.remove('hidden'); } catch(_) {}
                    }

                    skipBtn.addEventListener('click', onSkip);
                    // Click handler for ad link — log then open
                    try {
                        adLink.addEventListener('click', (e) => {
                            try {
                                e.preventDefault();
                                const url = adLink.href || '#';
                                const visitorId = getVisitorId();
                                const clickPayload = { adId: (adMeta && adMeta.id) ? adMeta.id : null, movieId: (movie && movie.id) ? movie.id : null, timestamp: Date.now(), visitorId, url };
                                addDoc(collection(db, 'ad_clicks'), clickPayload).catch(err => console.warn('ad_clicks addDoc failed', err));
                                if (adMeta && adMeta.id) {
                                    try { updateDoc(doc(db, 'ads', adMeta.id), { clicks: increment(1) }); } catch (e) { console.warn('clicks increment failed', e); }
                                }
                                window.open(url, '_blank');
                            } catch (err) { console.warn('ad link click error', err); }
                        });
                    } catch (e) {}
                    if (usingVideoAd) adVideo.addEventListener('ended', onAdEnded);
                } catch (err) {
                    console.warn('showAd error', err);
                }
            }

            // Schedule ads: compute ad times but also watch timeupdate/seeked so if user seeks past
            // the 5-minute mark we force the ad to play before resuming.
            function scheduleAds() {
                // reset flags
                adShown[0] = adShown[1] = false;
                adCount = 0;

                // If metadata not available, skip scheduling; timeupdate handlers will cover the check
            }

            // Time update checks: trigger ads if we've crossed thresholds and they haven't been shown
            function adTimeChecks() {
                try {
                    if (!video || !video.duration) return;
                    // first ad at 5 minutes
                    const firstAdSec = 5 * 60;
                    if (!adShown[0] && video.currentTime >= firstAdSec) {
                        showAd(0);
                        return;
                    }
                    // second ad at midpoint if available
                    const mid = Math.floor((video.duration || 0) / 2);
                    if (!adShown[1] && mid > firstAdSec && video.currentTime >= mid) {
                        showAd(1);
                        return;
                    }
                } catch (e) {
                    console.warn('adTimeChecks error', e);
                }
            }

            // When metadata loads we can prepare scheduling and load ads
            video.addEventListener('loadedmetadata', async () => {
                await loadAds();
                scheduleAds();
                // run an initial check in case the user started playback at a later position
                adTimeChecks();
                try {
                    // Quick dev/test trigger: add ?forceAd=1 to the URL to force the first ad immediately
                    const params = new URLSearchParams(window.location.search);
                    if (params.get('forceAd') === '1') {
                        console.debug('forceAd=1 detected, forcing ad slot 0');
                        // small timeout to allow UI to settle
                        setTimeout(() => {
                            try { showAd(0); } catch (e) { console.error('forceAd showAd error', e); }
                        }, 200);
                    }
                } catch (e) {
                    console.warn('forceAd check failed', e);
                }
            });

            // Run ad checks during playback and after seeks
            video.addEventListener('timeupdate', () => {
                adTimeChecks();
            });

            video.addEventListener('seeked', () => {
                // If user sought past the ad point(s), show the ad(s) immediately (but only once per slot)
                adTimeChecks();
            });

            // In some browsers autoplay may be restricted. If the video metadata
            // loads but playback does not automatically start, hide the loading
            // spinner and show the central play button so the user can start
            // playback manually. Without this, the spinner could remain
            // indefinitely, hiding the controls.
            video.addEventListener('loadedmetadata', () => {
                try {
                    if (video.paused) {
                        playerLoadingSpinner.classList.add('hidden');
                        centerPlayBtn.classList.remove('hidden');
                        centerPauseBtn.classList.add('hidden');
                    }
                } catch (err) {
                    console.error('Error handling loadedmetadata fallback', err);
                }
            });
        };

        const showIndicator = (indicator) => {
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 600);
        };

        const togglePlay = () => {
            if (!isVideoInitialized) {
                // If guest, redirect to login instead of initializing playback
                if (!currentUser) {
                    try { postLoginRedirect = { page: 'player', movieId: movie.id, episodeIndex: episodeIndex || 0 }; } catch(_) {}
                    showToast(translations[currentLanguage].loginRequired);
                    navigate({ page: 'login' });
                    return;
                }
                initializeVideoPlayback();
            } else if (video) {
                if (video.paused) {
                    // Require authentication to play
                    if (!currentUser) {
                        try { postLoginRedirect = { page: 'player', movieId: movie.id, episodeIndex: episodeIndex || 0 }; } catch(_) {}
                        showToast(translations[currentLanguage].loginRequired);
                        navigate({ page: 'login' });
                        return;
                    }
                    video.play();
                } else {
                    video.pause();
                }
            }
        };

        const showControls = () => {
            controls.classList.add('visible');
            clearTimeout(playerControlTimeout);
            if (video && !video.paused) {
                playerControlTimeout = setTimeout(() => {
                    // Only hide controls if the settings panel is not open; do not forcibly close the settings panel here
                    if (!settingsPanel.classList.contains('open')) {
                        controls.classList.remove('visible');
                    }
                }, 4000);
            }
        };

        const onPlay = () => {
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            if (playerLoadingSpinner.classList.contains('hidden')) {
                centerPlayBtn.classList.add('hidden');
                centerPauseBtn.classList.remove('hidden');
            }
            showControls();
        };
        const onPause = () => {
            playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
            if (playerLoadingSpinner.classList.contains('hidden')) {
                centerPlayBtn.classList.remove('hidden');
            }
            centerPauseBtn.classList.add('hidden');
            showControls();
        };
        const onTimeUpdate = () => {
            if (!video) return;
            seekBar.value = video.currentTime;
            currentTimeEl.textContent = formatTime(video.currentTime);
            if (Math.round(video.currentTime) % 5 === 0) {
                localStorage.setItem(`soundora-play-position-${movie.id}`, video.currentTime);
            }
        };
        const onLoadedMetadata = () => {
            if (!video) return;
            seekBar.max = video.duration;
            totalTimeEl.textContent = formatTime(video.duration);
        };
        const onEnded = () => {
            if(movie.type === 'series' && episodeIndex < movie.episodes.length - 1) {
                navigate({ page: 'player', movieId: movie.id, episodeIndex: episodeIndex + 1 });
            }
        };
        const onVolumeChange = () => {
            if (!video) return;
            volumeBtn.innerHTML = `<i class="fas ${video.muted || video.volume === 0 ? 'fa-volume-mute' : 'fa-volume-up'}"></i>`;
        };

        const onWaiting = () => {
            playerLoadingSpinner.classList.remove('hidden');
            centerPlayBtn.classList.add('hidden');
            centerPauseBtn.classList.add('hidden');
        };
        const onPlaying = () => {
            playerLoadingSpinner.classList.add('hidden');
            if (video && !video.paused) {
                centerPlayBtn.classList.add('hidden');
                centerPauseBtn.classList.remove('hidden');
            }
        };

        const handleTouchStart = (e) => {
            if (e.target.closest('button') || e.target.closest('input[type="range"]')) {
                return;
            }

            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;

            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            clearTimeout(touchTimer);

            if (tapLength < 300 && tapLength > 0) {
                e.preventDefault();
                if (!isVideoInitialized) return;

                const rect = playerContainer.getBoundingClientRect();
                const tapX = e.touches[0].clientX - rect.left;

                if (tapX < rect.width / 3) {
                    video.currentTime -= 10;
                    showIndicator(rewindIndicator);
                } else if (tapX > rect.width * 2 / 3) {
                    video.currentTime += 10;
                    showIndicator(forwardIndicator);
                } else {
                    togglePlay();
                }
                lastTap = 0;
            } else {
                pressTimer = setTimeout(() => {
                    if (!video) return;
                    originalPlaybackRate = video.playbackRate;
                    video.playbackRate = 2.0;
                    speedIndicator.style.opacity = '1';
                }, 400);
                lastTap = currentTime;
            }
        };

        const handleTouchEnd = (e) => {
            clearTimeout(pressTimer);
            if (video && video.playbackRate === 2.0) {
                video.playbackRate = originalPlaybackRate;
            }
            speedIndicator.style.opacity = '0';

            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0 && !e.target.closest('button') && !e.target.closest('input[type="range"]')) {
                 touchTimer = setTimeout(() => {
                    if (settingsPanel.classList.contains('open')) {
                        settingsPanel.classList.remove('open');
                    } else {
                        controls.classList.toggle('visible');
                    }
                    if (controls.classList.contains('visible') && video && !video.paused) {
                        showControls();
                    } else {
                        clearTimeout(playerControlTimeout);
                    }
                 }, 300);
            }
        };

        const handleTouchMove = (e) => {
            const moveX = Math.abs(e.touches[0].clientX - startX);
            const moveY = Math.abs(e.touches[0].clientY - startY);
            if (moveX > 10 || moveY > 10) {
                clearTimeout(pressTimer);
                clearTimeout(touchTimer);
                lastTap = 0;
                if (video && video.playbackRate === 2.0) {
                    video.playbackRate = originalPlaybackRate;
                }
                speedIndicator.style.opacity = '0';
            }
        };

        playerContainer.addEventListener('touchstart', handleTouchStart);
        playerContainer.addEventListener('touchend', handleTouchEnd);
        playerContainer.addEventListener('touchmove', handleTouchMove);

        playerContainer.addEventListener('click', (e) => {
            if ('ontouchstart' in document.documentElement) return;
            if (e.target.closest('button') || e.target.closest('input[type="range"]')) return;
            if (settingsPanel.classList.contains('open')) {
                settingsPanel.classList.remove('open');
            } else {
                controls.classList.toggle('visible');
            }
            showControls();
        });

        playPauseBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePlay(); });
        centerPlayBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePlay(); });
        centerPauseBtn.addEventListener('click', (e) => { e.stopPropagation(); togglePlay(); });

        seekBar.addEventListener('input', (e) => {
            e.stopPropagation();
            if (video) video.currentTime = seekBar.value;
        });
        volumeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (video) video.muted = !video.muted;
        });

        fullscreenBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            if (window.Android && typeof window.Android.toggleFullscreen === 'function') {
                isNativeFullscreen = !isNativeFullscreen;
                window.Android.toggleFullscreen(isNativeFullscreen);
                fullscreenBtn.innerHTML = isNativeFullscreen ? '<i class="fas fa-compress"></i>' : '<i class="fas fa-expand"></i>';
                // Ensure video continues playing when toggling fullscreen on Android
                if (video && video.paused) {
                    try { if (currentUser) video.play().catch(() => {}); } catch(_) {}
                }
            } else {
                // On non-Android platforms, request fullscreen on the player container rather than the video itself.
                // Using the player container preserves custom controls and overlays instead of triggering the
                // browser's native video controls.
                const playerEl = document.getElementById('player-container');
                if (!document.fullscreenElement) {
                    playerEl.requestFullscreen().catch(err => console.error(err));
                } else {
                    document.exitFullscreen();
                }
                // Ensure the video continues playing after entering/exiting fullscreen
                if (video && video.paused) {
                    try { if (currentUser) video.play().catch(() => {}); } catch(_) {}
                }
            }
        });

        document.addEventListener('fullscreenchange', () => {
            if (!window.Android) {
                if (document.fullscreenElement) {
                    fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                } else {
                    fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                }
            }
        });

        backBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            try {
                // Mark that we are returning from the player page to allow auto-resume on movie card
                sessionStorage.setItem('returnFromPlayer', 'true');
            } catch (err) {}
            history.back();
        });

        const mainSettings = settingsPanel.querySelector('#settings-main-view');
        const qualitySettings = settingsPanel.querySelector('#settings-quality-view');
        const speedSettings = settingsPanel.querySelector('#settings-speed-view');
        const subtitlesSettings = settingsPanel.querySelector('#settings-subtitles-view');
        const moreSettings = settingsPanel.querySelector('#settings-more-view');

        const showSettingsView = (viewToShow) => {
            // Har bir sozlamalar paneli yashiriladi, shu jumladan audio sozlamalar ko'rinishi
            [mainSettings, qualitySettings, speedSettings, audioSettings, subtitlesSettings, moreSettings].forEach(v => v.classList.add('hidden'));
            viewToShow.classList.remove('hidden');
        };

        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsPanel.classList.toggle('open');
            showSettingsView(mainSettings);
            showControls();
        });

        // Prevent clicks inside the settings panel from bubbling up to the playerContainer. Without this, clicking a sub-setting
        // (like quality, speed, audio or subtitles) would bubble to the playerContainer click handler and close the panel
        // immediately. By stopping propagation here, we ensure the user can interact with the settings submenus without
        // accidentally hiding the entire panel.
        settingsPanel.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        // On touch devices, also stop touch events from propagating out of the settings panel (prevents panel from closing on mobile)
        settingsPanel.addEventListener('touchstart', (e) => { e.stopPropagation(); });
        settingsPanel.addEventListener('touchend', (e) => { e.stopPropagation(); });

        const currentQualityLabel = settingsPanel.querySelector('#current-quality-label');
        currentQualityLabel.textContent = defaultQuality;
        settingsPanel.querySelector('#quality-settings-btn').addEventListener('click', () => {
            const qualities = Object.keys(sources).filter(q => sources[q]);
            qualitySettings.innerHTML = `
                <div class="p-4 border-b border-gray-700/50 flex items-center gap-4">
                    <button class="back-to-main-settings"><i class="fas fa-arrow-left"></i></button>
                    <h3 class="font-bold text-lg" data-lang-key="quality"></h3>
                </div>
                <div class="flex-grow overflow-y-auto">
                ${qualities.map(q => `<div class="settings-item quality-option ${q === currentQualityLabel.textContent ? 'active' : ''}" data-quality="${q}"><span>${q}</span><i class="fas fa-check ${q === currentQualityLabel.textContent ? '' : 'text-transparent'}"></i></div>`).join('')}
                </div>
            `;
            setLanguage(currentLanguage);
            qualitySettings.querySelector('.back-to-main-settings').addEventListener('click', () => showSettingsView(mainSettings));
            qualitySettings.querySelectorAll('.quality-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    if (!video) return;
                    const newQuality = opt.dataset.quality;
                    const currentTime = video.currentTime;
                        // Yangilangan manba URLsi
                        const newSrc = sources[newQuality];
                        // HLS oqimi uchun sifatni qo'lda o'zgartirishni qo'llab-quvvatlamaymiz, faqat MP4/DASH uchun
                        if (newSrc) {
                            video.src = newSrc;
                            window.currentVideoUrl = newSrc;
                            video.currentTime = currentTime;
                            try { if (currentUser) video.play().catch(() => {}); } catch(_) {}
                            currentQualityLabel.textContent = newQuality;
                        }
                        // Do not close the entire settings panel immediately upon selecting a quality; instead return to the main
                        // settings view to allow further changes. If you still wish to close the panel, you can tap outside.
                        showSettingsView(mainSettings);
                });
            });
            showSettingsView(qualitySettings);
        });

        const currentSpeedLabel = settingsPanel.querySelector('#current-speed-label');
        // Audio settings: label element and view container. This will display the currently selected audio language.
        const currentAudioLabel = settingsPanel.querySelector('#current-audio-label');
        const audioSettings = settingsPanel.querySelector('#settings-audio-view');
        // Initialize default audio label
        if (currentAudioLabel) {
            currentAudioLabel.textContent = 'Auto';
        }
        settingsPanel.querySelector('#speed-settings-btn').addEventListener('click', () => {
            const speeds = [0.5, 0.75, 1, 1.5, 2];
            const currentRate = video ? video.playbackRate : 1;
            speedSettings.innerHTML = `
                <div class="p-4 border-b border-gray-700/50 flex items-center gap-4">
                    <button class="back-to-main-settings"><i class="fas fa-arrow-left"></i></button>
                    <h3 class="font-bold text-lg" data-lang-key="playbackSpeed"></h3>
                </div>
                <div class="flex-grow overflow-y-auto">
                ${speeds.map(s => `<div class="settings-item speed-option ${s === currentRate ? 'active' : ''}" data-speed="${s}"><span>${s === 1 ? `${s}x (${translations[currentLanguage].normalSpeed})` : `${s}x`}</span><i class="fas fa-check ${s === currentRate ? '' : 'text-transparent'}"></i></div>`).join('')}
                </div>
            `;
            setLanguage(currentLanguage);
            speedSettings.querySelector('.back-to-main-settings').addEventListener('click', () => showSettingsView(mainSettings));
            speedSettings.querySelectorAll('.speed-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    if (!video) return;
                    const newSpeed = parseFloat(opt.dataset.speed);
                    video.playbackRate = newSpeed;
                    currentSpeedLabel.textContent = newSpeed === 1 ? translations[currentLanguage].normalSpeed : `${newSpeed}x`;
                    setLanguage(currentLanguage);
                    // Do not close the panel entirely; return to the main settings view so users can adjust more settings
                    showSettingsView(mainSettings);
                });
            });
            showSettingsView(speedSettings);
        });

        // Audio settings button handler
        const audioButton = settingsPanel.querySelector('#audio-settings-btn');
        if (audioButton) {
            audioButton.addEventListener('click', (ev) => {
                // Prevent bubbling to player container which would close the panel
                ev.stopPropagation();
                if (!video) return;
                // Determine available audio languages. Prefer movie.audioLangs if defined; otherwise parse from stored audio files; lastly fall back to video.audioTracks.
                let audioLangs = [];
                // 1. Use explicitly defined audioLangs on the movie document
                if (Array.isArray(movie.audioLangs) && movie.audioLangs.length > 0) {
                    audioLangs = movie.audioLangs;
                }
                // 2. If no audioLangs defined, attempt to infer languages from audioFiles names (e.g. "en.mp3" -> "en")
                if (audioLangs.length === 0 && Array.isArray(movie.audioFiles) && movie.audioFiles.length > 0) {
                    audioLangs = movie.audioFiles.map(f => {
                        const name = f.split('/').pop();
                        const base = name.split('.')[0];
                        return base.toLowerCase();
                    });
                }
                // 3. Fallback to audioTracks API
                if (audioLangs.length === 0 && video && video.audioTracks && video.audioTracks.length > 0) {
                    audioLangs = Array.from(video.audioTracks).map(at => at.language || at.label || '').filter(Boolean);
                }
                // Remove duplicates and falsy values
                audioLangs = Array.from(new Set(audioLangs.filter(Boolean)));
                // Always include a default/auto option
                const options = ['default', ...audioLangs];
                // Build options HTML
                const optionsHTML = options.map(lang => {
                    const isActive = (currentAudioLabel && ((currentAudioLabel.textContent || '').toLowerCase() === lang.toLowerCase() || (lang === 'default' && currentAudioLabel.textContent === 'Auto')));
                    const label = (lang === 'default') ? 'Auto' : lang.toUpperCase();
                    return `<div class="settings-item audio-option ${isActive ? 'active' : ''}" data-lang="${lang}"><span>${label}</span><i class="fas fa-check ${isActive ? '' : 'text-transparent'}"></i></div>`;
                }).join('');
                audioSettings.innerHTML = `
                    <div class="p-4 border-b border-gray-700/50 flex items-center gap-4">
                        <button class="back-to-main-settings"><i class="fas fa-arrow-left"></i></button>
                        <h3 class="font-bold text-lg">Audio</h3>
                    </div>
                    <div class="flex-grow overflow-y-auto">${optionsHTML}</div>
                `;
                // Back button returns to main view without closing the panel
                audioSettings.querySelector('.back-to-main-settings').addEventListener('click', (evt) => { evt.stopPropagation(); showSettingsView(mainSettings); });
                // Set click events for each audio option
                audioSettings.querySelectorAll('.audio-option').forEach(opt => {
                    opt.addEventListener('click', (e2) => {
                        e2.stopPropagation();
                        const selected = opt.dataset.lang;
                        // Update video audio tracks if supported
                        if (video && video.audioTracks && video.audioTracks.length > 0) {
                            Array.from(video.audioTracks).forEach(track => {
                                if (selected === 'default') {
                                    track.enabled = false;
                                } else {
                                    track.enabled = (track.language || track.label || '').toLowerCase() === selected.toLowerCase();
                                }
                            });
                        }
                        // Update label
                        if (currentAudioLabel) {
                            currentAudioLabel.textContent = (selected === 'default') ? 'Auto' : selected.toUpperCase();
                        }
                        // Return to main settings instead of closing panel completely
                        showSettingsView(mainSettings);
                    });
                });
                showSettingsView(audioSettings);
            });
        }

        const currentSubtitleLabel = settingsPanel.querySelector('#current-subtitle-label');
        settingsPanel.querySelector('#subtitles-settings-btn').addEventListener('click', () => {
            // When opening subtitle settings, prevent event from bubbling to the player container
            if (!video) return;
            // Determine available subtitle languages. Prefer explicit movie.subtitleLangs; otherwise parse from subtitleFiles names; lastly, fallback to video.textTracks.
            let subtitleLangs = [];
            if (Array.isArray(movie.subtitleLangs) && movie.subtitleLangs.length > 0) {
                subtitleLangs = movie.subtitleLangs;
            }
            // If no explicit subtitleLangs, infer from subtitleFiles names (e.g. "ru.vtt" -> "ru")
            if (subtitleLangs.length === 0 && Array.isArray(movie.subtitleFiles) && movie.subtitleFiles.length > 0) {
                subtitleLangs = movie.subtitleFiles.map(f => {
                    const name = f.split('/').pop();
                    const base = name.split('.')[0];
                    return base.toLowerCase();
                });
            }
            // If still none, use available text tracks on the video element
            const tracks = Array.from(video.textTracks);
            if (subtitleLangs.length === 0 && tracks.length > 0) {
                subtitleLangs = tracks.map(t => t.language || '').filter(Boolean);
            }
            // Build track info from the video element, but we also need labels to show in UI. We'll map languages to track objects if available.
            let trackOptions = [];
            if (tracks.length > 0) {
                trackOptions = tracks.map(track => ({ lang: track.language, label: track.label || track.language }));
            }
            // Remove duplicates
            subtitleLangs = Array.from(new Set(subtitleLangs.filter(Boolean)));
            // Determine currently active subtitle
            let activeTrackLang = 'off';
            tracks.forEach(track => { if (track.mode === 'showing') activeTrackLang = track.language; });
            // Build options: start with 'off'
            let optionsHTML = `<div class="settings-item subtitle-option ${activeTrackLang === 'off' ? 'active' : ''}" data-lang="off"><span>${translations[currentLanguage].noSubtitles}</span><i class="fas fa-check ${activeTrackLang === 'off' ? '' : 'text-transparent'}"></i></div>`;
            // For each subtitleLang, find a matching track label if available, otherwise just uppercase the language
            subtitleLangs.forEach(lang => {
                const matchingTrack = trackOptions.find(t => (t.lang || '').toLowerCase() === lang.toLowerCase());
                const label = matchingTrack ? matchingTrack.label : lang.toUpperCase();
                const isActive = lang.toLowerCase() === activeTrackLang.toLowerCase();
                optionsHTML += `<div class="settings-item subtitle-option ${isActive ? 'active' : ''}" data-lang="${lang}"><span>${label}</span><i class="fas fa-check ${isActive ? '' : 'text-transparent'}"></i></div>`;
            });
            subtitlesSettings.innerHTML = `
                <div class="p-4 border-b border-gray-700/50 flex items-center gap-4">
                    <button class="back-to-main-settings"><i class="fas fa-arrow-left"></i></button>
                    <h3 class="font-bold text-lg" data-lang-key="subtitles"></h3>
                </div>
                <div class="flex-grow overflow-y-auto">${optionsHTML}</div>
            `;
            setLanguage(currentLanguage);
            // Back button returns to main settings instead of closing the panel
            subtitlesSettings.querySelector('.back-to-main-settings').addEventListener('click', (evt) => { evt.stopPropagation(); showSettingsView(mainSettings); });
            subtitlesSettings.querySelectorAll('.subtitle-option').forEach(opt => {
                opt.addEventListener('click', (e2) => {
                    e2.stopPropagation();
                    const selectedLang = opt.dataset.lang;
                    // Update text track visibility
                    Array.from(video.textTracks).forEach(track => {
                        track.mode = (selectedLang !== 'off' && track.language && track.language.toLowerCase() === selectedLang.toLowerCase()) ? 'showing' : 'hidden';
                    });
                    currentSubtitleLabel.textContent = selectedLang === 'off' ? translations[currentLanguage].noSubtitles : selectedLang.toUpperCase();
                    setLanguage(currentLanguage);
                    // Return to main settings instead of closing the panel
                    showSettingsView(mainSettings);
                });
            });
            showSettingsView(subtitlesSettings);
        });

        settingsPanel.querySelector('#more-settings-btn').addEventListener('click', () => {
            moreSettings.innerHTML = `
                <div class="p-4 border-b border-gray-700/50 flex items-center gap-4">
                    <button class="back-to-main-settings"><i class="fas fa-arrow-left"></i></button>
                    <h3 class="font-bold text-lg" data-lang-key="more"></h3>
                </div>
                <div class="flex-grow overflow-y-auto">
                    <div class="settings-item">
                        <span data-lang-key="loopVideo"></span>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" id="loop-toggle" class="toggle-checkbox absolute block w-7 h-7 rounded-full bg-white border-4 appearance-none cursor-pointer" ${video && video.loop ? 'checked' : ''}/>
                            <label for="loop-toggle" class="toggle-label block overflow-hidden h-7 rounded-full bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                </div>
            `;
            setLanguage(currentLanguage);
            moreSettings.querySelector('.back-to-main-settings').addEventListener('click', () => showSettingsView(mainSettings));
            moreSettings.querySelector('#loop-toggle').addEventListener('change', (e) => {
                if (video) video.loop = e.target.checked;
            });
            showSettingsView(moreSettings);
        });

        const closeEpisodesBtn = playerPage.querySelector('#close-episodes-btn');
        const toggleEpisodesBtn = playerPage.querySelector('#toggle-episodes-btn');
        const episodeListPanel = playerPage.querySelector('#episode-list-panel');

        if (toggleEpisodesBtn) {
            toggleEpisodesBtn.addEventListener('click', e => {
                e.stopPropagation();
                episodeListPanel.classList.toggle('translate-x-full');
            });
        }
        if (closeEpisodesBtn) {
            closeEpisodesBtn.addEventListener('click', e => {
                e.stopPropagation();
                episodeListPanel.classList.add('translate-x-full');
            });
        }

        playerPage.querySelectorAll('.episode-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                const movieId = e.currentTarget.dataset.movieId;
                const episodeIndex = parseInt(e.currentTarget.dataset.episodeIndex, 10);
                navigate({ page: 'player', movieId, episodeIndex });
            });
        });

        // Chromecast tugmasi: foydalanuvchi bosganda video TV-ga uzatiladi
        if (castBtn && window.cast && cast.framework) {
            castBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                try {
                    const castContext = cast.framework.CastContext.getInstance();
                    let session = castContext.getCurrentSession();
                    if (!session) {
                        session = await castContext.requestSession();
                    }
                    if (session && window.currentVideoUrl) {
                        const mimeType = (movie.streamType === 'hls') ? 'application/x-mpegurl' : 'video/mp4';
                        const mediaInfo = new chrome.cast.media.MediaInfo(window.currentVideoUrl, mimeType);
                        mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
                        mediaInfo.metadata.title = movie.title;
                        const request = new chrome.cast.media.LoadRequest(mediaInfo);
                        await session.loadMedia(request);
                    }
                } catch (err) {
                    console.error('Cast load error', err);
                }
            });
        }

        initializeVideoPlayback();
        showControls();
    }

    let unsubMovies = null;
    let unsubUser = null;
    let unsubNotifications = null;

    async function createUserData(user, extraData = {}) {
        const userRef = doc(db, "users", user.uid);
        const userDoc = await getDoc(userRef);
        if (userDoc.exists()) return userDoc.data();

        const counterRef = doc(db, "counters", "userCounter");
        let newCount;
        try {
            await runTransaction(db, async (transaction) => {
                const counterDoc = await transaction.get(counterRef);
                const currentCount = counterDoc.exists() ? counterDoc.data().count : 1000;
                newCount = currentCount + 1;
                transaction.set(counterRef, { count: newCount }, { merge: true });
            });
        } catch (e) {
            console.error("Transaction failed: ", e);
            newCount = Math.floor(1000 + Math.random() * 9000);
        }
        const customId = `A-${String(newCount).padStart(4, '0')}`;

        const newUser = {
            uid: user.uid,
            email: user.email || null,
            phoneNumber: user.phoneNumber || null,
            displayName: extraData.name || user.displayName || user.phoneNumber || user.email?.split('@')[0],
            photoURL: user.photoURL || '',
            createdAt: serverTimestamp(),
            favorites: [],
            isPremium: false,
            role: 'user',
            customId: customId,
            secretWord: extraData.secretWord || null,
            region: extraData.region || 'uzbekistan',
            favoriteGenres: extraData.favoriteGenres || [],
            hasCompletedSurvey: !!extraData.hasCompletedSurvey,
            devices: []
        };
        await setDoc(userRef, newUser);
        return newUser;
    }

    // Update bottom navigation profile section with user info
    function updateBottomNavProfile() {
        const avatarEl = document.getElementById('bottom-nav-avatar');
        const usernameEl = document.getElementById('bottom-nav-username');
        const premiumBadge = document.getElementById('bottom-nav-premium-badge');

        if (!avatarEl || !usernameEl) return;

        if (currentUser) {
            // Update avatar
            if (currentUser.photoURL) {
                avatarEl.style.backgroundImage = `url(${currentUser.photoURL})`;
                avatarEl.style.backgroundSize = 'cover';
                avatarEl.style.backgroundPosition = 'center';
                avatarEl.innerHTML = '';
            } else {
                avatarEl.style.backgroundImage = '';
                const firstLetter = (currentUser.displayName || currentUser.email || 'U').charAt(0).toUpperCase();
                avatarEl.innerHTML = firstLetter;
            }

            // Update username
            const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'User';
            usernameEl.textContent = displayName;

            // Show/hide premium badge
            if (currentUser.isPremium && premiumBadge) {
                premiumBadge.classList.remove('hidden');
            } else if (premiumBadge) {
                premiumBadge.classList.add('hidden');
            }
        } else {
            // Reset to default
            avatarEl.style.backgroundImage = '';
            avatarEl.innerHTML = '<i class="fas fa-user text-base"></i>';
            usernameEl.textContent = translations[currentLanguage]?.navProfile || 'Profile';
            if (premiumBadge) {
                premiumBadge.classList.add('hidden');
            }
        }
    }

    function initFirebaseAndLoadContent() {
        onAuthStateChanged(auth, async (user) => {
            /*__BOOTSTRAP_INIT_DONE__*/
            if (!isInitialAuthCheckDone) {
                isInitialAuthCheckDone = true;
                // Render current page (or main) immediately; Firestore will hydrate after.
                const initialState = history.state || { page: 'main' };
                try { processNavigation(initialState, !history.state); } catch (e) { try { renderPage(initialState); } catch(_){} }
            }

            if (unsubUser) unsubUser();
            if (user) {
                // Save signed-in account to localStorage for account switching
                try {
                    upsertLocalAccount({
                        uid: user.uid,
                        displayName: user.displayName,
                        email: user.email,
                        phoneNumber: user.phoneNumber,
                        photoURL: user.photoURL || ''
                    });
                } catch (e) {
                    console.error('Error storing account info', e);
                }
                // Foydalanuvchi ma'lumotlarini yaratish yoki olish
                try { localStorage.setItem('soundora-lastUid', user.uid); } catch(_){ }
// Set minimal currentUser immediately for fast profile render
currentUser = { uid: user.uid, email: user.email || null, displayName: user.displayName || (user.email ? user.email.split('@')[0] : (user.phoneNumber || '')) };
// Ensure user doc exists in the background (non-blocking)
createUserData(user).catch(err => console.warn('createUserData failed (non-blocking):', err));

                if (user.email) {
                    setupPushNotifications();
                }
                // Subscribe to admin announcements once the user is authenticated.  The
                // subscription will be set up only on the first invocation thanks to
                // the adminAlertsUnsub guard in subscribeToAdminAlerts().  Admin
                // announcements are delivered as notifications in the header bell.
                subscribeToAdminAlerts();
                // Listen for changes to the current user's document and update UI in real time.
                unsubUser = onSnapshot(doc(db, "users", user.uid), (userDoc) => {
                    currentUser = { uid: userDoc.id, ...userDoc.data() };
                    currentUser.favoriteGenres = Array.isArray(currentUser.favoriteGenres) ? currentUser.favoriteGenres : [];
                    currentUser.hasCompletedSurvey = !!currentUser.hasCompletedSurvey;
                    currentUser.region = currentUser.region || 'uzbekistan';
                    try { localStorage.setItem('soundora-user-cache-' + user.uid, JSON.stringify(currentUser)); } catch (_) {}
                    upsertLocalAccount(currentUser);

                    // Foydalanuvchining til filtri ma'lumotini hujjatdan o'qish va qo'llash. Agar mavjud bo'lsa,
                    // selectedLangFilter o'zgaruvchisini yangilaymiz va tugmani qayta chizamiz.
                    try {
                        const data = userDoc.data();
                        if (data && data.preferredMovieLang) {
                            selectedLangFilter = data.preferredMovieLang;
                            // UI yangilanishi
                            renderLanguageButton();
                            buildLanguageDropdown();
                            // Agar hozirgi sahifa asosiy bo'lsa, filmlar ro'yxatini qayta filtrlaymiz
                            if (currentHistoryState?.page === 'main') {
                                const activeCategoryButton = document.querySelector('#category-nav .category-btn.active');
                                const currentCategory = activeCategoryButton ? activeCategoryButton.dataset.categoryValue : 'categoryAll';
                                filterAndDisplayMovies(currentCategory);
                            }
                        }
                    } catch (err) {
                        console.error('Error retrieving preferred movie language', err);
                    }
                    ensureSupportChatSubscription(currentUser);

                    // Subscribe to admin messages now that currentUser is set
                    console.log('📡 Subscribing to admin messages (user logged in)...');
                    subscribeToAdminMessages();

                    // Start QR auth monitor (approvals from this main device)
                    startQRAuthMonitor();

                    // Update bottom navigation with user info
                    updateBottomNavProfile();

                    if (currentUser && !currentUser.hasCompletedSurvey) {
                        if (postLoginRedirect?.page !== 'genre-survey') {
                            postLoginRedirect = { page: 'genre-survey' };
                        }
                        if (currentHistoryState?.page !== 'genre-survey') {
                            navigate({ page: 'genre-survey' });
                        }
                    }
                    // If initial auth check is done, re-render the current page. When on the profile
                    // page specifically, call renderProfilePage() directly to ensure the latest user
                    // information (like premium status or profile data) is reflected without
                    // navigating away and back. Otherwise fall back to renderPage with the
                    // current history state.
                    if (isInitialAuthCheckDone) {
                        if (currentHistoryState?.page === 'profile') {
                            renderProfilePage();
                        } else {
                            renderPage(currentHistoryState);
                        }
                    }
                });
            } else {
                currentUser = null;
                cleanupSupportChatSubscription();
                hideSupportSmsToast();
                // Stop QR monitor when logged out
                cleanupQRAuthMonitor();
                // Note: adminMessagesUnsub is NOT cleared here because it's a global broadcast
                // that should remain active even when logged out

                // Subscribe to admin messages now that currentUser is null (unregistered user)
                console.log('📡 Subscribing to admin messages (no user logged in)...');
                subscribeToAdminMessages();

                try { localStorage.removeItem('soundora-lastUid'); } catch(_) {}
                if (isAccountSwitchInProgress) {
                    return;
                }
                navigate({ page: 'login' });
            }

            if (!isInitialAuthCheckDone) {
                isInitialAuthCheckDone = true;
                const initialHash = window.location.hash.substring(1);
                const stateFromHash = pageRenderers[initialHash] ? { page: initialHash, ...Object.fromEntries(new URLSearchParams(window.location.search)) } : { page: 'main' };
                processNavigation(history.state || stateFromHash, !history.state);
            } else if (!isAccountSwitchInProgress) {
                renderPage(currentHistoryState);
                if (currentHistoryState?.page === 'main' && movies.length > 0) {
                    populateCategories();
                    filterAndDisplayMovies('categoryAll');
                }
                 if (postLoginRedirect) {
                     const dest = { ...postLoginRedirect };
                     postLoginRedirect = null;
                     navigate(dest);
                 } else if (currentUser && ['login', 'register', 'guest-profile'].includes(currentHistoryState?.page)) {
                     navigate({ page: 'main' });
                 }
            }
        });

        // Admin messages will be subscribed after auth state is determined
        console.log('📡 Admin messages subscription will be handled after auth state check...');

        unsubMovies = onSnapshot(collection(db, "movies"), (snapshot) => {
            const latestMovies = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setMovies(latestMovies);
            try { localStorage.setItem('soundora-movies-cache', JSON.stringify(latestMovies)); } catch (_) {}
            if (isInitialAuthCheckDone) {
                renderPage(currentHistoryState);
                if (currentHistoryState?.page === 'main') {
                    populateCategories();
                    filterAndDisplayMovies('categoryAll');
                }
            }
        }, (error) => {
            console.error("Error fetching movies: ", error);
            const moviesGrid = document.getElementById('movies-grid');
            if(moviesGrid) {
                moviesGrid.innerHTML = `<p class="col-span-full text-center text-red-500 mt-8">Ma'lumotlarni yuklab bo'lmadi. Internet aloqasini tekshiring.</p>`;
            }
        });
    }

    // -- Modal helper functions for rating and account switching --
    let ratingMovieId = null;
    // Holds the current rating value selected in the modal
    let selectedRatingValue = 0;
    function setupRatingModal() {
        const modal = document.getElementById('rating-modal');
        const starsContainer = document.getElementById('rating-stars');
        const closeBtn = document.getElementById('rating-modal-close');
        const submitBtn = document.getElementById('rating-submit');
        // Build stars only once
        if (starsContainer && starsContainer.children.length === 0) {
            for (let i = 1; i <= 10; i++) {
                const star = document.createElement('i');
                star.className = 'fas fa-star text-2xl text-gray-500 cursor-pointer';
                star.dataset.value = i;
                star.addEventListener('click', () => updateRatingStars(i));
                starsContainer.appendChild(star);
            }
        }
        closeBtn?.addEventListener('click', () => {
            modal?.classList.add('hidden');
        });
        submitBtn?.addEventListener('click', () => {
            // Submit the rating and update the movie rating
            if (ratingMovieId && selectedRatingValue > 0) {
                const aspects = {
                    direction: !!document.getElementById('rating-dir')?.checked,
                    plot: !!document.getElementById('rating-plot')?.checked,
                    spectacle: !!document.getElementById('rating-spectacle')?.checked,
                    actors: !!document.getElementById('rating-actors')?.checked
                };
                submitRating(ratingMovieId, selectedRatingValue, aspects);
            }
            modal?.classList.add('hidden');
            // Show thank you message
            showToast(translations[currentLanguage]?.thankYouForRating || 'РЎРїР°СЃРёР±Рѕ Р·Р° РѕС†РµРЅРєСѓ!');
        });
    }
    function updateRatingStars(value) {
        selectedRatingValue = value;
        const stars = document.querySelectorAll('#rating-stars i');
        stars.forEach(star => {
            const starVal = parseInt(star.dataset.value);
            if (starVal <= value) {
                star.classList.add('text-yellow-400');
                star.classList.remove('text-gray-500');
            } else {
                star.classList.remove('text-yellow-400');
                star.classList.add('text-gray-500');
            }
        });
    }

    /**
     * Saves the rating for the given movie and updates the displayed SND rating.
     * Ratings are stored per user in localStorage under the key
     * `soundora-ratings` as an object mapping userIds to movie rating maps.
     * A user may only rate a movie once; subsequent ratings overwrite the previous one.
     * After saving, the average rating across all stored ratings is computed and
     * stored on the movie object under `sndRating`. The UI is updated to reflect
     * the new average immediately.
     *
     * @param {string|number} movieId The ID of the movie being rated
     * @param {number} value The rating value selected (1-10)
     */
    function submitRating(movieId, value, aspects = {}) {
        if (!currentUser || !currentUser.uid) {
            showToast('Please log in to rate this movie.', true);
            return;
        }
        const userId = currentUser.uid;
        try {
            const key = 'soundora-ratings';
            let ratings = {};
            try {
                ratings = JSON.parse(localStorage.getItem(key)) || {};
            } catch (err) {
                ratings = {};
            }
            // Ensure user map exists
            if (!ratings[userId]) ratings[userId] = {};
            ratings[userId][String(movieId)] = value;
            localStorage.setItem(key, JSON.stringify(ratings));
            const aspectsKey = 'soundora-rating-aspects';
            let aspectsStore = {};
            try {
                aspectsStore = JSON.parse(localStorage.getItem(aspectsKey)) || {};
            } catch (err) {
                aspectsStore = {};
            }
            if (!aspectsStore[userId]) aspectsStore[userId] = {};
            aspectsStore[userId][String(movieId)] = {
                direction: !!aspects.direction,
                plot: !!aspects.plot,
                spectacle: !!aspects.spectacle,
                actors: !!aspects.actors
            };
            localStorage.setItem(aspectsKey, JSON.stringify(aspectsStore));
            // Recalculate average rating for this movie across all users
            let total = 0;
            let count = 0;
            for (const uid in ratings) {
                if (ratings[uid][String(movieId)]) {
                    total += ratings[uid][String(movieId)];
                    count++;
                }
            }
            const avgNum = count > 0 ? total / count : 0;
            const avg = count > 0 ? avgNum.toFixed(1) : '0.0';
            const aspectTotals = { direction: 0, plot: 0, spectacle: 0, actors: 0 };
            const aspectPercentages = { direction: 0, plot: 0, spectacle: 0, actors: 0 };
            for (const uid in aspectsStore) {
                const entry = aspectsStore[uid]?.[String(movieId)];
                if (!entry) continue;
                if (entry.direction) aspectTotals.direction += 1;
                if (entry.plot) aspectTotals.plot += 1;
                if (entry.spectacle) aspectTotals.spectacle += 1;
                if (entry.actors) aspectTotals.actors += 1;
            }
            if (count > 0) {
                aspectPercentages.direction = Math.round((aspectTotals.direction / count) * 100);
                aspectPercentages.plot = Math.round((aspectTotals.plot / count) * 100);
                aspectPercentages.spectacle = Math.round((aspectTotals.spectacle / count) * 100);
                aspectPercentages.actors = Math.round((aspectTotals.actors / count) * 100);
            }
            // Update movie object with average and votes count
            const movie = movies.find(m => String(m.id) === String(movieId));
            if (movie) {
                movie.sndRating = avg;
                movie.sndVotes = count;
                movie.aspectScores = aspectPercentages;
            }
            // Update rating UI if present
            const valueEl = document.querySelector('#info-rating .rating-value');
            const votesEl = document.querySelector('#info-rating .rating-votes-count');
            if (valueEl) valueEl.textContent = avg;
            if (votesEl) votesEl.textContent = count;
        const bars = document.querySelectorAll('#info-rating .rating-bar-fill');
        bars.forEach(bar => {
            const aspect = bar.dataset.aspect;
            const final = aspect ? (aspectPercentages[aspect] ?? 0) : Math.round(avgNum * 10);
            bar.dataset.final = `${final}`;
            bar.style.width = '0%';
            setTimeout(() => {
                bar.style.width = `${final}%`;
            }, 10);
        });
        const aspectValueEls = document.querySelectorAll('#info-rating [data-aspect-value]');
        aspectValueEls.forEach(span => {
            const aspect = span.dataset.aspectValue;
            if (!aspect) return;
            span.textContent = `${aspectPercentages[aspect] ?? 0}%`;
        });
        } catch (err) {
            console.error('Error saving rating', err);
        }
    }
    function openRatingModal(movieId) {
        ratingMovieId = movieId;
        setupRatingModal();
        const modal = document.getElementById('rating-modal');
        const dirBox = document.getElementById('rating-dir');
        const plotBox = document.getElementById('rating-plot');
        const spectacleBox = document.getElementById('rating-spectacle');
        const actorsBox = document.getElementById('rating-actors');
        const userId = currentUser?.uid;
        if (userId) {
            try {
                const aspectsStore = JSON.parse(localStorage.getItem('soundora-rating-aspects')) || {};
                const userAspects = aspectsStore[userId]?.[String(movieId)];
                if (dirBox) dirBox.checked = !!userAspects?.direction;
                if (plotBox) plotBox.checked = !!userAspects?.plot;
                if (spectacleBox) spectacleBox.checked = !!userAspects?.spectacle;
                if (actorsBox) actorsBox.checked = !!userAspects?.actors;
            } catch (err) {
                if (dirBox) dirBox.checked = false;
                if (plotBox) plotBox.checked = false;
                if (spectacleBox) spectacleBox.checked = false;
                if (actorsBox) actorsBox.checked = false;
            }
            try {
                const ratingsData = JSON.parse(localStorage.getItem('soundora-ratings')) || {};
                const previousValue = ratingsData[userId]?.[String(movieId)] || 0;
                selectedRatingValue = previousValue;
                updateRatingStars(previousValue);
            } catch (err) {
                selectedRatingValue = 0;
                updateRatingStars(0);
            }
        } else {
            if (dirBox) dirBox.checked = false;
            if (plotBox) plotBox.checked = false;
            if (spectacleBox) spectacleBox.checked = false;
            if (actorsBox) actorsBox.checked = false;
            selectedRatingValue = 0;
            updateRatingStars(0);
        }
        modal?.classList.remove('hidden');
    }
    function upsertLocalAccount(account) {
        if (!account || !account.uid) return;
        try {
            const accounts = JSON.parse(localStorage.getItem('soundora-accounts')) || [];
            const index = accounts.findIndex(item => item && item.uid === account.uid);
            const existing = index >= 0 ? accounts[index] : {};

            // Avatar colors - assign random if new account
            const avatarColors = ['gradient-purple', 'gradient-pink', 'gradient-blue', 'gradient-green', 'gradient-yellow', 'gradient-cyan', 'gradient-aqua', 'gradient-rose'];
            const randomColor = avatarColors[Math.floor(Math.random() * avatarColors.length)];

            const merged = {
                uid: account.uid,
                displayName: account.displayName || existing.displayName || account.email || account.phoneNumber || 'User',
                email: account.email !== undefined ? account.email : (existing.email ?? null),
                phoneNumber: account.phoneNumber !== undefined ? account.phoneNumber : (existing.phoneNumber ?? null),
                photoURL: account.photoURL !== undefined ? account.photoURL : (existing.photoURL || ''),
                isPremium: account.isPremium !== undefined ? !!account.isPremium : !!existing.isPremium,
                providerId: account.providerId !== undefined ? account.providerId : (existing.providerId ?? null),
                password: account.password || existing.password || null,
                avatarColor: existing.avatarColor || randomColor
            };
            if (!merged.password) {
                delete merged.password;
            }
            accounts[index >= 0 ? index : accounts.length] = merged;
            localStorage.setItem('soundora-accounts', JSON.stringify(accounts));
        } catch (err) {
            console.error('Error updating account info', err);
        }
    }

    function setupAccountSwitchModal() {
        const modal = document.getElementById('account-switch-modal');
        const closeBtn = document.getElementById('account-switch-close');
        const shareBtn = document.getElementById('account-share-subscription');
        closeBtn?.addEventListener('click', () => modal?.classList.add('hidden'));
        // Show share subscription modal with promo codes instead of directly generating a code
        shareBtn?.addEventListener('click', (e) => {
            e.preventDefault();
            modal?.classList.add('hidden');
            openShareSubscriptionModal();
        });
    }
    async function switchToStoredAccount(acc, modal) {
        if (isAccountSwitchInProgress) return;
        if (!acc?.email || !acc?.password) {
            showToast(translations[currentLanguage]?.loginRequired || 'Please log in to watch.', true);
            return;
        }
        if (currentUser?.uid === acc.uid) {
            modal?.classList.add('hidden');
            return;
        }
        isAccountSwitchInProgress = true;
        localStorage.setItem('soundora-selected-account', acc.uid);
        loadingOverlay?.classList.remove('hidden');
        try {
            await signInWithEmailAndPassword(auth, acc.email, acc.password);
            modal?.classList.add('hidden');
            const accountName = acc.displayName || acc.email || 'User';
            showToast((translations[currentLanguage]?.switchedToAccount || 'Switched to') + ' ' + accountName);
        } catch (signInErr) {
            console.error('Error signing in selected account', signInErr);
            showToast(translations[currentLanguage]?.invalidCredentials || 'Invalid login or password.', true);
        } finally {
            loadingOverlay?.classList.add('hidden');
            isAccountSwitchInProgress = false;
        }
    }

    function openAccountSwitchModal() {
        const modal = document.getElementById('account-switch-modal');
        const list = document.getElementById('account-list');
        if (!list) return;

        list.innerHTML = '';
        list.className = 'grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8 justify-items-center';

        // Show user profiles instead of accounts
        if (userProfiles.length === 0) {
            const emptyMsg = document.createElement('p');
            emptyMsg.className = 'col-span-full text-sm text-gray-400 text-center';
            emptyMsg.textContent = translations[currentLanguage]?.noSavedAccounts || 'No profiles yet.';
            list.appendChild(emptyMsg);
        }

        // Get stored accounts
        const storedAccounts = JSON.parse(localStorage.getItem('soundora-accounts') || '[]');

        // Render stored accounts
        storedAccounts.forEach(account => {
            const wrapper = document.createElement('div');
            wrapper.className = 'flex flex-col items-center gap-3 cursor-pointer group';

            const isActive = currentUser && currentUser.uid === account.uid;
            const currentProfileForAccount = getCurrentProfile();

            // Account avatar
            const avatar = document.createElement('div');
            const avatarColor = account.avatarColor || 'gradient-purple';
            avatar.className = `profile-avatar ${avatarColor} ${isActive ? 'active' : ''}`;

            // Use photo or first letter
            if (account.photoURL) {
                avatar.style.backgroundImage = `url(${account.photoURL})`;
                avatar.style.backgroundSize = 'cover';
                avatar.style.backgroundPosition = 'center';
            } else {
                const firstLetter = (account.displayName || account.email || 'U').charAt(0).toUpperCase();
                avatar.textContent = firstLetter;
            }

            // Add premium crown if account is premium
            if (account.isPremium) {
                const crown = document.createElement('span');
                crown.className = 'profile-crown';
                crown.innerHTML = '👑';
                avatar.appendChild(crown);
            }

            // Account name/email
            const nameLabel = document.createElement('span');
            nameLabel.className = `text-base font-semibold text-center ${isActive ? 'text-red-400' : 'text-gray-300'} group-hover:text-white transition-colors max-w-[140px] truncate`;
            nameLabel.textContent = account.displayName || account.email || 'User';

            wrapper.appendChild(avatar);
            wrapper.appendChild(nameLabel);

            // Click handler - show confirmation dialog
            wrapper.addEventListener('click', () => {
                // If clicking on current account, just close modal
                if (currentUser?.uid === account.uid) {
                    modal?.classList.add('hidden');
                    return;
                }

                // Show confirmation modal
                const confirmModal = document.getElementById('switch-confirm-modal');
                const accountNameSpan = document.getElementById('switch-account-name');
                if (confirmModal && accountNameSpan) {
                    accountNameSpan.textContent = account.displayName || account.email || 'User';
                    confirmModal.classList.remove('hidden');

                    // Setup confirmation handlers
                    const yesBtn = document.getElementById('switch-confirm-yes');
                    const noBtn = document.getElementById('switch-confirm-no');

                    const handleYes = async () => {
                        confirmModal.classList.add('hidden');
                        modal?.classList.add('hidden');
                        await switchToStoredAccount(account, modal);
                        cleanup();
                    };

                    const handleNo = () => {
                        confirmModal.classList.add('hidden');
                        cleanup();
                    };

                    const cleanup = () => {
                        yesBtn?.removeEventListener('click', handleYes);
                        noBtn?.removeEventListener('click', handleNo);
                    };

                    yesBtn?.addEventListener('click', handleYes);
                    noBtn?.addEventListener('click', handleNo);
                }
            });

            list.appendChild(wrapper);
        });

        // Add "Add Profile" button - yangi account bilan login qilish
        const addProfileWrapper = document.createElement('div');
        addProfileWrapper.className = 'flex flex-col items-center gap-3 cursor-pointer group';

        const addCircle = document.createElement('div');
        addCircle.className = 'profile-avatar bg-gray-700 hover:bg-gray-600 border-2 border-dashed border-gray-500';
        addCircle.innerHTML = '<i class="fas fa-user-plus text-5xl"></i>';

        const addLabel = document.createElement('span');
        addLabel.className = 'text-base font-semibold text-gray-400 group-hover:text-white transition-colors';
        addLabel.textContent = translations[currentLanguage]?.addNewAccount || 'Add Account';

        addProfileWrapper.appendChild(addCircle);
        addProfileWrapper.appendChild(addLabel);
        addProfileWrapper.addEventListener('click', () => {
            modal?.classList.add('hidden');
            // Navigate to login page to add new account
            postLoginRedirect = { page: 'main' };
            navigate({ page: 'login' });
        });
        list.appendChild(addProfileWrapper);

        // Add "Add Kids" button
        const addKidsWrapper = document.createElement('div');
        addKidsWrapper.className = 'flex flex-col items-center gap-3 cursor-pointer group';

        const kidsCircle = document.createElement('div');
        kidsCircle.className = 'profile-avatar kids bg-gradient-to-br from-purple-500 to-pink-500 border-2 border-dashed border-green-400';
        kidsCircle.innerHTML = '<i class="fas fa-child text-5xl"></i>';

        const kidsLabel = document.createElement('span');
        kidsLabel.className = 'text-base font-semibold text-gray-400 group-hover:text-white transition-colors';
        kidsLabel.textContent = translations[currentLanguage]?.addKids || 'Add Kids';

        addKidsWrapper.appendChild(kidsCircle);
        addKidsWrapper.appendChild(kidsLabel);
        addKidsWrapper.addEventListener('click', () => {
            modal?.classList.add('hidden');
            showCreateProfileModal(true);
        });
        list.appendChild(addKidsWrapper);

        setupAccountSwitchModal();
        modal?.classList.remove('hidden');
    }

    // Open Connected Devices modal
    function openDevicesModal() {
        const modal = document.getElementById('devices-modal');
        if (!modal || !currentUser) return;

        // Show modal
        modal.classList.remove('hidden');

        // Setup tab switching
        const devicesTab = document.getElementById('devices-tab');
        const qrTab = document.getElementById('qr-tab');
        const devicesContent = document.getElementById('devices-content');
        const qrContent = document.getElementById('qr-content');

        // Devices tab click
        devicesTab?.addEventListener('click', () => {
            devicesTab.classList.add('active');
            qrTab?.classList.remove('active');
            devicesContent?.classList.remove('hidden');
            qrContent?.classList.add('hidden');
        });

        // QR tab click
        qrTab?.addEventListener('click', () => {
            qrTab.classList.add('active');
            devicesTab?.classList.remove('active');
            qrContent?.classList.remove('hidden');
            devicesContent?.classList.add('hidden');

            // Generate QR code when tab is opened
            generateDeviceQRCode();
        });

        // Close button
        const closeBtn = document.getElementById('close-devices-modal');
        closeBtn?.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        // Load connected devices
        loadConnectedDevices();
    }

    // Generate QR code for device authentication
    function generateDeviceQRCode() {
        const container = document.getElementById('qr-code-container');
        if (!container || !currentUser) {
            console.error('QR container or user not found:', { container: !!container, user: !!currentUser });
            return;
        }

        console.log('Generating QR code for user:', currentUser.uid);

        // Clear previous QR code
        container.innerHTML = '';

        // Generate unique auth token with all needed data
        const authData = {
            uid: currentUser.uid,
            email: currentUser.email,
            timestamp: Date.now()
        };

        // Encode to base64 for URL safety
        const encodedToken = btoa(JSON.stringify(authData));

        // Create URL with token (this will work with phone camera scanner)
        const authURL = `${window.location.origin}${window.location.pathname}?qr=${encodedToken}`;

        console.log('QR Auth URL:', authURL);
        console.log('Auth data:', authData);

        // Create QR code
        if (typeof QRCode === 'undefined') {
            console.error('QRCode library not loaded!');
            container.innerHTML = '<p class="text-red-500 text-sm">QR Code library not loaded</p>';
            return;
        }

        new QRCode(container, {
            text: authURL,
            width: 256,
            height: 256,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
        });

        console.log('QR code generated successfully');

        // Start countdown timer
        startQRTimer(59);

        // Auto-regenerate after 59 seconds
        if (window.qrRefreshTimer) {
            clearTimeout(window.qrRefreshTimer);
        }
        window.qrRefreshTimer = setTimeout(() => {
            console.log('QR code expired, regenerating...');
            generateDeviceQRCode();
        }, 59000);
    }

    // QR Timer countdown
    function startQRTimer(seconds) {
        const timerElement = document.getElementById('qr-timer');
        if (!timerElement) return;

        let remaining = seconds;

        const updateTimer = () => {
            timerElement.textContent = `Expires in ${remaining}s`;
            remaining--;

            if (remaining < 0) {
                clearInterval(timerInterval);
            }
        };

        updateTimer();
        const timerInterval = setInterval(updateTimer, 1000);
    }

    // QR auth monitor unsub/interval handles
    let qrAuthUnsub = null;            // legacy query listener
    let qrInboxUnsub = null;           // inbox single-doc listener
    let qrAuthLocalTimer = null;       // localStorage polling
    let lastInboxRequestId = null;     // prevent duplicate notifications

    // Load connected devices from localStorage or Firebase
    function loadConnectedDevices() {
        const devicesList = document.getElementById('devices-list');
        if (!devicesList || !currentUser) return;

        devicesList.innerHTML = '';

        // Get devices from localStorage (will be Firebase later)
        const devices = JSON.parse(localStorage.getItem(`devices-${currentUser.uid}`) || '[]');

        if (devices.length === 0) {
            devicesList.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-mobile-alt text-4xl text-gray-600 mb-3"></i>
                    <p class="text-gray-400">${translations[currentLanguage]?.noDevices || 'No connected devices'}</p>
                </div>
            `;
            return;
        }

        // Render device list
        devices.forEach((device, index) => {
            const deviceItem = document.createElement('div');
            deviceItem.className = 'flex items-center justify-between p-4 bg-gray-800/50 rounded-lg hover:bg-gray-700/50 transition-colors';

            deviceItem.innerHTML = `
                <div class="flex items-center gap-4">
                    <i class="fas fa-${device.type === 'mobile' ? 'mobile-alt' : 'desktop'} text-2xl text-purple-400"></i>
                    <div>
                        <h4 class="text-white font-semibold">${device.name || 'Unknown Device'}</h4>
                        <p class="text-sm text-gray-400">${new Date(device.connectedAt).toLocaleDateString()}</p>
                    </div>
                </div>
                <button class="text-red-400 hover:text-red-300 transition-colors" onclick="removeDevice(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            `;

            devicesList.appendChild(deviceItem);
        });
    }

    // Remove a connected device
    function removeDevice(index) {
        if (!currentUser) return;

        const devices = JSON.parse(localStorage.getItem(`devices-${currentUser.uid}`) || '[]');
        devices.splice(index, 1);
        localStorage.setItem(`devices-${currentUser.uid}`, JSON.stringify(devices));

        loadConnectedDevices();
        showToast(translations[currentLanguage]?.deviceRemoved || 'Device removed');
    }

    // Handle QR authentication from URL parameters
    async function handleQRAuthFromURL() {
        const params = new URLSearchParams(window.location.search);
        const qrToken = params.get('qr');

        if (!qrToken) return;

        console.log('QR auth token found in URL:', qrToken);

        try {
            // Decode the token (base64)
            const decoded = atob(qrToken);
            const authData = JSON.parse(decoded);

            console.log('Decoded QR auth data:', authData);

            if (!authData.uid || !authData.email || !authData.timestamp) {
                throw new Error('Invalid QR token format');
            }
            // Delegate common processing
            await processQRAuthData(authData);

        } catch (err) {
            console.error('QR auth error:', err);
            showToast('QR kod xatosi: ' + err.message, 'error');

            // Clean URL
            window.history.replaceState({}, document.title, window.location.pathname);
            navigate({ page: 'login' });
        }
    }

    // Shared helper: validates token freshness and creates approval request then shows waiting UI
    async function processQRAuthData(authData) {
        // Check if token is expired (59 seconds)
        const now = Date.now();
        const tokenAge = (now - authData.timestamp) / 1000; // seconds
        if (tokenAge > 59) {
            console.error('QR token expired. Age:', tokenAge, 'seconds');
            showToast('QR kod muddati tugagan. Yangi kod yarating.', 'error');
            // Clean URL
            try { window.history.replaceState({}, document.title, window.location.pathname); } catch(_) {}
            navigate({ page: 'login' });
            return;
        }
        console.log('QR token valid. Age:', tokenAge.toFixed(1), 'seconds');

        // Create request
        const requestId = 'req_' + Math.random().toString(36).substring(2, 15);
        const authRequest = {
            uid: authData.uid,
            email: authData.email,
            requestId,
            deviceInfo: {
                name: navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Desktop Device',
                type: navigator.userAgent.includes('Mobile') ? 'mobile' : 'desktop',
                browser: getBrowserName(),
                userAgent: navigator.userAgent
            },
            timestamp: Date.now(),
            status: 'pending'
        };

        try {
            await setDoc(doc(db, 'qrAuthRequests', requestId), { ...authRequest, createdAt: serverTimestamp() });
            // Mirror into single-doc inbox for the account owner (main device real-time listener)
            await setDoc(doc(db, 'qrAuthInbox', authData.uid), {
                requestId,
                status: 'pending',
                deviceInfo: authRequest.deviceInfo,
                createdAt: serverTimestamp()
            }, { merge: true });
            console.log('Auth request created in Firestore (and inbox):', requestId);
            // Clean URL (if any)
            try { window.history.replaceState({}, document.title, window.location.pathname); } catch(_) {}
            // Show waiting page with Firestore listener
            showAuthApprovalWaitingFirestore(requestId, authData.uid);
        } catch (firestoreError) {
            console.warn('Firestore error, using localStorage fallback:', firestoreError);
            localStorage.setItem('qr-auth-request', JSON.stringify(authRequest));
            console.log('Auth request created in localStorage:', requestId);
            try { window.history.replaceState({}, document.title, window.location.pathname); } catch(_) {}
            showAuthApprovalWaiting(authRequest);
        }
    }

    // Show approval waiting page
    function showAuthApprovalWaitingFirestore(requestId, uid) {
        // Create modal
        const modal = document.createElement('div');
        modal.id = 'auth-approval-modal';
        modal.className = 'fixed inset-0 bg-black/90 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-md w-full border border-gray-800 p-8 text-center">
                <div class="mb-6">
                    <div class="w-20 h-20 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-hourglass-half text-4xl text-yellow-500 animate-pulse"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Tasdiqlash kutilmoqda</h2>
                    <p class="text-gray-400 text-sm">Asosiy qurilmangizda ushbu qurilmani tasdiqlang</p>
                </div>

                <div class="bg-gray-800/50 rounded-xl p-4 mb-6">
                    <p class="text-white text-sm"><i class="fas fa-sync fa-spin mr-2"></i>Firestore real-time listening...</p>
                </div>

                <div class="flex gap-3">
                    <button onclick="cancelAuthRequestFirestore('${requestId}')" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg transition">
                        Bekor qilish
                    </button>
                </div>

                <p class="text-xs text-gray-500 mt-4">Tasdiqlash uchun asosiy qurilmada bildirishnoma paydo bo'ladi</p>
            </div>
        `;

        document.body.appendChild(modal);

        // Listen to Firestore for real-time updates
        const unsubscribe = onSnapshot(doc(db, 'qrAuthRequests', requestId), async (snapshot) => {
            if (snapshot.exists()) {
                const data = snapshot.data();
                console.log('Auth request updated from Firestore:', data.status);

                if (data.status === 'approved' && data.credentials) {
                    console.log('Auth request approved!');
                    unsubscribe(); // Stop listening

                    // Remove modal
                    document.getElementById('auth-approval-modal')?.remove();

                    // Login with credentials
                    await loginWithApprovedCredentials(data.credentials, data.deviceInfo);

                    // Mark as completed
                    await setDoc(doc(db, 'qrAuthRequests', requestId), { status: 'completed' }, { merge: true });
                }
                else if (data.status === 'rejected') {
                    console.log('Auth request rejected');
                    unsubscribe();

                    document.getElementById('auth-approval-modal')?.remove();
                    showToast('Tasdiqlash rad etildi', 'error');
                    navigate({ page: 'login' });
                }
            }
        }, (error) => {
            console.error('Firestore listener error:', error);
            showToast('Real-time ulanishda xatolik', 'error');
        });

        // Timeout after 60 seconds
        setTimeout(() => {
            unsubscribe();
            const modalEl = document.getElementById('auth-approval-modal');
            if (modalEl) {
                modalEl.remove();
                showToast('Tasdiqlash vaqti tugadi', 'error');
                navigate({ page: 'login' });
            }
        }, 60000);
    }

    // Cancel auth request Firestore
    window.cancelAuthRequestFirestore = async function(requestId) {
        try {
            await setDoc(doc(db, 'qrAuthRequests', requestId), { status: 'cancelled' }, { merge: true });
        } catch (err) {
            console.error('Error cancelling:', err);
        }
        document.getElementById('auth-approval-modal')?.remove();
        navigate({ page: 'login' });
    };

    function showAuthApprovalWaiting(authRequest) {
        // Create modal
        const modal = document.createElement('div');
        modal.id = 'auth-approval-modal';
        modal.className = 'fixed inset-0 bg-black/90 backdrop-blur-sm z-[100] flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-gray-900 rounded-2xl shadow-2xl max-w-md w-full border border-gray-800 p-8 text-center">
                <div class="mb-6">
                    <div class="w-20 h-20 bg-yellow-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-hourglass-half text-4xl text-yellow-500 animate-pulse"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-2">Tasdiqlash kutilmoqda</h2>
                    <p class="text-gray-400 text-sm">Asosiy qurilmangizda ushbu qurilmani tasdiqlang</p>
                </div>

                <div class="bg-gray-800/50 rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Qurilma:</span>
                        <span class="text-white font-semibold">${authRequest.deviceInfo.name}</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-400 text-sm">Brauzer:</span>
                        <span class="text-white font-semibold">${authRequest.deviceInfo.browser}</span>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="cancelAuthRequest()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 rounded-lg transition">
                        Bekor qilish
                    </button>
                </div>

                <p class="text-xs text-gray-500 mt-4">Tasdiqlash uchun asosiy qurilmada bildirishnoma paydo bo'ladi</p>
            </div>
        `;

        document.body.appendChild(modal);

        // Start checking for approval (simulate - in real app would use Firebase)
        checkAuthApproval(authRequest);
    }

    // Check for auth approval
    function checkAuthApproval(authRequest) {
        let attempts = 0;
        const maxAttempts = 60; // 60 seconds

        const checkInterval = setInterval(() => {
            attempts++;

            // Check localStorage for approval
            const approvalData = localStorage.getItem(`qr-approval-${authRequest.requestId}`);

            if (approvalData) {
                const approval = JSON.parse(approvalData);

                if (approval.status === 'approved' && approval.credentials) {
                    console.log('Auth request approved!');
                    clearInterval(checkInterval);

                    // Remove modal
                    document.getElementById('auth-approval-modal')?.remove();

                    // Login with credentials
                    loginWithApprovedCredentials(approval.credentials, authRequest);

                    // Clean up
                    localStorage.removeItem('qr-auth-request');
                    localStorage.removeItem(`qr-approval-${authRequest.requestId}`);
                }
                else if (approval.status === 'rejected') {
                    console.log('Auth request rejected');
                    clearInterval(checkInterval);

                    document.getElementById('auth-approval-modal')?.remove();
                    showToast('Tasdiqlash rad etildi', 'error');
                    navigate({ page: 'login' });

                    localStorage.removeItem('qr-auth-request');
                    localStorage.removeItem(`qr-approval-${authRequest.requestId}`);
                }
            }

            if (attempts >= maxAttempts) {
                console.log('Auth request timeout');
                clearInterval(checkInterval);

                document.getElementById('auth-approval-modal')?.remove();
                showToast('Tasdiqlash vaqti tugadi', 'error');
                navigate({ page: 'login' });

                localStorage.removeItem('qr-auth-request');
            }
        }, 1000);
    }

    // Login with approved credentials
    async function loginWithApprovedCredentials(credentials, authRequest) {
        try {
            showToast('Tasdiqlandi! Hisobga kirilmoqda...', 'success');

            // Sign in with Firebase
            await signInWithEmailAndPassword(auth, credentials.email, credentials.password);

            console.log('Login successful via QR approval!');

            // Add device to connected devices
            const devices = JSON.parse(localStorage.getItem(`devices-${credentials.uid}`) || '[]');
            devices.push({
                ...authRequest.deviceInfo,
                connectedAt: Date.now()
            });
            localStorage.setItem(`devices-${credentials.uid}`, JSON.stringify(devices));

            // Save account to localStorage for future QR logins
            const storedAccounts = JSON.parse(localStorage.getItem('soundora-accounts') || '[]');
            const existingIndex = storedAccounts.findIndex(acc => acc.uid === credentials.uid);

            const accountData = {
                uid: credentials.uid,
                email: credentials.email,
                password: credentials.password,
                displayName: credentials.displayName || credentials.email,
                photoURL: credentials.photoURL || null,
                isPremium: credentials.isPremium || false,
                avatarColor: credentials.avatarColor || 'gradient-purple'
            };

            if (existingIndex >= 0) {
                storedAccounts[existingIndex] = accountData;
            } else {
                storedAccounts.push(accountData);
            }

            localStorage.setItem('soundora-accounts', JSON.stringify(storedAccounts));

            // Navigate to main page
            setTimeout(() => {
                navigate({ page: 'main' });
            }, 500);

        } catch (err) {
            console.error('Login error:', err);
            showToast('Login xatosi: ' + err.message, 'error');
            navigate({ page: 'login' });
        }
    }

    // Cancel auth request
    window.cancelAuthRequest = function() {
        const authRequest = JSON.parse(localStorage.getItem('qr-auth-request') || '{}');
        if (authRequest.requestId) {
            localStorage.removeItem(`qr-approval-${authRequest.requestId}`);
        }
        localStorage.removeItem('qr-auth-request');

        document.getElementById('auth-approval-modal')?.remove();
        navigate({ page: 'login' });
    };

    // Monitor for QR auth requests (on main device)
    function startQRAuthMonitor() {
        // Real-time Firestore listener for QR auth requests
        if (!currentUser) {
            console.log('No current user, skipping QR auth monitor');
            return;
        }
        // Prevent duplicates
        if (qrInboxUnsub || qrAuthUnsub || qrAuthLocalTimer) {
            console.log('QR auth monitor already running');
        }
        // Cleanup any prior monitors before starting
        cleanupQRAuthMonitor();

        console.log('Starting QR auth monitor for user:', currentUser.uid);

        // Preferred: single-doc inbox listener (avoids composite index)
        try {
            const inboxRef = doc(db, 'qrAuthInbox', currentUser.uid);
            qrInboxUnsub = onSnapshot(inboxRef, (snap) => {
                if (!snap.exists()) return;
                const data = snap.data() || {};
                const { requestId, status, deviceInfo } = data;
                if (!requestId || status !== 'pending') return;
                if (lastInboxRequestId === requestId) return; // already shown
                lastInboxRequestId = requestId;
                console.log('New QR auth request (Inbox):', { requestId, status, deviceInfo });
                showQRAuthApprovalNotification({ requestId, deviceInfo, status });
            }, (error) => {
                console.warn('Inbox listener error, falling back to query:', error);
                // Fallback to legacy query
                startQRAuthMonitorQuery();
            });
            console.log('Inbox QR auth monitor started');
            return;
        } catch (e) {
            console.warn('Failed to start inbox listener, trying query:', e);
        }

        // Fallback query approach
        startQRAuthMonitorQuery();
    }

    function startQRAuthMonitorQuery() {
        // Try Firestore collection query
        try {
            // Query all pending requests for current user
            const q = query(
                collection(db, 'qrAuthRequests'),
                where('uid', '==', currentUser.uid),
                where('status', '==', 'pending')
            );

            // Real-time listener
            qrAuthUnsub = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const request = {
                            requestId: change.doc.id,
                            ...change.doc.data()
                        };
                        console.log('New QR auth request detected (Firestore):', request);
                        showQRAuthApprovalNotification(request);
                    }
                });
            }, (error) => {
                console.warn('Firestore listener error, falling back to localStorage:', error);
                // Fallback to localStorage polling
                startQRAuthMonitorLocalStorage();
            });

            console.log('Firestore QR auth monitor started successfully');

        } catch (error) {
            console.warn('Firestore not available, using localStorage:', error);
            // Fallback to localStorage
            startQRAuthMonitorLocalStorage();
        }
    }

    // LocalStorage fallback monitor
    function startQRAuthMonitorLocalStorage() {
        console.log('Starting localStorage QR auth monitor');
        if (qrAuthLocalTimer) clearInterval(qrAuthLocalTimer);
        qrAuthLocalTimer = setInterval(() => {
            if (!currentUser) return;

            const requestData = localStorage.getItem('qr-auth-request');
            if (requestData) {
                try {
                    const request = JSON.parse(requestData);

                    if (request.uid === currentUser.uid && request.status === 'pending') {
                        console.log('New QR auth request detected (localStorage):', request);
                        showQRAuthApprovalNotification(request);
                    }
                } catch (e) {
                    console.error('Error parsing localStorage QR auth request:', e);
                }
            }
        }, 2000);
    }

    // Cleanup QR monitor
    function cleanupQRAuthMonitor() {
        try {
            if (qrInboxUnsub) { qrInboxUnsub(); qrInboxUnsub = null; }
            if (qrAuthUnsub) { qrAuthUnsub(); qrAuthUnsub = null; }
        } catch(_) {}
        try {
            if (qrAuthLocalTimer) { clearInterval(qrAuthLocalTimer); qrAuthLocalTimer = null; }
        } catch(_) {}
        lastInboxRequestId = null;
    }

    // Show QR auth approval notification
    function showQRAuthApprovalNotification(request) {
        // Check if notification already shown
        if (document.getElementById('qr-auth-notification')) return;

        const notification = document.createElement('div');
        notification.id = 'qr-auth-notification';
        notification.className = 'fixed top-4 right-4 z-[110] w-96 max-w-[90vw]';
        notification.innerHTML = `
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 rounded-xl shadow-2xl p-6 border border-blue-400 animate-slideIn">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                            <i class="fas fa-mobile-alt text-2xl text-white"></i>
                        </div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-white font-bold text-lg mb-1">Yangi qurilma</h3>
                        <p class="text-blue-100 text-sm mb-3">Hisobingizga kirish uchun ruxsat so'rayapti</p>
                        <div class="bg-white/10 rounded-lg p-3 mb-4">
                            <div class="flex items-center justify-between text-sm mb-1">
                                <span class="text-blue-100">Qurilma:</span>
                                <span class="text-white font-semibold">${request.deviceInfo.name}</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span class="text-blue-100">Brauzer:</span>
                                <span class="text-white font-semibold">${request.deviceInfo.browser}</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="approveQRAuthRequest('${request.requestId}')" class="flex-1 bg-white hover:bg-gray-100 text-blue-600 font-semibold py-2 px-4 rounded-lg transition">
                                <i class="fas fa-check mr-2"></i>Tasdiqlash
                            </button>
                            <button onclick="rejectQRAuthRequest('${request.requestId}')" class="flex-1 bg-red-500/20 hover:bg-red-500/30 text-white font-semibold py-2 px-4 rounded-lg transition">
                                <i class="fas fa-times mr-2"></i>Rad etish
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.appendChild(notification);
    }

    // Approve QR auth request
    window.approveQRAuthRequest = async function(requestId) {
        console.log('Approving QR auth request:', requestId);

        const notification = document.getElementById('qr-auth-notification');
        if (notification) notification.remove();

        if (!currentUser) {
            showToast('Xatolik: Foydalanuvchi topilmadi', 'error');
            return;
        }

        try {
            // Get user password from stored accounts
            const storedAccounts = JSON.parse(localStorage.getItem('soundora-accounts') || '[]');
            const account = storedAccounts.find(acc => acc.uid === currentUser.uid);

            if (!account || !account.password) {
                showToast('Xatolik: Hisob ma\'lumotlari topilmadi', 'error');
                return;
            }

            // Create approval credentials
            const credentials = {
                uid: currentUser.uid,
                email: currentUser.email,
                password: account.password,
                displayName: currentUser.displayName || currentUser.email,
                photoURL: currentUser.photoURL || null,
                isPremium: currentUser.isPremium || false,
                avatarColor: account.avatarColor || 'gradient-purple'
            };

            // Try Firestore first
            try {
                // Get device info from request
                const requestDoc = await getDoc(doc(db, 'qrAuthRequests', requestId));
                if (!requestDoc.exists()) {
                    throw new Error('Request not found in Firestore');
                }

                const requestData = requestDoc.data();

                // Update Firestore with approval
                await setDoc(doc(db, 'qrAuthRequests', requestId), {
                    status: 'approved',
                    credentials: credentials,
                    deviceInfo: requestData.deviceInfo,
                    approvedAt: serverTimestamp()
                }, { merge: true });
                // Notify inbox doc to clear pending on main device
                if (requestData.uid) {
                    await setDoc(doc(db, 'qrAuthInbox', requestData.uid), {
                        requestId,
                        status: 'approved',
                        approvedAt: serverTimestamp()
                    }, { merge: true });
                }

                showToast('Qurilma tasdiqlandi!', 'success');
                console.log('QR auth request approved in Firestore:', requestId);

            } catch (firestoreError) {
                console.warn('Firestore error, using localStorage fallback:', firestoreError);

                // Fallback to localStorage
                const approval = {
                    status: 'approved',
                    credentials: credentials,
                    timestamp: Date.now()
                };

                localStorage.setItem(`qr-approval-${requestId}`, JSON.stringify(approval));
                localStorage.removeItem('qr-auth-request');

                showToast('Qurilma tasdiqlandi!', 'success');
                console.log('QR auth request approved in localStorage:', requestId);
            }

        } catch (err) {
            console.error('Error approving QR auth:', err);
            showToast('Tasdiqlashda xatolik: ' + err.message, 'error');
        }
    };

    // Reject QR auth request
    window.rejectQRAuthRequest = async function(requestId) {
        console.log('Rejecting QR auth request:', requestId);

        const notification = document.getElementById('qr-auth-notification');
        if (notification) notification.remove();

        try {
            // Try Firestore first: fetch request to know target uid
            const requestDoc = await getDoc(doc(db, 'qrAuthRequests', requestId));
            const requestData = requestDoc.exists() ? requestDoc.data() : {};
            await setDoc(doc(db, 'qrAuthRequests', requestId), {
                status: 'rejected',
                rejectedAt: serverTimestamp()
            }, { merge: true });
            // Update inbox so main device clears the pending state
            if (requestData.uid) {
                await setDoc(doc(db, 'qrAuthInbox', requestData.uid), {
                    requestId,
                    status: 'rejected',
                    rejectedAt: serverTimestamp()
                }, { merge: true });
            }

            showToast('Qurilma rad etildi', 'info');
            console.log('QR auth request rejected in Firestore:', requestId);
        } catch (firestoreError) {
            console.warn('Firestore error, using localStorage fallback:', firestoreError);

            // Fallback to localStorage
            const rejection = {
                status: 'rejected',
                timestamp: Date.now()
            };

            localStorage.setItem(`qr-approval-${requestId}`, JSON.stringify(rejection));
            localStorage.removeItem('qr-auth-request');

            showToast('Qurilma rad etildi', 'info');
            console.log('QR auth request rejected in localStorage:', requestId);
        }
    };

    // QR Scanner functionality for login page
    let html5QrCode = null;

    // Open QR Scanner
    function openQRScanner() {
        const qrScannerModal = document.getElementById('qr-scanner-modal');
        const qrScanStatus = document.getElementById('qr-scan-status');

        if (!qrScannerModal) {
            console.error('QR Scanner modal not found!');
            return;
        }

        console.log('Opening QR scanner...');
        qrScannerModal.classList.remove('hidden');
        qrScanStatus.textContent = 'Initializing camera...';
        qrScanStatus.className = 'text-sm text-center mt-4 text-gray-400';

        // Initialize and start scanner
        setTimeout(async () => {
            try {
                console.log('Checking Html5Qrcode availability:', typeof Html5Qrcode);

                // Check if Html5Qrcode is available
                if (typeof Html5Qrcode === 'undefined') {
                    throw new Error('Html5Qrcode library not loaded');
                }

                // Initialize QR scanner
                if (!html5QrCode) {
                    console.log('Creating new Html5Qrcode instance...');
                    html5QrCode = new Html5Qrcode("qr-reader");
                }

                console.log('Starting QR scanner...');
                // Start scanning
                await html5QrCode.start(
                    { facingMode: "environment" }, // Use back camera
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 250 }
                    },
                    onQRScanSuccess,
                    onQRScanError
                );

                console.log('QR Scanner started successfully');
                qrScanStatus.textContent = extraTranslations[currentLanguage]?.scanInstruction || 'Scan the QR code';
            } catch (err) {
                console.error('QR Scanner error:', err);
                let errorMsg = 'Error: ';
                if (err.name === 'NotAllowedError') {
                    errorMsg = 'Camera permission denied. Please allow camera access.';
                } else if (err.name === 'NotFoundError') {
                    errorMsg = 'No camera found on this device.';
                } else if (err.message && err.message.includes('library not loaded')) {
                    errorMsg = 'QR Scanner library not loaded. Please refresh the page.';
                } else {
                    errorMsg = 'Camera error: ' + (err.message || 'Unknown error');
                }
                qrScanStatus.textContent = errorMsg;
                qrScanStatus.className = 'text-sm text-center mt-4 text-red-500';
            }
        }, 300);
    }

    // Close QR scanner
    function closeQRScanner() {
        console.log('Closing QR scanner...');
        const qrScannerModal = document.getElementById('qr-scanner-modal');
        const qrScanStatus = document.getElementById('qr-scan-status');

        if (html5QrCode) {
            console.log('Stopping scanner... isScanning:', html5QrCode.isScanning);
            if (html5QrCode.isScanning) {
                html5QrCode.stop()
                    .then(() => console.log('Scanner stopped successfully'))
                    .catch(err => console.error('Error stopping scanner:', err));
            }
        }

        qrScannerModal?.classList.add('hidden');
        if (qrScanStatus) {
            qrScanStatus.textContent = '';
            qrScanStatus.className = 'text-sm text-center mt-4 text-gray-400';
        }
    }

    // QR Scan success handler
    async function onQRScanSuccess(decodedText) {
        console.log('QR Code scanned:', decodedText);
        const qrScanStatus = document.getElementById('qr-scan-status');

        try {
            let authData = null;
            // Case 1: URL with ?qr=
            if (typeof decodedText === 'string' && decodedText.includes('?qr=')) {
                const url = new URL(decodedText);
                const qrParam = url.searchParams.get('qr');
                if (!qrParam) throw new Error('QR param missing in URL');
                const decoded = atob(qrParam);
                authData = JSON.parse(decoded);
            } else {
                // Case 2: Base64-encoded JSON or raw JSON
                try {
                    // Try base64 -> JSON
                    const maybeDecoded = atob(decodedText);
                    authData = JSON.parse(maybeDecoded);
                } catch (_) {
                    // Try plain JSON
                    authData = JSON.parse(decodedText);
                }
            }
            console.log('Parsed QR token:', authData);
            if (!authData || !authData.uid || !authData.email || !authData.timestamp) {
                throw new Error('Invalid QR code format');
            }

            qrScanStatus.textContent = 'QR code found! Signing in...';
            qrScanStatus.className = 'text-sm text-center mt-4 text-green-500';

            // Stop scanning
            if (html5QrCode && html5QrCode.isScanning) {
                console.log('Stopping scanner after successful scan...');
                await html5QrCode.stop();
            }
            // Reuse same flow as URL handler
            await processQRAuthData(authData);
            // Close modal (approval modal will open next)
            closeQRScanner();

        } catch (err) {
            console.error('QR decode error:', err);
            qrScanStatus.textContent = 'Invalid QR code. Please try again.';
            qrScanStatus.className = 'text-sm text-center mt-4 text-red-500';
        }
    }

    // QR Scan error handler (ignore most errors)
    function onQRScanError(errorMessage) {
        // Ignore scanning errors, they're normal during scanning
    }

    // Get browser name helper
    function getBrowserName() {
        const ua = navigator.userAgent;
        if (ua.includes('Chrome')) return 'Chrome';
        if (ua.includes('Firefox')) return 'Firefox';
        if (ua.includes('Safari')) return 'Safari';
        if (ua.includes('Edge')) return 'Edge';
        return 'Unknown';
    }

    // Setup close button for QR scanner
    document.getElementById('close-qr-scanner')?.addEventListener('click', closeQRScanner);

    // Show create profile modal
    function showCreateProfileModal(isKids = false) {
        const profileName = prompt(
            translations[currentLanguage]?.enterProfileName || 'Enter profile name:',
            isKids ? (translations[currentLanguage]?.kidsProfileName || 'Kids') : ''
        );

        if (profileName && profileName.trim()) {
            const newProfile = createProfile(profileName.trim(), isKids);
            setActiveProfile(newProfile.id);
            showToast(translations[currentLanguage]?.profileCreated || 'Profile created!');

            // Refresh content if on main page
            if (currentHistoryState?.page === 'main') {
                const activeCategoryButton = document.querySelector('#category-nav .category-btn.active');
                const currentCategory = activeCategoryButton ? activeCategoryButton.dataset.categoryValue : 'categoryAll';
                filterAndDisplayMovies(currentCategory);
            }
        }
    }

    // Open the share subscription modal which lists existing promo codes and allows generating new ones
    function openShareSubscriptionModal() {
        const modal = document.getElementById('share-modal');
        if (!modal || !currentUser) return;
        const listEl = modal.querySelector('#promo-codes-list');
        listEl.innerHTML = '';
        let allCodes = [];
        try {
            allCodes = JSON.parse(localStorage.getItem('soundora-promo-codes')) || [];
        } catch (e) {
            allCodes = [];
        }
        const userId = currentUser?.uid;
        const codes = allCodes.filter(c => c.userId === userId);
        if (codes.length === 0) {
            listEl.innerHTML = `<p class="text-gray-400" data-lang-key="noPromoCodes"></p>`;
        } else {
            codes.forEach((codeObj) => {
                const row = document.createElement('div');
                row.className = 'flex items-center justify-between bg-gray-800/50 p-3 rounded-lg';
                // Code label
                const label = document.createElement('span');
                label.className = 'text-white font-mono';
                label.textContent = codeObj.code;
                // Status badge
                const status = document.createElement('span');
                status.className = 'text-xs px-2 py-1 rounded-full ' + (codeObj.used ? 'bg-gray-700 text-gray-300' : 'bg-green-700 text-green-200');
                status.setAttribute('data-lang-key', codeObj.used ? 'codeUsed' : 'codeUnused');
                // Copy button
                const copyBtn = document.createElement('button');
                copyBtn.className = 'ml-3 px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded';
                copyBtn.setAttribute('data-lang-key', 'copy');
                copyBtn.addEventListener('click', () => {
                    copyToClipboard(codeObj.code);
                    showToast(translations[currentLanguage]?.promoCodeCopied || 'Promo code copied!');
                });
                row.appendChild(label);
                row.appendChild(status);
                row.appendChild(copyBtn);
                listEl.appendChild(row);
            });
        }
        const limit = currentUser && currentUser.isPremium ? 4 : 2;
        const unusedExists = codes.some(c => !c.used);
        const generateBtn = modal.querySelector('#generate-promo-btn');
        // Hide generate button if user has reached limit and still has unused codes
        if (codes.length >= limit && unusedExists) {
            generateBtn.style.display = 'none';
        } else {
            generateBtn.style.display = 'block';
        }
        generateBtn.onclick = () => {
            let codesAll = [];
            try {
                codesAll = JSON.parse(localStorage.getItem('soundora-promo-codes')) || [];
            } catch (e) {
                codesAll = [];
            }
            const userCodes = codesAll.filter(c => c.userId === userId);
            const unused = userCodes.find(c => !c.used);
            // If there is an unused code, simply copy it and show a toast
            if (unused) {
                copyToClipboard(unused.code);
                showToast(`Promo code ${unused.code} copied to clipboard!`);
                openShareSubscriptionModal();
                return;
            }
            if (userCodes.length >= limit) {
                showToast('Promo code limit reached.', true);
                return;
            }
            // Generate a unique new code
            const generateCode = () => Math.random().toString(36).substring(2, 10).toUpperCase();
            let newCode;
            do {
                newCode = generateCode();
            } while (codesAll.some(c => c.code === newCode));
            const now = Date.now();
            const expiresAt = now + 7 * 24 * 60 * 60 * 1000;
            const newCodeObj = { code: newCode, userId, createdAt: now, expiresAt, used: false };
            codesAll.push(newCodeObj);
            localStorage.setItem('soundora-promo-codes', JSON.stringify(codesAll));
            copyToClipboard(newCode);
            showToast(`Promo code ${newCode} copied to clipboard!`);
            openShareSubscriptionModal();
        };
        modal.classList.remove('hidden');
    }

    // Setup event listeners for the share modal (close action)
    function setupShareModal() {
        const modal = document.getElementById('share-modal');
        const closeBtn = document.getElementById('share-modal-close');
        closeBtn?.addEventListener('click', () => {
            modal?.classList.add('hidden');
        });
    }

    /**
     * Initialize series controls (seasons, ranges, episodes) for a given movie ID.
     * This will dynamically populate three rows of buttons: season numbers,
     * episode ranges (e.g., "1-10"), and individual episode numbers. When a range
     * or season is selected, the corresponding episodes are displayed. Clicking
     * an episode button will trigger playback via handlePlayClick.
     * This UI is shown only on mobile (via CSS classes) and for series with episodes.
     *
     * @param {string|number} movieId The movie ID to initialize controls for.
     */
    function initializeSeriesControls(movieId) {
        const movie = movies.find(m => String(m.id) === String(movieId));
        if (!movie || !Array.isArray(movie.episodes) || movie.episodes.length === 0) return;
        const seasonRow = document.getElementById('season-row');
        const rangeRow = document.getElementById('range-row');
        const episodeRow = document.getElementById('episode-row');
        if (!seasonRow || !rangeRow || !episodeRow) return;
        // Clear any existing buttons
        seasonRow.innerHTML = '';
        rangeRow.innerHTML = '';
        episodeRow.innerHTML = '';
        const totalRanges = Math.ceil(movie.episodes.length / 10);
        // Populate season buttons (1,2,3,...)
        for (let i = 0; i < totalRanges; i++) {
            const btn = document.createElement('button');
            btn.className = 'season-btn px-3 py-2 rounded bg-gray-800 text-white hover:bg-red-600 transition-colors';
            btn.dataset.index = i;
            btn.textContent = String(i + 1);
            seasonRow.appendChild(btn);
        }
        // Populate range buttons (1-10,11-20,...)
        for (let i = 0; i < totalRanges; i++) {
            const start = i * 10 + 1;
            const end = Math.min((i + 1) * 10, movie.episodes.length);
            const btn = document.createElement('button');
            btn.className = 'range-btn px-3 py-2 rounded bg-gray-800 text-white hover:bg-red-600 transition-colors';
            btn.dataset.index = i;
            btn.textContent = `${start}-${end}`;
            rangeRow.appendChild(btn);
        }
        // Helper to render episodes for a selected range index
        function renderEpisodes(rangeIndex) {
            episodeRow.innerHTML = '';
            const startIdx = rangeIndex * 10;
            const endIdx = Math.min(startIdx + 10, movie.episodes.length);
            for (let i = startIdx; i < endIdx; i++) {
                const epBtn = document.createElement('button');
                epBtn.className = 'episode-btn flex-1 text-center px-3 py-2 rounded bg-gray-800 text-white hover:bg-red-600 transition-colors';
                epBtn.dataset.index = i;
                epBtn.textContent = String(i + 1);
                episodeRow.appendChild(epBtn);
            }
        }
        // Highlight the selected season and range buttons
        function highlightSelection(index) {
            seasonRow.querySelectorAll('.season-btn').forEach(btn => {
                const btnIdx = parseInt(btn.dataset.index);
                if (btnIdx === index) {
                    btn.classList.add('bg-red-600');
                    btn.classList.remove('bg-gray-800');
                } else {
                    btn.classList.remove('bg-red-600');
                    btn.classList.add('bg-gray-800');
                }
            });
            rangeRow.querySelectorAll('.range-btn').forEach(btn => {
                const btnIdx = parseInt(btn.dataset.index);
                if (btnIdx === index) {
                    btn.classList.add('bg-red-600');
                    btn.classList.remove('bg-gray-800');
                } else {
                    btn.classList.remove('bg-red-600');
                    btn.classList.add('bg-gray-800');
                }
            });
        }
        // Initial render of first range
        highlightSelection(0);
        renderEpisodes(0);
        // Event listeners for season and range row
        seasonRow.addEventListener('click', (e) => {
            const btn = e.target.closest('.season-btn');
            if (!btn) return;
            const idx = parseInt(btn.dataset.index);
            highlightSelection(idx);
            renderEpisodes(idx);
        });
        rangeRow.addEventListener('click', (e) => {
            const btn = e.target.closest('.range-btn');
            if (!btn) return;
            const idx = parseInt(btn.dataset.index);
            highlightSelection(idx);
            renderEpisodes(idx);
        });
        // Episode click: reuse handlePlayClick for playback
        episodeRow.addEventListener('click', (e) => {
            const btn = e.target.closest('.episode-btn');
            if (!btn) return;
            const epIndex = parseInt(btn.dataset.index);
            // Build a synthetic target to match handlePlayClick signature
            handlePlayClick({
                currentTarget: { dataset: { movieId: String(movieId), episodeIndex: epIndex } }
            });
        });
    }

    /**
     * Request a Google Cast session. If the Cast SDK is available, this will prompt
     * the user to choose a Cast-enabled device and start casting the current player.
     */
    function requestCastingSession() {
        try {
            if (window.cast && cast.framework) {
                const context = cast.framework.CastContext.getInstance();
                context.setOptions({ receiverApplicationId: window.SOUNDORA_CAST_APP_ID });
                context.requestSession().catch((error) => {
                    console.error('Cast session error', error);
                    showToast('РћС€РёР±РєР° РєР°СЃС‚РёРЅРіР°');
                });
            } else {
                showToast('Cast SDK РЅРµРґРѕСЃС‚СѓРїРµРЅ');
            }
        } catch (err) {
            console.error('Cast error', err);
            showToast('Cast SDK РЅРµРґРѕСЃС‚СѓРїРµРЅ');
        }
    }

    function initApp() {
        const savedLang = localStorage.getItem('soundora-lang') || 'ru';

        // Add missing translations to extraTranslations
        extraTranslations.ru = extraTranslations.ru || {};
        extraTranslations.ru.loginWithGoogle = "Войти через Google";
        extraTranslations.ru.qrLogin = "Войти через QR код";
        extraTranslations.ru.scanQR = "Сканируйте QR код";
        extraTranslations.ru.scanInstruction = "Отсканируйте QR код на вашем устройстве для входа";

        setLanguage(savedLang);
        // Initialize rating, account switch and share subscription modals
        setupRatingModal();
        setupAccountSwitchModal();
        setupShareModal();

        // Til filtri tugmasini va dropdownni dastlabki holatga o'rnatamiz.
        initLanguageFilter();

        initFirebaseAndLoadContent();

        // Check for QR auth token in URL
        handleQRAuthFromURL();

        // Listen for auth state changes and update bottom nav in real-time
        if (window.auth) {
            onAuthStateChanged(auth, (user) => {
                console.log('Auth state changed in initApp:', user?.displayName);
                // Wait a bit for currentUser to be updated by main listener
                setTimeout(() => {
                    if (typeof updateBottomNavProfile === 'function') {
                        updateBottomNavProfile();
                    }
                }, 500);
            });
        }

        document.getElementById('home-link-header').addEventListener('click', (e) => { e.preventDefault(); navigate({ page: 'main' }); });
        document.getElementById('notification-button-header').addEventListener('click', toggleNotificationPanel);

        // Monitor localStorage for QR auth requests (for main device)
        startQRAuthMonitor();

        // Long press funksiyasi uchun o'zgaruvchilar
        let longPressTimer = null;
        let longPressTriggered = false;
        const LONG_PRESS_DURATION = 500; // 500ms = 0.5 sekund

        // Profile menu modal funksiyalari

        // Helper function: Get user data from currentUser global variable
        function getCurrentUserData() {
            // Use currentUser global variable if available
            if (window.currentUser && window.currentUser.uid) {
                const displayName = currentUser.displayName || currentUser.email?.split('@')[0] || 'User';
                const isPremium = currentUser.isPremium || false;
                const avatarLetter = displayName.charAt(0).toUpperCase();

                return {
                    uid: currentUser.uid,
                    username: displayName,
                    isPremium: isPremium,
                    avatar: avatarLetter,
                    photoURL: currentUser.photoURL || null
                };
            }

            // Fallback to localStorage if currentUser not available yet
            const username = localStorage.getItem('soundora-username') || 'Guest';
            const isPremium = localStorage.getItem('soundora-premium') === 'true';
            const avatarLetter = username.charAt(0).toUpperCase();

            return {
                uid: null,
                username: username,
                isPremium: isPremium,
                avatar: avatarLetter,
                photoURL: null
            };
        }

        // Generate random gradient color based on username
        function getAvatarGradient(colorName) {
            const gradientMap = {
                'gradient-purple': 'from-purple-500 to-indigo-600',
                'gradient-pink': 'from-pink-500 to-rose-600',
                'gradient-blue': 'from-blue-500 to-cyan-600',
                'gradient-green': 'from-green-500 to-teal-600',
                'gradient-yellow': 'from-yellow-500 to-orange-600',
                'gradient-cyan': 'from-cyan-500 to-blue-600',
                'gradient-aqua': 'from-teal-500 to-green-600',
                'gradient-rose': 'from-rose-500 to-pink-600'
            };

            return gradientMap[colorName] || 'from-blue-500 to-purple-600';
        }

        // Get real logged-in accounts from localStorage (same as Account Switch modal)
        function getSavedAccounts() {
            try {
                const accounts = JSON.parse(localStorage.getItem('soundora-accounts')) || [];
                return accounts.filter(acc => acc && acc.uid); // Filter out invalid entries
            } catch (e) {
                console.error('Error reading soundora-accounts:', e);
                return [];
            }
        }

        // Get current account ID from localStorage
        function getCurrentAccountId() {
            return localStorage.getItem('soundora-lastUid') || null;
        }

        // Get all saved accounts from localStorage (real accounts only)
        let savedAccounts = getSavedAccounts();
        let currentAccountId = getCurrentAccountId();

        console.log('Initial savedAccounts:', savedAccounts);
        console.log('Initial currentAccountId:', currentAccountId);

        function renderAccountsList() {
            // Refresh accounts from localStorage
            savedAccounts = getSavedAccounts();
            currentAccountId = getCurrentAccountId();

            const accountsList = document.getElementById('accounts-list');
            const currentAccount = savedAccounts.find(acc => acc.uid === currentAccountId);
            const otherAccounts = savedAccounts.filter(acc => acc.uid !== currentAccountId);

            // Debug log
            console.log('=== renderAccountsList ===');
            console.log('savedAccounts:', savedAccounts);
            console.log('currentAccountId:', currentAccountId);
            console.log('currentAccount:', currentAccount);
            console.log('otherAccounts:', otherAccounts);

            if (!accountsList) {
                console.error('accounts-list element not found!');
                return;
            }

            // Get current account display name
            const currentDisplayName = currentAccount?.displayName || window.currentUser?.displayName || 'User';
            const currentAvatar = currentDisplayName.charAt(0).toUpperCase();
            const currentGradient = getAvatarGradient(currentAccount?.avatarColor || 'gradient-blue');

            // Update header with current account
            const headerUsername = document.querySelector('#profile-menu-content h3');
            if (headerUsername) {
                headerUsername.textContent = currentDisplayName;
            }

            // Update current account display
            const activeAccountDiv = document.querySelector('#profile-menu-content .border-b.border-gray-700:nth-child(3)');
            console.log('activeAccountDiv:', activeAccountDiv);

            if (activeAccountDiv) {
                activeAccountDiv.innerHTML = `
                    <div class="flex items-center gap-3 cursor-pointer hover:bg-gray-800/30 rounded-lg transition-colors p-2 -m-2">
                        <div class="w-14 h-14 rounded-full bg-gradient-to-br ${currentGradient} flex items-center justify-center flex-shrink-0">
                            <span class="text-white text-xl font-bold">${currentAvatar}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <span class="text-white font-semibold text-base">${currentDisplayName}</span>
                                <i class="fas fa-check-circle text-blue-500 text-sm"></i>
                            </div>
                            <span class="text-gray-400 text-sm">Active now</span>
                        </div>
                    </div>
                `;

                // Add click event to close modal when clicking current account
                const currentAccountContainer = activeAccountDiv.querySelector('div');
                if (currentAccountContainer) {
                    currentAccountContainer.addEventListener('click', () => {
                        console.log('Clicked on current account - closing modal');
                        hideProfileMenu();
                    });
                }
            }

            // Clear and render other accounts
            accountsList.innerHTML = '';

            console.log('Rendering other accounts:', otherAccounts.length);

            otherAccounts.forEach((account, index) => {
                console.log(`Rendering account ${index}:`, account);
                const displayName = account.displayName || account.email?.split('@')[0] || 'User';
                const avatar = displayName.charAt(0).toUpperCase();
                const gradient = getAvatarGradient(account.avatarColor || 'gradient-blue');
                const accountItem = document.createElement('div');
                accountItem.className = 'px-4 py-3 border-b border-gray-700 cursor-pointer hover:bg-gray-800/50 transition-colors';
                accountItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-14 h-14 rounded-full bg-gradient-to-br ${gradient} flex items-center justify-center flex-shrink-0">
                            <span class="text-white text-xl font-bold">${avatar}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <span class="text-white font-semibold text-base">${displayName}</span>
                        </div>
                    </div>
                `;

                accountItem.addEventListener('click', () => {
                    console.log('Switching to account:', account);
                    switchAccount(account.uid);
                });

                accountsList.appendChild(accountItem);
            });

            console.log('Accounts rendered. List children:', accountsList.children.length);
        }

        function switchAccount(uid) {
            const account = savedAccounts.find(acc => acc.uid === uid);
            if (!account) {
                console.error('Account not found:', uid);
                return;
            }

            console.log('Switching account to:', account);

            // Hide modal first
            hideProfileMenu();

            // Check if it's the same account
            if (window.currentUser?.uid === uid) {
                console.log('Already on this account');
                return;
            }

            // Vibration feedback
            navigator.vibrate && navigator.vibrate(30);

            // Show loading toast
            showToast(`Switching to ${account.displayName || account.email}...`);

            // Use the existing switchToStoredAccount function
            if (typeof switchToStoredAccount === 'function') {
                switchToStoredAccount(account, null).then(() => {
                    console.log('Account switched successfully');

                    // onAuthStateChanged will automatically trigger and update UI
                    // No need to manually update - just wait for auth state change

                    // Navigate to main page to show fresh content
                    setTimeout(() => {
                        navigate({ page: 'main' });
                    }, 500);
                }).catch(err => {
                    console.error('Failed to switch account:', err);
                    showToast('Failed to switch account. Please try again.', true);
                });
            } else {
                // Fallback: direct Firebase sign in
                if (account.email && account.password && window.auth) {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    loadingOverlay?.classList.remove('hidden');

                    signOut(auth).then(() => {
                        return signInWithEmailAndPassword(auth, account.email, account.password);
                    }).then(() => {
                        showToast(`Switched to ${account.displayName || account.email}`);
                        loadingOverlay?.classList.add('hidden');
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    }).catch(err => {
                        console.error('Error switching account:', err);
                        loadingOverlay?.classList.add('hidden');
                        showToast('Failed to switch account. Please try again.', true);
                    });
                } else {
                    showToast('Account credentials not found. Please log in again.', true);
                    navigate({ page: 'login' });
                }
            }
        }

        function showProfileMenu() {
            const modal = document.getElementById('profile-menu-modal');
            const content = document.getElementById('profile-menu-content');
            renderAccountsList();
            modal.classList.remove('hidden');

            // Add history state for back button support
            history.pushState({ modal: 'profile-menu' }, '');

            setTimeout(() => {
                content.style.transform = 'translateY(0)';
            }, 10);

            // Add swipe down to close functionality
            let startY = 0;
            let currentY = 0;
            let isDragging = false;

            const handlebar = content.querySelector('.pt-3');

            const handleTouchStart = (e) => {
                startY = e.touches[0].clientY;
                isDragging = true;
            };

            const handleTouchMove = (e) => {
                if (!isDragging) return;
                currentY = e.touches[0].clientY;
                const diff = currentY - startY;

                if (diff > 0) {
                    content.style.transform = `translateY(${diff}px)`;
                }
            };

            const handleTouchEnd = () => {
                if (!isDragging) return;
                isDragging = false;

                const diff = currentY - startY;

                if (diff > 100) {
                    // Close if dragged down more than 100px
                    hideProfileMenu();
                } else {
                    // Snap back
                    content.style.transform = 'translateY(0)';
                }
            };

            handlebar.addEventListener('touchstart', handleTouchStart, { passive: true });
            handlebar.addEventListener('touchmove', handleTouchMove, { passive: true });
            handlebar.addEventListener('touchend', handleTouchEnd, { passive: true });
        }

        function hideProfileMenu() {
            const modal = document.getElementById('profile-menu-modal');
            const content = document.getElementById('profile-menu-content');
            content.style.transform = 'translateY(100%)';

            // Remove history state if it was added
            if (history.state?.modal === 'profile-menu') {
                history.back();
            }

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // Profile menu modal eventlari
        document.getElementById('close-profile-menu-btn').addEventListener('click', hideProfileMenu);

        const profileMenuModal = document.getElementById('profile-menu-modal');

        // Click event for desktop
        profileMenuModal.addEventListener('click', (e) => {
            if (e.target.id === 'profile-menu-modal') {
                console.log('Modal backdrop clicked');
                hideProfileMenu();
            }
        });

        // Touch event for mobile (more reliable)
        profileMenuModal.addEventListener('touchend', (e) => {
            if (e.target.id === 'profile-menu-modal') {
                console.log('Modal backdrop touched');
                e.preventDefault();
                hideProfileMenu();
            }
        }, { passive: false });

        document.getElementById('add-account-btn').addEventListener('click', () => {
            hideProfileMenu();
            navigate({ page: 'login' });
        });

        // Bottom navigation links
        const homeLink = document.getElementById('home-link-bottom');
        const favoritesLink = document.getElementById('favorites-link-bottom');
        const supportLink = document.getElementById('support-link-bottom');

        // Home, Favorites, Support uchun oddiy click - long press yo'q
        homeLink.addEventListener('click', (e) => { e.preventDefault(); navigate({ page: 'main' }); });
        favoritesLink.addEventListener('click', (e) => { e.preventDefault(); navigate({ page: 'favorites' }); });
        supportLink.addEventListener('click', (e) => { e.preventDefault(); navigate({ page: 'support' }); });

        // Barcha bottom nav links uchun context menu ni o'chirish
        [homeLink, favoritesLink, supportLink].forEach(link => {
            link.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                e.stopPropagation();
                return false;
            });
        });

        // Profile link with long press support
        const profileLink = document.getElementById('profile-link-bottom');
        let touchMoved = false;

        // Context menu ni to'xtatish (Google Chrome long press menu)
        profileLink.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            e.stopPropagation();
            return false;
        });

        // Touch events uchun (mobile)
        profileLink.addEventListener('touchstart', (e) => {
            touchMoved = false;
            longPressTriggered = false;
            longPressTimer = setTimeout(() => {
                if (!touchMoved) {
                    longPressTriggered = true;
                    navigator.vibrate && navigator.vibrate(50); // Haptic feedback
                    showProfileMenu();
                }
            }, LONG_PRESS_DURATION);
        }, { passive: true });

        profileLink.addEventListener('touchmove', (e) => {
            touchMoved = true;
            clearTimeout(longPressTimer);
        }, { passive: true });

        profileLink.addEventListener('touchend', (e) => {
            clearTimeout(longPressTimer);
            if (!touchMoved && !longPressTriggered) {
                e.preventDefault();
                e.stopPropagation();
                // Oddiy click - profil sahifasiga o'tish
                navigate({ page: 'profile' });
            } else if (longPressTriggered) {
                e.preventDefault();
                e.stopPropagation();
            }
        });

        profileLink.addEventListener('touchcancel', () => {
            clearTimeout(longPressTimer);
            longPressTriggered = false;
        });

        // Click eventni to'xtatish (touch eventlar bilan conflict qilmasligi uchun)
        profileLink.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
        });

        // Mouse events uchun (desktop)
        profileLink.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return; // Faqat left click
            longPressTriggered = false;
            longPressTimer = setTimeout(() => {
                longPressTriggered = true;
                showProfileMenu();
            }, LONG_PRESS_DURATION);
        });

        profileLink.addEventListener('mouseup', (e) => {
            clearTimeout(longPressTimer);
            if (!longPressTriggered && e.button === 0) {
                e.preventDefault();
                e.stopPropagation();
                // Oddiy click - profil sahifasiga o'tish
                navigate({ page: 'profile' });
            }
        });

        profileLink.addEventListener('mouseleave', () => {
            clearTimeout(longPressTimer);
        });

        // Load current account data on page load - Sync with updateBottomNavProfile
        function loadCurrentAccountUI() {
            // This function will be called after accounts are initialized
            // Just call the existing updateBottomNavProfile function
            if (typeof updateBottomNavProfile === 'function') {
                updateBottomNavProfile();
            }
        }

        // Execute on page load - delay to ensure currentUser is loaded
        setTimeout(() => {
            loadCurrentAccountUI();
        }, 500);
        // Only attach search modal handler if the search button exists (some layouts remove it)
        const searchBtnNav = document.getElementById('search-button-bottom-nav');
        if (searchBtnNav) {
            searchBtnNav.addEventListener('click', showSearchModal);
        }

        window.addEventListener('popstate', (e) => {
            // Check if profile menu modal is open
            const profileMenuModal = document.getElementById('profile-menu-modal');
            if (profileMenuModal && !profileMenuModal.classList.contains('hidden')) {
                e.preventDefault();
                hideProfileMenu();
                history.pushState(currentHistoryState, '', `#${currentHistoryState.page}`);
                return;
            }

            if (!modalOverlay.classList.contains('hidden')) {
                closeModal();
                history.pushState(currentHistoryState, '', `#${currentHistoryState.page}`);
                return;
            }

            const currentPage = currentHistoryState?.page;

            if (currentPage === 'main') {
                if (navigator.app && navigator.app.exitApp) {
                    navigator.app.exitApp();
                }
                return;
            }

            const topLevelSections = ['favorites', 'profile', 'guest-profile', 'premium'];
            if (topLevelSections.includes(currentPage)) {
                e.preventDefault();
                navigate({ page: 'main' });
                return;
            }

            const newState = e.state || { page: 'main' };
            processNavigation(newState, false);
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && activeVideoElement && !activeVideoElement.paused && document.pictureInPictureEnabled && !activeVideoElement.disablePictureInPicture) {
                activeVideoElement.requestPictureInPicture().catch(error => {
                    console.error('PiP Error:', error);
                });
            }
        });

        // Disable context menu globally for all links and images
        document.addEventListener('contextmenu', (e) => {
            // Allow context menu only for input fields and textareas
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return true;
            }

            // Prevent context menu for everything else
            e.preventDefault();
            e.stopPropagation();
            return false;
        }, false);

        // Prevent long press context menu on touch devices
        document.addEventListener('touchstart', (e) => {
            if (e.target.tagName === 'A' || e.target.tagName === 'IMG') {
                // Prevent default for links and images only
                // This prevents the context menu on long press
            }
        }, { passive: true });
    }

    try {
        window.navigate = navigate;
        window.processNavigation = processNavigation;
        window.checkRegionRestriction = checkRegionRestriction;
    } catch (_) {}
    initApp();
});
</script>

<!-- Custom premium kassa logic -->
<script>
    /**
     * Premium purchase modal functionality adapted from the standalone kassa page.
     * Only Russia (ru) and Central Asia (ca) regions are supported.
     */
    (function() {
      // Define region and payment configurations
      const kassaRegions = {
        // Russia uses rubles as the base and has a rate of 1
        ru: {
          name: 'Russia',
          currency: 'в‚Ѕ',
          rate: 1,
          paymentMethods: ['SBP', 'Card']
        },
        // Approximate conversion rates for Central Asian currencies based on 2025 averages
        kz: {
          name: 'Kazakhstan',
          currency: 'в‚ё',
          rate: 6,
          paymentMethods: ['Card']
        },
        uz: {
          name: 'Uzbekistan',
          currency: 'UZS ',
          rate: 150,
          paymentMethods: ['Card']
        },
        kg: {
          name: 'Kyrgyzstan',
          currency: 'KGS ',
          rate: 1,
          paymentMethods: ['Card']
        },
        tj: {
          name: 'Tajikistan',
          currency: 'TJS ',
          rate: 0.11,
          paymentMethods: ['Card']
        },
        tm: {
          name: 'Turkmenistan',
          currency: 'TMT ',
          rate: 0.04,
          paymentMethods: ['Card']
        }
      };
      let kassaCurrentRegion = 'ru';
      async function kassaDetectRegion() {
        const saved = localStorage.getItem('soundora-region');
        if (saved && kassaRegions[saved]) {
          return saved;
        }
        try {
          const response = await fetch('https://ipapi.co/json/');
          if (!response.ok) throw new Error('IP API request failed');
          const data = await response.json();
          // Attempt to use the ISO country code returned by the API. Lowercase it for our keys.
          let code = data && data.country_code ? data.country_code.toLowerCase() : 'ru';
          // If we don't have a configuration for this country, default to Russia.
          if (!kassaRegions[code]) {
            code = 'ru';
          }
          localStorage.setItem('soundora-region', code);
          return code;
        } catch (err) {
          console.warn('Region auto-detection failed:', err);
        }
        localStorage.setItem('soundora-region', 'ru');
        return 'ru';
      }
      function kassaPopulateRegionSelect() {
        const select = document.getElementById('kassa-region-select');
        if (!select) return;
        select.innerHTML = '';
        Object.keys(kassaRegions).forEach(code => {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = kassaRegions[code].name;
          select.appendChild(option);
        });
        select.value = kassaCurrentRegion;
        select.addEventListener('change', () => {
          kassaCurrentRegion = select.value;
          try {
            localStorage.setItem('soundora-region', kassaCurrentRegion);
          } catch (err) {
            console.warn('Unable to save region preference:', err);
          }
          kassaUpdatePlanDetails();
          kassaUpdatePaymentMethods();
        });
      }
      function kassaUpdatePlanDetails() {
        const regionData = kassaRegions[kassaCurrentRegion];
        // Determine the base price in rubles. currentKassaTotalPrice represents the price for the selected plan in rubles.
        const baseRubPrice = window.currentKassaTotalPrice ? Number(window.currentKassaTotalPrice) : 299;
        // Convert the price into the selected region's currency using its conversion rate. Round to avoid long decimals.
        const convertedPrice = Math.round(baseRubPrice * (regionData.rate || 1));
        const months = window.currentKassaPlanMonths || 1;
        const planNameEl = document.getElementById('kassa-plan-name');
        const durationEl = document.getElementById('kassa-plan-duration');
        const priceEl = document.getElementById('kassa-plan-price');
        if (planNameEl) planNameEl.textContent = 'Premium Plan';
        if (durationEl) durationEl.textContent = 'Duration: ' + months + ' month' + (Number(months) > 1 ? 's' : '');
        if (priceEl) priceEl.textContent = regionData.currency + convertedPrice;
        const summaryPriceEl = document.getElementById('kassa-summary-price');
        if (summaryPriceEl) summaryPriceEl.textContent = regionData.currency + convertedPrice;
      }
      function kassaUpdatePaymentMethods() {
        const select = document.getElementById('kassa-payment-method');
        if (!select) return;
        select.innerHTML = '';
        kassaRegions[kassaCurrentRegion].paymentMethods.forEach(method => {
          const option = document.createElement('option');
          option.value = method;
          option.textContent = method === 'SBP' ? 'РЎР‘Рџ' : method;
          select.appendChild(option);
        });
      }
      function kassaComputeExpirationDate() {
        const months = window.currentKassaPlanMonths || 1;
        const now = new Date();
        const expiration = new Date(now.getFullYear(), now.getMonth() + Number(months), now.getDate());
        return expiration.toLocaleDateString();
      }

      // Translations for the premium kassa modal.
      // Contains localized strings for English (en), Russian (ru) and Uzbek (uz).
      const kassaTranslations = {
        en: {
          planDetails: "Plan Details",
          email: "Email",
          subscriptionPlan: "Subscription Plan",
          duration: "Duration",
          selectPaymentMethod: "Select payment method",
          region: "Region:",
          continue: "Continue",
          back: "Back",
          orderSummary: "Order Summary",
          plan: "Plan",
          regionLabel: "Region",
          price: "Price",
          expires: "Expires",
          paymentDetails: "Payment Details",
          nameOnCard: "Name on card",
          cardNumber: "Card Number",
          expiryDate: "Expiry Date",
          cvc: "CVC",
          payerName: "Payer Name",
          uzcardNumber: "Uzcard/Humo Number",
          purchaseConfirmed: "Purchase Confirmed!",
          purchaseActivated: "Your premium subscription has been activated!",
          confirmPurchase: "Confirm Purchase",
          close: "Close"
        },
        ru: {
          planDetails: "Р”РµС‚Р°Р»Рё РїР»Р°РЅР°",
          email: "Р­Р». РїРѕС‡С‚Р°",
          subscriptionPlan: "РџР»Р°РЅ РїРѕРґРїРёСЃРєРё",
          duration: "Р”Р»РёС‚РµР»СЊРЅРѕСЃС‚СЊ",
          selectPaymentMethod: "Р’С‹Р±РµСЂРёС‚Рµ СЃРїРѕСЃРѕР± РѕРїР»Р°С‚С‹",
          region: "Р РµРіРёРѕРЅ:",
          continue: "РџСЂРѕРґРѕР»Р¶РёС‚СЊ",
          back: "РќР°Р·Р°Рґ",
          orderSummary: "РЎРІРѕРґРєР° Р·Р°РєР°Р·Р°",
          plan: "РџР»Р°РЅ",
          regionLabel: "Р РµРіРёРѕРЅ",
          price: "Р¦РµРЅР°",
          expires: "Р”РµР№СЃС‚РІРёС‚РµР»СЊРЅРѕ РґРѕ",
          paymentDetails: "РџР»Р°С‚РµР¶РЅР°СЏ РёРЅС„РѕСЂРјР°С†РёСЏ",
          nameOnCard: "РРјСЏ РЅР° РєР°СЂС‚Рµ",
          cardNumber: "РќРѕРјРµСЂ РєР°СЂС‚С‹",
          expiryDate: "РЎСЂРѕРє РґРµР№СЃС‚РІРёСЏ",
          cvc: "CVC",
          payerName: "РРјСЏ РїР»Р°С‚РµР»СЊС‰РёРєР°",
          uzcardNumber: "РќРѕРјРµСЂ Uzcard/Humo",
          purchaseConfirmed: "РџРѕРєСѓРїРєР° РїРѕРґС‚РІРµСЂР¶РґРµРЅР°!",
          purchaseActivated: "Р’Р°С€Р° РїСЂРµРјРёСѓРј РїРѕРґРїРёСЃРєР° Р°РєС‚РёРІРёСЂРѕРІР°РЅР°!",
          confirmPurchase: "РџРѕРґС‚РІРµСЂРґРёС‚СЊ РїРѕРєСѓРїРєСѓ",
          close: "Р—Р°РєСЂС‹С‚СЊ"
        },
        uz: {
          planDetails: "Reja tafsilotlari",
          email: "Elektron pochta",
          subscriptionPlan: "Obuna rejasi",
          duration: "Davomiyligi",
          selectPaymentMethod: "To'lov usulini tanlang",
          region: "Hudud:",
          continue: "Davom etish",
          back: "Orqaga",
          orderSummary: "Buyurtma tafsilotlari",
          plan: "Reja",
          regionLabel: "Hudud",
          price: "Narxi",
          expires: "Muddati tugaydi",
          paymentDetails: "To'lov tafsilotlari",
          nameOnCard: "Karta egasi nomi",
          cardNumber: "Karta raqami",
          expiryDate: "Amal qilish muddati",
          cvc: "CVC",
          payerName: "To'lovchi nomi",
          uzcardNumber: "Uzcard/Humo raqami",
          purchaseConfirmed: "Xarid tasdiqlandi!",
          purchaseActivated: "Premium obunangiz faollashtirildi!",
          confirmPurchase: "Xaridni tasdiqlash",
          close: "Yopish"
        }
      };

      /**
       * Apply translations to the kassa modal based on the current interface language.
       */
      function kassaApplyTranslations() {
        let lang = typeof currentLanguage !== 'undefined' ? currentLanguage : 'ru';
        if (!['en', 'ru', 'uz'].includes(lang)) lang = 'ru';
        const t = kassaTranslations[lang] || kassaTranslations['en'];
        // Step1 elements
        const step1Title = document.getElementById('kassa-step1-title');
        if (step1Title) step1Title.textContent = t.planDetails;
        const emailLabel = document.getElementById('kassa-email-label');
        if (emailLabel) emailLabel.textContent = t.email;
        const planHeading = document.getElementById('kassa-plan-heading');
        if (planHeading) planHeading.textContent = t.subscriptionPlan;
        const durationEl = document.getElementById('kassa-plan-duration');
        if (durationEl) {
          const months = window.currentKassaPlanMonths || 1;
          durationEl.textContent = t.duration + ': ' + months + ' month' + (Number(months) > 1 ? 's' : '');
        }
        const paymentMethodLabel = document.getElementById('kassa-payment-method-label');
        if (paymentMethodLabel) paymentMethodLabel.textContent = t.selectPaymentMethod;
        const regionLabelEl = document.getElementById('kassa-region-label');
        if (regionLabelEl) regionLabelEl.textContent = t.region;
        const continueBtn = document.getElementById('kassa-continue-btn');
        if (continueBtn) continueBtn.textContent = t.continue;
        // Step2 headings and labels
        const step2 = document.getElementById('kassa-step2');
        if (step2) {
          const h2s = step2.querySelectorAll('h2');
          if (h2s[0]) h2s[0].textContent = t.orderSummary;
          if (h2s[1]) h2s[1].textContent = t.paymentDetails;
          const summaryContainer = step2.querySelector('.md\\:w-1\\/2');
          if (summaryContainer) {
            const labelSpans = summaryContainer.querySelectorAll('p span.font-semibold');
            if (labelSpans.length >= 5) {
              labelSpans[0].textContent = t.plan + ':';
              labelSpans[1].textContent = t.duration + ':';
              labelSpans[2].textContent = t.regionLabel + ':';
              labelSpans[3].textContent = t.price + ':';
              labelSpans[4].textContent = t.expires + ':';
            }
          }
        }
        // Payment form labels
        const cardRU = document.getElementById('kassa-payment-form-card-ru');
        if (cardRU) {
          const labels = cardRU.querySelectorAll('label');
          if (labels[0]) labels[0].textContent = t.nameOnCard;
          if (labels[1]) labels[1].textContent = t.cardNumber;
          if (labels[2]) labels[2].textContent = t.expiryDate;
          if (labels[3]) labels[3].textContent = t.cvc;
        }
        const cardCA = document.getElementById('kassa-payment-form-card-ca');
        if (cardCA) {
          const labelsCA = cardCA.querySelectorAll('label');
          if (labelsCA[0]) labelsCA[0].textContent = t.payerName;
          if (labelsCA[1]) labelsCA[1].textContent = t.uzcardNumber;
          if (labelsCA[2]) labelsCA[2].textContent = t.expiryDate;
        }
        const confirmBtn = document.getElementById('kassa-confirm-btn');
        if (confirmBtn) confirmBtn.textContent = t.confirmPurchase;
        const backLink = document.getElementById('kassa-back-link');
        if (backLink) backLink.innerHTML = '← ' + t.back;
        // Step3 success messages
        const step3 = document.getElementById('kassa-step3');
        if (step3) {
          const titleEl = step3.querySelector('h1');
          const msgEl = step3.querySelector('p');
          if (titleEl) titleEl.textContent = t.purchaseConfirmed;
          if (msgEl) msgEl.textContent = t.purchaseActivated;
          const closeBtn = document.getElementById('kassa-success-close');
          if (closeBtn) {
            if (typeof translations !== 'undefined' && translations[currentLanguage] && translations[currentLanguage].close) {
              closeBtn.textContent = translations[currentLanguage].close;
            } else {
              closeBtn.textContent = t.close;
            }
          }
        }
      }
      function kassaShowPaymentForm(method) {
        const cardRU = document.getElementById('kassa-payment-form-card-ru');
        const cardCA = document.getElementById('kassa-payment-form-card-ca');
        const sbp = document.getElementById('kassa-payment-form-sbp');
        if (cardRU) cardRU.classList.add('hidden');
        if (cardCA) cardCA.classList.add('hidden');
        if (sbp) sbp.classList.add('hidden');
        if (method === 'Card') {
          if (kassaCurrentRegion === 'ru' && cardRU) {
            cardRU.classList.remove('hidden');
          } else if (kassaCurrentRegion !== 'ru' && cardCA) {
            // For all non-Russian regions use the Central Asia card form
            cardCA.classList.remove('hidden');
          }
        } else if (method === 'SBP' && sbp) {
          sbp.classList.remove('hidden');
        }
      }
      function kassaInitEventListeners() {
        if (window.__kassaListenersInitialized) return;
        window.__kassaListenersInitialized = true;
        const continueBtn = document.getElementById('kassa-continue-btn');
        if (continueBtn) {
          continueBtn.addEventListener('click', () => {
            const emailVal = document.getElementById('kassa-email')?.value.trim() || '';
            const planName = 'Premium Plan';
            const months = window.currentKassaPlanMonths || 1;
            const regionData = kassaRegions[kassaCurrentRegion];
            // Convert the total price (rubles) to the selected region's currency
            const baseRub = window.currentKassaTotalPrice ? Number(window.currentKassaTotalPrice) : 299;
            const converted = Math.round(baseRub * (regionData.rate || 1));
            document.getElementById('kassa-summary-plan-name').textContent = planName;
            document.getElementById('kassa-summary-plan-duration').textContent = months + ' month' + (Number(months) > 1 ? 's' : '');
            document.getElementById('kassa-summary-region').textContent = regionData.name;
            document.getElementById('kassa-summary-price').textContent = regionData.currency + converted;
            document.getElementById('kassa-summary-expiration').textContent = kassaComputeExpirationDate();
            const selectedMethod = document.getElementById('kassa-payment-method').value;
            kassaShowPaymentForm(selectedMethod);
            document.getElementById('kassa-step1').classList.add('hidden');
            document.getElementById('kassa-step2').classList.remove('hidden');
          });
        }
        const paymentSelect = document.getElementById('kassa-payment-method');
        if (paymentSelect) {
          paymentSelect.addEventListener('change', () => {
            kassaShowPaymentForm(paymentSelect.value);
          });
        }
        const backLink = document.getElementById('kassa-back-link');
        if (backLink) {
          backLink.addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('kassa-step2').classList.add('hidden');
            document.getElementById('kassa-step1').classList.remove('hidden');
          });
        }
        const confirmBtn = document.getElementById('kassa-confirm-btn');
        if (confirmBtn) {
          confirmBtn.addEventListener('click', () => {
            const s1 = document.getElementById('kassa-step1');
            const s2 = document.getElementById('kassa-step2');
            const s3 = document.getElementById('kassa-step3');
            if (s1) s1.classList.add('hidden');
            if (s2) s2.classList.add('hidden');
            if (s3) s3.classList.remove('hidden');
          });
        }
      }
      window.showPremiumKassa = async function() {
        kassaCurrentRegion = await kassaDetectRegion();
        kassaPopulateRegionSelect();
        kassaUpdatePlanDetails();
        kassaUpdatePaymentMethods();
        const emailInput = document.getElementById('kassa-email');
        if (emailInput) emailInput.value = '';
        kassaShowPaymentForm(document.getElementById('kassa-payment-method')?.value || 'Card');
        const s1 = document.getElementById('kassa-step1');
        const s2 = document.getElementById('kassa-step2');
        const s3 = document.getElementById('kassa-step3');
        if (s1) s1.classList.remove('hidden');
        if (s2) s2.classList.add('hidden');
        if (s3) s3.classList.add('hidden');
        kassaInitEventListeners();
        // Apply translations to the kassa modal based on current language
        if (typeof kassaApplyTranslations === 'function') {
          kassaApplyTranslations();
        }
      };
    })();
</script>

<!-- Script to handle offline/online status and restore last state -->
<script>
    // Functions to show and hide offline/online banners
    function showOfflineBanner() {
        const banner = document.getElementById('offline-banner');
        if (banner) banner.classList.remove('hidden');
    }
    function hideOfflineBanner() {
        const banner = document.getElementById('offline-banner');
        if (banner) banner.classList.add('hidden');
    }
    function showOnlineBanner() {
        const banner = document.getElementById('online-banner');
        if (banner) banner.classList.remove('hidden');
    }
    function hideOnlineBanner() {
        const banner = document.getElementById('online-banner');
        if (banner) banner.classList.add('hidden');
    }

    // Event listeners for network status
    window.addEventListener('offline', () => {
        showOfflineBanner();
    });
    window.addEventListener('online', () => {
        showOnlineBanner();
    });

    document.addEventListener('DOMContentLoaded', async () => {
        // Setup OK buttons for banners
        const offBtn = document.getElementById('offline-ok-btn');
        const onBtn  = document.getElementById('online-ok-btn');
        offBtn?.addEventListener('click', () => {
            hideOfflineBanner();
        });
        onBtn?.addEventListener('click', () => {
            hideOnlineBanner();
        });
        // Restore last navigation state if offline
        if (!navigator.onLine) {
            try {
                const lastStateRaw = localStorage.getItem('soundora-lastState');
                if (lastStateRaw) {
                    const lastState = JSON.parse(lastStateRaw);
                    if (lastState && lastState.page) {
                        processNavigation(lastState, false);
                    }
                }
            } catch (err) {
                console.error('Error restoring last state:', err);
            }
            showOfflineBanner();
        }
    });
</script>
<!-- Rating Modal -->
<div id="rating-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden">
    <div class="bg-gray-900 rounded-lg w-11/12 max-w-md p-6 relative">
        <button id="rating-modal-close" class="absolute top-3 right-3 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
        <h3 class="text-lg font-bold mb-2" data-lang-key="yourRatingTitle"></h3>
        <p class="text-sm text-gray-400 mb-4" data-lang-key="ratingImproves"></p>
        <div id="rating-stars" class="flex justify-center mb-4"></div>
        <div class="mb-4 space-y-2">
            <label class="flex items-center gap-2"><input type="checkbox" id="rating-dir" class="h-4 w-4 text-red-600"><span data-lang-key="directionCheckbox"></span></label>
            <label class="flex items-center gap-2"><input type="checkbox" id="rating-plot" class="h-4 w-4 text-red-600"><span data-lang-key="plotCheckbox"></span></label>
            <label class="flex items-center gap-2"><input type="checkbox" id="rating-spectacle" class="h-4 w-4 text-red-600"><span data-lang-key="spectacleCheckbox"></span></label>
            <label class="flex items-center gap-2"><input type="checkbox" id="rating-actors" class="h-4 w-4 text-red-600"><span data-lang-key="actorsCheckbox"></span></label>
        </div>
        <button id="rating-submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg" data-lang-key="rateButton"></button>
    </div>
</div>
<!-- Account Switch Modal -->
<div id="account-switch-modal" class="fixed inset-0 z-50 hidden bg-black/70">
    <div class="flex flex-col w-full h-full bg-gray-900/95 backdrop-blur-sm">
        <div class="flex items-center justify-between px-6 py-5 border-b border-gray-800">
            <div>
                <p class="text-sm uppercase tracking-wide text-red-400 font-semibold" data-lang-key="profile"></p>
                <h3 class="text-2xl font-bold text-white" data-lang-key="whoIsWatching"></h3>
            </div>
            <button id="account-switch-close" class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-800 text-gray-300 hover:text-white hover:bg-gray-700 transition">
                <i class="fas fa-times text-lg"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto px-6 py-8">
            <div id="account-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 justify-items-center"></div>
        </div>
        <div class="px-6 py-6 bg-gray-900 border-t border-gray-800 space-y-3">
            <button id="account-share-subscription" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-400 hover:to-pink-400 text-white font-semibold py-3 px-4 rounded-xl transition" data-lang-key="shareSubscription"></button>
        </div>
    </div>
</div>

<!-- Account Switch Confirmation Modal -->
<div id="switch-confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 hidden">
    <div class="bg-gray-900 rounded-xl w-11/12 max-w-md p-6 relative shadow-2xl border border-gray-800">
        <div class="text-center mb-6">
            <div class="mx-auto w-16 h-16 bg-gradient-to-br from-red-500 to-pink-500 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-user-friends text-2xl text-white"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2" data-lang-key="switchAccountConfirm"></h3>
            <p class="text-gray-400 text-sm">
                <span data-lang-key="switchAccountMessage"></span>
                <span id="switch-account-name" class="text-red-400 font-semibold"></span>?
            </p>
        </div>
        <div class="flex gap-3">
            <button id="switch-confirm-no" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg transition">
                <span data-lang-key="confirmNo"></span>
            </button>
            <button id="switch-confirm-yes" class="flex-1 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-500 hover:to-pink-500 text-white font-semibold py-3 px-4 rounded-lg transition">
                <span data-lang-key="confirmYes"></span>
            </button>
        </div>
    </div>
</div>

<!-- Share Subscription Modal -->
<div id="share-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden">
    <div class="bg-gray-900 rounded-lg w-11/12 max-w-lg p-6 relative overflow-y-auto max-h-[80vh]">
        <button id="share-modal-close" class="absolute top-3 right-3 text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
        <h3 class="text-lg font-bold mb-4" data-lang-key="promoCodesList"></h3>
        <div id="promo-codes-list" class="space-y-4"></div>
        <button id="generate-promo-btn" class="mt-4 w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg" data-lang-key="generateCode"></button>
    </div>
</div>
<!-- Kassa overlay for premium subscription purchases -->
<div id="kassa-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/70 hidden">
    <div class="bg-gray-900 rounded-lg w-11/12 max-w-2xl p-4 relative">
        <button id="kassa-close-btn" class="absolute top-2 right-2 text-gray-400 hover:text-white text-2xl"><i class="fas fa-times"></i></button>
        <!-- Inline Premium Kassa -->
        <div id="kassa-container" class="w-full max-h-[80vh] overflow-y-auto text-white">
            <!-- Step 1: Subscription Details -->
            <!-- Step 1: Plan Details and Payment Method -->
            <div id="kassa-step1" class="p-6">
                <h1 id="kassa-step1-title" class="text-3xl font-bold mb-6">Plan Details</h1>
                <!-- Email input -->
                <div class="mb-6">
                    <label id="kassa-email-label" for="kassa-email" class="block font-medium mb-2">Email</label>
                    <input type="email" id="kassa-email" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-red-500 focus:outline-none" placeholder="you@example.com" required>
                </div>
                <!-- Plan overview -->
                <div class="mb-6">
                    <h2 id="kassa-plan-heading" class="text-xl font-semibold mb-2">Subscription Plan</h2>
                    <p id="kassa-plan-name" class="text-lg">Premium Plan</p>
                    <p id="kassa-plan-duration" class="text-sm text-gray-400 mb-1">Duration: 1 month</p>
                    <p id="kassa-plan-price" class="text-lg font-bold"></p>
                </div>
                <!-- Payment method selection -->
                <div class="mb-6">
                    <label id="kassa-payment-method-label" class="block font-medium mb-2" for="kassa-payment-method">Select payment method</label>
                    <select id="kassa-payment-method" class="w-full p-2 rounded bg-gray-700 border border-gray-600"></select>
                </div>
                <!-- Navigation row: region selection and continue button -->
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label id="kassa-region-label" for="kassa-region-select" class="text-sm">Region:</label>
                        <select id="kassa-region-select" class="bg-gray-700 border border-gray-600 p-1 rounded text-sm"></select>
                    </div>
                    <button id="kassa-continue-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded w-full md:w-auto">Continue</button>
                </div>
            </div>
            <!-- Step 2: Payment Details -->
            <!-- Step 2: Checkout -->
            <div id="kassa-step2" class="hidden p-6">
                <a href="#" id="kassa-back-link" class="text-sm text-red-500 mb-4 inline-block">← Back</a>
                <div class="flex flex-col md:flex-row gap-8">
                    <!-- Order summary -->
                    <div class="md:w-1/2">
                        <h2 class="text-2xl font-bold mb-4">Order Summary</h2>
                        <div class="space-y-2">
                            <p><span class="font-semibold">Plan:</span> <span id="kassa-summary-plan-name"></span></p>
                            <p><span class="font-semibold">Duration:</span> <span id="kassa-summary-plan-duration"></span></p>
                            <p><span class="font-semibold">Region:</span> <span id="kassa-summary-region"></span></p>
                            <p><span class="font-semibold">Price:</span> <span id="kassa-summary-price"></span></p>
                            <p><span class="font-semibold">Expires:</span> <span id="kassa-summary-expiration"></span></p>
                        </div>
                    </div>
                    <!-- Payment details -->
                    <div class="md:w-1/2">
                        <h2 class="text-2xl font-bold mb-4">Payment Details</h2>
                        <!-- Card form for Russia -->
                        <div id="kassa-payment-form-card-ru" class="hidden">
                            <div class="mb-4">
                                <label class="block font-medium mb-1" for="kassa-card-name-ru">Name on card</label>
                                <input type="text" id="kassa-card-name-ru" class="w-full p-2 rounded bg-gray-700 border border-gray-600" placeholder="John Doe">
                            </div>
                            <div class="mb-4">
                                <label class="block font-medium mb-1" for="kassa-card-number-ru">Card Number</label>
                                <input type="text" id="kassa-card-number-ru" class="w-full p-2 rounded bg-gray-700 border border-gray-600" placeholder="**** **** **** 1234" maxlength="19">
                            </div>
                            <div class="flex gap-4 mb-4">
                                <div class="flex-1">
                                    <label class="block font-medium mb-1" for="kassa-card-exp-ru">Expiry Date</label>
                                    <input type="text" id="kassa-card-exp-ru" class="w-full p-2 rounded bg-gray-700 border border-gray-600" placeholder="MM/YY" maxlength="5">
                                </div>
                                <div class="flex-1">
                                    <label class="block font-medium mb-1" for="kassa-card-cvc-ru">CVC</label>
                                    <input type="text" id="kassa-card-cvc-ru" class="w-full p-2 rounded bg-gray-700 border border-gray-600" placeholder="123" maxlength="4">
                                </div>
                            </div>
                        </div>
                        <!-- Card form for Central Asia -->
                        <div id="kassa-payment-form-card-ca" class="hidden">
                            <div class="mb-4">
                                <label class="block font-medium mb-1" for="kassa-card-name-ca">Payer Name</label>
                                <input type="text" id="kassa-card-name-ca" class="w-full p-2 rounded bg-gray-700 border border-gray-600" placeholder="John Doe">
                            </div>
                            <div class="mb-4">
                                <label class="block font-medium mb-1" for="kassa-card-number-ca">Uzcard/Humo Number</label>
                                <input type="text" id="kassa-card-number-ca" class="w-full p-2 rounded bg-gray-700 border border-gray-600" placeholder="8600 00** **** 1234">
                            </div>
                            <div class="mb-4">
                                <label class="block font-medium mb-1" for="kassa-card-exp-ca">Expiry Date</label>
                                <input type="text" id="kassa-card-exp-ca" class="w-full p-2 rounded bg-gray-700 border border-gray-600" placeholder="MM/YY">
                            </div>
                        </div>
                        <!-- SBP form -->
                        <div id="kassa-payment-form-sbp" class="hidden">
                            <p class="mb-4">To pay via SBP (РЎР‘Рџ), please scan the QR code shown in your banking app or follow the instructions provided after confirming your purchase.</p>
                        </div>
                        <button id="kassa-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded w-full">Confirm Purchase</button>
                    </div>
                </div>
            </div>
            <!-- Step 3: Success Message -->
            <div id="kassa-step3" class="p-6 hidden text-center">
                <div class="bg-green-500 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                    <i class="fa-solid fa-check text-5xl text-white"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2">Purchase Confirmed!</h1>
                <p class="mb-6 text-slate-300">Your premium subscription has been activated!</p>
                <button id="kassa-success-close" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    window.addEventListener('load', function() {
        if (typeof handleLogout === 'function') {
            window.handleLogout = handleLogout;
        }
    });
// Expose a function to open the premium kassa overlay from plan cards.
    // It accepts the number of months and the total price (without currency sign) and populates the modal accordingly.
    window.openKassa = function(months, totalPrice) {
      const overlay = document.getElementById('kassa-overlay');
      if (!overlay) return;
      // Store plan information globally so it can be used in subsequent steps
      window.currentKassaPlanMonths = months;
      window.currentKassaTotalPrice = totalPrice;
  // The new kassa implementation will handle region selection, plan details and payment method rendering.
  // Display the overlay and initialize the premium kassa modal.
  overlay.classList.remove('hidden');
  if (typeof showPremiumKassa === 'function') {
    // Invoke after a slight delay to ensure modal elements are present in the DOM
    setTimeout(() => { showPremiumKassa(); }, 0);
  }
    };

    // Close the kassa overlay when the main close button is clicked
    const kassaCloseBtn = document.getElementById('kassa-close-btn');
    if (kassaCloseBtn) {
      kassaCloseBtn.addEventListener('click', function() {
        const overlay = document.getElementById('kassa-overlay');
        if (overlay) overlay.classList.add('hidden');
      });
    }

    // Enable/disable the proceed button based on email and region inputs
    function updateKassaProceedState() {
      const emailInput = document.getElementById('kassa-email');
      const regionSelect = document.getElementById('kassa-region');
      const proceedBtn = document.getElementById('kassa-proceed');
      if (!emailInput || !regionSelect || !proceedBtn) return;
      const emailValid = emailInput.checkValidity() && emailInput.value.trim().length > 0;
      // Persist selected region for future use
      if (regionSelect.value) {
        try {
          localStorage.setItem('soundora-region', regionSelect.value);
        } catch (err) {
          console.warn('Unable to save region preference:', err);
        }
      }
      if (regionSelect.value && emailValid) {
        proceedBtn.disabled = false;
        proceedBtn.classList.remove('opacity-50');
        proceedBtn.classList.remove('cursor-not-allowed');
      } else {
        proceedBtn.disabled = true;
        proceedBtn.classList.add('opacity-50');
        proceedBtn.classList.add('cursor-not-allowed');
      }
    }

    // Attach listeners for email and region changes to update proceed state
    (function() {
      const emailInput = document.getElementById('kassa-email');
      const regionSelect = document.getElementById('kassa-region');
      const proceedBtn = document.getElementById('kassa-proceed');
      if (emailInput) emailInput.addEventListener('input', updateKassaProceedState);
      if (regionSelect) regionSelect.addEventListener('change', updateKassaProceedState);
      // Proceed to step2 when the proceed button is clicked
      if (proceedBtn) {
        proceedBtn.addEventListener('click', function() {
          const months = window.currentKassaPlanMonths;
          const total = window.currentKassaTotalPrice;
          const emailVal = document.getElementById('kassa-email').value.trim();
          const regionVal = document.getElementById('kassa-region').value;
          // Populate summary fields
          const summaryPlan = document.getElementById('kassa-summary-plan');
          const summaryTotal = document.getElementById('kassa-summary-total');
          const summaryRegion = document.getElementById('kassa-summary-region');
          const summaryEmail = document.getElementById('kassa-summary-email');
          if (summaryPlan) summaryPlan.textContent = months + ' month' + (Number(months) > 1 ? 's' : '');
          if (summaryTotal) summaryTotal.textContent = total + ' в‚Ѕ';
          if (summaryRegion) summaryRegion.textContent = regionSelect.options[regionSelect.selectedIndex]?.text || regionVal;
          if (summaryEmail) summaryEmail.textContent = emailVal;
          // Build payment fields for the selected region
          renderKassaPaymentFields(regionVal);
          // Show step2 and hide step1
          const s1 = document.getElementById('kassa-step1');
          const s2 = document.getElementById('kassa-step2');
          if (s1) s1.classList.add('hidden');
          if (s2) s2.classList.remove('hidden');
        });
      }
    })();

    // Function to render payment form fields based on selected region
    function renderKassaPaymentFields(region) {
      const container = document.getElementById('kassa-payment-fields');
      if (!container) return;
      container.innerHTML = '';
      if (region === 'balance') {
        const msg = document.createElement('p');
        msg.textContent = 'Your account balance will be used for this purchase. No card details are required.';
        msg.className = 'text-slate-300';
        container.appendChild(msg);
        return;
      }
      let cardNumberLabel = 'Card Number';
      // Use Uzcard/Humo label for Central Asia (ca) and Uzbekistan (uz)
      if (region === 'uz' || region === 'ca') {
        cardNumberLabel = 'Uzcard/Humo Number';
      }
      const nameDiv = document.createElement('div');
      const nameLabel = document.createElement('label');
      nameLabel.className = 'block text-sm font-medium text-slate-300 mb-1';
      nameLabel.textContent = (region === 'ru' || region === 'other') ? 'Name on Card' : 'Payer Name';
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.required = true;
      nameInput.placeholder = 'John Doe';
      nameInput.className = 'w-full bg-slate-700 border-slate-600 rounded-md p-2 text-white focus:ring-red-500 focus:border-red-500';
      nameDiv.appendChild(nameLabel);
      nameDiv.appendChild(nameInput);
      container.appendChild(nameDiv);
      const cardDiv = document.createElement('div');
      const cardLabel = document.createElement('label');
      cardLabel.className = 'block text-sm font-medium text-slate-300 mb-1';
      cardLabel.textContent = cardNumberLabel;
      const cardInput = document.createElement('input');
      cardInput.type = 'text';
      cardInput.required = true;
      cardInput.placeholder = (region === 'uz' || region === 'ca') ? '8600 00** **** 1234' : '**** **** **** 1234';
      cardInput.className = 'w-full bg-slate-700 border-slate-600 rounded-md p-2 text-white focus:ring-red-500 focus:border-red-500';
      cardDiv.appendChild(cardLabel);
      cardDiv.appendChild(cardInput);
      container.appendChild(cardDiv);
      // For Russia show card fields with expiry and CVC; for Central Asia (ca) or Uzbekistan show only expiry (no CVC)
      if (region === 'ru') {
        const wrapper = document.createElement('div');
        wrapper.className = 'flex space-x-3';
        const expDiv = document.createElement('div');
        expDiv.className = 'flex-1';
        const expLabel = document.createElement('label');
        expLabel.className = 'block text-sm font-medium text-slate-300 mb-1';
        expLabel.textContent = 'Expiry Date';
        const expInput = document.createElement('input');
        expInput.type = 'text';
        expInput.required = true;
        expInput.placeholder = 'MM/YY';
        expInput.className = 'w-full bg-slate-700 border-slate-600 rounded-md p-2 text-white focus:ring-red-500 focus:border-red-500';
        expDiv.appendChild(expLabel);
        expDiv.appendChild(expInput);
        const cvcDiv = document.createElement('div');
        cvcDiv.className = 'flex-1';
        const cvcLabel = document.createElement('label');
        cvcLabel.className = 'block text-sm font-medium text-slate-300 mb-1';
        cvcLabel.textContent = 'CVC';
        const cvcInput = document.createElement('input');
        cvcInput.type = 'text';
        cvcInput.required = true;
        cvcInput.placeholder = '123';
        cvcInput.className = 'w-full bg-slate-700 border-slate-600 rounded-md p-2 text-white focus:ring-red-500 focus:border-red-500';
        cvcDiv.appendChild(cvcLabel);
        cvcDiv.appendChild(cvcInput);
        wrapper.appendChild(expDiv);
        wrapper.appendChild(cvcDiv);
        container.appendChild(wrapper);
      } else if (region === 'uz' || region === 'ca') {
        const expDiv = document.createElement('div');
        expDiv.className = 'flex-1';
        const expLabel = document.createElement('label');
        expLabel.className = 'block text-sm font-medium text-slate-300 mb-1';
        expLabel.textContent = 'Expiry Date';
        const expInput = document.createElement('input');
        expInput.type = 'text';
        expInput.required = true;
        expInput.placeholder = 'MM/YY';
        expInput.className = 'w-full bg-slate-700 border-slate-600 rounded-md p-2 text-white focus:ring-red-500 focus:border-red-500';
        expDiv.appendChild(expLabel);
        expDiv.appendChild(expInput);
        container.appendChild(expDiv);
      }
    }

    // Handle payment form submission (confirm purchase)
    (function() {
      const paymentForm = document.getElementById('kassa-payment-form');
      if (paymentForm) {
        paymentForm.addEventListener('submit', function(e) {
          e.preventDefault();
          const s2 = document.getElementById('kassa-step2');
          const s3 = document.getElementById('kassa-step3');
          if (s2) s2.classList.add('hidden');
          if (s3) s3.classList.remove('hidden');
        });
      }
    })();

    // Handle back button from step2 to step1
    (function() {
      const backBtn = document.getElementById('kassa-back');
      if (backBtn) {
        backBtn.addEventListener('click', function() {
          const s1 = document.getElementById('kassa-step1');
          const s2 = document.getElementById('kassa-step2');
          if (s1) s1.classList.remove('hidden');
          if (s2) s2.classList.add('hidden');
        });
      }
    })();

    // Close overlay after success
    (function() {
      const successClose = document.getElementById('kassa-success-close');
      if (successClose) {
        successClose.addEventListener('click', function() {
          const overlay = document.getElementById('kassa-overlay');
          if (overlay) overlay.classList.add('hidden');
        });
      }
    })();
</script>


<!-- === SND: Full-screen Search Overlay Patch === -->
<script>
    (function () {
      const overlayHTML = `
      <div id="snd-search-overlay" class="fixed inset-0 z-[60] hidden bg-[#05070d]/95 backdrop-blur-sm flex flex-col">
        <div class="p-4 flex items-center gap-3 border-b border-gray-800">
          <button id="snd-search-back" class="text-white text-xl hover:text-red-400 transition">
            <i class="fas fa-arrow-left"></i>
          </button>
          <div class="relative flex-1">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
            <input id="snd-search-input" type="text" autocomplete="off"
                   class="w-full bg-gray-900/70 text-white rounded-xl pl-10 pr-20 py-2.5 outline-none focus:ring-2 focus:ring-red-500 transition"
                   placeholder="">
            <button id="snd-search-mic" type="button"
                    class="absolute right-10 top-1/2 -translate-y-1/2 text-gray-600 hover:text-gray-300 transition"
                    title="">
              <i class="fas fa-microphone"></i>
            </button>
            <button id="snd-search-clear" type="button"
                    class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hidden hover:text-white transition">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <div class="flex-1 overflow-hidden">
          <div class="h-full overflow-y-auto px-4 py-4 space-y-6">
            <section>
              <div class="flex items-center justify-between mb-2">
                <h2 id="snd-history-title" class="text-sm font-semibold uppercase tracking-wide text-gray-400"></h2>
                <button id="snd-history-clear-all" class="text-xs text-gray-400 hover:text-red-400 transition"></button>
              </div>
              <div id="snd-search-history" class="space-y-2"></div>
            </section>
            <section>
              <div class="flex items-center justify-between mb-2">
                <h2 id="snd-trending-title" class="text-sm font-semibold uppercase tracking-wide text-gray-400"></h2>
              </div>
              <div id="snd-search-trending" class="space-y-2"></div>
            </section>
            <section>
              <div class="flex items-center justify-between mb-2">
                <h2 id="snd-results-title" class="text-sm font-semibold uppercase tracking-wide text-gray-400"></h2>
              </div>
              <div id="snd-search-results" class="space-y-3 pb-2"></div>
            </section>
          </div>
        </div>
      </div>`;
      const overlayCopy = {
        ru: {
          placeholder: "Поиск фильмов, сериалов и жанров",
          historyTitle: "Недавние запросы",
          historyEmpty: "Нет сохранённых запросов.",
          historyClearAll: "Очистить всё",
          historyRemove: "Удалить из истории",
          trendingTitle: "Популярные запросы",
          trendingEmpty: "Популярных запросов пока нет.",
          resultsTitle: "Результаты",
          resultsEmpty: "Ничего не найдено.",
          resultsNoQuery: "Введите запрос, чтобы увидеть результаты.",
          voiceHint: "Голосовой поиск скоро появится"
        },
        uz: {
          placeholder: "Film, serial va janrlarni qidiring",
          historyTitle: "So'nggi qidiruvlar",
          historyEmpty: "Saqlangan qidiruvlar yo'q.",
          historyClearAll: "Hammasini tozalash",
          historyRemove: "Tarixdan o'chirish",
          trendingTitle: "Mashhur qidiruvlar",
          trendingEmpty: "Hozircha mashhur qidiruvlar yo'q.",
          resultsTitle: "Natijalar",
          resultsEmpty: "Hech narsa topilmadi.",
          resultsNoQuery: "Natijalar shu yerda paydo bo'ladi.",
          voiceHint: "Ovozli qidiruv tez orada"
        },
        en: {
          placeholder: "Search for movies, series, or genres",
          historyTitle: "Recent searches",
          historyEmpty: "No saved searches yet.",
          historyClearAll: "Clear all",
          historyRemove: "Remove from history",
          trendingTitle: "Popular searches",
          trendingEmpty: "No popular searches yet.",
          resultsTitle: "Results",
          resultsEmpty: "Nothing found.",
          resultsNoQuery: "Results will appear here after you search.",
          voiceHint: "Voice search coming soon"
        }
      };
      const DEFAULT_TRENDING = {
        ru: [
          { label: "Брат 2", icon: "fas fa-chart-line text-amber-400" },
          { label: "Кавказская пленница", icon: "fas fa-chart-line text-amber-300" },
          { label: "Ирония судьбы", icon: "fas fa-chart-line text-amber-300" },
          { label: "Офицеры", icon: "fas fa-chart-line text-amber-200" },
          { label: "Белое солнце пустыни", icon: "fas fa-chart-line text-amber-200" }
        ],
        uz: [
          { label: "Mahabbat (O'zbekiston)", icon: "fas fa-chart-line text-amber-400" },
          { label: "Suleyman Too (Qirg'iziston)", icon: "fas fa-chart-line text-amber-300" },
          { label: "Istiqbol (Tojikiston)", icon: "fas fa-chart-line text-amber-300" },
          { label: "Brat 2", icon: "fas fa-chart-line text-amber-200" },
          { label: "Kavkazskaya plennitsa", icon: "fas fa-chart-line text-amber-200" }
        ],
        en: [
          { label: "Brother 2", icon: "fas fa-chart-line text-amber-400" },
          { label: "Prisoner of the Caucasus", icon: "fas fa-chart-line text-amber-300" },
          { label: "Irony of Fate", icon: "fas fa-chart-line text-amber-300" },
          { label: "Officers", icon: "fas fa-chart-line text-amber-200" },
          { label: "White Sun of the Desert", icon: "fas fa-chart-line text-amber-200" }
        ],
        default: [
          { label: "Brat 2", icon: "fas fa-chart-line text-amber-400" },
          { label: "Kavkazskaya plennitsa", icon: "fas fa-chart-line text-amber-300" },
          { label: "Ironiya sudby", icon: "fas fa-chart-line text-amber-300" },
          { label: "Ofitsery", icon: "fas fa-chart-line text-amber-200" },
          { label: "Beloye solnce pustyni", icon: "fas fa-chart-line text-amber-200" }
        ]
      };
      const MAX_HISTORY_ITEMS = 12;
      let scrollLockSnapshot = null;
      let pendingSearchNavigation = null;
      let awaitingSearchPopstate = false;
      let searchNavigationRetryTimer = null;

      function getOverlayCopy() {
        const lang = (typeof currentLanguage === "string" ? currentLanguage : "ru").toLowerCase();
        return overlayCopy[lang] || overlayCopy.ru;
      }

      function getTrendingDefaults() {
        const lang = (typeof currentLanguage === "string" ? currentLanguage : "ru").toLowerCase();
        return DEFAULT_TRENDING[lang] || DEFAULT_TRENDING.default || [];
      }

      function ensureOverlay() {
        if (!document.getElementById("snd-search-overlay")) {
          document.body.insertAdjacentHTML("beforeend", overlayHTML);
        }
      }

      function applyOverlayLocale() {
        const overlay = document.getElementById("snd-search-overlay");
        if (!overlay) return;
        const copy = getOverlayCopy();
        const input = document.getElementById("snd-search-input");
        const mic = document.getElementById("snd-search-mic");
        const historyTitle = document.getElementById("snd-history-title");
        const trendingTitle = document.getElementById("snd-trending-title");
        const resultsTitle = document.getElementById("snd-results-title");
        const clearAllBtn = document.getElementById("snd-history-clear-all");

        if (input) input.placeholder = copy.placeholder;
        if (mic) mic.title = copy.voiceHint;
        if (historyTitle) historyTitle.textContent = copy.historyTitle;
        if (trendingTitle) trendingTitle.textContent = copy.trendingTitle;
        if (resultsTitle) resultsTitle.textContent = copy.resultsTitle;
        if (clearAllBtn) clearAllBtn.textContent = copy.historyClearAll;
      }

      function lockScroll() {
        const body = document.body;
        if (!body || scrollLockSnapshot) return;
        scrollLockSnapshot = {
          overflow: body.style.overflow || "",
          paddingRight: body.style.paddingRight || ""
        };
        const scrollBarWidth = window.innerWidth - document.documentElement.clientWidth;
        if (scrollBarWidth > 0) {
          body.style.paddingRight = `${scrollBarWidth}px`;
        }
        body.style.overflow = "hidden";
      }

      function unlockScroll() {
        const body = document.body;
        if (!body || !scrollLockSnapshot) return;
        body.style.overflow = scrollLockSnapshot.overflow;
        body.style.paddingRight = scrollLockSnapshot.paddingRight;
        scrollLockSnapshot = null;
      }

      function flushPendingNavigation(targetOverride) {
        const target = targetOverride || pendingSearchNavigation;
        if (!target) return;

        pendingSearchNavigation = target;

        const tryNavigate = (attempt = 0) => {
          const navFn = typeof window.navigate === "function" ? window.navigate : null;
          if (navFn) {
            if (searchNavigationRetryTimer) {
              clearTimeout(searchNavigationRetryTimer);
              searchNavigationRetryTimer = null;
            }
            pendingSearchNavigation = null;
            awaitingSearchPopstate = false;
            try {
              navFn(target);
            } catch (err) {
              console.error("Failed to navigate to search result", err);
            }
            return;
          }
          if (attempt === 40) {
            console.warn("navigate() not ready yet for search result", target);
          }
          searchNavigationRetryTimer = setTimeout(() => tryNavigate(attempt + 1), 75);
        };

        if (searchNavigationRetryTimer) {
          clearTimeout(searchNavigationRetryTimer);
          searchNavigationRetryTimer = null;
        }

        tryNavigate();
      }

      function getHistory() {
        try {
          const stored = JSON.parse(localStorage.getItem("soundora-search-history") || "[]");
          return Array.isArray(stored) ? stored.filter(item => typeof item === "string" && item.trim()) : [];
        } catch (_) {
          return [];
        }
      }

      function setHistory(history) {
        try {
          localStorage.setItem("soundora-search-history", JSON.stringify(history));
        } catch (_) {}
      }

      function removeHistoryItem(value) {
        const history = getHistory().filter(item => item !== value);
        setHistory(history);
        try {
          const stats = JSON.parse(localStorage.getItem("soundora-search-stats") || "{}");
          if (stats && Object.prototype.hasOwnProperty.call(stats, value)) {
            delete stats[value];
            localStorage.setItem("soundora-search-stats", JSON.stringify(stats));
          }
        } catch (_) {}
        renderHistory();
        renderTrending();
      }

      function clearHistoryAll() {
        try {
          localStorage.removeItem("soundora-search-history");
          localStorage.removeItem("soundora-search-stats");
        } catch (_) {}
        renderHistory();
        renderTrending();
      }

      function saveHistoryItem(value) {
        const query = (value || "").trim();
        if (!query) return;
        const history = getHistory();
        const existingIndex = history.findIndex(item => item.toLowerCase() === query.toLowerCase());
        if (existingIndex !== -1) {
          history.splice(existingIndex, 1);
        }
        history.unshift(query);
        while (history.length > MAX_HISTORY_ITEMS) {
          history.pop();
        }
        setHistory(history);
        try {
          const stats = JSON.parse(localStorage.getItem("soundora-search-stats") || "{}");
          stats[query] = (typeof stats[query] === "number" ? stats[query] : 0) + 1;
          localStorage.setItem("soundora-search-stats", JSON.stringify(stats));
        } catch (_) {}
        renderHistory();
        renderTrending();
      }

      function renderHistory() {
        const wrap = document.getElementById("snd-search-history");
        const clearAllBtn = document.getElementById("snd-history-clear-all");
        if (!wrap) return;
        const copy = getOverlayCopy();
        const history = getHistory();
        wrap.innerHTML = "";
        if (clearAllBtn) {
          clearAllBtn.disabled = history.length === 0;
          clearAllBtn.classList.toggle("opacity-40", history.length === 0);
          clearAllBtn.classList.toggle("pointer-events-none", history.length === 0);
        }
        if (history.length === 0) {
          const empty = document.createElement("p");
          empty.className = "text-gray-500 text-sm";
          empty.textContent = copy.historyEmpty;
          wrap.appendChild(empty);
          return;
        }
        const frag = document.createDocumentFragment();
        history.forEach((entry) => {
          const row = document.createElement("div");
          row.className = "flex items-center gap-3 px-3 py-2 rounded-lg bg-gray-900/40 hover:bg-gray-800 transition";
          const queryBtn = document.createElement("button");
          queryBtn.type = "button";
          queryBtn.className = "flex-1 text-left text-sm text-gray-100 truncate";
          queryBtn.dataset.q = entry;
          queryBtn.dataset.role = "query";
          queryBtn.textContent = entry;
          const removeBtn = document.createElement("button");
          removeBtn.type = "button";
          removeBtn.className = "text-gray-500 hover:text-red-400 transition";
          removeBtn.dataset.q = entry;
          removeBtn.dataset.role = "delete";
          removeBtn.setAttribute("aria-label", copy.historyRemove);
          removeBtn.innerHTML = '<i class="fas fa-times"></i>';
          row.append(queryBtn, removeBtn);
          frag.appendChild(row);
        });
        wrap.appendChild(frag);
        wrap.querySelectorAll("button[data-q]").forEach((btn) => {
          if (btn.dataset.role === "delete") {
            btn.addEventListener("click", (event) => {
              event.stopPropagation();
              removeHistoryItem(btn.dataset.q || "");
            });
          } else {
            btn.addEventListener("click", () => {
              const value = btn.dataset.q || "";
              saveHistoryItem(value);
              const input = document.getElementById("snd-search-input");
              if (input) {
                input.value = value;
                input.focus();
              }
              doSearch(value);
            });
          }
        });
      }

      function renderTrending() {
        const wrap = document.getElementById("snd-search-trending");
        if (!wrap) return;
        const copy = getOverlayCopy();
        wrap.innerHTML = "";
        let stats = {};
        try {
          stats = JSON.parse(localStorage.getItem("soundora-search-stats") || "{}");
        } catch (_) {
          stats = {};
        }
        const fromStats = Object.entries(stats)
          .filter(([label, count]) => typeof label === "string" && label.trim() && typeof count === "number")
          .sort((a, b) => b[1] - a[1])
          .slice(0, 8)
          .map(([label]) => ({ label, icon: "fas fa-chart-line text-amber-300" }));
        const items = fromStats.length ? fromStats : getTrendingDefaults();
        if (!items.length) {
          const empty = document.createElement("p");
          empty.className = "text-gray-500 text-sm";
          empty.textContent = copy.trendingEmpty;
          wrap.appendChild(empty);
          return;
        }
        const frag = document.createDocumentFragment();
        items.forEach((item) => {
          const label = (item && item.label) ? item.label : "";
          if (!label.trim()) return;
          const row = document.createElement("button");
          row.type = "button";
          row.className = "w-full flex items-center justify-between gap-3 px-3 py-2 rounded-lg bg-gray-900/40 hover:bg-gray-800 transition";
          row.dataset.q = label;
          const left = document.createElement("span");
          left.className = "flex items-center gap-3 text-sm text-gray-100 truncate";
          const icon = document.createElement("i");
          icon.className = item.icon || "fas fa-chart-line text-amber-300";
          const text = document.createElement("span");
          text.className = "truncate";
          text.textContent = label;
          left.append(icon, text);
          const rightIcon = document.createElement("i");
          rightIcon.className = "fas fa-magnifying-glass text-gray-500";
          row.append(left, rightIcon);
          row.addEventListener("click", () => {
            saveHistoryItem(label);
            const input = document.getElementById("snd-search-input");
            if (input) {
              input.value = label;
              input.focus();
            }
            doSearch(label);
          });
          frag.appendChild(row);
        });
        wrap.appendChild(frag);
      }

      function setResultsMessage(message) {
        const container = document.getElementById("snd-search-results");
        if (!container) return;
        container.innerHTML = "";
        const note = document.createElement("p");
        note.className = "text-gray-500 text-sm px-2 py-4 text-center";
        note.textContent = message;
        container.appendChild(note);
      }

      function renderResults(list, emptyMessage) {
        const container = document.getElementById("snd-search-results");
        if (!container) return;
        const copy = getOverlayCopy();
        container.innerHTML = "";
        if (!Array.isArray(list) || list.length === 0) {
          setResultsMessage(emptyMessage || copy.resultsEmpty);
          return;
        }
        const input = document.getElementById("snd-search-input");
        const frag = document.createDocumentFragment();
        list.forEach((movie) => {
          if (!movie || !movie.id) return;
          const item = document.createElement("a");
          item.href = "#";
          item.className = "snd-search-result flex items-center gap-3 p-3 rounded-xl bg-gray-900/40 hover:bg-gray-800 transition";
          item.dataset.movieId = String(movie.id);
          const posterWrap = document.createElement("div");
          posterWrap.className = "w-12 h-16 rounded-lg overflow-hidden bg-gray-800 flex-shrink-0";
          const img = document.createElement("img");
          const fallbackPoster = `https://placehold.co/200x300/1f2937/ffffff?text=${encodeURIComponent(movie.title || "Movie")}`;
          img.src = typeof movie.poster === "string" && movie.poster.trim() ? movie.poster : fallbackPoster;
          img.alt = movie.title || "";
          img.className = "w-full h-full object-cover";
          img.addEventListener("error", () => {
            img.onerror = null;
            img.src = fallbackPoster;
          });
          posterWrap.appendChild(img);
          const info = document.createElement("div");
          info.className = "flex-1 min-w-0";
          const titleEl = document.createElement("p");
          titleEl.className = "text-sm font-semibold text-white truncate";
          titleEl.textContent = movie.title || "";
          const subtitleEl = document.createElement("p");
          subtitleEl.className = "text-xs text-gray-400 truncate";
          const genreText = Array.isArray(movie.genre) ? movie.genre.join(", ") : (movie.genre || "");
          const subtitleParts = [movie.year || "", genreText].filter(Boolean);
          subtitleEl.textContent = subtitleParts.join(" | ");
          info.append(titleEl, subtitleEl);
          const chevron = document.createElement("i");
          chevron.className = "fas fa-chevron-right text-gray-600";
          item.append(posterWrap, info, chevron);
          item.addEventListener("click", (event) => {
            event.preventDefault();
            const currentQuery = input && input.value ? input.value.trim() : "";
            if (currentQuery) {
              saveHistoryItem(currentQuery);
            }
            const movieId = item.dataset.movieId;
            const target = movieId ? { page: "movie-details", movieId } : null;

    // --- FIX: navigate immediately instead of waiting for popstate/back ---
    if (target) {
      try {
        if (typeof window.navigate === "function") {
          window.navigate(target);
        } else {
          // Graceful fallback
          history.pushState(target, "", `#${target.page}`);
        }
      } catch (err) {
        console.error("Immediate navigate failed", err);
      }
      // Close the search overlay *after* we navigate so Back returns to search
      try { closeOverlay(); } catch(_) {}
      return;
    }
    // --- /FIX ---

            if (!target) return;
            pendingSearchNavigation = target;
            const hasOverlayState = history.state && history.state.overlay === "search";
            closeOverlay();
            if (hasOverlayState) {
              awaitingSearchPopstate = true;
              try {
                history.back();
              } catch (_) {
                flushPendingNavigation(target);
              }
            } else {
              setTimeout(() => flushPendingNavigation(target), 0);
            }
          });
          frag.appendChild(item);
        });
        if (!frag.children.length) {
          setResultsMessage(emptyMessage || copy.resultsEmpty);
          return;
        }
        container.appendChild(frag);
      }

      function parseQuery(q) {
        const tokens = (q || "").toLowerCase().split(/\s+/).filter(Boolean);
        const result = { text: [], years: [] };
        tokens.forEach((token) => {
          if (/^\d{2,4}$/.test(token)) {
            result.years.push(token);
          } else {
            result.text.push(token);
          }
        });
        return result;
      }

      function doSearch(raw) {
        const query = (raw || "").trim();
        const copy = getOverlayCopy();
        const clearBtn = document.getElementById("snd-search-clear");
        const micBtn = document.getElementById("snd-search-mic");
        if (clearBtn) clearBtn.classList.toggle("hidden", query.length === 0);
        if (micBtn) micBtn.classList.toggle("hidden", query.length > 0);
        if (!query) {
          renderResults([], copy.resultsNoQuery);
          return;
        }
        const source = Array.isArray(window.movies) ? window.movies : (Array.isArray(window.sndMovies) ? window.sndMovies : []);
        if (!source.length) {
          renderResults([], copy.resultsEmpty);
          return;
        }
        const filters = parseQuery(query);
        const results = source.filter((movie) => {
          const title = String(movie.title || "").toLowerCase();
          const original = String(movie.originalTitle || "").toLowerCase();
          const genre = Array.isArray(movie.genre) ? movie.genre.join(" ").toLowerCase() : String(movie.genre || "").toLowerCase();
          if (filters.text.length && !filters.text.every((token) => title.includes(token) || original.includes(token) || genre.includes(token))) {
            return false;
          }
          if (filters.years.length) {
            const year = String(movie.year || "");
            if (!filters.years.every((token) => year.startsWith(token))) {
              return false;
            }
          }
          return true;
        }).slice(0, 60);
        renderResults(results, copy.resultsEmpty);
      }

      function debounce(fn, delay) {
        let timeout;
        return function (...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => fn.apply(this, args), delay);
        };
      }

      function attachOverlayEvents() {
        const backBtn = document.getElementById("snd-search-back");
        const clearBtn = document.getElementById("snd-search-clear");
        const clearAllBtn = document.getElementById("snd-history-clear-all");
        const input = document.getElementById("snd-search-input");

        if (backBtn) {
          backBtn.onclick = () => history.back();
        }
        if (clearBtn && input) {
          clearBtn.onclick = () => {
            input.value = "";
            doSearch("");
            input.focus();
          };
        }
        if (clearAllBtn) {
          clearAllBtn.onclick = () => clearHistoryAll();
        }
        if (input) {
          input.oninput = debounce(() => doSearch(input.value), 150);
          input.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
              const value = input.value.trim();
              if (value) {
                saveHistoryItem(value);
                doSearch(value);
              }
            }
            if (event.key === "Escape") {
              history.back();
            }
          });
        }
      }

      function openOverlay() {
        ensureOverlay();
        const overlay = document.getElementById("snd-search-overlay");
        if (!overlay) return;
        if (!window._sndSearchOpen) {
          history.pushState({ page: (window.currentHistoryState && window.currentHistoryState.page) || "main", overlay: "search" }, "", location.href);
        }
        overlay.classList.remove("hidden");
        pendingSearchNavigation = null;
        awaitingSearchPopstate = false;
        lockScroll();
        applyOverlayLocale();
        attachOverlayEvents();
        const input = document.getElementById("snd-search-input");
        const clearBtn = document.getElementById("snd-search-clear");
        const micBtn = document.getElementById("snd-search-mic");
        if (input) {
          input.value = "";
          input.focus();
        }
        if (clearBtn) clearBtn.classList.add("hidden");
        if (micBtn) micBtn.classList.remove("hidden");
        renderHistory();
        renderTrending();
        renderResults([], getOverlayCopy().resultsNoQuery);
        window._sndSearchOpen = true;
      }

      function closeOverlay() {
        const overlay = document.getElementById("snd-search-overlay");
        if (!overlay || overlay.classList.contains("hidden")) {
          window._sndSearchOpen = false;
          return;
        }
        overlay.classList.add("hidden");
        unlockScroll();
        window._sndSearchOpen = false;
      }

      function patchHeader() {
        const headerRight = document.querySelector("header .flex.items-center.space-x-4");
        if (!headerRight) return;
        const langWrap = document.getElementById("language-button-wrapper-header");
        if (langWrap) langWrap.style.display = "none";
        if (!document.getElementById("snd-open-search-btn")) {
          const btn = document.createElement("button");
          btn.id = "snd-open-search-btn";
          btn.className = "text-gray-300 hover:text-white transition duration-300";
          btn.innerHTML = '<i class="fas fa-search text-lg"></i>';
          headerRight.insertBefore(btn, headerRight.firstChild);
          btn.addEventListener("click", (event) => {
            event.preventDefault();
            openOverlay();
          });
        }
      }

      window.addEventListener("popstate", (event) => {
        if (event && event.state && event.state.overlay === "search") {
          openOverlay();
          return;
        }
        if (awaitingSearchPopstate) {
          awaitingSearchPopstate = false;
          closeOverlay();
          flushPendingNavigation();
          return;
        }
        if (window._sndSearchOpen) {
          closeOverlay();
        }
        flushPendingNavigation();
      });

      document.addEventListener("DOMContentLoaded", () => {
        patchHeader();
      });

      window.sndOpenSearch = openOverlay;
      window.sndCloseSearch = closeOverlay;
      window.sndRefreshSearchLocale = applyOverlayLocale;
    })();
</script>

</body>
</html>
